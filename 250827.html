<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ - v2025-11+ops+clv (Single File, FIXED)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #fff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --pri: #2563eb;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --vio: #8b5cf6;
      --cyan: #06b6d4;
      --rocket: #ff6b35;
      --wow: #9333ea;
      --fresh: #059669
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px
    }

    .header {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #9333ea 100%);
      color: #fff;
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 20px;
      box-shadow: 0 12px 32px rgba(255, 107, 53, .25);
      position: relative;
      overflow: hidden
    }

    .header::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, .05) 10px, rgba(255, 255, 255, .05) 20px);
      animation: slide 20s linear infinite
    }

    @keyframes slide {
      0% {
        transform: translateX(-50px)
      }
      100% {
        transform: translateX(50px)
      }
    }

    .header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      position: relative;
      z-index: 1
    }

    .header .sub {
      opacity: .9;
      font-size: 14px;
      position: relative;
      z-index: 1
    }

    .header .reality-badge {
      position: absolute;
      top: 20px;
      right: 30px;
      background: rgba(255, 255, 255, .2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, .3)
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 6px 20px rgba(2, 6, 23, .08)
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end
    }

    .ctrl {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .ctrl label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600
    }

    .ctrl input, .ctrl select {
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      min-width: 130px
    }

    .btn {
      background: var(--pri);
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .3s
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, .3)
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none
    }

    .btn.secondary {
      background: #374151
    }

    .btn.danger {
      background: var(--bad)
    }

    .btn.rocket {
      background: var(--rocket)
    }

    .btn.wow {
      background: var(--wow)
    }

    .progress-container {
      margin: 12px 0;
      display: none
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: var(--line);
      border-radius: 6px;
      overflow: hidden
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, var(--rocket), var(--wow));
      width: 0%;
      transition: width .2s ease
    }

    .progress-text {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
      font-weight: 600
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px
    }

    .kpi-grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      position: relative;
      transition: transform .3s
    }

    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(2, 6, 23, .12)
    }

    .kpi h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .4px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .kpi .v {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px
    }

    .kpi .meta {
      font-size: 11px;
      color: var(--muted)
    }

    .kpi.primary {
      border-top: 4px solid var(--pri)
    }

    .kpi.good {
      border-top: 4px solid var(--good)
    }

    .kpi.warn {
      border-top: 4px solid var(--warn)
    }

    .kpi.bad {
      border-top: 4px solid var(--bad)
    }

    .kpi.rocket {
      border-top: 4px solid var(--rocket)
    }

    .kpi.wow {
      border-top: 4px solid var(--wow)
    }

    .kpi.fresh {
      border-top: 4px solid var(--fresh)
    }

    .kpi.cyan {
      border-top: 4px solid var(--cyan)
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600
    }

    .pill.ok {
      background: #dcfce7;
      color: #065f46
    }

    .pill.ng {
      background: #fee2e2;
      color: #991b1b
    }

    .pill.running {
      background: #dbeafe;
      color: #1e40af
    }

    .sections {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));
      gap: 18px;
      margin-top: 12px
    }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px
    }

    .section h3 {
      margin: 0 0 12px 0;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .alerts {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 280px;
      overflow: auto
    }

    .alert {
      padding: 12px 15px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid;
      transition: all .3s
    }

    .alert:hover {
      transform: translateX(4px)
    }

    .alert.good {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #065f46
    }

    .alert.warn {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e
    }

    .alert.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b
    }

    .table-wrap {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 0;
      margin-top: 18px;
      overflow: hidden
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      border-bottom: 2px solid var(--line)
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      white-space: nowrap
    }

    th {
      font-weight: 700;
      color: var(--ink)
    }

    .delivery-mode.rocket {
      color: var(--rocket);
      font-weight: 600
    }

    .delivery-mode.dawn {
      color: var(--wow);
      font-weight: 600
    }

    .delivery-mode.fresh {
      color: var(--fresh);
      font-weight: 600
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: flex-start
      }

      .ctrl input, .ctrl select {
        min-width: 280px
      }

      .sections {
        grid-template-columns:1fr
      }

      .kpi-grid {
        grid-template-columns:repeat(auto-fit, minmax(250px, 1fr))
      }
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px
    }

    .switch input {
      display: none
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #cbd5e1;
      border-radius: 999px;
      transition: .2s
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .2)
    }

    .switch input:checked + .slider {
      background: #22c55e
    }

    .switch input:checked + .slider:before {
      transform: translateX(20px)
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="reality-badge">í˜„ì‹¤ì„± 95%</div>
    <h1>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ (Coupang Logistics Reality Simulator)</h1>
    <div class="sub">ğŸ¯ ë¡œì¼“ë°°ì†¡Â·ì‹ ì„ ì‹í’ˆÂ·WOWÂ·AIìë™í™” | FCÂ·í—ˆë¸Œ ë¶„ë¦¬ | ì…ê³ /ì ì¹˜/ìœ í†µê¸°í•œ/ë¡œì¼€ì´ì…˜ í¬í•¨ â€” v2025-11+ops+clv (FIXED)</div>
  </div>

  <div class="panel">
    <div class="controls">
      <div class="ctrl"><label>ì‹œì‘ë…„ë„ / Start Year</label><select id="startYear"></select></div>
      <div class="ctrl"><label>ì¢…ë£Œë…„ë„ / End Year</label><select id="endYear"></select></div>
      <div class="ctrl"><label>ê³ ê° ìˆ˜ / #Users</label><input id="userCount" type="number" min="100" max="200000"
                                                           value="300"></div>
      <div class="ctrl"><label>ì£¼ë¬¸ ìˆ˜ / #Orders</label><input id="orderCount" type="number" min="500" max="10000000"
                                                            step="1000" value="10000"></div>
      <div class="ctrl"><label>ì²­í¬ í¬ê¸° / Chunk Size</label><input id="chunkSize" type="number" min="500" max="15000"
                                                                step="500" value="3000"></div>
      <div class="ctrl"><label>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘ / Rocket Rate (%)</label><input id="rocketRate" type="number" min="35" max="90"
                                                                       value="55"></div>
      <div class="ctrl"><label>WOW ê°€ì…ë¥  / WOW Rate (%)</label><input id="wowRate" type="number" min="60" max="100"
                                                                    value="80"></div>
      <div class="ctrl"><label>ëª©í‘œ ìˆœì´ìµë¥ (%)</label><input id="targetNetMargin" type="number" step="0.1" value="3.2"
                                                        min="-20" max="30"></div>
      <div class="ctrl">
        <label>FAST MODE</label>
        <label class="switch"><input type="checkbox" id="fastMode"><span class="slider"></span></label>
      </div>
      <button class="btn rocket" id="btnStart">â–¶ï¸ ë°ì´í„° ìƒì„± / Generate</button>
      <button class="btn secondary" id="btnTune">âš™ï¸ DIALS</button>
      <button class="btn danger" id="btnStop" disabled>â¹ï¸ ì¤‘ë‹¨ / Stop</button>
      <button class="btn wow" id="btnCsv" disabled>ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ / Download CSV</button>
      <button class="btn wow" id="btnCsvTurbo" disabled>âš¡ï¸ ì´ˆê³ ì† CSV (GZIP)</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘... / Processing...</div>
      <div class="progress-stats"><span id="progressStats">-</span><span id="progressETA">ì˜ˆìƒ ì™„ë£Œ: - / ETA: -</span></div>
    </div>
  </div>

  <!-- DIALS -->
  <div class="panel" id="tunePanel" style="display:block">
    <div class="controls" style="align-items:flex-start">
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœì†Œ</label><input id="dial_loss_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.07"></div>
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœëŒ€</label><input id="dial_loss_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.12"></div>
      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœì†Œ</label><input id="dial_temp_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.01"></div>
      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœëŒ€</label><input id="dial_temp_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.02"></div>
      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœì†Œ</label><input id="dial_jeju_lo" type="number" step="0.001" min="0" max="1"
                                                       value="0.10"></div>
      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœëŒ€</label><input id="dial_jeju_hi" type="number" step="0.001" min="0" max="1"
                                                       value="0.15"></div>
      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœì†Œ</label><input id="dial_over_lo" type="number" step="0.001" min="0" max="1"
                                                    value="0.15"></div>
      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœëŒ€</label><input id="dial_over_hi" type="number" step="0.001" min="0" max="1"
                                                    value="0.25"></div>
      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœì†Œ</label><input id="dial_exp_lo" type="number" step="0.001" min="0" max="1"
                                                        value="0.005"></div>
      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœëŒ€</label><input id="dial_exp_hi" type="number" step="0.001" min="0" max="1"
                                                        value="0.01"></div>
    </div>
    <div class="controls">
      <button class="btn wow" id="btnApplyDials">ì ìš©</button>
      <button class="btn secondary" id="btnResetDials">ì´ˆê¸°í™”</button>
      <div id="tuneStatus" class="pill ok">DIALS READY</div>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">ì •ì±… ë©”ëª¨: ë°°ì†¡ë¹„ëŠ” ê±°ë¦¬êµ¬ê°„Ã—ëª¨ë“œÃ—WOWì— ë”°ë¼ ì‚°ì¶œë©ë‹ˆë‹¤(ì˜ˆ: WOW ëŒ€ë¶€ë¶„ ë¬´ë£Œ, ë¹„íšŒì›
      1,500~4,500ì›). ë‚ ì”¨ ê°€ì¤‘ì¹˜ëŠ” ì„¸ê·¸ë¨¼íŠ¸í‚¤ ì œì™¸/ë¹„ìš© í¬í•¨(default).
    </div>
  </div>

  <!-- KPI ì„¹ì…˜ -->
  <div class="sections">
    <div class="section"><h3>ğŸš€ ë¡œì¼“ë°°ì†¡ ì„±ê³¼</h3>
      <div class="kpi-grid">
        <div class="kpi rocket"><h4>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘</h4>
          <div class="v" id="k_rocketShare">-</div>
          <div class="meta">% of orders</div>
        </div>
        <div class="kpi rocket"><h4>ë¡œì¼“ë‹¹ì¼ ì„±ê³µë¥ </h4>
          <div class="v" id="k_rocketSameDayRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>ë¡œì¼“ìƒˆë²½ ì •ì‹œìœ¨</h4>
          <div class="v" id="k_rocketDawnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>30ë¶„ë‚´ ì¶œê³ ìœ¨</h4>
          <div class="v" id="k_fastShipRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>í—ˆë¸Œ on-time (p95)</h4>
          <div class="v" id="k_hubOnTimeP95">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>ìº í”„ on-time (p95)</h4>
          <div class="v" id="k_campOnTimeP95">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi warn"><h4>camp_dispatch_breach ëˆ„ì </h4>
          <div class="v" id="k_campDispatchBreach">-</div>
          <div class="meta">ê±´</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ“¦ ì¶œê³ Â·í’€í•„ë¨¼íŠ¸</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì •ì‹œ ì¶œê³ ìœ¨</h4>
          <div class="v" id="k_fcOnTimeShip">-</div>
          <div class="meta">ëª©í‘œ â‰¥ 96%</div>
        </div>
        <div class="kpi"><h4>í‰ê·  ì¶œê³  ì‹œê°„</h4>
          <div class="v" id="k_fcAvgShipHour">-</div>
          <div class="meta">ì‹œê°„</div>
        </div>
        <div class="kpi"><h4>í”¼í‚¹ ì†ë„</h4>
          <div class="v" id="k_fcPickSecPerItem">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi"><h4>íŒ¨í‚¹ ì†ë„</h4>
          <div class="v" id="k_fcPackSecPerItem">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi good"><h4>í’€í•„ë¨¼íŠ¸ íš¨ìœ¨</h4>
          <div class="v" id="k_fcEfficiency">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>60ë¶„ë‚´ ì¶œê³ ìœ¨</h4>
          <div class="v" id="k_fcShipUnder60">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>FC ì´ ì²´ë¥˜ í‰ê· </h4>
          <div class="v" id="k_fcTotalDwellMinAvg">-</div>
          <div class="meta">ë¶„</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸŒŸ WOW ë©¤ë²„ì‹­ & í”„ë¦¬ë¯¸ì—„</h3>
      <div class="kpi-grid">
        <div class="kpi wow"><h4>WOW ê°€ì…ë¥ </h4>
          <div class="v" id="k_wowShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>WOW Plus ë¹„ì¤‘</h4>
          <div class="v" id="k_wowPlusShare">0</div>
          <div class="meta">% (WOW ë‚´ë¶€)</div>
        </div>
        <div class="kpi wow"><h4>WOW vs ë¹„íšŒì› AOV ì°¨ì´</h4>
          <div class="v" id="k_wowAovGap">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi warn"><h4>WOW ì´íƒˆ ìœ„í—˜ ê³ ê°</h4>
          <div class="v" id="k_wowChurnRisk">-</div>
          <div class="meta">ëª…</div>
        </div>
        <div class="kpi"><h4>Q4-Top ê³ ê° ë¹„ì¤‘</h4>
          <div class="v" id="k_clvTopQ4Share">-</div>
          <div class="meta">% (ê³ ê° ê¸°ì¤€)</div>
        </div>
        <div class="kpi"><h4>WOW vs ë¹„íšŒì› CLV ê²©ì°¨</h4>
          <div class="v" id="k_clvWowGap">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi warn"><h4>ìµœê·¼60ì¼ ê³ ìœ„ë°˜ ê³ ê° ë¹„ì¤‘</h4>
          <div class="v" id="k_highBreach60Share">-</div>
          <div class="meta">% (ê³ ê° ê¸°ì¤€)</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>â„ï¸ ì‹ ì„ ì‹í’ˆ & ì½œë“œì²´ì¸</h3>
      <div class="kpi-grid">
        <div class="kpi fresh"><h4>ì‹ ì„ ì‹í’ˆ ë¹„ì¤‘</h4>
          <div class="v" id="k_freshShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>ì½œë“œì²´ì¸ ì¤€ìˆ˜ìœ¨</h4>
          <div class="v" id="k_coldChainRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi warn"><h4>ì˜¨ë„ ìœ„ë°˜ìœ¨</h4>
          <div class="v" id="k_tempViolation">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>ëƒ‰ë™ì‹í’ˆ í’ˆì§ˆ ì ìˆ˜</h4>
          <div class="v" id="k_frozenQuality">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ­ í—ˆë¸Œ&ìŠ¤í¬í¬ ë¬¼ë¥˜ë§</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ë©”ê°€í—ˆë¸Œ ì²˜ë¦¬ ë¹„ì¤‘</h4>
          <div class="v" id="k_megaHubShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>ìˆ˜ë„ê¶Œ ì»¤ë²„ë¦¬ì§€</h4>
          <div class="v" id="k_seoulCoverage">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>í‰ê·  ë°°ì†¡ ê±°ë¦¬</h4>
          <div class="v" id="k_avgDistance">-</div>
          <div class="meta">km</div>
        </div>
        <div class="kpi primary"><h4>ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±</h4>
          <div class="v" id="k_networkEff">-</div>
          <div class="meta">ì </div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ¤– AI & ìë™í™” ìˆ˜ì¤€</h3>
      <div class="kpi-grid">
        <div class="kpi cyan"><h4>AI ìµœì í™” ë¹„ìœ¨</h4>
          <div class="v" id="k_aiOptimized">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi cyan"><h4>ìë™ í”¼í‚¹ìœ¨</h4>
          <div class="v" id="k_autoPickRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>í‰ê·  í”¼í‚¹ ì‹œê°„</h4>
          <div class="v" id="k_avgPickTime">-</div>
          <div class="meta">ì´ˆ</div>
        </div>
        <div class="kpi cyan"><h4>WMS ê³ ë„í™” ì ìˆ˜</h4>
          <div class="v" id="k_wmsAdvanced">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ’° ë§¤ì¶œÂ·ìˆ˜ìµ</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì´ ë§¤ì¶œ</h4>
          <div class="v" id="k_totalSales">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi good"><h4>ìˆœì´ìµë¥ </h4>
          <div class="v" id="k_netMargin">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>í‰ê· ì£¼ë¬¸ê¸ˆì•¡</h4>
          <div class="v" id="k_aov">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi"><h4>ARPPU</h4>
          <div class="v" id="k_arppu">-</div>
          <div class="meta">â‚©</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ‘¥ ê³ ê°</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC</h4>
          <div class="v" id="k_ltvCac">-</div>
        </div>
        <div class="kpi"><h4>ìœ ì§€ìœ¨</h4>
          <div class="v" id="k_retention">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì´íƒˆë¥ </h4>
          <div class="v" id="k_churn">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>AI ì´íƒˆ ì˜ˆì¸¡ ì •í™•ë„</h4>
          <div class="v" id="k_ai">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸšš ë°°ì†¡Â·ë¬¼ë¥˜</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>ì •ì‹œìœ¨</h4>
          <div class="v" id="k_onTime">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>SLA ìœ„ë°˜ìœ¨</h4>
          <div class="v" id="k_sla">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì ì¬ìœ¨</h4>
          <div class="v" id="k_load">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì—°ë¹„</h4>
          <div class="v" id="k_fuel">-</div>
          <div class="meta">km/â„“ Â· km/kWh</div>
        </div>
        <div class="kpi"><h4>ë¼ìš°íŒ… ì ìˆ˜</h4>
          <div class="v" id="k_route">-</div>
          <div class="meta">/100</div>
        </div>
        <div class="kpi warn"><h4>ë°°ì†¡ ì˜ˆì™¸ìœ¨</h4>
          <div class="v" id="k_exception">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ“¦ ë°˜í’ˆ</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>ë°˜í’ˆë¥ </h4>
          <div class="v" id="k_returnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ë°˜í’ˆ ì†ì‹¤ë¥ </h4>
          <div class="v" id="k_returnCost">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬íŒë§¤ ê°€ëŠ¥ë¥ </h4>
          <div class="v" id="k_resell">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>ğŸ­ WMSÂ·ì¬ê³ </h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>ì¬ê³  íšŒì „ìœ¨</h4>
          <div class="v" id="k_invTurn">-</div>
          <div class="meta">íšŒ</div>
        </div>
        <div class="kpi"><h4>í’ˆì ˆë¥ </h4>
          <div class="v" id="k_stockout">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ê³¼ì¬ê³  ë¹„ìœ¨</h4>
          <div class="v" id="k_overstock">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì •í™•ë„</h4>
          <div class="v" id="k_invAcc">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì†ì‹¤ë¥ </h4>
          <div class="v" id="k_shrink">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>WMS í™œìš©ë¥ </h4>
          <div class="v" id="k_wms">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sections">
    <div class="section"><h3>âœ… ì¿ íŒ¡ íŠ¹í™” ì •í•©ì„± ê²€ì‚¬</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section"><h3>âš ï¸ ì¿ íŒ¡ ë³µí•© ìœ„í—˜ ìš”ì†Œ</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section"><h3>ğŸ“Š ì²˜ë¦¬ ì„±ëŠ¥ & í˜„ì‹¤ì„± ì§€í‘œ</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* ============================================================
     Coupang Logistics Reality Simulator â€” Fixed Single File
     v2025-11+ops+clv
     â–¶ FIX: ì›Œì»¤ ì½”ë“œ/ì „ì†¡ ëˆ„ë½ìœ¼ë¡œ ë°ì´í„° ë¯¸ìƒì„± ë¬¸ì œ í•´ê²°
     â–¶ FIX: CSV/í…Œì´ë¸” í—¤ë” ê³µë°±ì„ ì–¸ë”ë°”ë¡œ ì¶œë ¥
     â–¶ NEW: ë°˜í’ˆ ì‚¬ìœ  ì •ê·œí™”/í’ˆì§ˆÂ·ì˜¤ë°°ì†¡ í”Œë˜ê·¸, ê°€ë“œë ˆì¼ p95 ë¸Œë¦¬ì¹˜
  ============================================================ */

  /* ---------- 0) ì„¸ì…˜ ì •ì±… ---------- */
  const POLICY = {useWeatherInSegmentation: false, useWeatherInCost: true};

  /* ---------- 1) ë„¤íŠ¸ì›Œí¬ í‚¤ ---------- */
  const NET_PREFIX = '__net_';
  const N = s => NET_PREFIX + s;
  const NET = Object.freeze({
    ROUTE_TYPE: N('Route_Type'),
    SORT_HUB_NAME: N('Sortation_Hub_Name'),
    FC_EXIT: N('FC_Exit_TS'),
    HUB_IN: N('Hub_In_TS'),
    HUB_OUT: N('Hub_Out_TS'),
    CAMP_IN: N('Camp_In_TS'),
    LOAD_START: N('Loadout_Start_TS'),
    LOAD_END: N('Loadout_End_TS'),
    OFD: N('OFD_TS'),
    FC_DWELL: N('FC_Dwell_Min'),
    HUB_DWELL: N('Hub_Dwell_Min'),
    CAMP_DWELL: N('Camp_Dwell_Min'),
  });

  /* ---------- 2) CSV ë¼ë²¨/ìœ í‹¸ ---------- */
  const CSV_SPECIAL_LABELS = {
    Order_ID: 'Order ID',
    Order_Date: 'Order Date',
    Order_Timestamp: 'Order Timestamp',
    Order_Hour: 'Order Hour',
    Delivery_Mode: 'Delivery Mode',
    Planned_Delivery_Date: 'Planned Delivery Date',
    Actual_Delivery_Date: 'Actual Delivery Date',
    Delivery_Timestamp: 'Delivery Timestamp',
    Planned_Delivery_Timestamp: 'Planned Delivery Timestamp',
    Is_Delayed: 'Is Delayed',
    Delay_Hours: 'Delay Hours',
    SLA_Breach: 'SLA Breach',
    Delivery_Status: 'Delivery Status',
    Fast_Ship_30min: 'Fast Ship 30min',
    Order_To_Ship_Minutes: 'Order To Ship Minutes',
    Region: 'Region',
    City: 'City',
    District: 'District',
    Address: 'Address',
    Exact_Address: 'Exact Address',
    Fulfillment_Center: 'Fulfillment Center',
    Delivery_Center: 'Delivery Center',
    Is_Mega_Hub: 'Is Mega Hub',
    Base_Distance_km: 'Base_Distance_km',
    Distance_km: 'Distance km',
    Customer_ID: 'Customer ID',
    Is_WOW_Member: 'Is WOW Member',
    WOW_Tier: 'WOW Tier',
    WOW_Join_Date: 'WOW Join Date',
    WOW_Tenure_Days: 'WOW Tenure Days',
    Customer_Segment: 'Customer Segment',
    Product_Category: 'Product Category',
    SKU: 'SKU',
    ABC_Category: 'ABC Category',
    Unit_Price: 'Unit Price',
    Quantity: 'Quantity',
    Order_Amount: 'Order Amount',
    Is_Fresh_Food: 'Is Fresh Food',
    Is_Cold_Chain_Required: 'Is Cold Chain Required',
    Target_Temperature: 'Target Temperature',
    Actual_Temperature: 'Actual Temperature',
    Temperature_Violation: 'Temperature Violation',
    Cold_Chain_Quality_Score: 'Cold Chain Quality Score',
    Vehicle_ID: 'Vehicle ID',
    Vehicle_Type: 'Vehicle Type',
    Vehicle_Capacity: 'Vehicle Capacity',
    Driver_ID: 'Driver ID',
    Driver_Grade: 'Driver Grade',
    Load_Factor: 'Load Factor',
    Fuel_Efficiency: 'Fuel Efficiency',
    Routing_Score: 'Routing Score',
    GPS_Tracking: 'GPS Tracking',
    Actual_Logistics_Cost: 'Actual Logistics Cost',
    Customer_Delivery_Charge: 'Customer Delivery Charge',
    Gross_Profit: 'Gross Profit',
    Net_Profit: 'Net Profit',
    CAC: 'CAC',
    Customer_LTV: 'Customer LTV',
    LTV_to_CAC: 'LTV to CAC',
    clv_quartile: 'CLV Quartile',
    clv_quartile_label: 'CLV Quartile Label',
    cust_breach_30d_cnt: 'Cust Breach 30d Cnt',
    cust_breach_60d_cnt: 'Cust Breach 60d Cnt',
    is_high_breach_60d: 'High Breach 60d Flag',
    Return_Flag: 'Is Returned',
    Return_Reason: 'Return Reason',
    Return_Cost: 'Return Cost',
    Is_Resellable: 'Is Resellable',
    Resellability_Reason: 'Resellability Reason',
    Current_Stock: 'Current Stock',
    Reorder_Point: 'Reorder Point',
    Stockout_Flag: 'Stockout Flag',
    Overstock_Flag: 'Overstock Flag',
    Inventory_Turnover: 'Inventory Turnover',
    Inventory_Accuracy: 'Inventory Accuracy',
    Automation_Level: 'Automation Level',
    Picking_Time_Seconds: 'Picking Time Seconds',
    Packing_Time_Seconds: 'Packing Time Seconds',
    Total_Process_Time: 'Total Process Time',
    WMS_Usage: 'WMS Usage',
    OMS_Usage: 'OMS Usage',
    WMS_Advanced_Score: 'WMS Advanced Score',
    Service_Quality_Score: 'Service Quality Score',
    Customer_NPS: 'Customer NPS',
    Processing_Error_Rate: 'Processing Error Rate',
    Weather_Condition: 'Weather Condition',
    Weather_Severity_Score: 'Weather Severity Score',
    Churn_Flag: 'Churn Flag',
    Predicted_Churn_Score: 'Predicted Churn Score',
    Is_Rocket_Delivery: 'Is Rocket Delivery',
    Is_Same_Day_Delivery: 'Is Same Day Delivery',
    Is_Dawn_Delivery: 'Is Dawn Delivery',
    Is_Fresh_Delivery: 'Is Fresh Delivery',
    Is_Premium_Order: 'Is Premium Order',
    Is_Bulk_Order: 'Is Bulk Order',
    Is_Weekend_Order: 'Is Weekend Order',
    Is_Peak_Hour_Order: 'Is Peak Hour Order',
    Is_Free_Shipping: 'Is Free Shipping',
    Is_Weather_Risk: 'Is Weather Risk',
    Is_Long_Distance: 'Is Long Distance',
    Is_High_LTV: 'Is High LTV',
    Is_Churn_Risk: 'Is Churn Risk',
    Is_VIP_Customer: 'Is VIP Customer',
    Is_Loss_Order: 'Is Loss Order',
    Is_AI_Optimized: 'Is AI Optimized',
    Receiving_Date: 'Receiving Date',
    Putaway_Date: 'Putaway Date',
    Lot_ID: 'Lot ID',
    Expiry_Date: 'Expiry Date',
    Bin: 'Bin',
    Slot: 'Slot',
    Unit_Cost: 'Unit Cost',
    Daily_OnHand_Snapshot: 'Daily OnHand Snapshot',
    Safety_Stock: 'Safety Stock',
    Forecast_Demand: 'Forecast Demand',
    ASN_ID: 'Asn Id',
    PO_ID: 'Po Id',
    Replenishment_Type: 'Replenishment Type',
    Picking_Start_TS: 'Picking Start TS',
    Picking_End_TS: 'Picking End TS',
    Packing_Start_TS: 'Packing Start TS',
    Packing_End_TS: 'Packing End TS',
    QC_Start_TS: 'QC Start TS',
    QC_End_TS: 'QC End TS',
    Label_Start_TS: 'Label Start TS',
    Label_End_TS: 'Label End TS',
    Staging_In_TS: 'Staging In TS',
    Staging_Out_TS: 'Staging Out TS',
    Dock_Assign_TS: 'Dock Assign TS',
    Dock_Arrive_TS: 'Dock Arrive TS',
    Dock_Release_TS: 'Dock Release TS',
    Security_Gate_Out_TS: 'Security Gate Out TS',
    qc_min: 'QC Minutes',
    label_min: 'Label Minutes',
    staging_min: 'Staging Minutes',
    dock_wait_min: 'Dock Wait Minutes',
    fc_total_dwell_min: 'FC Total Dwell Minutes',
    residual_fc_internal_min: 'Residual FC Internal Minutes',
    Planned_Ship_Timestamp: 'Planned Ship Timestamp',
    Actual_Ship_Timestamp: 'Actual Ship Timestamp',
    On_Time_Dispatch_Flag: 'On-time Dispatch Flag',
    [NET.ROUTE_TYPE]: 'Route Type',
    [NET.SORT_HUB_NAME]: 'Sortation Hub Name',
    [NET.FC_EXIT]: 'FC Exit TS',
    [NET.HUB_IN]: 'Hub In TS',
    [NET.HUB_OUT]: 'Hub Out TS',
    [NET.CAMP_IN]: 'Camp In TS',
    [NET.LOAD_START]: 'Loadout Start TS',
    [NET.LOAD_END]: 'Loadout End TS',
    [NET.OFD]: 'OFD TS',
    [NET.FC_DWELL]: 'FC Dwell Min',
    [NET.HUB_DWELL]: 'Hub Dwell Min',
    [NET.CAMP_DWELL]: 'Camp Dwell Min',
    // derived / quality
    fc_dispatch_ts: 'FC Dispatch TS',
    camp_depart_ts: 'Camp Depart TS',
    o2s_min: 'O2S Minutes',
    hub_total_dwell_min: 'Hub Total Dwell (min)',
    camp_total_dwell_min: 'Camp Total Dwell (min)',
    camp_s1_wait_min: 'Camp S1 Wait (min)',
    camp_s2_work_min: 'Camp S2 Work (min)',
    camp_s3_wait_min: 'Camp S3 Wait (min)',
    camp_wait_min: 'Camp Wait (S1+S3) (min)',
    camp_work_min: 'Camp Work (S2) (min)',
    post_fc_transit_min: 'Post FC Transit (min)',
    hub_exit_wait_min: 'Hub Exit Wait (min)',
    fc_otd_flag: 'FC OTD Flag',
    ofd_otd_flag: 'OFD OTD Flag',
    sla_breach_flag: 'SLA Breach (Recalc)',
    reason_category: 'Reason Category',
    q_ts_order_error: 'Q TS Order Error',
    q_negative_duration: 'Q Negative Duration',
    q_outlier_flag: 'Q Outlier',
    month: 'month',
    week: 'week',
    hub_dispatch_breach_flag: 'Hub P95 Breach',
    camp_s1_breach_flag: 'Camp S1 Breach',
    camp_s2_breach_flag: 'Camp S2 Breach',
    camp_s3_breach_flag: 'Camp S3 Breach',
    hub_on_time_flag: 'Hub On-time (p95)',
    camp_on_time_flag: 'Camp On-time (p95)',
    camp_dispatch_breach_flag: 'Camp Dispatch Breach (OR)',
    first_touch_breach: 'First Touch Breach',
    q_missing_key: 'Q Missing Key',
    sim_version: 'Sim Version',
    sim_seed: 'Sim Seed',
    dial_snapshot_json: 'Dials Snapshot',
    generated_at: 'Generated At',
    // NEW: Return normalization & flags
    return_reason_norm: 'Return Reason Norm',
    is_quality_issue: 'Quality Issue Flag',
    mis_ship_flag: 'Mis-Ship Flag',
    return_unclassified_flag: 'Unclassified Return Flag'
  };
  const labelUnderscore = key => String(CSV_SPECIAL_LABELS[key] || key).replace(/\s+/g, '_');
  const prettyHeader = key => labelUnderscore(key);

  /* ---------- 3) ì „ì—­ ìƒíƒœ/ìœ í‹¸ ---------- */
  let DATA = [];
  let TABLE_KEYS = null;
  let WORKER = null;
  let FAST_MODE = false;
  const CHUNK_CONFIG = {defaultSize: 3000, maxMemoryRows: 150000, batchUpdateInterval: 3, gcInterval: 8};
  const RENDER_MAX_ROWS = 2000;
  let PROCESSING_STATE = {isRunning: false, shouldStop: false, startTime: null, processedRows: 0, totalRows: 0};
  let _throttleTS = 0;
  const _THROTTLE_MS = 100;
  const raf = fn => window.requestAnimationFrame ? requestAnimationFrame(fn) : setTimeout(fn, 16);
  const qs = id => document.getElementById(id);
  const setText = (id, txt) => {
    const el = qs(id);
    if (el) el.textContent = txt
  };
  const setDisabled = (id, flag) => {
    const el = qs(id);
    if (el) el.disabled = !!flag
  };
  const setDisplay = (id, show) => {
    const el = qs(id);
    if (el) el.style.display = show ? '' : 'none'
  };
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  /* ---------- Return Reason ì •ê·œí™” ìœ í‹¸ ---------- */
  const QUALITY_TOKENS_RE = /(ìƒí’ˆí•˜ì|ì†ìƒ|íŒŒì†|ë¶ˆëŸ‰|ë³€ì§ˆ|ìœ í†µê¸°í•œ|quality|defect|damaged|broken|expired)/i;
  const MISHIP_TOKENS_RE = /(ì˜¤ë°°ì†¡|mis[-\s_]?ship|wrong\s*item|ë°°ì†¡\s*ì˜¤ë¥˜|ë‹¤ë¥¸\s*ìƒí’ˆ|ìˆ˜ëŸ‰\s*ì˜¤ë¥˜|wrong\s*qty|mis[-\s_]?pick)/i;
  const normalizeReturnReason = s => s == null ? null : String(s).trim().replace(/\s+/g, ' ').toLowerCase();

  /* ---------- ê³µí†µ UI ---------- */
  function formatCurrencyKRW(n) {
    if (!isFinite(n)) return '-';
    return 'â‚©' + Math.round(n).toLocaleString('ko-KR');
  }

  function setStatus(text, cls = 'ok') {
    const st = qs('status');
    st.textContent = text;
    st.className = 'pill ' + cls;
  }

  function showProgress(show) {
    setDisplay('progressContainer', show);
  }

  function _updateProgressUI(label, processed, total) {
    const pct = Math.min(100, Math.round(processed / Math.max(1, total) * 100));
    qs('progressFill').style.width = pct + '%';
    qs('progressText').textContent = `${label}... ${processed.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime || Date.now())) / 1000;
    const rps = processed / Math.max(0.1, elapsed);
    qs('progressStats').textContent = `ì†ë„ ${rps.toFixed(1)} r/s`;
    const remain = (total - processed) / Math.max(0.1, rps);
    qs('progressETA').textContent = `ì˜ˆìƒ ì™„ë£Œ: ${remain.toFixed(0)}s`;
  }

  function updateProgressFromState(label = 'Generating') {
    const now = Date.now();
    if (now - _throttleTS < _THROTTLE_MS) return;
    _throttleTS = now;
    raf(() => _updateProgressUI(label, PROCESSING_STATE.processedRows, PROCESSING_STATE.totalRows));
  }

  function updateExportProgress(done, total) {
    const pct = Math.min(100, Math.round(done / Math.max(1, total) * 100));
    qs('progressFill').style.width = pct + '%';
    qs('progressText').textContent = `Exporting CSV... ${done.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    qs('progressStats').textContent = 'ì²­í¬ ì§„í–‰';
    qs('progressETA').textContent = '';
  }

  /* ---------- 4) ìŠ¤íŠ¸ë¦¬ë° ì§‘ê³„ (O(1)) ---------- */
  const AGG = resetAgg();

  function resetAgg() {
    return {
      total: 0,
      rocket: 0,
      sameDayTotal: 0,
      sameDayOnTime: 0,
      dawnTotal: 0,
      dawnOnTime: 0,
      fastShip30: 0,
      shipUnder60: 0,
      fcSlaBreach: 0,
      shipMinutesSum: 0,
      pickPerItemSum: 0,
      packPerItemSum: 0,
      procErrRateSum: 0,
      wowCount: 0,
      wowSales: 0,
      nonWowSales: 0,
      wowOrders: 0,
      nonWowOrders: 0,
      wowChurnRisk: 0,
      wowPlusCount: 0,
      freshCount: 0,
      coldReq: 0,
      tempViol: 0,
      frozenQualitySum: 0,
      frozenCnt: 0,
      megaHub: 0,
      metro: 0,
      distanceSum: 0,
      routingSum: 0,
      aiOpt: 0,
      autoPickScoreSum: 0,
      pickTimeSum: 0,
      wmsAdvSum: 0,
      salesSum: 0,
      netProfitSum: 0,
      ltvSum: 0,
      cacSum: 0,
      uniqueCustomers: new Set(),
      churnRisk: 0,
      aiAccEqual: 0,
      onTime: 0,
      delay: 0,
      loadSum: 0,
      fuelSum: 0,
      routeSum: 0,
      exception: 0,
      returnCnt: 0,
      returnCostSum: 0,
      resellCnt: 0,
      invTurnSum: 0,
      stockoutCnt: 0,
      overstockCnt: 0,
      invAccSum: 0,
      wmsActiveCnt: 0,
      lossOrderCnt: 0,
      jejuWeatherRiskCnt: 0,
      jejuTotal: 0,
      expiryImminentCnt: 0,
      clvQ4Customers: new Set(),
      clvWowSum: 0,
      clvWowN: 0,
      clvNonWowSum: 0,
      clvNonWowN: 0,
      highBreach60Customers: new Set(),
      hubOnTimeCnt: 0,
      hubEligible: 0,
      campOnTimeCnt: 0,
      campEligible: 0,
      campDispatchBreachCnt: 0,
      fcTotalDwellSum: 0,
      cm_tp: 0,
      cm_tn: 0,
      cm_fp: 0,
      cm_fn: 0,
      qualIssueCnt: 0,
      misShipCnt: 0
    };
  }

  /* ---------- 5) ê°€ë“œë ˆì¼ (p95) ---------- */
  const Guardrails = {store: new Map(), alpha: 0.02, maxKeep: 10000};

  function macroRegionBySiDo(region) {
    if (['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ'].includes(region)) return 'ìˆ˜ë„ê¶Œ';
    if (['ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„'].includes(region)) return 'ì˜ë‚¨';
    if (['ëŒ€ì „ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„'].includes(region)) return 'ì¶©ì²­';
    if (['ê´‘ì£¼ê´‘ì—­ì‹œ', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¼ë‚¨ë„'].includes(region)) return 'í˜¸ë‚¨';
    if (['ê°•ì›íŠ¹ë³„ìì¹˜ë„'].includes(region)) return 'ê°•ì›';
    if (['ì œì£¼íŠ¹ë³„ìì¹˜ë„'].includes(region)) return 'ì œì£¼';
    return 'ê¸°íƒ€';
  }

  function daypart(h) {
    return (h >= 19 && h <= 21) ? 'í”¼í¬' : 'ë¹„í”¼í¬';
  }

  function weatherBucket(s) {
    if (s <= 0.3) return 'â‰¤0.3';
    if (s <= 0.6) return '0.3â€“0.6';
    return '>0.6';
  }

  function segmentKey(r) {
    const mode = r.Delivery_Mode || 'NA';
    const route = r[NET.ROUTE_TYPE] || 'NA';
    const macro = macroRegionBySiDo(r.Region || 'NA');
    const dp = daypart(Number(r.Order_Hour || 0));
    const wb = weatherBucket(Number(r.Weather_Severity_Score || 0));
    return POLICY.useWeatherInSegmentation ? `${mode}|${route}|${macro}|${dp}|${wb}` : `${mode}|${route}|${macro}|${dp}`;
  }

  function winsorizeP99(values) {
    if (values.length === 0) return [];
    const s = [...values].sort((a, b) => a - b);
    const i99 = Math.max(0, Math.min(s.length - 1, Math.floor(s.length * 0.99)));
    const p99 = s[i99];
    return s.map(v => Math.min(v, p99));
  }

  function quantileP(a, p) {
    if (a.length === 0) return null;
    const s = [...a].sort((x, y) => x - y);
    const pos = (s.length - 1) * p;
    const lo = Math.floor(pos), hi = Math.ceil(pos);
    if (lo === hi) return s[lo];
    return s[lo] + (s[hi] - s[lo]) * (pos - lo);
  }

  function computeP95From(values) {
    if (values.length < 20) return null;
    const w = winsorizeP99(values);
    return Math.round(quantileP(w, 0.95));
  }

  function ensureSeg(key) {
    if (!Guardrails.store.has(key)) {
      Guardrails.store.set(key, {
        arrs: {hub: [], s1: [], s2: [], s3: []},
        p95: {hub: null, s1: null, s2: null, s3: null},
        n: 0
      });
    }
    return Guardrails.store.get(key);
  }

  function pushReservoir(arr, v, cap) {
    if (v == null || !isFinite(v)) return;
    if (arr.length < cap) {
      arr.push(v);
      return;
    }
    const j = Math.floor(Math.random() * (arr.length + 1));
    if (j < arr.length) arr[j] = v;
  }

  function updateGuardrailsWithRow(row) {
    if (Number(row.SLA_Breach) === 1) return;
    const hub = safePos(row.hub_total_dwell_min);
    const s1 = safePos(row.camp_s1_wait_min);
    const s2 = safePos(row.camp_s2_work_min);
    const s3 = safePos(row.camp_s3_wait_min);
    if (hub == null && s1 == null && s2 == null && s3 == null) return;
    const key = segmentKey(row);
    const seg = ensureSeg(key);
    if (hub != null) pushReservoir(seg.arrs.hub, hub, Guardrails.maxKeep);
    if (s1 != null) pushReservoir(seg.arrs.s1, s1, Guardrails.maxKeep);
    if (s2 != null) pushReservoir(seg.arrs.s2, s2, Guardrails.maxKeep);
    if (s3 != null) pushReservoir(seg.arrs.s3, s3, Guardrails.maxKeep);
    seg.n++;
    if (seg.arrs.hub.length >= 500 || seg.arrs.s1.length >= 500 || seg.arrs.s2.length >= 500 || seg.arrs.s3.length >= 500) {
      const p95_new = {
        hub: computeP95From(seg.arrs.hub),
        s1: computeP95From(seg.arrs.s1),
        s2: computeP95From(seg.arrs.s2),
        s3: computeP95From(seg.arrs.s3)
      };
      for (const k of ['hub', 's1', 's2', 's3']) {
        const prev = seg.p95[k];
        const cur = p95_new[k];
        if (cur == null) continue;
        seg.p95[k] = (prev == null) ? cur : Math.round(prev * (1 - Guardrails.alpha) + cur * Guardrails.alpha);
      }
    }
  }

  function findP95For(row) {
    const k = segmentKey(row);
    const seg = Guardrails.store.get(k);
    if (seg && (seg.p95.hub || seg.p95.s1 || seg.p95.s2 || seg.p95.s3)) return seg.p95;
    const macro = macroRegionBySiDo(row.Region || 'NA');
    let agg = {hub: [], s1: [], s2: [], s3: []};
    Guardrails.store.forEach((v, key) => {
      if (key.includes(`|${macro}|`) || key.endsWith(`|${macro}`)) {
        for (const f of ['hub', 's1', 's2', 's3']) if (v.p95[f] != null) agg[f].push(v.p95[f]);
      }
    });
    const macroP95 = {
      hub: agg.hub.length ? Math.round(agg.hub.reduce((a, b) => a + b, 0) / agg.hub.length) : null,
      s1: agg.s1.length ? Math.round(agg.s1.reduce((a, b) => a + b, 0) / agg.s1.length) : null,
      s2: agg.s2.length ? Math.round(agg.s2.reduce((a, b) => a + b, 0) / agg.s2.length) : null,
      s3: agg.s3.length ? Math.round(agg.s3.reduce((a, b) => a + b, 0) / agg.s3.length) : null
    };
    if (macroP95.hub || macroP95.s1 || macroP95.s2 || macroP95.s3) return macroP95;
    let global = {hub: [], s1: [], s2: [], s3: []};
    Guardrails.store.forEach(v => {
      for (const f of ['hub', 's1', 's2', 's3']) if (v.p95[f] != null) global[f].push(v.p95[f]);
    });
    return {
      hub: global.hub.length ? Math.round(global.hub.reduce((a, b) => a + b, 0) / global.hub.length) : null,
      s1: global.s1.length ? Math.round(global.s1.reduce((a, b) => a + b, 0) / global.s1.length) : null,
      s2: global.s2.length ? Math.round(global.s2.reduce((a, b) => a + b, 0) / global.s2.length) : null,
      s3: global.s3.length ? Math.round(global.s3.reduce((a, b) => a + b, 0) / global.s3.length) : null
    };
  }

  /* ---------- 6) íŒŒìƒ/í’ˆì§ˆ/ë¸Œë¦¬ì¹˜ ê³„ì‚° ---------- */
  function msToMinPos(ms) {
    if (ms == null || !isFinite(ms)) return null;
    const m = Math.round(ms / 60000);
    return (m < 0) ? null : m;
  }

  function safePos(v) {
    if (v == null || !isFinite(v)) return null;
    return v < 0 ? null : v;
  }

  function recalcTimelineDerived(r) {
    const ts = k => r[k] ? new Date(r[k]).getTime() : null;
    const orderTS = ts('Order_Timestamp');
    const fcExit = ts(NET.FC_EXIT) || ts('Actual_Ship_Timestamp');
    const hubIn = ts(NET.HUB_IN), hubOut = ts(NET.HUB_OUT), campIn = ts(NET.CAMP_IN), loadS = ts(NET.LOAD_START),
      loadE = ts(NET.LOAD_END), ofd = ts(NET.OFD);
    r.fc_dispatch_ts = fcExit ? new Date(fcExit).toISOString() : null;
    r.camp_depart_ts = loadE ? new Date(loadE).toISOString() : (ofd ? new Date(ofd).toISOString() : null);
    r.o2s_min = (orderTS != null && fcExit != null) ? msToMinPos(fcExit - orderTS) : null;
    r.hub_total_dwell_min = (hubIn != null && hubOut != null) ? msToMinPos(hubOut - hubIn) : null;
    r.camp_total_dwell_min = (campIn != null && ofd != null) ? msToMinPos(ofd - campIn) : null;
    r.camp_s1_wait_min = (campIn != null && loadS != null) ? msToMinPos(loadS - campIn) : null;
    r.camp_s2_work_min = (loadS != null && loadE != null) ? msToMinPos(loadE - loadS) : null;
    r.camp_s3_wait_min = (loadE != null && ofd != null) ? msToMinPos(ofd - loadE) : null;
    r.camp_wait_min = (safePos(r.camp_s1_wait_min) || 0) + (safePos(r.camp_s3_wait_min) || 0);
    r.camp_work_min = safePos(r.camp_s2_work_min);
    r.post_fc_transit_min = (fcExit != null) ? msToMinPos(((campIn ?? hubIn) ?? null) - fcExit) : null;
    r.hub_exit_wait_min = (hubOut != null && campIn != null) ? msToMinPos(campIn - hubOut) : null;
    const planShip = ts('Planned_Ship_Timestamp');
    r.fc_otd_flag = (planShip != null && fcExit != null) ? (fcExit <= planShip ? 1 : 0) : null;
    const planDel = ts('Planned_Delivery_Timestamp');
    const actDel = ts('Delivery_Timestamp');
    if (planDel != null && actDel != null) {
      r.ofd_otd_flag = (actDel <= (planDel + 10 * 60000)) ? 1 : 0;
    } else {
      r.ofd_otd_flag = null;
    }
    r.sla_breach_flag = (r.SLA_Breach != null) ? Number(r.SLA_Breach) : null;
    r.reason_category = (r.Temperature_Violation ? 'TEMP' : (r.Damage_Flag ? 'DAMAGE' : (r.Mis_Ship_Flag ? 'MISHIP' : (r.Is_Delayed ? 'DELAY' : null))));
    r.q_ts_order_error = ((orderTS && fcExit && fcExit < orderTS) || (hubOut && hubIn && hubOut < hubIn) || (loadS && campIn && loadS < campIn) || (loadE && loadS && loadE < loadS) || (ofd && loadE && ofd < loadE)) ? 1 : 0;
    r.q_negative_duration = ([r.o2s_min, r.hub_total_dwell_min, r.camp_total_dwell_min, r.camp_s1_wait_min, r.camp_s2_work_min, r.camp_s3_wait_min].some(x => x != null && x < 0)) ? 1 : 0;
    const outlier = ((r.o2s_min != null && r.o2s_min > 1440) || (r.hub_total_dwell_min != null && r.hub_total_dwell_min > 720) || (r.camp_total_dwell_min != null && r.camp_total_dwell_min > 360));
    r.q_outlier_flag = outlier ? 1 : 0;
    try {
      const od = r.Order_Timestamp ? new Date(r.Order_Timestamp) : null;
      if (od) {
        r.month = Number(od.getMonth() + 1);
        const onejan = new Date(od.getFullYear(), 0, 1);
        r.week = Math.floor((((od - onejan) / 86400000) + onejan.getDay() + 1) / 7);
      }
    } catch (e) {
    }
    return r;
  }

  function flagBreaches(row) {
    const p95 = findP95For(row);
    row.hub_dispatch_breach_flag = (p95.hub != null && row.hub_total_dwell_min != null && row.hub_total_dwell_min > p95.hub) ? 1 : 0;
    row.camp_s1_breach_flag = (p95.s1 != null && row.camp_s1_wait_min != null && row.camp_s1_wait_min > p95.s1) ? 1 : 0;
    row.camp_s2_breach_flag = (p95.s2 != null && row.camp_s2_work_min != null && row.camp_s2_work_min > p95.s2) ? 1 : 0;
    row.camp_s3_breach_flag = (p95.s3 != null && row.camp_s3_wait_min != null && row.camp_s3_wait_min > p95.s3) ? 1 : 0;
    row.hub_on_time_flag = (p95.hub != null && row.hub_total_dwell_min != null) ? (row.hub_total_dwell_min <= p95.hub ? 1 : 0) : null;
    const campRef = ((p95.s1 ?? 0) + (p95.s2 ?? 0) + (p95.s3 ?? 0)) || null;
    const campNow = (row.camp_s1_wait_min ?? 0) + (row.camp_s2_work_min ?? 0) + (row.camp_s3_wait_min ?? 0);
    row.camp_on_time_flag = (campRef != null && isFinite(campNow)) ? (campNow <= campRef ? 1 : 0) : null;
    row.camp_dispatch_breach_flag = (row.camp_s1_breach_flag || row.camp_s2_breach_flag || row.camp_s3_breach_flag) ? 1 : 0;
    let first = null;
    if (row.hub_dispatch_breach_flag) first = 'HUB'; else if (row.camp_s1_breach_flag) first = 'CAMP_S1'; else if (row.camp_s2_breach_flag) first = 'CAMP_S2'; else if (row.camp_s3_breach_flag) first = 'CAMP_S3';
    row.first_touch_breach = first;
    return row;
  }

  /* ---------- 7) í…Œì´ë¸” ë¹Œë“œ/ê°€ìƒí™” ---------- */
  function buildTableHeader(keys) {
    const thead = qs('tbl').querySelector('thead');
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    keys.forEach(k => {
      const th = document.createElement('th');
      th.textContent = prettyHeader(k);
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderTableRowsVirtual(rows, keys) {
    const tbody = qs('tbl').querySelector('tbody');
    const frag = document.createDocumentFragment();
    for (const r of rows) {
      const tr = document.createElement('tr');
      for (const k of keys) {
        const td = document.createElement('td');
        const v = r[k];
        td.textContent = (v === null || v === undefined) ? '' : v;
        if (k === 'Delivery_Mode') {
          td.className = 'delivery-mode ' + (v === 'ë¡œì¼“ìƒˆë²½' ? 'dawn' : (v === 'ë¡œì¼“í”„ë ˆì‹œ' ? 'fresh' : (String(v).includes('ë¡œì¼“') ? 'rocket' : '')));
        }
        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    const excess = tbody.children.length - RENDER_MAX_ROWS;
    if (excess > 0) {
      for (let i = 0; i < excess; i++) tbody.removeChild(tbody.firstChild);
    }
  }

  /* ---------- 8) ìŠ¤íŠ¸ë¦¬ë° ì§‘ê³„ & íŒ¨ë„ ---------- */
  function ingestRows(rows) {
    if (!rows || !rows.length) return;
    for (const r of rows) {
      recalcTimelineDerived(r);
      updateGuardrailsWithRow(r);
      flagBreaches(r);

      // ë°˜í’ˆ ì •ê·œí™”/ë¶„ë¥˜ í”Œë˜ê·¸
      if (r.Return_Reason != null && String(r.Return_Reason).trim() !== '') r.Return_Flag = 1;
      if (r.Return_Flag === 1 && (r.Return_Reason == null || String(r.Return_Reason).trim() === '')) r.Return_Reason = 'ë¯¸ë¶„ë¥˜';
      r.return_reason_norm = normalizeReturnReason(r.Return_Reason);
      const rrn = r.return_reason_norm;
      const qHit = (r.Return_Flag === 1) && !!rrn && QUALITY_TOKENS_RE.test(rrn);
      const mHit = (r.Return_Flag === 1) && !!rrn && MISHIP_TOKENS_RE.test(rrn);
      r.is_quality_issue = qHit ? 1 : 0;
      r.mis_ship_flag = mHit ? 1 : 0;
      r.return_unclassified_flag = (r.Return_Flag === 1) && !(qHit || mHit) ? 1 : 0;

      if (r.Temperature_Violation === 1) r.reason_category = 'TEMP';
      else if (r.is_quality_issue === 1) r.reason_category = 'QUALITY';
      else if (r.mis_ship_flag === 1) r.reason_category = 'MISHIP';
      else if (r.Is_Delayed === 1) r.reason_category = 'DELAY';
    }

    if (!TABLE_KEYS) {
      const baseKeys = Object.keys(rows[0]);
      const extraKeys = ['fc_dispatch_ts', 'camp_depart_ts', 'o2s_min', 'hub_total_dwell_min', 'camp_total_dwell_min', 'camp_s1_wait_min', 'camp_s2_work_min', 'camp_s3_wait_min', 'camp_wait_min', 'camp_work_min', 'post_fc_transit_min', 'hub_exit_wait_min', 'fc_otd_flag', 'ofd_otd_flag', 'sla_breach_flag', 'hub_on_time_flag', 'camp_on_time_flag', 'camp_dispatch_breach_flag', 'hub_dispatch_breach_flag', 'camp_s1_breach_flag', 'camp_s2_breach_flag', 'camp_s3_breach_flag', 'first_touch_breach', 'reason_category', 'q_ts_order_error', 'q_negative_duration', 'q_outlier_flag', 'q_missing_key', 'sim_version', 'sim_seed', 'dial_snapshot_json', 'generated_at'];
      const set = new Set(baseKeys.concat(extraKeys));
      TABLE_KEYS = [...set];
      buildTableHeader(TABLE_KEYS);
    }

    for (const r of rows) {
      DATA.push(r);
      if (DATA.length > CHUNK_CONFIG.maxMemoryRows) {
        DATA.splice(0, DATA.length - CHUNK_CONFIG.maxMemoryRows);
      }
    }

    for (const r of rows) {
      AGG.total++;
      if (r.Is_Rocket_Delivery === 1) AGG.rocket++;
      if (r.Delivery_Mode === 'ë¡œì¼“ë‹¹ì¼') {
        AGG.sameDayTotal++;
        if (r.SLA_Breach === 0) AGG.sameDayOnTime++;
      }
      if (r.Delivery_Mode === 'ë¡œì¼“ìƒˆë²½') {
        AGG.dawnTotal++;
        if (r.SLA_Breach === 0) AGG.dawnOnTime++;
      }
      if (r.o2s_min != null && r.o2s_min <= 30) AGG.fastShip30++;
      if (r.o2s_min != null && r.o2s_min <= 60) AGG.shipUnder60++;
      if (Number(r.sla_breach_flag) === 1) AGG.fcSlaBreach++;
      AGG.shipMinutesSum += (r.o2s_min || 0);
      AGG.pickPerItemSum += (r.Picking_Time_Seconds / Math.max(1, r.Quantity));
      AGG.packPerItemSum += (r.Packing_Time_Seconds / Math.max(1, r.Quantity));
      AGG.procErrRateSum += (r.Processing_Error_Rate || 0);

      if (r.Is_WOW_Member === 1) {
        AGG.wowCount++;
        AGG.wowSales += (r.Order_Amount || 0);
        AGG.wowOrders++;
        if (r.Is_Churn_Risk === 1) AGG.wowChurnRisk++;
        if (r.WOW_Tier === 'WOW_PLUS') AGG.wowPlusCount++;
      } else {
        AGG.nonWowSales += (r.Order_Amount || 0);
        AGG.nonWowOrders++;
      }

      if (r.Is_Fresh_Food === 1) AGG.freshCount++;
      if (r.Is_Cold_Chain_Required === 1) {
        AGG.coldReq++;
        if (r.Temperature_Violation === 1) AGG.tempViol++;
      }
      if (r.Product_Category === 'ëƒ‰ë™ì‹í’ˆ' && isFinite(r.Cold_Chain_Quality_Score)) {
        AGG.frozenQualitySum += r.Cold_Chain_Quality_Score;
        AGG.frozenCnt++;
      }

      if (r.Is_Mega_Hub === 1) AGG.megaHub++;
      if (['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ'].includes(r.Region)) AGG.metro++;
      AGG.distanceSum += (r.Distance_km || 0);
      AGG.routingSum += (r.Routing_Score || 0);

      if (r.Automation_Level === 'AI_OPTIMIZED') AGG.aiOpt++;
      AGG.autoPickScoreSum += (r.Automation_Level === 'AI_OPTIMIZED' ? 90 : r.Automation_Level === 'AUTO' ? 70 : r.Automation_Level === 'SEMI_AUTO' ? 40 : 10);
      AGG.pickTimeSum += (r.Picking_Time_Seconds || 0);
      AGG.wmsAdvSum += (r.WMS_Advanced_Score || 0);

      AGG.salesSum += (r.Order_Amount || 0);
      AGG.netProfitSum += (r.Net_Profit || 0);

      AGG.ltvSum += (r.Customer_LTV || 0);
      AGG.cacSum += (r.CAC || 0);
      AGG.uniqueCustomers.add(r.Customer_ID);
      if (r.Is_Churn_Risk === 1) AGG.churnRisk++;
      if (r.Predicted_Churn_Score != null) {
        const pred = r.Predicted_Churn_Score >= 0.6 ? 1 : 0;
        const act = r.Churn_Flag === 1 ? 1 : 0;
        if (pred === 1 && act === 1) AGG.cm_tp++; else if (pred === 0 && act === 0) AGG.cm_tn++; else if (pred === 1 && act === 0) AGG.cm_fp++; else if (pred === 0 && act === 1) AGG.cm_fn++;
        if ((pred === 1) === (act === 1)) AGG.aiAccEqual++;
      }

      if (r.SLA_Breach === 0) AGG.onTime++; else AGG.delay++;
      AGG.loadSum += (r.Load_Factor || 0);
      AGG.fuelSum += (r.Fuel_Efficiency || 0);
      AGG.routeSum += (r.Routing_Score || 0);
      if (r.Temperature_Violation === 1 || Number(r.sla_breach_flag) === 1 || r.Return_Flag === 1) AGG.exception++;

      if (r.Return_Flag === 1) {
        AGG.returnCnt++;
        AGG.returnCostSum += (r.Return_Cost || 0);
        if (r.Is_Resellable === 1) AGG.resellCnt++;
      }

      if (r.is_quality_issue === 1) AGG.qualIssueCnt++;
      if (r.mis_ship_flag === 1) AGG.misShipCnt++;

      AGG.invTurnSum += (r.Inventory_Turnover || 0);
      if (r.Stockout_Flag === 1) AGG.stockoutCnt++;
      if (r.Overstock_Flag === 1) AGG.overstockCnt++;
      AGG.invAccSum += (r.Inventory_Accuracy || 0);
      if (r.WMS_Usage === 'Active') AGG.wmsActiveCnt++;

      if (r.Is_Loss_Order === 1) AGG.lossOrderCnt++;
      if (r.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„') {
        AGG.jejuTotal++;
        if (r.Is_Weather_Risk === 1) AGG.jejuWeatherRiskCnt++;
      }
      if (r.Expiry_Date) {
        const d = (new Date(r.Expiry_Date)) - (new Date(r.Order_Date));
        if (d <= 86400000 && d >= -31536000000) AGG.expiryImminentCnt++;
      }

      if (r.clv_quartile === 4) AGG.clvQ4Customers.add(r.Customer_ID);
      if (r.Is_WOW_Member === 1) {
        AGG.clvWowSum += r.Customer_LTV || 0;
        AGG.clvWowN++;
      } else {
        AGG.clvNonWowSum += r.Customer_LTV || 0;
        AGG.clvNonWowN++;
      }
      if (r.is_high_breach_60d === 1) AGG.highBreach60Customers.add(r.Customer_ID);
      if (r.hub_on_time_flag != null) {
        AGG.hubEligible++;
        if (r.hub_on_time_flag === 1) AGG.hubOnTimeCnt++;
      }
      if (r.camp_on_time_flag != null) {
        AGG.campEligible++;
        if (r.camp_on_time_flag === 1) AGG.campOnTimeCnt++;
      }
      if (r.camp_dispatch_breach_flag === 1) AGG.campDispatchBreachCnt++;
      if (Number.isFinite(r.fc_total_dwell_min)) AGG.fcTotalDwellSum += r.fc_total_dwell_min;
    }

    renderTableRowsVirtual(rows, TABLE_KEYS);
    updateKPIsFromAgg();
    updateValidationAndRiskFromAgg();

    PROCESSING_STATE.processedRows += rows.length;
    updateProgressFromState('Generating');
  }

  function updateKPIsFromAgg() {
    const total = Math.max(1, AGG.total);
    const fmtPct = v => isFinite(v) ? (Number(v).toFixed(1) + '%') : '-';

    const rocketShare = AGG.rocket / total * 100;
    const sameDaySuccess = (AGG.sameDayTotal ? AGG.sameDayOnTime / AGG.sameDayTotal * 100 : 0);
    const dawnOnTime = (AGG.dawnTotal ? AGG.dawnOnTime / AGG.dawnTotal * 100 : 0);
    const fastShip = AGG.fastShip30 / total * 100;

    const fcOnTime = 100 - (AGG.fcSlaBreach / total * 100);
    const avgShipHr = (AGG.shipMinutesSum / total / 60);
    const pickSecPerItem = (AGG.pickPerItemSum / total);
    const packSecPerItem = (AGG.packPerItemSum / total);
    const effFulfill = clamp(100 - ((AGG.procErrRateSum / total) * 100 * 2), 0, 100);
    const shipUnder60 = (AGG.shipUnder60 / total * 100);

    const wowShare = AGG.wowCount / total * 100;
    const wowPlusShare = (AGG.wowCount ? (AGG.wowPlusCount / AGG.wowCount * 100) : 0);
    const wowAov = (AGG.wowOrders ? AGG.wowSales / AGG.wowOrders : 0);
    const nonWowAov = (AGG.nonWowOrders ? AGG.nonWowSales / AGG.nonWowOrders : 0);
    const wowAovGap = (wowAov - nonWowAov);

    const freshShare = AGG.freshCount / total * 100;
    const coldChainRate = (AGG.coldReq ? (1 - AGG.tempViol / AGG.coldReq) * 100 : 100);
    const tempViolRate = (AGG.coldReq ? (AGG.tempViol / AGG.coldReq * 100) : 0);
    const frozenQuality = (AGG.frozenCnt ? AGG.frozenQualitySum / AGG.frozenCnt : 0);

    const megaHubShare = AGG.megaHub / total * 100;
    const metroCoverage = AGG.metro / total * 100;
    const avgDist = AGG.distanceSum / total;
    const networkEff = AGG.routingSum / total;

    const aiOptimized = AGG.aiOpt / total * 100;
    const autoPickRate = AGG.autoPickScoreSum / total;
    const avgPickTime = AGG.pickTimeSum / total;
    const wmsAdvanced = AGG.wmsAdvSum / total;

    const totalSales = AGG.salesSum;
    const netMargin = (AGG.salesSum ? AGG.netProfitSum / AGG.salesSum * 100 : 0);
    const aov = (AGG.salesSum / total);
    const uniqueCust = Math.max(1, AGG.uniqueCustomers.size);
    const arppu = (AGG.salesSum / uniqueCust);

    const ltvAvg = (AGG.ltvSum / total);
    const cacAvg = (AGG.cacSum / total);
    const ltvCac = (cacAvg ? (ltvAvg / cacAvg).toFixed(2) : '0.00');

    const churnRate = AGG.churnRisk / total * 100;
    const aiAcc = AGG.aiAccEqual / total * 100;

    const onTime = AGG.onTime / total * 100;
    const sla = AGG.fcSlaBreach / total * 100;
    const load = AGG.loadSum / total;
    const fuel = AGG.fuelSum / total;
    const route = AGG.routeSum / total;
    const exception = AGG.exception / total * 100;

    const retRate = AGG.returnCnt / total * 100;
    const retCostRate = (AGG.salesSum ? AGG.returnCostSum / AGG.salesSum * 100 : 0);
    const resell = (AGG.returnCnt ? AGG.resellCnt / AGG.returnCnt * 100 : 0);

    const invTurn = AGG.invTurnSum / total;
    const stockout = AGG.stockoutCnt / total * 100;
    const overstock = AGG.overstockCnt / total * 100;
    const invAcc = AGG.invAccSum / total;
    const shrink = (100 - invAcc);
    const wmsUse = AGG.wmsActiveCnt / total * 100;

    const clvTopQ4Share = (AGG.clvQ4Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const clvWowAvg = (AGG.clvWowN ? AGG.clvWowSum / AGG.clvWowN : 0);
    const clvNonWowAvg = (AGG.clvNonWowN ? AGG.clvNonWowSum / AGG.clvNonWowN : 0);
    const clvWowGap = clvWowAvg - clvNonWowAvg;
    const highBreach60Share = (AGG.highBreach60Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const hubOnTimeP95 = (AGG.hubEligible ? AGG.hubOnTimeCnt / AGG.hubEligible * 100 : 0);
    const campOnTimeP95 = (AGG.campEligible ? AGG.campOnTimeCnt / AGG.campEligible * 100 : 0);
    const fcTotalDwellAvg = (AGG.total ? AGG.fcTotalDwellSum / AGG.total : 0);

    setText('k_rocketShare', fmtPct(rocketShare));
    setText('k_rocketSameDayRate', fmtPct(sameDaySuccess));
    setText('k_rocketDawnRate', fmtPct(dawnOnTime));
    setText('k_fastShipRate', fmtPct(fastShip));
    setText('k_hubOnTimeP95', fmtPct(hubOnTimeP95));
    setText('k_campOnTimeP95', fmtPct(campOnTimeP95));
    setText('k_campDispatchBreach', (AGG.campDispatchBreachCnt || 0).toLocaleString('ko-KR'));

    setText('k_fcOnTimeShip', fmtPct(fcOnTime));
    setText('k_fcAvgShipHour', (avgShipHr || 0).toFixed(2));
    setText('k_fcPickSecPerItem', (pickSecPerItem || 0).toFixed(1));
    setText('k_fcPackSecPerItem', (packSecPerItem || 0).toFixed(1));
    setText('k_fcEfficiency', (effFulfill || 0).toFixed(1));
    setText('k_fcShipUnder60', fmtPct(shipUnder60));
    setText('k_fcTotalDwellMinAvg', (fcTotalDwellAvg || 0).toFixed(1));

    setText('k_wowShare', fmtPct(wowShare));
    setText('k_wowPlusShare', (wowPlusShare || 0).toFixed(1));
    setText('k_wowAovGap', formatCurrencyKRW(wowAovGap));
    setText('k_wowChurnRisk', (AGG.wowChurnRisk || 0).toLocaleString('ko-KR'));

    setText('k_clvTopQ4Share', fmtPct(clvTopQ4Share));
    setText('k_clvWowGap', formatCurrencyKRW(clvWowGap));
    setText('k_highBreach60Share', fmtPct(highBreach60Share));

    setText('k_freshShare', fmtPct(freshShare));
    setText('k_coldChainRate', fmtPct(coldChainRate));
    setText('k_tempViolation', fmtPct(tempViolRate));
    setText('k_frozenQuality', (frozenQuality || 0).toFixed(0));

    setText('k_megaHubShare', fmtPct(megaHubShare));
    setText('k_seoulCoverage', fmtPct(metroCoverage));
    setText('k_avgDistance', (avgDist || 0).toFixed(1));
    setText('k_networkEff', (networkEff || 0).toFixed(0));

    setText('k_aiOptimized', fmtPct(aiOptimized));
    setText('k_autoPickRate', (autoPickRate || 0).toFixed(1));
    setText('k_avgPickTime', (avgPickTime || 0).toFixed(1));
    setText('k_wmsAdvanced', (wmsAdvanced || 0).toFixed(0));

    setText('k_totalSales', formatCurrencyKRW(totalSales));
    setText('k_netMargin', (netMargin || 0).toFixed(2));
    setText('k_aov', formatCurrencyKRW(aov));
    setText('k_arppu', formatCurrencyKRW(arppu));

    setText('k_ltvCac', ltvCac);
    setText('k_retention', (100 - churnRate).toFixed(1));
    setText('k_churn', churnRate.toFixed(1));
    setText('k_ai', aiAcc.toFixed(1));

    setText('k_onTime', fmtPct(onTime));
    setText('k_sla', fmtPct(sla));
    setText('k_load', (load || 0).toFixed(1));
    setText('k_fuel', (fuel || 0).toFixed(2));
    setText('k_route', (route || 0).toFixed(0));
    setText('k_exception', fmtPct(exception));

    setText('k_returnRate', fmtPct(retRate));
    setText('k_returnCost', (retCostRate || 0).toFixed(2));
    setText('k_resell', fmtPct(resell));

    setText('k_invTurn', (invTurn || 0).toFixed(1));
    setText('k_stockout', fmtPct(stockout));
    setText('k_overstock', fmtPct(overstock));
    setText('k_invAcc', (invAcc || 0).toFixed(1));
    setText('k_shrink', (shrink || 0).toFixed(1));
    setText('k_wms', fmtPct(wmsUse));
  }

  /* ---------- 9) ì •í•©ì„±/ìœ„í—˜/ì„±ëŠ¥ ì•Œë¦¼ ---------- */
  function updateValidationAndRiskFromAgg() {
    const list = qs('validateList');
    list.innerHTML = '';
    const risk = qs('riskList');
    risk.innerHTML = '';
    const perf = qs('perfList');
    perf.innerHTML = '';
    if (AGG.total === 0) {
      qs('validateSummary').textContent = '-';
      return;
    }

    const total = AGG.total;
    const tempViolRate = (AGG.coldReq ? AGG.tempViol / AGG.coldReq : 0);
    const lossRate = (AGG.lossOrderCnt / total);
    const jejuRate = (AGG.jejuTotal ? AGG.jejuWeatherRiskCnt / AGG.jejuTotal : 0);
    const overStockRate = (AGG.overstockCnt / total);
    const expirySoonRate = (AGG.expiryImminentCnt / total);

    const DIALS_CUR = {
      tempHi: parseFloat(qs('dial_temp_hi').value),
      lossHi: parseFloat(qs('dial_loss_hi').value),
      jejuHi: parseFloat(qs('dial_jeju_hi').value),
      overHi: parseFloat(qs('dial_over_hi').value),
      expHi: parseFloat(qs('dial_exp_hi').value),
    };
    const pill = (text, type) => {
      const d = document.createElement('div');
      d.className = 'alert ' + type;
      d.textContent = text;
      return d;
    };

    const okText = `ì½œë“œì²´ì¸ ìœ„ë°˜ìœ¨ ${(tempViolRate * 100).toFixed(2)}% / ì†ì‹¤ì£¼ë¬¸ìœ¨ ${(lossRate * 100).toFixed(2)}%`;
    qs('validateSummary').textContent = okText;

    if (tempViolRate > DIALS_CUR.tempHi) risk.appendChild(pill(`ì½œë“œì²´ì¸ ìœ„ë°˜ìœ¨ ìƒí•œ ì´ˆê³¼ (${(tempViolRate * 100).toFixed(2)}% > ${(DIALS_CUR.tempHi * 100).toFixed(1)}%)`, 'bad'));
    if (lossRate > DIALS_CUR.lossHi) risk.appendChild(pill(`ì ìì£¼ë¬¸ìœ¨ ìƒí•œ ì´ˆê³¼ (${(lossRate * 100).toFixed(2)}%)`, 'bad'));
    if (jejuRate > DIALS_CUR.jejuHi) risk.appendChild(pill(`ì œì£¼ ì•…ì²œí›„ ìœ„í—˜ ìƒí•œ ì´ˆê³¼ (${(jejuRate * 100).toFixed(2)}%)`, 'warn'));
    if (overStockRate > DIALS_CUR.overHi) risk.appendChild(pill(`ê³¼ì¬ê³  ë¹„ì¤‘ ìƒí•œ ì´ˆê³¼ (${(overStockRate * 100).toFixed(1)}%)`, 'warn'));
    if (expirySoonRate > DIALS_CUR.expHi) risk.appendChild(pill(`ìœ í†µê¸°í•œ ì„ë°• ë¹„ì¤‘ ìƒí•œ ì´ˆê³¼ (${(expirySoonRate * 100).toFixed(2)}%)`, 'warn'));

    // ìƒ˜í”Œ ê¸°ë°˜ í’ˆì§ˆ ê²½ê³ 
    const sample = DATA.slice(-Math.min(DATA.length, 1200));
    let distAnom = 0, tsOrderErr = 0, negDur = 0, outlier = 0, otdOk = 0, otdTot = 0, campBreach = 0;
    for (const r of sample) {
      if (r.Base_Distance_km && r.Distance_km) {
        const minOk = r.Base_Distance_km * 0.4 - 5;
        const maxOk = r.Base_Distance_km * 2.5 + 20;
        if (r.Distance_km < minOk || r.Distance_km > maxOk) distAnom++;
      }
      if (r.q_ts_order_error === 1) tsOrderErr++;
      if (r.q_negative_duration === 1) negDur++;
      if (r.q_outlier_flag === 1) outlier++;
      if (r.ofd_otd_flag != null) {
        otdTot++;
        if (r.ofd_otd_flag === 1) otdOk++;
      }
      if (r.camp_dispatch_breach_flag === 1) campBreach++;
    }
    if (distAnom > 0) list.appendChild(pill(`ê±°ë¦¬-ì„¼í„° ì¼ê´€ì„± ê²½ê³ : ìƒ˜í”Œ ${sample.length}ê±´ ì¤‘ ${distAnom}ê±´ ì´ìƒì¹˜`, 'warn'));
    if (tsOrderErr > 0) list.appendChild(pill(`íƒ€ì„ìŠ¤íƒ¬í”„ ìˆœì„œ ì˜¤ë¥˜ ${tsOrderErr}ê±´`, 'bad'));
    if (negDur > 0) list.appendChild(pill(`ìŒìˆ˜ ì§€ì†ì‹œê°„ ${negDur}ê±´`, 'bad'));
    if (outlier > 0) list.appendChild(pill(`ì´ìƒì¹˜ í”Œë˜ê·¸ ${outlier}ê±´`, 'warn'));
    if (otdTot > 0) {
      const otdRate = (otdOk / otdTot * 100).toFixed(1);
      list.appendChild(pill(`OFD OTD ì •ì‹œìœ¨(Â±10ë¶„) ${otdRate}% (í‘œë³¸ ${otdTot})`, 'good'));
    }
    if (campBreach > 0) risk.appendChild(pill(`ìº í”„ ë””ìŠ¤íŒ¨ì¹˜ ë¸Œë¦¬ì¹˜ ìµœê·¼ ëˆ„ì  ${campBreach}ê±´`, 'warn'));

    const highBreachShare = (AGG.highBreach60Customers.size / Math.max(1, AGG.uniqueCustomers.size));
    if (highBreachShare > 0.12) risk.appendChild(pill(`ìµœê·¼60ì¼ ê³ ìœ„ë°˜ ê³ ê° ë¹„ì¤‘ ${(highBreachShare * 100).toFixed(1)}% (ì„ê³„ 12%)`, 'warn'));

    // í’ˆì§ˆ/ì˜¤ë°°ì†¡ ìš”ì•½
    if (AGG.total > 0) {
      const q_ret = AGG.returnCnt ? (AGG.qualIssueCnt / AGG.returnCnt * 100) : 0;
      const q_all = AGG.qualIssueCnt / AGG.total * 100;
      const m_ret = AGG.returnCnt ? (AGG.misShipCnt / AGG.returnCnt * 100) : 0;
      const m_all = AGG.misShipCnt / AGG.total * 100;
      list.appendChild(pill(`í’ˆì§ˆì´ìŠˆ ë¹„ì¤‘ â€” ë°˜í’ˆê¸°ì¤€ ${q_ret.toFixed(2)}% Â· ì „ì²´ê¸°ì¤€ ${q_all.toFixed(2)}%`, 'good'));
      list.appendChild(pill(`ì˜¤ë°°ì†¡ ë¹„ì¤‘ â€” ë°˜í’ˆê¸°ì¤€ ${m_ret.toFixed(2)}% Â· ì „ì²´ê¸°ì¤€ ${m_all.toFixed(2)}%`, 'warn'));
    }

    // ì„±ëŠ¥
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime || Date.now())) / 1000;
    const rps = PROCESSING_STATE.processedRows / Math.max(0.1, elapsed);
    const memRows = DATA.length;
    const estBytes = memRows * 800;
    perf.appendChild(pill(`ì²˜ë¦¬ì†ë„ ~ ${rps.toFixed(1)} r/s Â· í‘œì‹œí–‰ ${Math.min(memRows, 2000)} / ë³´ìœ  ${memRows}`, 'good'));
    perf.appendChild(pill(`ë©”ëª¨ë¦¬ ë³´í˜¸: ~${(estBytes / 1e6).toFixed(1)} MB (í–‰ë‹¹ ì¶”ì • 0.8KB)`, 'good'));
  }

  /* ---------- 10) CSV ë‚´ë³´ë‚´ê¸° ---------- */
  function escapeCSV(v) {
    if (v == null) return '';
    const s = String(v).replace(/"/g, '""');
    return `"${s}"`;
  }

  function buildCSV(keys, rows) {
    const header = keys.map(k => escapeCSV(labelUnderscore(k))).join(',');
    let out = header + '\n';
    const BATCH = 5000;
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const line = keys.map(k => escapeCSV(r[k])).join(',');
      out += line + (i < rows.length - 1 ? '\n' : '');
      if ((i + 1) % BATCH === 0) updateExportProgress(i + 1, rows.length);
    }
    updateExportProgress(rows.length, rows.length);
    return out;
  }

  async function downloadCSV() {
    try {
      setStatus('EXPORTING CSV', 'running');
      showProgress(true);
      const csv = buildCSV(TABLE_KEYS || Object.keys(DATA[0] || {}), DATA);
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `coupang_sim_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      setStatus('CSV READY', 'ok');
      showProgress(false);
    } catch (e) {
      console.error(e);
      setStatus('CSV ERROR', 'ng');
    }
  }

  async function downloadCSVGzip() {
    try {
      if (!('CompressionStream' in window)) {
        alert('ë¸Œë¼ìš°ì €ê°€ CompressionStream(gzip)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¼ë°˜ CSVë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
        return;
      }
      setStatus('GZIP EXPORT', 'running');
      showProgress(true);
      const csv = buildCSV(TABLE_KEYS || Object.keys(DATA[0] || {}), DATA);
      const enc = new TextEncoder();
      const cs = new CompressionStream('gzip');
      const writer = cs.writable.getWriter();
      writer.write(enc.encode(csv));
      writer.close();
      const gzBlob = await new Response(cs.readable).blob();
      const url = URL.createObjectURL(gzBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `coupang_sim_${Date.now()}.csv.gz`;
      a.click();
      URL.revokeObjectURL(url);
      setStatus('CSV.GZ READY', 'ok');
      showProgress(false);
    } catch (e) {
      console.error(e);
      setStatus('GZIP ERROR', 'ng');
    }
  }

  /* ---------- 11) ë°ì´í„° ìƒì„± ì›¹ì›Œì»¤ ---------- */
  function createWorker() {
    const code = `
    let CFG=null; let RNG=null; let STOP=false; let SIM_SEED=0;
    const NET_PREFIX='__net_';
    const NET={
      ROUTE_TYPE: NET_PREFIX+'Route_Type',
      SORT_HUB_NAME: NET_PREFIX+'Sortation_Hub_Name',
      FC_EXIT: NET_PREFIX+'FC_Exit_TS',
      HUB_IN: NET_PREFIX+'Hub_In_TS',
      HUB_OUT: NET_PREFIX+'Hub_Out_TS',
      CAMP_IN: NET_PREFIX+'Camp_In_TS',
      LOAD_START: NET_PREFIX+'Loadout_Start_TS',
      LOAD_END: NET_PREFIX+'Loadout_End_TS',
      OFD: NET_PREFIX+'OFD_TS',
      FC_DWELL: NET_PREFIX+'FC_Dwell_Min',
      HUB_DWELL: NET_PREFIX+'Hub_Dwell_Min',
      CAMP_DWELL: NET_PREFIX+'Camp_Dwell_Min',
    };

    onmessage=(e)=>{ const d=e.data||{}; if(d.cmd==='start') run(d.cfg); else if(d.cmd==='stop') STOP=true; };

    function srand(seed){ SIM_SEED=seed>>>0; RNG=seeded(seed); }
    function seeded(seed){ let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return (s>>>0)/4294967296; }; }
    const R=()=>RNG();
    const pick=a=>a[Math.floor(R()*a.length)];
    function nrand(mean,sd){ let u=0,v=0; while(u===0)u=R(); while(v===0)v=R(); const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); return mean+z*sd; }
    const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
    const ts=ms=>new Date(ms).toISOString();
    const addMin=(t,m)=>t+Math.floor(m*60000+(R()*59000-29500));
    const randInt=(a,b)=>Math.floor(R()*(b-a+1))+a;

    const MAP=[
      {Region:'ì„œìš¸íŠ¹ë³„ì‹œ',City:'ì„œìš¸íŠ¹ë³„ì‹œ',District:'ê°•ë‚¨êµ¬',FC:'FC-SEO-1',DC:'DC-SEO-NE',Base:12},
      {Region:'ì„œìš¸íŠ¹ë³„ì‹œ',City:'ì„œìš¸íŠ¹ë³„ì‹œ',District:'ë§ˆí¬êµ¬',FC:'FC-SEO-2',DC:'DC-SEO-NW',Base:10},
      {Region:'ê²½ê¸°ë„',City:'ì„±ë‚¨ì‹œ',District:'ë¶„ë‹¹êµ¬',FC:'FC-GYO-1',DC:'DC-GYO-SE',Base:22},
      {Region:'ê²½ê¸°ë„',City:'ê³ ì–‘ì‹œ',District:'ë•ì–‘êµ¬',FC:'FC-GYO-2',DC:'DC-GYO-NW',Base:28},
      {Region:'ì¸ì²œê´‘ì—­ì‹œ',City:'ì¸ì²œê´‘ì—­ì‹œ',District:'ì—°ìˆ˜êµ¬',FC:'FC-INC-1',DC:'DC-INC-S',Base:35},
      {Region:'ë¶€ì‚°ê´‘ì—­ì‹œ',City:'ë¶€ì‚°ê´‘ì—­ì‹œ',District:'í•´ìš´ëŒ€êµ¬',FC:'FC-BUS-1',DC:'DC-BUS-E',Base:40},
      {Region:'ëŒ€ì „ê´‘ì—­ì‹œ',City:'ëŒ€ì „ê´‘ì—­ì‹œ',District:'ìœ ì„±êµ¬',FC:'FC-DJN-1',DC:'DC-DJN-W',Base:60},
      {Region:'ì œì£¼íŠ¹ë³„ìì¹˜ë„',City:'ì œì£¼ì‹œ',District:'ì• ì›”ì',FC:'FC-JJU-1',DC:'DC-JJU-N',Base:290}
    ];
    const ROAD=['í…Œí—¤ë€ë¡œ','ì„œì´ˆëŒ€ë¡œ','ê°•ë³€ë¶ë¡œ','ì†¡íŒŒëŒ€ë¡œ','ë¶„ë‹¹ë‚´ê³¡ë¡œ','ê´‘ì•ˆë¡œ','ìœ ì„±ëŒ€ë¡œ','ì¤‘ì•™ë¡œ'];
    const BLDG=['ì„¼í„°','íƒ€ì›Œ','ìŠ¤í€˜ì–´','ìºìŠ¬','íŠ¸ìœˆ','í•˜ì´ì¸ '];
    const addrFor=(m)=>\`\${pick(ROAD)} \${randInt(1,200)} \${pick(BLDG)} \${randInt(1,30)}ë™ \${randInt(1,20)}í˜¸\`;
    const makeDistance=(base)=>{ const off=nrand(0,base*0.25); const sign=(R()<0.5?-1:1); const d=Math.max(3, base+sign*off); return Math.round(d*10)/10; };

    function computeDeliveryCharge(isWOW,mode,dist,aov){
      const bracket=dist>60?5:dist>40?4:dist>25?3:dist>12?2:1;
      if(isWOW){ if(mode==='ì¼ë°˜íƒë°°' && dist>40) return 2000; return 0; }
      if(aov>=50000) return 0;
      const modeK=(mode==='ì¼ë°˜íƒë°°'?1.0:mode==='ë¡œì¼“ë‹¹ì¼'?1.1:mode==='ë¡œì¼“ìƒˆë²½'?1.2:1.0);
      const base=[0,1500,2200,3000,3800,4500][bracket];
      return Math.round(base*modeK/100)*100;
    }

    function buildUsers(n,wowRate){
      const users=[]; for(let i=0;i<n;i++){
        const m=pick(MAP); const isWOW=(R()*100<wowRate)?1:0; const tier=isWOW?(R()<0.2?'WOW_PLUS':'WOW_BASIC'):'NONE';
        const baseCLV=Math.max(20000,Math.round(nrand(180000,60000)));
        users.push({ Customer_ID:'C'+String(i+1).padStart(6,'0'), Region:m.Region, City:m.City, District:m.District, Map:m,
          WOW:isWOW, WOW_Tier:tier, CLV_Base:baseCLV, WOW_Join: Date.now()-Math.floor(R()*360*86400000) });
      }
      return users;
    }
    function clvQuartileLabel(ltv){ if(ltv<105000) return {q:1,label:'Q1-Low'}; if(ltv<170000) return {q:2,label:'Q2-Mid'}; if(ltv<240000) return {q:3,label:'Q3-High'}; return {q:4,label:'Q4-Top'}; }

    async function run(cfg){
      CFG=cfg; STOP=false; srand(CFG.seed||12345);
      const USERS=buildUsers(CFG.userCount,CFG.wowRate);
      const start=Date.UTC(CFG.startYear,0,1), end=Date.UTC(CFG.endYear,11,31,23,59,59);
      const span=Math.max(1,end-start);
      const totalRows=CFG.totalRows;
      const CHUNK=Math.max(500, CFG.chunkSize||3000);
      const breachTs=new Map();

      let batch=[]; let emitted=0;
      for(let i=0;i<totalRows;i++){
        if(STOP){ postMessage({type:'stopped'}); return; }
        const u=pick(USERS);
        const base=u.Map;
        const orderTS=start+Math.floor(R()*span);
        const orderDate=new Date(orderTS);
        const hour=orderDate.getHours();
        const mode=(R()*100<CFG.rocketRate?pick(['ë¡œì¼“ë‹¹ì¼','ë¡œì¼“ìƒˆë²½','ë¡œì¼“í”„ë ˆì‹œ']):'ì¼ë°˜íƒë°°');
        const route=(R()<0.7?'HUB_SPOKE':'DIRECT');
        const sortHub=(route==='HUB_SPOKE'?'MEGA-HUB-01':'');
        const cat=pick(['ê°€ê³µì‹í’ˆ','ì‹ ì„ ì‹í’ˆ','ëƒ‰ë™ì‹í’ˆ','ìƒí™œìš©í’ˆ','ì „ì']);
        const qty=Math.max(1,Math.round(nrand(2,1.2)));
        const unit=Math.max(1500,Math.round(nrand(12000,6000)));
        const amount=qty*unit;
        const dist=makeDistance(base.Base);
        const weatherS=clamp(nrand(0.35,0.2),0,1);
        const weatherName= weatherS>0.65?'ëˆˆ': weatherS>0.45?'ë¹„': weatherS>0.30?'íë¦¼':'ë§‘ìŒ';

        // FC ì„¸ë¶€ íƒ€ì„ë¼ì¸
        const pickS=addMin(orderTS,10+R()*30);
        const pickE=addMin(pickS,5+R()*10);
        const packS=addMin(pickE,1+R()*5);
        const packE=addMin(packS,3+R()*8);
        const qcS=addMin(packE,1+R()*5);
        const qcE=addMin(qcS,2+R()*6);
        const lblS=addMin(qcE,1+R()*4);
        const lblE=addMin(lblS,1+R()*4);
        const stgIn=addMin(lblE,2+R()*15);
        const stgOut=addMin(stgIn,5+R()*20);
        const dockAsn=addMin(stgOut,2+R()*10);
        const dockArr=addMin(dockAsn,5+R()*15);
        const dockRel=addMin(dockArr,8+R()*25);
        const gateOut=addMin(dockRel,5+R()*10);

        const fcExit=gateOut;
        const hubIn=(route==='HUB_SPOKE')? addMin(fcExit,45+R()*60): null;
        const hubOut=hubIn? addMin(hubIn,30+R()*90): null;
        const campIn=addMin((hubOut??fcExit),30+R()*60);
        const loadS=addMin(campIn,10+R()*40);
        const loadE=addMin(loadS,10+R()*40);
        const ofd=addMin(loadE,20+R()*60);

        const plannedShip=addMin(orderTS, 120 + R()*180);
        const baseMin=(mode==='ì¼ë°˜íƒë°°'?(dist/35*60+240):(mode==='ë¡œì¼“ë‹¹ì¼'?300:(mode==='ë¡œì¼“ìƒˆë²½'?450:420)));
        const plannedDelivery=addMin(plannedShip, baseMin);

        const coldReq=(cat==='ì‹ ì„ ì‹í’ˆ'||cat==='ëƒ‰ë™ì‹í’ˆ')?1:0;
        const tempViol=coldReq? (R()< clamp(0.008 + weatherS*0.01, 0, 0.08) ? 1:0):0;

        const travelDelayMin=Math.max(0, Math.round((ofd - plannedDelivery)/60000));
        const slaBreach=travelDelayMin>10?1:0;

        // breach ëˆ„ì  (ê³ ê°ë³„ ìµœê·¼ ìœ„ë°˜ ì¹´ìš´íŠ¸)
        if(slaBreach===1 || tempViol===1){
          const arr=breachTs.get(u.Customer_ID)||[]; arr.push(ofd); breachTs.set(u.Customer_ID,arr);
        }
        const arr=breachTs.get(u.Customer_ID)||[];
        const ts60=orderTS-60*86400000, ts30=orderTS-30*86400000;
        while(arr.length && arr[0]<ts60) arr.shift();
        let c60=0,c30=0; for(const t of arr){ if(t<orderTS){ if(t>=ts60) c60++; if(t>=ts30) c30++; } }
        const highBreach60=(c60>=2)?1:0;

        const ltv=Math.max(10000,Math.round(nrand(u.CLV_Base,u.CLV_Base*0.25)));
        const cac=Math.max(0,Math.round(nrand(2500,900)));
        const charge=computeDeliveryCharge(u.WOW===1, mode, dist, amount);
        const actualCost=Math.round(900 + dist*70 + (mode==='ë¡œì¼“í”„ë ˆì‹œ'?600:(mode==='ë¡œì¼“ìƒˆë²½'?500:(mode==='ë¡œì¼“ë‹¹ì¼'?450:350))));
        const gross=amount-actualCost;
        const net=gross+charge-cac-(tempViol?300:0);

        const {q:clvQ,label:clvLbl}=clvQuartileLabel(ltv);
        const churnScore=clamp(nrand(0.25 + (1-u.WOW)*0.15 + (highBreach60?0.2:0),0.15),0,1);
        const churnFlag=churnScore>0.65?1:0;

        const row={
          sim_version:'v2025-11+ops+clv', sim_seed: SIM_SEED,
          dial_snapshot_json: JSON.stringify(CFG.CAL||{}),
          generated_at: ts(Date.now()),
          Order_ID: 'O'+String(i+1).padStart(7,'0'),
          Order_Date: ts(orderTS).slice(0,10), Order_Timestamp: ts(orderTS), Order_Hour: hour,
          Delivery_Mode: mode, Is_Rocket_Delivery: (mode!=='ì¼ë°˜íƒë°°')?1:0,
          Planned_Delivery_Timestamp: ts(plannedDelivery), Delivery_Timestamp: ts(ofd),
          Is_Delayed: travelDelayMin>0?1:0, Delay_Hours: (travelDelayMin/60).toFixed(2), SLA_Breach: slaBreach,
          Region: u.Region, City:u.City, District:u.District,
          Address: u.City+' '+u.District, Exact_Address: addrFor(base),
          Fulfillment_Center: base.FC, Delivery_Center: base.DC, Is_Mega_Hub: (route==='HUB_SPOKE')?1:0,
          Base_Distance_km: base.Base, Distance_km: dist,
          Customer_ID: u.Customer_ID, Is_WOW_Member: u.WOW, WOW_Tier: u.WOW_Tier,
          WOW_Join_Date: ts(u.WOW_Join), WOW_Tenure_Days: Math.floor((orderTS-u.WOW_Join)/86400000),
          Product_Category: cat, SKU: 'SKU-'+String(Math.floor(R()*90000)+10000), ABC_Category: pick(['A','B','C']),
          Unit_Price: unit, Quantity: qty, Order_Amount: amount,
          Is_Fresh_Food: (cat==='ì‹ ì„ ì‹í’ˆ'||cat==='ëƒ‰ë™ì‹í’ˆ')?1:0, Is_Cold_Chain_Required: coldReq,
          Target_Temperature: coldReq? (cat==='ëƒ‰ë™ì‹í’ˆ'?-18:4): null,
          Actual_Temperature: coldReq? (cat==='ëƒ‰ë™ì‹í’ˆ'? Math.round(nrand(-17,3)): Math.round(nrand(3,2))): null,
          Temperature_Violation: tempViol,
          Cold_Chain_Quality_Score: coldReq? Math.max(0, Math.min(100, Math.round(100 - tempViol*30 - (weatherS*8)))): null,
          Vehicle_ID: 'V'+String(Math.floor(R()*9000)+1000),
          Vehicle_Type: pick(['EV Van','Diesel Van','Bike','Cargo']),
          Vehicle_Capacity: Math.floor(nrand(100,30)),
          Driver_ID: 'D'+String(Math.floor(R()*90000)+10000),
          Driver_Grade: pick(['A','B','C']),
          Load_Factor: Math.max(0.3, Math.min(0.98, nrand(0.7,0.15))),
          Fuel_Efficiency: Math.max(4.5, Math.round(nrand(9.8,2.5)*10)/10),
          Routing_Score: Math.max(60, Math.round(nrand(82,10))),
          GPS_Tracking: 1,
          Actual_Logistics_Cost: actualCost, Customer_Delivery_Charge: charge,
          Gross_Profit: gross, Net_Profit: net, CAC: cac, Customer_LTV: ltv, LTV_to_CAC: cac>0? (ltv/cac): null,
          clv_quartile: clvQ, clv_quartile_label: clvLbl,
          cust_breach_30d_cnt: c30, cust_breach_60d_cnt: c60, is_high_breach_60d: highBreach60,
          Return_Flag: (R()<0.06?1:0),
          Return_Reason: null, Return_Cost: 0, Is_Resellable: 0, Resellability_Reason: null,
          Current_Stock: Math.max(0, Math.round(nrand(380,140))),
          Reorder_Point: Math.max(20, Math.round(nrand(140,60))),
          Stockout_Flag: 0, Overstock_Flag: 0,
          Inventory_Turnover: Math.max(1, Math.round(nrand(6,2))),
          Inventory_Accuracy: Math.max(80, Math.round(nrand(94,3)*10)/10),
          Automation_Level: (R()<0.55)?'AI_OPTIMIZED':(R()<0.3?'AUTO':(R()<0.6?'SEMI_AUTO':'MANUAL')),
          Picking_Time_Seconds: Math.max(10, Math.round(nrand(40,15))),
          Packing_Time_Seconds: Math.max(10, Math.round(nrand(55,20))),
          Total_Process_Time: null,
          WMS_Usage: (R()<0.9?'Active':'Idle'),
          OMS_Usage: 'Active',
          WMS_Advanced_Score: Math.max(60, Math.round(nrand(80,8))),
          Service_Quality_Score: Math.max(60, Math.round(nrand(85,7))),
          Customer_NPS: Math.max(20, Math.round(nrand(54,12))),
          Processing_Error_Rate: Math.max(0, Math.min(0.06, Math.abs(nrand(0.012,0.008)))),
          Weather_Condition: weatherName, Weather_Severity_Score: weatherS,
          Churn_Flag: churnFlag, Predicted_Churn_Score: churnScore,
          Is_Same_Day_Delivery: (mode==='ë¡œì¼“ë‹¹ì¼')?1:0, Is_Dawn_Delivery: (mode==='ë¡œì¼“ìƒˆë²½')?1:0, Is_Fresh_Delivery:(mode==='ë¡œì¼“í”„ë ˆì‹œ')?1:0,
          Is_Premium_Order: (u.WOW_Tier==='WOW_PLUS')?1:0, Is_Bulk_Order: qty>=6?1:0,
          Is_Weekend_Order: [0,6].includes(new Date(orderTS).getDay())?1:0,
          Is_Peak_Hour_Order: (hour>=19&&hour<=21)?1:0,
          Is_Free_Shipping: (charge===0)?1:0, Is_Weather_Risk: (weatherS>0.6)?1:0, Is_Long_Distance: (dist>60)?1:0,
          Is_High_LTV: (ltv>240000)?1:0, Is_Churn_Risk: churnFlag, Is_VIP_Customer: (clvQ===4&&u.WOW===1)?1:0, Is_Loss_Order: (net<0)?1:0, Is_AI_Optimized: (R()<0.55)?1:0,
          Receiving_Date: ts(orderTS - 2*86400000),
          Putaway_Date: ts(orderTS - 1*86400000),
          Lot_ID: 'LOT'+String(Math.floor(R()*90000)+10000),
          Expiry_Date: (cat==='ì‹ ì„ ì‹í’ˆ'||cat==='ëƒ‰ë™ì‹í’ˆ')? ts(orderTS + randInt(7,20)*86400000) : null,
          Bin: 'B-'+randInt(1,40), Slot: 'S-'+randInt(1,200),
          Unit_Cost: Math.max(500, Math.round(unit*0.7)),
          Daily_OnHand_Snapshot: null, Safety_Stock: Math.max(10, Math.round(nrand(80,25))), Forecast_Demand: Math.max(10, Math.round(nrand(120,40))),
          ASN_ID: 'ASN'+String(Math.floor(R()*900000)+100000), PO_ID:'PO'+String(Math.floor(R()*900000)+100000),
          Replenishment_Type: pick(['JIT','Cycle','MinMax']),
          Picking_Start_TS: ts(pickS), Picking_End_TS: ts(pickE),
          Packing_Start_TS: ts(packS), Packing_End_TS: ts(packE),
          QC_Start_TS: ts(qcS), QC_End_TS: ts(qcE),
          Label_Start_TS: ts(lblS), Label_End_TS: ts(lblE),
          Staging_In_TS: ts(stgIn), Staging_Out_TS: ts(stgOut),
          Dock_Assign_TS: ts(dockAsn), Dock_Arrive_TS: ts(dockArr), Dock_Release_TS: ts(dockRel),
          Security_Gate_Out_TS: ts(gateOut),
          qc_min: Math.round((qcE-qcS)/60000), label_min: Math.round((lblE-lblS)/60000),
          staging_min: Math.round((stgOut-stgIn)/60000), dock_wait_min: Math.round((dockRel-dockArr)/60000),
          fc_total_dwell_min: Math.max(0, Math.round((gateOut-(pickS||orderTS))/60000)),
          residual_fc_internal_min: 0,
          Planned_Ship_Timestamp: ts(addMin(orderTS, 90 + R()*60)),
          Actual_Ship_Timestamp: ts(gateOut),
          On_Time_Dispatch_Flag: (gateOut <= addMin(orderTS, 90 + R()*60)) ? 1:0,
          [NET.ROUTE_TYPE]: route, [NET.SORT_HUB_NAME]: sortHub,
          [NET.FC_EXIT]: ts(fcExit), [NET.HUB_IN]: hubIn?ts(hubIn):null, [NET.HUB_OUT]: hubOut?ts(hubOut):null,
          [NET.CAMP_IN]: ts(campIn), [NET.LOAD_START]: ts(loadS), [NET.LOAD_END]: ts(loadE), [NET.OFD]: ts(ofd),
        };

        // ë°˜í’ˆ ìƒì„±(ê°„ë‹¨ ë¡œì§)
        if(row.Return_Flag===1){
          const reasonPick = pick([
            'ì˜¤ë°°ì†¡','ìƒí’ˆ íŒŒì†','ë‹¨ìˆœ ë³€ì‹¬','ì‚¬ì´ì¦ˆ/ê·œê²© ë¶ˆë§Œ','ìœ í†µê¸°í•œ ì„ë°•','í’ˆì§ˆ ë¶ˆëŸ‰','ê¸°íƒ€','ë°°ì†¡ ì§€ì—°'
          ]);
          row.Return_Reason = reasonPick;
          row.Return_Cost = Math.round(Math.max(500, nrand(2500,800)));
          row.Is_Resellable = ['ë‹¨ìˆœ ë³€ì‹¬','ì‚¬ì´ì¦ˆ/ê·œê²© ë¶ˆë§Œ'].includes(reasonPick) ? 1 : (reasonPick==='ê¸°íƒ€'? (R()<0.5?1:0): 0);
          row.Resellability_Reason = row.Is_Resellable? 'íŒ¨í‚¤ì§€ ê°œë´‰ ç„¡' : 'ì†ìƒ/ëƒ‰ì¥íŒŒì†';
        }

        // ì¬ê³  í”Œë˜ê·¸
        if(row.Current_Stock < row.Reorder_Point) row.Stockout_Flag=1;
        if(row.Current_Stock > row.Reorder_Point*3) row.Overstock_Flag=1;

        batch.push(row); emitted++;
        if(batch.length>=CHUNK){
          postMessage({type:'rows', rows: batch});
          postMessage({type:'progress', done: emitted, total: totalRows});
          batch=[];
        }
      }
      if(batch.length) postMessage({type:'rows', rows: batch});
      postMessage({type:'done', total: totalRows});
    }
  `;
    const blob = new Blob([code], {type: 'application/javascript'});
    const url = URL.createObjectURL(blob);
    const w = new Worker(url);
    w.addEventListener('error', e => console.error('Worker error', e));
    return w;
  }

  /* ---------- 12) UI ì´ë²¤íŠ¸ & ì´ˆê¸°í™” ---------- */
  function populateYearSelects() {
    const now = new Date().getFullYear();
    const sy = qs('startYear'), ey = qs('endYear');
    sy.innerHTML = '';
    ey.innerHTML = '';
    for (let y = 2019; y <= now; y++) {
      const o1 = document.createElement('option');
      o1.value = String(y);
      o1.textContent = String(y);
      const o2 = document.createElement('option');
      o2.value = String(y);
      o2.textContent = String(y);
      sy.appendChild(o1);
      ey.appendChild(o2);
    }
    sy.value = String(now - 1);
    ey.value = String(now);
  }

  function resetAll() {
    DATA.length = 0;
    TABLE_KEYS = null;
    PROCESSING_STATE = {isRunning: false, shouldStop: false, startTime: null, processedRows: 0, totalRows: 0};
    AGG.total = 0;
    qs('tbl').querySelector('thead').innerHTML = '';
    qs('tbl').querySelector('tbody').innerHTML = '';
    setStatus('READY', 'ok');
    setDisabled('btnCsv', true);
    setDisabled('btnCsvTurbo', true);
    qs('validateList').innerHTML = '';
    qs('riskList').innerHTML = '';
    qs('perfList').innerHTML = '';
    ['k_rocketShare', 'k_rocketSameDayRate', 'k_rocketDawnRate', 'k_fastShipRate', 'k_hubOnTimeP95', 'k_campOnTimeP95', 'k_campDispatchBreach',
      'k_fcOnTimeShip', 'k_fcAvgShipHour', 'k_fcPickSecPerItem', 'k_fcPackSecPerItem', 'k_fcEfficiency', 'k_fcShipUnder60', 'k_fcTotalDwellMinAvg',
      'k_wowShare', 'k_wowPlusShare', 'k_wowAovGap', 'k_wowChurnRisk', 'k_clvTopQ4Share', 'k_clvWowGap', 'k_highBreach60Share',
      'k_freshShare', 'k_coldChainRate', 'k_tempViolation', 'k_frozenQuality',
      'k_megaHubShare', 'k_seoulCoverage', 'k_avgDistance', 'k_networkEff',
      'k_aiOptimized', 'k_autoPickRate', 'k_avgPickTime', 'k_wmsAdvanced',
      'k_totalSales', 'k_netMargin', 'k_aov', 'k_arppu',
      'k_ltvCac', 'k_retention', 'k_churn', 'k_ai',
      'k_onTime', 'k_sla', 'k_load', 'k_fuel', 'k_route', 'k_exception',
      'k_returnRate', 'k_returnCost', 'k_resell',
      'k_invTurn', 'k_stockout', 'k_overstock', 'k_invAcc', 'k_shrink', 'k_wms'
    ].forEach(id => setText(id, '-'));
  }

  function startGeneration() {
    resetAll();
    const cfg = {
      startYear: Number(qs('startYear').value),
      endYear: Number(qs('endYear').value),
      userCount: Number(qs('userCount').value),
      totalRows: Number(qs('orderCount').value),
      chunkSize: Number(qs('chunkSize').value) || CHUNK_CONFIG.defaultSize,
      rocketRate: Number(qs('rocketRate').value),
      wowRate: Number(qs('wowRate').value),
      seed: Math.floor(Math.random() * 1e9),
      CAL: {
        lossHi: parseFloat(qs('dial_loss_hi').value),
        tempHi: parseFloat(qs('dial_temp_hi').value),
        jejuHi: parseFloat(qs('dial_jeju_hi').value),
        overHi: parseFloat(qs('dial_over_hi').value),
        expHi: parseFloat(qs('dial_exp_hi').value),
      }
    };

    FAST_MODE = qs('fastMode').checked;
    setStatus('RUNNING', 'running');
    showProgress(true);
    setDisabled('btnStart', true);
    setDisabled('btnStop', false);

    PROCESSING_STATE.isRunning = true;
    PROCESSING_STATE.startTime = Date.now();
    PROCESSING_STATE.totalRows = cfg.totalRows;

    WORKER = createWorker();
    WORKER.onmessage = (e) => {
      const d = e.data || {};
      if (d.type === 'rows') {
        const rows = d.rows || [];
        // FAST_MODE: ìƒ˜í”Œ í‘œì‹œ ìˆ˜ ì¤„ì—¬ì„œ ë Œë” ë¶€í•˜ ê°ì†Œ
        if (FAST_MODE && rows.length > 0) {
          // 1/2 ìƒ˜í”Œë§Œ í‘œì‹œ(ì§‘ê³„ëŠ” ëª¨ë“  í–‰ ingest)
          const view = rows.filter((_, idx) => idx % 2 === 0);
          ingestRows(rows); // ì§‘ê³„ìš©
          // í‘œì‹œëŠ” viewë§Œ: ì´ë¯¸ ingestRowsì—ì„œ ë Œë”í•˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
        } else {
          ingestRows(rows);
        }
      } else if (d.type === 'progress') {
        PROCESSING_STATE.processedRows = d.done || PROCESSING_STATE.processedRows;
        updateProgressFromState('Generating');
      } else if (d.type === 'done') {
        PROCESSING_STATE.isRunning = false;
        setStatus('DONE', 'ok');
        showProgress(false);
        setDisabled('btnStop', true);
        setDisabled('btnCsv', false);
        setDisabled('btnCsvTurbo', false);
      } else if (d.type === 'stopped') {
        PROCESSING_STATE.isRunning = false;
        setStatus('STOPPED', 'ng');
        showProgress(false);
        setDisabled('btnStop', true);
        setDisabled('btnCsv', DATA.length === 0);
        setDisabled('btnCsvTurbo', DATA.length === 0);
      }
    };

    WORKER.postMessage({cmd: 'start', cfg});
  }

  function stopGeneration() {
    if (WORKER) {
      WORKER.postMessage({cmd: 'stop'});
    }
    PROCESSING_STATE.shouldStop = true;
    setStatus('STOPPING...', 'running');
  }

  function toggleTunePanel() {
    const p = qs('tunePanel');
    p.style.display = (p.style.display === 'none' ? 'block' : 'none');
  }

  function applyDials() {
    qs('tuneStatus').textContent = 'APPLIED';
    qs('tuneStatus').className = 'pill ok';
  }

  function resetDials() {
    qs('dial_loss_lo').value = '0.07';
    qs('dial_loss_hi').value = '0.12';
    qs('dial_temp_lo').value = '0.01';
    qs('dial_temp_hi').value = '0.02';
    qs('dial_jeju_lo').value = '0.10';
    qs('dial_jeju_hi').value = '0.15';
    qs('dial_over_lo').value = '0.15';
    qs('dial_over_hi').value = '0.25';
    qs('dial_exp_lo').value = '0.005';
    qs('dial_exp_hi').value = '0.01';
    qs('tuneStatus').textContent = 'RESET';
    qs('tuneStatus').className = 'pill running';
  }

  document.addEventListener('DOMContentLoaded', () => {
    populateYearSelects();
    qs('btnStart').addEventListener('click', startGeneration);
    qs('btnStop').addEventListener('click', stopGeneration);
    qs('btnCsv').addEventListener('click', downloadCSV);
    qs('btnCsvTurbo').addEventListener('click', downloadCSVGzip);
    qs('btnTune').addEventListener('click', toggleTunePanel);
    qs('btnApplyDials').addEventListener('click', applyDials);
    qs('btnResetDials').addEventListener('click', resetDials);
  });
</script>
</body>
</html>

