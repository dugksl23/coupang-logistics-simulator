<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>🚀 쿠팡 물류 시뮬레이션 시스템 - v2025-11+ops+clv (Single File, FIXED)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #fff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --pri: #2563eb;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --vio: #8b5cf6;
      --cyan: #06b6d4;
      --rocket: #ff6b35;
      --wow: #9333ea;
      --fresh: #059669
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px
    }

    .header {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #9333ea 100%);
      color: #fff;
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 20px;
      box-shadow: 0 12px 32px rgba(255, 107, 53, .25);
      position: relative;
      overflow: hidden
    }

    .header::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, .05) 10px, rgba(255, 255, 255, .05) 20px);
      animation: slide 20s linear infinite
    }

    @keyframes slide {
      0% {
        transform: translateX(-50px)
      }
      100% {
        transform: translateX(50px)
      }
    }

    .header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      position: relative;
      z-index: 1
    }

    .header .sub {
      opacity: .9;
      font-size: 14px;
      position: relative;
      z-index: 1
    }

    .header .reality-badge {
      position: absolute;
      top: 20px;
      right: 30px;
      background: rgba(255, 255, 255, .2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, .3)
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 6px 20px rgba(2, 6, 23, .08)
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end
    }

    .ctrl {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .ctrl label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600
    }

    .ctrl input, .ctrl select {
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      min-width: 130px
    }

    .btn {
      background: var(--pri);
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .3s
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, .3)
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none
    }

    .btn.secondary {
      background: #374151
    }

    .btn.danger {
      background: var(--bad)
    }

    .btn.rocket {
      background: var(--rocket)
    }

    .btn.wow {
      background: var(--wow)
    }

    .progress-container {
      margin: 12px 0;
      display: none
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: var(--line);
      border-radius: 6px;
      overflow: hidden
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, var(--rocket), var(--wow));
      width: 0%;
      transition: width .2s ease
    }

    .progress-text {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
      font-weight: 600
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px
    }

    .kpi-grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      position: relative;
      transition: transform .3s
    }

    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(2, 6, 23, .12)
    }

    .kpi h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .4px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .kpi .v {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px
    }

    .kpi .meta {
      font-size: 11px;
      color: var(--muted)
    }

    .kpi.primary {
      border-top: 4px solid var(--pri)
    }

    .kpi.good {
      border-top: 4px solid var(--good)
    }

    .kpi.warn {
      border-top: 4px solid var(--warn)
    }

    .kpi.bad {
      border-top: 4px solid var(--bad)
    }

    .kpi.rocket {
      border-top: 4px solid var(--rocket)
    }

    .kpi.wow {
      border-top: 4px solid var(--wow)
    }

    .kpi.fresh {
      border-top: 4px solid var(--fresh)
    }

    .kpi.cyan {
      border-top: 4px solid var(--cyan)
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600
    }

    .pill.ok {
      background: #dcfce7;
      color: #065f46
    }

    .pill.ng {
      background: #fee2e2;
      color: #991b1b
    }

    .pill.running {
      background: #dbeafe;
      color: #1e40af
    }

    .sections {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));
      gap: 18px;
      margin-top: 12px
    }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px
    }

    .section h3 {
      margin: 0 0 12px 0;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .alerts {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 280px;
      overflow: auto
    }

    .alert {
      padding: 12px 15px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid;
      transition: all .3s
    }

    .alert:hover {
      transform: translateX(4px)
    }

    .alert.good {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #065f46
    }

    .alert.warn {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e
    }

    .alert.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b
    }

    .table-wrap {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 0;
      margin-top: 18px;
      overflow: hidden
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      border-bottom: 2px solid var(--line)
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      white-space: nowrap
    }

    th {
      font-weight: 700;
      color: var(--ink)
    }

    .delivery-mode.rocket {
      color: var(--rocket);
      font-weight: 600
    }

    .delivery-mode.dawn {
      color: var(--wow);
      font-weight: 600
    }

    .delivery-mode.fresh {
      color: var(--fresh);
      font-weight: 600
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: flex-start
      }

      .ctrl input, .ctrl select {
        min-width: 280px
      }

      .sections {
        grid-template-columns:1fr
      }

      .kpi-grid {
        grid-template-columns:repeat(auto-fit, minmax(250px, 1fr))
      }
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px
    }

    .switch input {
      display: none
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #cbd5e1;
      border-radius: 999px;
      transition: .2s
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .2)
    }

    .switch input:checked + .slider {
      background: #22c55e
    }

    .switch input:checked + .slider:before {
      transform: translateX(20px)
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="reality-badge">현실성 95%</div>
    <h1>🚀 쿠팡 물류 시뮬레이션 시스템 (Coupang Logistics Reality Simulator)</h1>
    <div class="sub">🎯 로켓배송·신선식품·WOW·AI자동화 | FC·허브 분리 | 입고/적치/유통기한/로케이션 포함 — v2025-11+ops+clv (FIXED)</div>
  </div>

  <div class="panel">
    <div class="controls">
      <div class="ctrl"><label>시작년도 / Start Year</label><select id="startYear"></select></div>
      <div class="ctrl"><label>종료년도 / End Year</label><select id="endYear"></select></div>
      <div class="ctrl"><label>고객 수 / #Users</label><input id="userCount" type="number" min="100" max="200000"
                                                           value="300"></div>
      <div class="ctrl"><label>주문 수 / #Orders</label><input id="orderCount" type="number" min="500" max="10000000"
                                                            step="1000" value="10000"></div>
      <div class="ctrl"><label>청크 크기 / Chunk Size</label><input id="chunkSize" type="number" min="500" max="15000"
                                                                step="500" value="3000"></div>
      <div class="ctrl"><label>로켓배송 비중 / Rocket Rate (%)</label><input id="rocketRate" type="number" min="35" max="90"
                                                                       value="55"></div>
      <div class="ctrl"><label>WOW 가입률 / WOW Rate (%)</label><input id="wowRate" type="number" min="60" max="100"
                                                                    value="80"></div>
      <div class="ctrl"><label>목표 순이익률(%)</label><input id="targetNetMargin" type="number" step="0.1" value="3.2"
                                                        min="-20" max="30"></div>
      <div class="ctrl">
        <label>FAST MODE</label>
        <label class="switch"><input type="checkbox" id="fastMode"><span class="slider"></span></label>
      </div>
      <button class="btn rocket" id="btnStart">▶️ 데이터 생성 / Generate</button>
      <button class="btn secondary" id="btnTune">⚙️ DIALS</button>
      <button class="btn danger" id="btnStop" disabled>⏹️ 중단 / Stop</button>
      <button class="btn wow" id="btnCsv" disabled>📥 CSV 다운로드 / Download CSV</button>
      <button class="btn wow" id="btnCsvTurbo" disabled>⚡️ 초고속 CSV (GZIP)</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">처리 중... / Processing...</div>
      <div class="progress-stats"><span id="progressStats">-</span><span id="progressETA">예상 완료: - / ETA: -</span></div>
    </div>
  </div>

  <!-- DIALS -->
  <div class="panel" id="tunePanel" style="display:block">
    <div class="controls" style="align-items:flex-start">
      <div class="ctrl"><label>적자주문율 최소</label><input id="dial_loss_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.07"></div>
      <div class="ctrl"><label>적자주문율 최대</label><input id="dial_loss_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.12"></div>
      <div class="ctrl"><label>온도위반율 최소</label><input id="dial_temp_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.01"></div>
      <div class="ctrl"><label>온도위반율 최대</label><input id="dial_temp_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.02"></div>
      <div class="ctrl"><label>제주 악천후 최소</label><input id="dial_jeju_lo" type="number" step="0.001" min="0" max="1"
                                                       value="0.10"></div>
      <div class="ctrl"><label>제주 악천후 최대</label><input id="dial_jeju_hi" type="number" step="0.001" min="0" max="1"
                                                       value="0.15"></div>
      <div class="ctrl"><label>과재고 최소</label><input id="dial_over_lo" type="number" step="0.001" min="0" max="1"
                                                    value="0.15"></div>
      <div class="ctrl"><label>과재고 최대</label><input id="dial_over_hi" type="number" step="0.001" min="0" max="1"
                                                    value="0.25"></div>
      <div class="ctrl"><label>유통기한 임박 최소</label><input id="dial_exp_lo" type="number" step="0.001" min="0" max="1"
                                                        value="0.005"></div>
      <div class="ctrl"><label>유통기한 임박 최대</label><input id="dial_exp_hi" type="number" step="0.001" min="0" max="1"
                                                        value="0.01"></div>
    </div>
    <div class="controls">
      <button class="btn wow" id="btnApplyDials">적용</button>
      <button class="btn secondary" id="btnResetDials">초기화</button>
      <div id="tuneStatus" class="pill ok">DIALS READY</div>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">
      정책 메모: 배송비는 거리구간×모드×WOW에 따라 산출됩니다(예: WOW 대부분 무료, 비회원 1,500~4,500원). 날씨 가중치는 세그먼트키 제외/비용 포함(default).
    </div>
  </div>

  <!-- KPI 섹션들 (원본 유지) -->
  <div class="sections">
    <div class="section"><h3>🚀 로켓배송 성과</h3>
      <div class="kpi-grid">
        <div class="kpi rocket"><h4>로켓배송 비중</h4>
          <div class="v" id="k_rocketShare">-</div>
          <div class="meta">% of orders</div>
        </div>
        <div class="kpi rocket"><h4>로켓당일 성공률</h4>
          <div class="v" id="k_rocketSameDayRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>로켓새벽 정시율</h4>
          <div class="v" id="k_rocketDawnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>30분내 출고율</h4>
          <div class="v" id="k_fastShipRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>허브 on-time (p95)</h4>
          <div class="v" id="k_hubOnTimeP95">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>캠프 on-time (p95)</h4>
          <div class="v" id="k_campOnTimeP95">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi warn"><h4>camp_dispatch_breach 누적</h4>
          <div class="v" id="k_campDispatchBreach">-</div>
          <div class="meta">건</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>📦 출고·풀필먼트</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>정시 출고율</h4>
          <div class="v" id="k_fcOnTimeShip">-</div>
          <div class="meta">목표 ≥ 96%</div>
        </div>
        <div class="kpi"><h4>평균 출고 시간</h4>
          <div class="v" id="k_fcAvgShipHour">-</div>
          <div class="meta">시간</div>
        </div>
        <div class="kpi"><h4>피킹 속도</h4>
          <div class="v" id="k_fcPickSecPerItem">-</div>
          <div class="meta">초/개</div>
        </div>
        <div class="kpi"><h4>패킹 속도</h4>
          <div class="v" id="k_fcPackSecPerItem">-</div>
          <div class="meta">초/개</div>
        </div>
        <div class="kpi good"><h4>풀필먼트 효율</h4>
          <div class="v" id="k_fcEfficiency">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>60분내 출고율</h4>
          <div class="v" id="k_fcShipUnder60">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>FC 총 체류 평균</h4>
          <div class="v" id="k_fcTotalDwellMinAvg">-</div>
          <div class="meta">분</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>🌟 WOW 멤버십 & 프리미엄</h3>
      <div class="kpi-grid">
        <div class="kpi wow"><h4>WOW 가입률</h4>
          <div class="v" id="k_wowShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>WOW Plus 비중</h4>
          <div class="v" id="k_wowPlusShare">0</div>
          <div class="meta">% (WOW 내부)</div>
        </div>
        <div class="kpi wow"><h4>WOW vs 비회원 AOV 차이</h4>
          <div class="v" id="k_wowAovGap">-</div>
          <div class="meta">₩</div>
        </div>
        <div class="kpi warn"><h4>WOW 이탈 위험 고객</h4>
          <div class="v" id="k_wowChurnRisk">-</div>
          <div class="meta">명</div>
        </div>
        <div class="kpi"><h4>Q4-Top 고객 비중</h4>
          <div class="v" id="k_clvTopQ4Share">-</div>
          <div class="meta">% (고객 기준)</div>
        </div>
        <div class="kpi"><h4>WOW vs 비회원 CLV 격차</h4>
          <div class="v" id="k_clvWowGap">-</div>
          <div class="meta">₩</div>
        </div>
        <div class="kpi warn"><h4>최근60일 고위반 고객 비중</h4>
          <div class="v" id="k_highBreach60Share">-</div>
          <div class="meta">% (고객 기준)</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>❄️ 신선식품 & 콜드체인</h3>
      <div class="kpi-grid">
        <div class="kpi fresh"><h4>신선식품 비중</h4>
          <div class="v" id="k_freshShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>콜드체인 준수율</h4>
          <div class="v" id="k_coldChainRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi warn"><h4>온도 위반율</h4>
          <div class="v" id="k_tempViolation">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>냉동식품 품질 점수</h4>
          <div class="v" id="k_frozenQuality">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>🏭 허브&스포크 물류망</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>메가허브 처리 비중</h4>
          <div class="v" id="k_megaHubShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>수도권 커버리지</h4>
          <div class="v" id="k_seoulCoverage">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>평균 배송 거리</h4>
          <div class="v" id="k_avgDistance">-</div>
          <div class="meta">km</div>
        </div>
        <div class="kpi primary"><h4>네트워크 효율성</h4>
          <div class="v" id="k_networkEff">-</div>
          <div class="meta">점</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>🤖 AI & 자동화 수준</h3>
      <div class="kpi-grid">
        <div class="kpi cyan"><h4>AI 최적화 비율</h4>
          <div class="v" id="k_aiOptimized">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi cyan"><h4>자동 피킹율</h4>
          <div class="v" id="k_autoPickRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>평균 피킹 시간</h4>
          <div class="v" id="k_avgPickTime">-</div>
          <div class="meta">초</div>
        </div>
        <div class="kpi cyan"><h4>WMS 고도화 점수</h4>
          <div class="v" id="k_wmsAdvanced">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>💰 매출·수익</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>총 매출</h4>
          <div class="v" id="k_totalSales">-</div>
          <div class="meta">₩</div>
        </div>
        <div class="kpi good"><h4>순이익률</h4>
          <div class="v" id="k_netMargin">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>평균주문금액</h4>
          <div class="v" id="k_aov">-</div>
          <div class="meta">₩</div>
        </div>
        <div class="kpi"><h4>ARPPU</h4>
          <div class="v" id="k_arppu">-</div>
          <div class="meta">₩</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>👥 고객</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC</h4>
          <div class="v" id="k_ltvCac">-</div>
        </div>
        <div class="kpi"><h4>유지율</h4>
          <div class="v" id="k_retention">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>이탈률</h4>
          <div class="v" id="k_churn">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>AI 이탈 예측 정확도</h4>
          <div class="v" id="k_ai">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>🚚 배송·물류</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>정시율</h4>
          <div class="v" id="k_onTime">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>SLA 위반율</h4>
          <div class="v" id="k_sla">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>적재율</h4>
          <div class="v" id="k_load">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>연비</h4>
          <div class="v" id="k_fuel">-</div>
          <div class="meta">km/ℓ · km/kWh</div>
        </div>
        <div class="kpi"><h4>라우팅 점수</h4>
          <div class="v" id="k_route">-</div>
          <div class="meta">/100</div>
        </div>
        <div class="kpi warn"><h4>배송 예외율</h4>
          <div class="v" id="k_exception">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>📦 반품</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>반품률</h4>
          <div class="v" id="k_returnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>반품 손실률</h4>
          <div class="v" id="k_returnCost">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>재판매 가능률</h4>
          <div class="v" id="k_resell">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section"><h3>🏭 WMS·재고</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>재고 회전율</h4>
          <div class="v" id="k_invTurn">-</div>
          <div class="meta">회</div>
        </div>
        <div class="kpi"><h4>품절률</h4>
          <div class="v" id="k_stockout">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>과재고 비율</h4>
          <div class="v" id="k_overstock">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>재고 정확도</h4>
          <div class="v" id="k_invAcc">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>재고 손실률</h4>
          <div class="v" id="k_shrink">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>WMS 활용률</h4>
          <div class="v" id="k_wms">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sections">
    <div class="section"><h3>✅ 쿠팡 특화 정합성 검사</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section"><h3>⚠️ 쿠팡 복합 위험 요소</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section"><h3>📊 처리 성능 & 현실성 지표</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* ============================================================
     Coupang Logistics Reality Simulator — Fixed Single File
     v2025-11+ops+clv
     ▶ FIX: 워커 코드/전송 누락으로 데이터 미생성 문제 해결
     ▶ FIX: CSV/테이블 헤더 공백을 언더바로 출력
     ▶ NEW: 코호트·CRM·Executive 컬럼/로직 추가, 반품 정규화/품질·오배송 플래그, 가드레일 p95 브리치
  ============================================================ */

  const POLICY = {useWeatherInSegmentation: false, useWeatherInCost: true};

  /* ---------- Network meta keys ---------- */
  const NET_PREFIX = '__net_';
  const N = s => NET_PREFIX + s;
  const NET = Object.freeze({
    ROUTE_TYPE: N('Route_Type'), SORT_HUB_NAME: N('Sortation_Hub_Name'),
    FC_EXIT: N('FC_Exit_TS'), HUB_IN: N('Hub_In_TS'), HUB_OUT: N('Hub_Out_TS'),
    CAMP_IN: N('Camp_In_TS'), LOAD_START: N('Loadout_Start_TS'), LOAD_END: N('Loadout_End_TS'), OFD: N('OFD_TS'),
    FC_DWELL: N('FC_Dwell_Min'), HUB_DWELL: N('Hub_Dwell_Min'), CAMP_DWELL: N('Camp_Dwell_Min'),
  });

  /* ---------- CSV labels ---------- */
  const CSV_SPECIAL_LABELS = {
    Order_ID: 'Order ID',
    Order_Date: 'Order Date',
    Order_Timestamp: 'Order Timestamp',
    Order_Hour: 'Order Hour',
    Delivery_Mode: 'Delivery Mode',
    Planned_Delivery_Date: 'Planned Delivery Date',
    Actual_Delivery_Date: 'Actual Delivery Date',
    Delivery_Timestamp: 'Delivery Timestamp',
    Planned_Delivery_Timestamp: 'Planned Delivery Timestamp',
    Is_Delayed: 'Is Delayed',
    Delay_Hours: 'Delay Hours',
    SLA_Breach: 'SLA Breach',
    Delivery_Status: 'Delivery Status',
    Fast_Ship_30min: 'Fast Ship 30min',
    Order_To_Ship_Minutes: 'Order To Ship Minutes',
    Region: 'Region',
    City: 'City',
    Address: 'Address',
    District: 'District',
    Exact_Address: 'Exact Address',
    Fulfillment_Center: 'Fulfillment Center',
    Delivery_Center: 'Delivery Center',
    Is_Mega_Hub: 'Is Mega Hub',
    Base_Distance_km: 'Base_Distance_km',
    Distance_km: 'Distance km',
    Customer_ID: 'Customer ID',
    Is_WOW_Member: 'Is WOW Member',
    WOW_Tier: 'WOW Tier',
    WOW_Join_Date: 'WOW Join Date',
    WOW_Tenure_Days: 'WOW Tenure Days',
    Customer_Segment: 'Customer Segment',
    Product_Category: 'Product Category',
    SKU: 'SKU',
    ABC_Category: 'ABC Category',
    Unit_Price: 'Unit Price',
    Quantity: 'Quantity',
    Order_Amount: 'Order Amount',
    Is_Fresh_Food: 'Is Fresh Food',
    Is_Cold_Chain_Required: 'Is Cold Chain Required',
    Target_Temperature: 'Target Temperature',
    Actual_Temperature: 'Actual Temperature',
    Temperature_Violation: 'Temperature Violation',
    Cold_Chain_Quality_Score: 'Cold Chain Quality Score',
    Vehicle_ID: 'Vehicle ID',
    Vehicle_Type: 'Vehicle Type',
    Vehicle_Capacity: 'Vehicle Capacity',
    Driver_ID: 'Driver ID',
    Driver_Grade: 'Driver Grade',
    Load_Factor: 'Load Factor',
    Fuel_Efficiency: 'Fuel Efficiency',
    Routing_Score: 'Routing Score',
    GPS_Tracking: 'GPS Tracking',
    Actual_Logistics_Cost: 'Actual Logistics Cost',
    Customer_Delivery_Charge: 'Customer Delivery Charge',
    Gross_Profit: 'Gross Profit',
    Net_Profit: 'Net Profit',
    CAC: 'CAC',
    Customer_LTV: 'Customer LTV',
    LTV_to_CAC: 'LTV to CAC',
    clv_quartile: 'CLV Quartile',
    clv_quartile_label: 'CLV Quartile Label',
    cust_breach_30d_cnt: 'Cust Breach 30d Cnt',
    cust_breach_60d_cnt: 'Cust Breach 60d Cnt',
    is_high_breach_60d: 'High Breach 60d Flag',
    Return_Flag: 'Is Returned',
    Return_Reason: 'Return Reason',
    Return_Cost: 'Return Cost',
    Is_Resellable: 'Is Resellable',
    Resellability_Reason: 'Resellability Reason',
    Current_Stock: 'Current Stock',
    Reorder_Point: 'Reorder Point',
    Stockout_Flag: 'Stockout Flag',
    Overstock_Flag: 'Overstock Flag',
    Inventory_Turnover: 'Inventory Turnover',
    Inventory_Accuracy: 'Inventory Accuracy',
    Automation_Level: 'Automation Level',
    Picking_Time_Seconds: 'Picking Time Seconds',
    Packing_Time_Seconds: 'Packing Time Seconds',
    Total_Process_Time: 'Total Process Time',
    WMS_Usage: 'WMS Usage',
    OMS_Usage: 'OMS Usage',
    WMS_Advanced_Score: 'WMS Advanced Score',
    Service_Quality_Score: 'Service Quality Score',
    Customer_NPS: 'Customer NPS',
    Processing_Error_Rate: 'Processing Error Rate',
    Weather_Condition: 'Weather Condition',
    Weather_Severity_Score: 'Weather Severity Score',
    Churn_Flag: 'Churn Flag',
    Predicted_Churn_Score: 'Predicted Churn Score',
    Is_Rocket_Delivery: 'Is Rocket Delivery',
    Is_Same_Day_Delivery: 'Is Same Day Delivery',
    Is_Dawn_Delivery: 'Is Dawn Delivery',
    Is_Fresh_Delivery: 'Is Fresh Delivery',
    Is_Premium_Order: 'Is Premium Order',
    Is_Bulk_Order: 'Is Bulk Order',
    Is_Weekend_Order: 'Is Weekend Order',
    Is_Peak_Hour_Order: 'Is Peak Hour Order',
    Is_Free_Shipping: 'Is Free Shipping',
    Is_Weather_Risk: 'Is Weather Risk',
    Is_Long_Distance: 'Is Long Distance',
    Is_High_LTV: 'Is High LTV',
    Is_Churn_Risk: 'Is Churn Risk',
    Is_VIP_Customer: 'Is VIP Customer',
    Is_Loss_Order: 'Is Loss Order',
    Is_AI_Optimized: 'Is AI Optimized',
    Receiving_Date: 'Receiving Date',
    Putaway_Date: 'Putaway Date',
    Lot_ID: 'Lot ID',
    Expiry_Date: 'Expiry Date',
    Bin: 'Bin',
    Slot: 'Slot',
    Unit_Cost: 'Unit Cost',
    Daily_OnHand_Snapshot: 'Daily OnHand Snapshot',
    Safety_Stock: 'Safety Stock',
    Forecast_Demand: 'Forecast Demand',
    ASN_ID: 'Asn Id',
    PO_ID: 'Po Id',
    Replenishment_Type: 'Replenishment Type',
    Picking_Start_TS: 'Picking Start TS',
    Picking_End_TS: 'Picking End TS',
    Packing_Start_TS: 'Packing Start TS',
    Packing_End_TS: 'Packing End TS',
    QC_Start_TS: 'QC Start TS',
    QC_End_TS: 'QC End TS',
    Label_Start_TS: 'Label Start TS',
    Label_End_TS: 'Label End TS',
    Staging_In_TS: 'Staging In TS',
    Staging_Out_TS: 'Staging Out TS',
    Dock_Assign_TS: 'Dock Assign TS',
    Dock_Arrive_TS: 'Dock Arrive TS',
    Dock_Release_TS: 'Dock Release TS',
    Security_Gate_Out_TS: 'Security Gate Out TS',
    qc_min: 'QC Minutes',
    label_min: 'Label Minutes',
    staging_min: 'Staging Minutes',
    dock_wait_min: 'Dock Wait Minutes',
    fc_total_dwell_min: 'FC Total Dwell Minutes',
    residual_fc_internal_min: 'Residual FC Internal Minutes',
    Planned_Ship_Timestamp: 'Planned Ship Timestamp',
    Actual_Ship_Timestamp: 'Actual Ship Timestamp',
    On_Time_Dispatch_Flag: 'On-time Dispatch Flag',
    [NET.ROUTE_TYPE]: 'Route Type',
    [NET.SORT_HUB_NAME]: 'Sortation Hub Name',
    [NET.FC_EXIT]: 'FC Exit TS',
    [NET.HUB_IN]: 'Hub In TS',
    [NET.HUB_OUT]: 'Hub Out TS',
    [NET.CAMP_IN]: 'Camp In TS',
    [NET.LOAD_START]: 'Loadout Start TS',
    [NET.LOAD_END]: 'Loadout End TS',
    [NET.OFD]: 'OFD TS',
    [NET.FC_DWELL]: 'FC Dwell Min',
    [NET.HUB_DWELL]: 'Hub Dwell Min',
    [NET.CAMP_DWELL]: 'Camp Dwell Min',
    fc_dispatch_ts: 'FC Dispatch TS',
    camp_depart_ts: 'Camp Depart TS',
    o2s_min: 'O2S Minutes',
    hub_total_dwell_min: 'Hub Total Dwell (min)',
    camp_total_dwell_min: 'Camp Total Dwell (min)',
    camp_s1_wait_min: 'Camp S1 Wait (min)',
    camp_s2_work_min: 'Camp S2 Work (min)',
    camp_s3_wait_min: 'Camp S3 Wait (min)',
    camp_wait_min: 'Camp Wait (S1+S3) (min)',
    camp_work_min: 'Camp Work (S2) (min)',
    post_fc_transit_min: 'Post FC Transit (min)',
    hub_exit_wait_min: 'Hub Exit Wait (min)',
    fc_otd_flag: 'FC OTD Flag',
    ofd_otd_flag: 'OFD OTD Flag',
    sla_breach_flag: 'SLA Breach (Recalc)',
    reason_category: 'Reason Category',
    q_ts_order_error: 'Q TS Order Error',
    q_negative_duration: 'Q Negative Duration',
    q_outlier_flag: 'Q Outlier',
    month: 'month',
    week: 'week',
    hub_dispatch_breach_flag: 'Hub P95 Breach',
    camp_s1_breach_flag: 'Camp S1 Breach',
    camp_s2_breach_flag: 'Camp S2 Breach',
    camp_s3_breach_flag: 'Camp S3 Breach',
    hub_on_time_flag: 'Hub On-time (p95)',
    camp_on_time_flag: 'Camp On-time (p95)',
    camp_dispatch_breach_flag: 'Camp Dispatch Breach (OR)',
    first_touch_breach: 'First Touch Breach',
    q_missing_key: 'Q Missing Key',
    sim_version: 'Sim Version',
    sim_seed: 'Sim Seed',
    dial_snapshot_json: 'Dials Snapshot',
    generated_at: 'Generated At',
    return_reason_norm: 'Return Reason Norm',
    is_quality_issue: 'Quality Issue Flag',
    mis_ship_flag: 'Mis-Ship Flag',
    return_unclassified_flag: 'Unclassified Return Flag',

    // ===== NEW: Cohort / CRM / Executive =====
    first_order_ts: 'first_order_ts',
    cohort_month: 'cohort_month',
    active_dt: 'active_dt',
    is_active_d7: 'is_active_d7',
    is_active_d30: 'is_active_d30',
    repurchase_d90: 'repurchase_d90',
    repurchase_d180: 'repurchase_d180',
    wow_conversion_within_90d: 'wow_conversion_within_90d',
    onboarding_quality: 'onboarding_quality',
    last_order_ts: 'last_order_ts',
    days_since_last_order: 'days_since_last_order',
    churn_band: 'churn_band',
    visit_30d: 'visit_30d',
    login_30d: 'login_30d',
    push_open_30d: 'push_open_30d',
    wishlist_30d: 'wishlist_30d',
    interest_score_30d: 'interest_score_30d',
    treatment_flag: 'treatment_flag',
    campaign_id: 'campaign_id',
    coupon_code: 'coupon_code',
    coupon_cost: 'coupon_cost',
    extra_shipping_cost: 'extra_shipping_cost',
    extra_fulfillment_cost: 'extra_fulfillment_cost',
    winback_30d_flag: 'winback_30d_flag',
    net_rev_30d: 'net_rev_30d',
    net_rev_90d: 'net_rev_90d',
    net_rev_180d: 'net_rev_180d',
    roi_30d: 'roi_30d',
    clv_roi_90d: 'clv_roi_90d',
    clv_roi_180d: 'clv_roi_180d',
    payback_days: 'payback_days',
    ltv_cac_ratio_exec: 'ltv_cac_ratio_exec'
  };
  const labelUnderscore = key => String(CSV_SPECIAL_LABELS[key] || key).replace(/\s+/g, '_');
  const prettyHeader = key => labelUnderscore(key);

  /* ---------- state ---------- */
  let DATA = [];
  let TABLE_KEYS = null;
  let WORKER = null;
  let FAST_MODE = false;
  const CHUNK_CONFIG = {defaultSize: 3000, maxMemoryRows: 150000, batchUpdateInterval: 3, gcInterval: 8};
  const RENDER_MAX_ROWS = 2000;
  let PROCESSING_STATE = {isRunning: false, shouldStop: false, startTime: null, processedRows: 0, totalRows: 0};
  let _throttleTS = 0;
  const _THROTTLE_MS = 100;
  const raf = fn => window.requestAnimationFrame ? requestAnimationFrame(fn) : setTimeout(fn, 16);
  const qs = id => document.getElementById(id);
  const setText = (id, txt) => {
    const el = qs(id);
    if (el) el.textContent = txt
  };
  const setDisabled = (id, flag) => {
    const el = qs(id);
    if (el) el.disabled = !!flag
  };
  const setDisplay = (id, show) => {
    const el = qs(id);
    if (el) el.style.display = show ? '' : 'none'
  };
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  /* ---------- Return Reason normalize ---------- */
  const QUALITY_TOKENS_RE = /(상품하자|손상|파손|불량|변질|유통기한|quality|defect|damaged|broken|expired)/i;
  const MISHIP_TOKENS_RE = /(오배송|mis[-\s_]?ship|wrong\s*item|배송\s*오류|다른\s*상품|수량\s*오류|wrong\s*qty|mis[-\s_]?pick)/i;
  const normalizeReturnReason = s => s == null ? null : String(s).trim().replace(/\s+/g, ' ').toLowerCase();

  /* ---------- UI helpers ---------- */
  function formatCurrencyKRW(n) {
    if (!isFinite(n)) return '-';
    return '₩' + Math.round(n).toLocaleString('ko-KR');
  }

  function setStatus(text, cls = 'ok') {
    const st = qs('status');
    st.textContent = text;
    st.className = 'pill ' + cls;
  }

  function showProgress(show) {
    setDisplay('progressContainer', show);
  }

  function _updateProgressUI(label, processed, total) {
    const pct = Math.min(100, Math.round(processed / Math.max(1, total) * 100));
    qs('progressFill').style.width = pct + '%';
    qs('progressText').textContent = `${label}... ${processed.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime || Date.now())) / 1000;
    const rps = processed / Math.max(0.1, elapsed);
    qs('progressStats').textContent = `속도 ${rps.toFixed(1)} r/s`;
    const remain = (total - processed) / Math.max(0.1, rps);
    qs('progressETA').textContent = `예상 완료: ${remain.toFixed(0)}s`;
  }

  function updateProgressFromState(label = 'Generating') {
    const now = Date.now();
    if (now - _throttleTS < _THROTTLE_MS) return;
    _throttleTS = now;
    raf(() => _updateProgressUI(label, PROCESSING_STATE.processedRows, PROCESSING_STATE.totalRows));
  }

  function updateExportProgress(done, total) {
    const pct = Math.min(100, Math.round(done / Math.max(1, total) * 100));
    qs('progressFill').style.width = pct + '%';
    qs('progressText').textContent = `Exporting CSV... ${done.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    qs('progressStats').textContent = '청크 진행';
    qs('progressETA').textContent = '';
  }

  /* ---------- streaming aggregator ---------- */
  const AGG = resetAgg();

  function resetAgg() {
    return {
      total: 0,
      rocket: 0,
      sameDayTotal: 0,
      sameDayOnTime: 0,
      dawnTotal: 0,
      dawnOnTime: 0,
      fastShip30: 0,
      shipUnder60: 0,
      fcSlaBreach: 0,
      shipMinutesSum: 0,
      pickPerItemSum: 0,
      packPerItemSum: 0,
      procErrRateSum: 0,
      wowCount: 0,
      wowSales: 0,
      nonWowSales: 0,
      wowOrders: 0,
      nonWowOrders: 0,
      wowChurnRisk: 0,
      wowPlusCount: 0,
      freshCount: 0,
      coldReq: 0,
      tempViol: 0,
      frozenQualitySum: 0,
      frozenCnt: 0,
      megaHub: 0,
      metro: 0,
      distanceSum: 0,
      routingSum: 0,
      aiOpt: 0,
      autoPickScoreSum: 0,
      pickTimeSum: 0,
      wmsAdvSum: 0,
      salesSum: 0,
      netProfitSum: 0,
      ltvSum: 0,
      cacSum: 0,
      uniqueCustomers: new Set(),
      churnRisk: 0,
      aiAccEqual: 0,
      onTime: 0,
      delay: 0,
      loadSum: 0,
      fuelSum: 0,
      routeSum: 0,
      exception: 0,
      returnCnt: 0,
      returnCostSum: 0,
      resellCnt: 0,
      invTurnSum: 0,
      stockoutCnt: 0,
      overstockCnt: 0,
      invAccSum: 0,
      wmsActiveCnt: 0,
      lossOrderCnt: 0,
      jejuWeatherRiskCnt: 0,
      jejuTotal: 0,
      expiryImminentCnt: 0,
      clvQ4Customers: new Set(),
      clvWowSum: 0,
      clvWowN: 0,
      clvNonWowSum: 0,
      clvNonWowN: 0,
      highBreach60Customers: new Set(),
      hubOnTimeCnt: 0,
      hubEligible: 0,
      campOnTimeCnt: 0,
      campEligible: 0,
      campDispatchBreachCnt: 0,
      fcTotalDwellSum: 0,
      cm_tp: 0,
      cm_tn: 0,
      cm_fp: 0,
      cm_fn: 0,
      qualIssueCnt: 0,
      misShipCnt: 0
    };
  }

  /* ---------- guardrails p95 ---------- */
  const Guardrails = {store: new Map(), alpha: 0.02, maxKeep: 10000};

  function macroRegionBySiDo(region) {
    if (['서울특별시', '경기도', '인천광역시'].includes(region)) return '수도권';
    if (['부산광역시', '대구광역시', '울산광역시', '경상북도', '경상남도'].includes(region)) return '영남';
    if (['대전광역시', '세종특별자치시', '충청북도', '충청남도'].includes(region)) return '충청';
    if (['광주광역시', '전북특별자치도', '전라남도'].includes(region)) return '호남';
    if (['강원특별자치도'].includes(region)) return '강원';
    if (['제주특별자치도'].includes(region)) return '제주';
    return '기타';
  }

  function daypart(h) {
    return (h >= 19 && h <= 21) ? '피크' : '비피크';
  }

  function weatherBucket(s) {
    if (s <= 0.3) return '≤0.3';
    if (s <= 0.6) return '0.3–0.6';
    return '>0.6';
  }

  function segmentKey(r) {
    const mode = r.Delivery_Mode || 'NA', route = r[NET.ROUTE_TYPE] || 'NA',
      macro = macroRegionBySiDo(r.Region || 'NA'), dp = daypart(Number(r.Order_Hour || 0));
    const wb = weatherBucket(Number(r.Weather_Severity_Score || 0));
    return POLICY.useWeatherInSegmentation ? `${mode}|${route}|${macro}|${dp}|${wb}` : `${mode}|${route}|${macro}|${dp}`;
  }

  function winsorizeP99(values) {
    if (values.length === 0) return [];
    const s = [...values].sort((a, b) => a - b);
    const i99 = Math.max(0, Math.min(s.length - 1, Math.floor(s.length * 0.99)));
    const p99 = s[i99];
    return s.map(v => Math.min(v, p99));
  }

  function quantileP(a, p) {
    if (a.length === 0) return null;
    const s = [...a].sort((x, y) => x - y);
    const pos = (s.length - 1) * p;
    const lo = Math.floor(pos), hi = Math.ceil(pos);
    if (lo === hi) return s[lo];
    return s[lo] + (s[hi] - s[lo]) * (pos - lo);
  }

  function computeP95From(values) {
    if (values.length < 20) return null;
    const w = winsorizeP99(values);
    return Math.round(quantileP(w, 0.95));
  }

  function ensureSeg(key) {
    if (!Guardrails.store.has(key)) {
      Guardrails.store.set(key, {
        arrs: {hub: [], s1: [], s2: [], s3: []},
        p95: {hub: null, s1: null, s2: null, s3: null},
        n: 0
      });
    }
    return Guardrails.store.get(key);
  }

  function pushReservoir(arr, v, cap) {
    if (v == null || !isFinite(v)) return;
    if (arr.length < cap) {
      arr.push(v);
      return;
    }
    const j = Math.floor(Math.random() * (arr.length + 1));
    if (j < arr.length) arr[j] = v;
  }

  function updateGuardrailsWithRow(row) {
    if (Number(row.SLA_Breach) === 1) return;
    const hub = safePos(row.hub_total_dwell_min), s1 = safePos(row.camp_s1_wait_min),
      s2 = safePos(row.camp_s2_work_min), s3 = safePos(row.camp_s3_wait_min);
    if (hub == null && s1 == null && s2 == null && s3 == null) return;
    const key = segmentKey(row);
    const seg = ensureSeg(key);
    if (hub != null) pushReservoir(seg.arrs.hub, hub, Guardrails.maxKeep);
    if (s1 != null) pushReservoir(seg.arrs.s1, s1, Guardrails.maxKeep);
    if (s2 != null) pushReservoir(seg.arrs.s2, s2, Guardrails.maxKeep);
    if (s3 != null) pushReservoir(seg.arrs.s3, s3, Guardrails.maxKeep);
    seg.n++;
    if (seg.arrs.hub.length >= 500 || seg.arrs.s1.length >= 500 || seg.arrs.s2.length >= 500 || seg.arrs.s3.length >= 500) {
      const p95_new = {
        hub: computeP95From(seg.arrs.hub),
        s1: computeP95From(seg.arrs.s1),
        s2: computeP95From(seg.arrs.s2),
        s3: computeP95From(seg.arrs.s3)
      };
      for (const k of ['hub', 's1', 's2', 's3']) {
        const prev = seg.p95[k], cur = p95_new[k];
        if (cur == null) continue;
        seg.p95[k] = (prev == null) ? cur : Math.round(prev * (1 - Guardrails.alpha) + cur * Guardrails.alpha);
      }
    }
  }

  function findP95For(row) {
    const k = segmentKey(row);
    const seg = Guardrails.store.get(k);
    if (seg && (seg.p95.hub || seg.p95.s1 || seg.p95.s2 || seg.p95.s3)) return seg.p95;
    const macro = macroRegionBySiDo(row.Region || 'NA');
    let agg = {hub: [], s1: [], s2: [], s3: []};
    Guardrails.store.forEach((v, key) => {
      if (key.includes(`|${macro}|`) || key.endsWith(`|${macro}`)) {
        for (const f of ['hub', 's1', 's2', 's3']) if (v.p95[f] != null) agg[f].push(v.p95[f]);
      }
    });
    const macroP95 = {
      hub: agg.hub.length ? Math.round(agg.hub.reduce((a, b) => a + b, 0) / agg.hub.length) : null,
      s1: agg.s1.length ? Math.round(agg.s1.reduce((a, b) => a + b, 0) / agg.s1.length) : null,
      s2: agg.s2.length ? Math.round(agg.s2.reduce((a, b) => a + b, 0) / agg.s2.length) : null,
      s3: agg.s3.length ? Math.round(agg.s3.reduce((a, b) => a + b, 0) / agg.s3.length) : null
    };
    if (macroP95.hub || macroP95.s1 || macroP95.s2 || macroP95.s3) return macroP95;
    let global = {hub: [], s1: [], s2: [], s3: []};
    Guardrails.store.forEach(v => {
      for (const f of ['hub', 's1', 's2', 's3']) if (v.p95[f] != null) global[f].push(v.p95[f]);
    });
    return {
      hub: global.hub.length ? Math.round(global.hub.reduce((a, b) => a + b, 0) / global.hub.length) : null,
      s1: global.s1.length ? Math.round(global.s1.reduce((a, b) => a + b, 0) / global.s1.length) : null,
      s2: global.s2.length ? Math.round(global.s2.reduce((a, b) => a + b, 0) / global.s2.length) : null,
      s3: global.s3.length ? Math.round(global.s3.reduce((a, b) => a + b, 0) / global.s3.length) : null
    };
  }

  /* ---------- derived ---------- */
  function msToMinPos(ms) {
    if (ms == null || !isFinite(ms)) return null;
    const m = Math.round(ms / 60000);
    return (m < 0) ? null : m;
  }

  function safePos(v) {
    if (v == null || !isFinite(v)) return null;
    return v < 0 ? null : v;
  }

  function recalcTimelineDerived(r) {
    const ts = k => r[k] ? new Date(r[k]).getTime() : null;
    const orderTS = ts('Order_Timestamp');
    const fcExit = ts(NET.FC_EXIT) || ts('Actual_Ship_Timestamp');
    const hubIn = ts(NET.HUB_IN), hubOut = ts(NET.HUB_OUT), campIn = ts(NET.CAMP_IN), loadS = ts(NET.LOAD_START),
      loadE = ts(NET.LOAD_END), ofd = ts(NET.OFD);
    r.fc_dispatch_ts = fcExit ? new Date(fcExit).toISOString() : null;
    r.camp_depart_ts = loadE ? new Date(loadE).toISOString() : (ofd ? new Date(ofd).toISOString() : null);
    r.o2s_min = (orderTS != null && fcExit != null) ? msToMinPos(fcExit - orderTS) : null;
    r.hub_total_dwell_min = (hubIn != null && hubOut != null) ? msToMinPos(hubOut - hubIn) : null;
    r.camp_total_dwell_min = (campIn != null && ofd != null) ? msToMinPos(ofd - campIn) : null;
    r.camp_s1_wait_min = (campIn != null && loadS != null) ? msToMinPos(loadS - campIn) : null;
    r.camp_s2_work_min = (loadS != null && loadE != null) ? msToMinPos(loadE - loadS) : null;
    r.camp_s3_wait_min = (loadE != null && ofd != null) ? msToMinPos(ofd - loadE) : null;
    r.camp_wait_min = (safePos(r.camp_s1_wait_min) || 0) + (safePos(r.camp_s3_wait_min) || 0);
    r.camp_work_min = safePos(r.camp_s2_work_min);
    r.post_fc_transit_min = (fcExit != null) ? msToMinPos(((campIn ?? hubIn) ?? null) - fcExit) : null;
    r.hub_exit_wait_min = (hubOut != null && campIn != null) ? msToMinPos(campIn - hubOut) : null;
    const planShip = ts('Planned_Ship_Timestamp');
    r.fc_otd_flag = (planShip != null && fcExit != null) ? (fcExit <= planShip ? 1 : 0) : null;
    const planDel = ts('Planned_Delivery_Timestamp');
    const actDel = ts('Delivery_Timestamp');
    r.ofd_otd_flag = (planDel != null && actDel != null) ? (actDel <= (planDel + 10 * 60000) ? 1 : 0) : null;
    r.sla_breach_flag = (r.SLA_Breach != null) ? Number(r.SLA_Breach) : null;
    r.reason_category = (r.Temperature_Violation ? 'TEMP' : (r.Damage_Flag ? 'DAMAGE' : (r.Mis_Ship_Flag ? 'MISHIP' : (r.Is_Delayed ? 'DELAY' : null))));
    r.q_ts_order_error = ((orderTS && fcExit && fcExit < orderTS) || (hubOut && hubIn && hubOut < hubIn) || (loadS && campIn && loadS < campIn) || (loadE && loadS && loadE < loadS) || (ofd && loadE && ofd < loadE)) ? 1 : 0;
    r.q_negative_duration = ([r.o2s_min, r.hub_total_dwell_min, r.camp_total_dwell_min, r.camp_s1_wait_min, r.camp_s2_work_min, r.camp_s3_wait_min].some(x => x != null && x < 0)) ? 1 : 0;
    const outlier = ((r.o2s_min != null && r.o2s_min > 1440) || (r.hub_total_dwell_min != null && r.hub_total_dwell_min > 720) || (r.camp_total_dwell_min != null && r.camp_total_dwell_min > 360));
    r.q_outlier_flag = outlier ? 1 : 0;
    try {
      const od = r.Order_Timestamp ? new Date(r.Order_Timestamp) : null;
      if (od) {
        r.month = Number(od.getMonth() + 1);
        const onejan = new Date(od.getFullYear(), 0, 1);
        r.week = Math.floor((((od - onejan) / 86400000) + onejan.getDay() + 1) / 7);
      }
    } catch (e) {
    }
    return r;
  }

  function flagBreaches(row) {
    const p95 = findP95For(row);
    row.hub_dispatch_breach_flag = (p95.hub != null && row.hub_total_dwell_min != null && row.hub_total_dwell_min > p95.hub) ? 1 : 0;
    row.camp_s1_breach_flag = (p95.s1 != null && row.camp_s1_wait_min != null && row.camp_s1_wait_min > p95.s1) ? 1 : 0;
    row.camp_s2_breach_flag = (p95.s2 != null && row.camp_s2_work_min != null && row.camp_s2_work_min > p95.s2) ? 1 : 0;
    row.camp_s3_breach_flag = (p95.s3 != null && row.camp_s3_wait_min != null && row.camp_s3_wait_min > p95.s3) ? 1 : 0;
    row.hub_on_time_flag = (p95.hub != null && row.hub_total_dwell_min != null) ? (row.hub_total_dwell_min <= p95.hub ? 1 : 0) : null;
    const campRef = ((p95.s1 ?? 0) + (p95.s2 ?? 0) + (p95.s3 ?? 0)) || null;
    const campNow = (row.camp_s1_wait_min ?? 0) + (row.camp_s2_work_min ?? 0) + (row.camp_s3_wait_min ?? 0);
    row.camp_on_time_flag = (campRef != null && isFinite(campNow)) ? (campNow <= campRef ? 1 : 0) : null;
    row.camp_dispatch_breach_flag = (row.camp_s1_breach_flag || row.camp_s2_breach_flag || row.camp_s3_breach_flag) ? 1 : 0;
    let first = null;
    if (row.hub_dispatch_breach_flag) first = 'HUB'; else if (row.camp_s1_breach_flag) first = 'CAMP_S1'; else if (row.camp_s2_breach_flag) first = 'CAMP_S2'; else if (row.camp_s3_breach_flag) first = 'CAMP_S3';
    row.first_touch_breach = first;
    return row;
  }

  /* ---------- table ---------- */
  function buildTableHeader(keys) {
    const thead = qs('tbl').querySelector('thead');
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    keys.forEach(k => {
      const th = document.createElement('th');
      th.textContent = prettyHeader(k);
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderTableRowsVirtual(rows, keys) {
    const tbody = qs('tbl').querySelector('tbody');
    const frag = document.createDocumentFragment();
    for (const r of rows) {
      const tr = document.createElement('tr');
      for (const k of keys) {
        const td = document.createElement('td');
        const v = r[k];
        td.textContent = (v === null || v === undefined) ? '' : v;
        if (k === 'Delivery_Mode') {
          td.className = 'delivery-mode ' + (v === '로켓새벽' ? 'dawn' : (v === '로켓프레시' ? 'fresh' : (String(v).includes('로켓') ? 'rocket' : '')));
        }
        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    const excess = tbody.children.length - RENDER_MAX_ROWS;
    if (excess > 0) {
      for (let i = 0; i < excess; i++) tbody.removeChild(tbody.firstChild);
    }
  }

  /* ---------- ingest ---------- */
  function ingestRows(rows) {
    if (!rows || !rows.length) return;
    for (const r of rows) {
      recalcTimelineDerived(r);
      updateGuardrailsWithRow(r);
      flagBreaches(r);

      // Return normalization & flags
      if (r.Return_Reason != null && String(r.Return_Reason).trim() !== '') r.Return_Flag = 1;
      if (r.Return_Flag === 1 && (r.Return_Reason == null || String(r.Return_Reason).trim() === '')) r.Return_Reason = '미분류';
      r.return_reason_norm = normalizeReturnReason(r.Return_Reason);
      const rrn = r.return_reason_norm;
      const qHit = (r.Return_Flag === 1) && !!rrn && QUALITY_TOKENS_RE.test(rrn);
      const mHit = (r.Return_Flag === 1) && !!rrn && MISHIP_TOKENS_RE.test(rrn);
      r.is_quality_issue = qHit ? 1 : 0;
      r.mis_ship_flag = mHit ? 1 : 0;
      r.return_unclassified_flag = (r.Return_Flag === 1) && !(qHit || mHit) ? 1 : 0;

      if (r.Temperature_Violation === 1) r.reason_category = 'TEMP';
      else if (r.is_quality_issue === 1) r.reason_category = 'QUALITY';
      else if (r.mis_ship_flag === 1) r.reason_category = 'MISHIP';
      else if (r.Is_Delayed === 1) r.reason_category = 'DELAY';
    }

    if (!TABLE_KEYS) {
      const baseKeys = Object.keys(rows[0]);
      const extraKeys = [
        'fc_dispatch_ts', 'camp_depart_ts', 'o2s_min', 'hub_total_dwell_min', 'camp_total_dwell_min',
        'camp_s1_wait_min', 'camp_s2_work_min', 'camp_s3_wait_min', 'camp_wait_min', 'camp_work_min',
        'post_fc_transit_min', 'hub_exit_wait_min', 'fc_otd_flag', 'ofd_otd_flag', 'sla_breach_flag',
        'hub_on_time_flag', 'camp_on_time_flag', 'camp_dispatch_breach_flag', 'hub_dispatch_breach_flag',
        'camp_s1_breach_flag', 'camp_s2_breach_flag', 'camp_s3_breach_flag', 'first_touch_breach', 'reason_category',
        'q_ts_order_error', 'q_negative_duration', 'q_outlier_flag', 'q_missing_key', 'sim_version', 'sim_seed', 'dial_snapshot_json', 'generated_at',
        // NEW: Cohort/CRM/Exec header pin
        'first_order_ts', 'cohort_month', 'active_dt', 'is_active_d7', 'is_active_d30',
        'repurchase_d90', 'repurchase_d180', 'wow_conversion_within_90d', 'onboarding_quality',
        'last_order_ts', 'days_since_last_order', 'churn_band',
        'visit_30d', 'login_30d', 'push_open_30d', 'wishlist_30d', 'interest_score_30d',
        'treatment_flag', 'campaign_id', 'coupon_code', 'coupon_cost', 'extra_shipping_cost', 'extra_fulfillment_cost',
        'winback_30d_flag', 'net_rev_30d', 'net_rev_90d', 'net_rev_180d', 'roi_30d', 'clv_roi_90d', 'clv_roi_180d', 'payback_days',
        'ltv_cac_ratio_exec'
      ];
      const set = new Set(baseKeys.concat(extraKeys));
      TABLE_KEYS = [...set];
      buildTableHeader(TABLE_KEYS);
    }

    for (const r of rows) {
      DATA.push(r);
      if (DATA.length > CHUNK_CONFIG.maxMemoryRows) {
        DATA.splice(0, DATA.length - CHUNK_CONFIG.maxMemoryRows);
      }
    }

    // aggregator
    for (const r of rows) {
      AGG.total++;
      if (r.Is_Rocket_Delivery === 1) AGG.rocket++;
      if (r.Delivery_Mode === '로켓당일') {
        AGG.sameDayTotal++;
        if (r.SLA_Breach === 0) AGG.sameDayOnTime++;
      }
      if (r.Delivery_Mode === '로켓새벽') {
        AGG.dawnTotal++;
        if (r.SLA_Breach === 0) AGG.dawnOnTime++;
      }
      if (r.o2s_min != null && r.o2s_min <= 30) AGG.fastShip30++;
      if (r.o2s_min != null && r.o2s_min <= 60) AGG.shipUnder60++;
      if (Number(r.sla_breach_flag) === 1) AGG.fcSlaBreach++;
      AGG.shipMinutesSum += (r.o2s_min || 0);
      AGG.pickPerItemSum += (r.Picking_Time_Seconds / Math.max(1, r.Quantity));
      AGG.packPerItemSum += (r.Packing_Time_Seconds / Math.max(1, r.Quantity));
      AGG.procErrRateSum += (r.Processing_Error_Rate || 0);

      if (r.Is_WOW_Member === 1) {
        AGG.wowCount++;
        AGG.wowSales += (r.Order_Amount || 0);
        AGG.wowOrders++;
        if (r.Is_Churn_Risk === 1) AGG.wowChurnRisk++;
        if (r.WOW_Tier === 'WOW_PLUS') AGG.wowPlusCount++;
      } else {
        AGG.nonWowSales += (r.Order_Amount || 0);
        AGG.nonWowOrders++;
      }

      if (r.Is_Fresh_Food === 1) AGG.freshCount++;
      if (r.Is_Cold_Chain_Required === 1) {
        AGG.coldReq++;
        if (r.Temperature_Violation === 1) AGG.tempViol++;
      }
      if (r.Product_Category === '냉동식품' && isFinite(r.Cold_Chain_Quality_Score)) {
        AGG.frozenQualitySum += r.Cold_Chain_Quality_Score;
        AGG.frozenCnt++;
      }

      if (r.Is_Mega_Hub === 1) AGG.megaHub++;
      if (['서울특별시', '경기도', '인천광역시'].includes(r.Region)) AGG.metro++;
      AGG.distanceSum += (r.Distance_km || 0);
      AGG.routingSum += (r.Routing_Score || 0);

      if (r.Automation_Level === 'AI_OPTIMIZED') AGG.aiOpt++;
      AGG.autoPickScoreSum += (r.Automation_Level === 'AI_OPTIMIZED' ? 90 : r.Automation_Level === 'AUTO' ? 70 : r.Automation_Level === 'SEMI_AUTO' ? 40 : 10);
      AGG.pickTimeSum += (r.Picking_Time_Seconds || 0);
      AGG.wmsAdvSum += (r.WMS_Advanced_Score || 0);

      AGG.salesSum += (r.Order_Amount || 0);
      AGG.netProfitSum += (r.Net_Profit || 0);

      AGG.ltvSum += (r.Customer_LTV || 0);
      AGG.cacSum += (r.CAC || 0);
      AGG.uniqueCustomers.add(r.Customer_ID);
      if (r.Is_Churn_Risk === 1) AGG.churnRisk++;
      if (r.Predicted_Churn_Score != null) {
        const pred = r.Predicted_Churn_Score >= 0.6 ? 1 : 0;
        const act = r.Churn_Flag === 1 ? 1 : 0;
        if (pred === 1 && act === 1) AGG.cm_tp++; else if (pred === 0 && act === 0) AGG.cm_tn++; else if (pred === 1 && act === 0) AGG.cm_fp++; else if (pred === 0 && act === 1) AGG.cm_fn++;
        if ((pred === 1) === (act === 1)) AGG.aiAccEqual++;
      }

      if (r.SLA_Breach === 0) AGG.onTime++; else AGG.delay++;
      AGG.loadSum += (r.Load_Factor || 0);
      AGG.fuelSum += (r.Fuel_Efficiency || 0);
      AGG.routeSum += (r.Routing_Score || 0);
      if (r.Temperature_Violation === 1 || Number(r.sla_breach_flag) === 1 || r.Return_Flag === 1) AGG.exception++;

      if (r.Return_Flag === 1) {
        AGG.returnCnt++;
        AGG.returnCostSum += (r.Return_Cost || 0);
        if (r.Is_Resellable === 1) AGG.resellCnt++;
      }
      if (r.is_quality_issue === 1) AGG.qualIssueCnt++;
      if (r.mis_ship_flag === 1) AGG.misShipCnt++;

      AGG.invTurnSum += (r.Inventory_Turnover || 0);
      if (r.Stockout_Flag === 1) AGG.stockoutCnt++;
      if (r.Overstock_Flag === 1) AGG.overstockCnt++;
      AGG.invAccSum += (r.Inventory_Accuracy || 0);
      if (r.WMS_Usage === 'Active') AGG.wmsActiveCnt++;

      if (r.Is_Loss_Order === 1) AGG.lossOrderCnt++;
      if (r.Region === '제주특별자치도') {
        AGG.jejuTotal++;
        if (r.Is_Weather_Risk === 1) AGG.jejuWeatherRiskCnt++;
      }
      if (r.Expiry_Date) {
        const d = (new Date(r.Expiry_Date)) - (new Date(r.Order_Date));
        if (d <= 86400000 && d >= -31536000000) AGG.expiryImminentCnt++;
      }

      if (r.clv_quartile === 4) AGG.clvQ4Customers.add(r.Customer_ID);
      if (r.Is_WOW_Member === 1) {
        AGG.clvWowSum += r.Customer_LTV || 0;
        AGG.clvWowN++;
      } else {
        AGG.clvNonWowSum += r.Customer_LTV || 0;
        AGG.clvNonWowN++;
      }
      if (r.is_high_breach_60d === 1) AGG.highBreach60Customers.add(r.Customer_ID);
      if (r.hub_on_time_flag != null) {
        AGG.hubEligible++;
        if (r.hub_on_time_flag === 1) AGG.hubOnTimeCnt++;
      }
      if (r.camp_on_time_flag != null) {
        AGG.campEligible++;
        if (r.camp_on_time_flag === 1) AGG.campOnTimeCnt++;
      }
      if (r.camp_dispatch_breach_flag === 1) AGG.campDispatchBreachCnt++;
      if (Number.isFinite(r.fc_total_dwell_min)) AGG.fcTotalDwellSum += r.fc_total_dwell_min;
    }

    renderTableRowsVirtual(rows, TABLE_KEYS);
    updateKPIsFromAgg();
    updateValidationAndRiskFromAgg();

    PROCESSING_STATE.processedRows += rows.length;
    updateProgressFromState('Generating');
  }

  function updateKPIsFromAgg() {
    const total = Math.max(1, AGG.total);
    const fmtPct = v => isFinite(v) ? (Number(v).toFixed(1) + '%') : '-';

    const rocketShare = AGG.rocket / total * 100;
    const sameDaySuccess = (AGG.sameDayTotal ? AGG.sameDayOnTime / AGG.sameDayTotal * 100 : 0);
    const dawnOnTime = (AGG.dawnTotal ? AGG.dawnOnTime / AGG.dawnTotal * 100 : 0);
    const fastShip = AGG.fastShip30 / total * 100;

    const fcOnTime = 100 - (AGG.fcSlaBreach / total * 100);
    const avgShipHr = (AGG.shipMinutesSum / total / 60);
    const pickSecPerItem = (AGG.pickPerItemSum / total);
    const packSecPerItem = (AGG.packPerItemSum / total);
    const effFulfill = clamp(100 - ((AGG.procErrRateSum / total) * 100 * 2), 0, 100);
    const shipUnder60 = (AGG.shipUnder60 / total * 100);

    const wowShare = AGG.wowCount / total * 100;
    const wowPlusShare = (AGG.wowCount ? (AGG.wowPlusCount / AGG.wowCount * 100) : 0);
    const wowAov = (AGG.wowOrders ? AGG.wowSales / AGG.wowOrders : 0);
    const nonWowAov = (AGG.nonWowOrders ? AGG.nonWowSales / AGG.nonWowOrders : 0);
    const wowAovGap = (wowAov - nonWowAov);

    const freshShare = AGG.freshCount / total * 100;
    const coldChainRate = (AGG.coldReq ? (1 - AGG.tempViol / AGG.coldReq) * 100 : 100);
    const tempViolRate = (AGG.coldReq ? (AGG.tempViol / AGG.coldReq * 100) : 0);
    const frozenQuality = (AGG.frozenCnt ? AGG.frozenQualitySum / AGG.frozenCnt : 0);

    const megaHubShare = AGG.megaHub / total * 100;
    const metroCoverage = AGG.metro / total * 100;
    const avgDist = AGG.distanceSum / total;
    const networkEff = AGG.routingSum / total;

    const aiOptimized = AGG.aiOpt / total * 100;
    const autoPickRate = AGG.autoPickScoreSum / total;
    const avgPickTime = AGG.pickTimeSum / total;
    const wmsAdvanced = AGG.wmsAdvSum / total;

    const totalSales = AGG.salesSum;
    const netMargin = (AGG.salesSum ? AGG.netProfitSum / AGG.salesSum * 100 : 0);
    const aov = (AGG.salesSum / total);
    const uniqueCust = Math.max(1, AGG.uniqueCustomers.size);
    const arppu = (AGG.salesSum / uniqueCust);

    const ltvAvg = (AGG.ltvSum / total);
    const cacAvg = (AGG.cacSum / total);
    const ltvCac = (cacAvg ? (ltvAvg / cacAvg).toFixed(2) : '0.00');

    const churnRate = AGG.churnRisk / total * 100;
    const aiAcc = AGG.aiAccEqual / total * 100;

    const onTime = AGG.onTime / total * 100;
    const sla = AGG.fcSlaBreach / total * 100;
    const load = AGG.loadSum / total;
    const fuel = AGG.fuelSum / total;
    const route = AGG.routeSum / total;
    const exception = AGG.exception / total * 100;

    const retRate = AGG.returnCnt / total * 100;
    const retCostRate = (AGG.salesSum ? AGG.returnCostSum / AGG.salesSum * 100 : 0);
    const resell = (AGG.returnCnt ? AGG.resellCnt / AGG.returnCnt * 100 : 0);

    const invTurn = AGG.invTurnSum / total;
    const stockout = AGG.stockoutCnt / total * 100;
    const overstock = AGG.overstockCnt / total * 100;
    const invAcc = AGG.invAccSum / total;
    const shrink = (100 - invAcc);
    const wmsUse = AGG.wmsActiveCnt / total * 100;

    const clvTopQ4Share = (AGG.clvQ4Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const clvWowAvg = (AGG.clvWowN ? AGG.clvWowSum / AGG.clvWowN : 0);
    const clvNonWowAvg = (AGG.clvNonWowN ? AGG.clvNonWowSum / AGG.clvNonWowN : 0);
    const clvWowGap = clvWowAvg - clvNonWowAvg;
    const highBreach60Share = (AGG.highBreach60Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const hubOnTimeP95 = (AGG.hubEligible ? AGG.hubOnTimeCnt / AGG.hubEligible * 100 : 0);
    const campOnTimeP95 = (AGG.campEligible ? AGG.campOnTimeCnt / AGG.campEligible * 100 : 0);
    const fcTotalDwellAvg = (AGG.total ? AGG.fcTotalDwellSum / AGG.total : 0);

    setText('k_rocketShare', fmtPct(rocketShare));
    setText('k_rocketSameDayRate', fmtPct(sameDaySuccess));
    setText('k_rocketDawnRate', fmtPct(dawnOnTime));
    setText('k_fastShipRate', fmtPct(fastShip));
    setText('k_hubOnTimeP95', fmtPct(hubOnTimeP95));
    setText('k_campOnTimeP95', fmtPct(campOnTimeP95));
    setText('k_campDispatchBreach', (AGG.campDispatchBreachCnt || 0).toLocaleString('ko-KR'));

    setText('k_fcOnTimeShip', fmtPct(fcOnTime));
    setText('k_fcAvgShipHour', (avgShipHr || 0).toFixed(2));
    setText('k_fcPickSecPerItem', (pickSecPerItem || 0).toFixed(1));
    setText('k_fcPackSecPerItem', (packSecPerItem || 0).toFixed(1));
    setText('k_fcEfficiency', (effFulfill || 0).toFixed(1));
    setText('k_fcShipUnder60', fmtPct(shipUnder60));
    setText('k_fcTotalDwellMinAvg', (fcTotalDwellAvg || 0).toFixed(1));

    setText('k_wowShare', fmtPct(wowShare));
    setText('k_wowPlusShare', (wowPlusShare || 0).toFixed(1));
    setText('k_wowAovGap', formatCurrencyKRW(wowAovGap));
    setText('k_wowChurnRisk', (AGG.wowChurnRisk || 0).toLocaleString('ko-KR'));
    setText('k_clvTopQ4Share', fmtPct(clvTopQ4Share));
    setText('k_clvWowGap', formatCurrencyKRW(clvWowGap));
    setText('k_highBreach60Share', fmtPct(highBreach60Share));

    setText('k_freshShare', fmtPct(freshShare));
    setText('k_coldChainRate', fmtPct(coldChainRate));
    setText('k_tempViolation', fmtPct(tempViolRate));
    setText('k_frozenQuality', (frozenQuality || 0).toFixed(0));

    setText('k_megaHubShare', fmtPct(megaHubShare));
    setText('k_seoulCoverage', fmtPct(metroCoverage));
    setText('k_avgDistance', (avgDist || 0).toFixed(1));
    setText('k_networkEff', (networkEff || 0).toFixed(0));

    setText('k_aiOptimized', fmtPct(aiOptimized));
    setText('k_autoPickRate', (autoPickRate || 0).toFixed(1));
    setText('k_avgPickTime', (avgPickTime || 0).toFixed(1));
    setText('k_wmsAdvanced', (wmsAdvanced || 0).toFixed(0));

    setText('k_totalSales', formatCurrencyKRW(totalSales));
    setText('k_netMargin', (netMargin || 0).toFixed(2));
    setText('k_aov', formatCurrencyKRW(aov));
    setText('k_arppu', formatCurrencyKRW(arppu));

    setText('k_ltvCac', ltvCac);
    setText('k_retention', (100 - churnRate).toFixed(1) + '%');
    setText('k_churn', churnRate.toFixed(1) + '%');
    setText('k_ai', aiAcc.toFixed(1) + '%');

    setText('k_onTime', fmtPct(onTime));
    setText('k_sla', fmtPct(sla));
    setText('k_load', (load || 0).toFixed(1) + '%');
    setText('k_fuel', (fuel || 0).toFixed(2));
    setText('k_route', (route || 0).toFixed(0));
    setText('k_exception', fmtPct(exception));

    setText('k_returnRate', fmtPct(retRate));
    setText('k_returnCost', retCostRate.toFixed(2) + '%');
    setText('k_resell', resell.toFixed(1) + '%');

    setText('k_invTurn', (invTurn || 0).toFixed(2));
    setText('k_stockout', stockout.toFixed(2) + '%');
    setText('k_overstock', overstock.toFixed(2) + '%');
    setText('k_invAcc', (invAcc || 0).toFixed(1) + '%');
    setText('k_shrink', (shrink || 0).toFixed(1) + '%');
    setText('k_wms', wmsUse.toFixed(1) + '%');
  }

  /* ---------- validation & risk dashboards ---------- */
  function updateValidationAndRiskFromAgg() {
    const vList = qs('validateList');
    const rList = qs('riskList');
    const pList = qs('perfList');
    vList.innerHTML = '';
    rList.innerHTML = '';
    pList.innerHTML = '';
    const add = (el, cls, msg) => {
      const d = document.createElement('div');
      d.className = `alert ${cls}`;
      d.textContent = msg;
      el.appendChild(d);
    };

    // Validations
    const sameDayOk = (AGG.sameDayTotal ? (AGG.sameDayOnTime / AGG.sameDayTotal * 100) : 100);
    if (sameDayOk >= 95) add(vList, 'good', `로켓당일 정시 ${sameDayOk.toFixed(1)}% (OK ≥95%)`);
    else add(vList, 'warn', `로켓당일 정시 ${sameDayOk.toFixed(1)}% (목표 95%)`);

    const campP95Ok = (AGG.campEligible ? (AGG.campOnTimeCnt / AGG.campEligible * 100) : 100);
    add(vList, campP95Ok >= 90 ? 'good' : 'warn', `캠프 p95 on-time ${campP95Ok.toFixed(1)}%`);

    const hubP95Ok = (AGG.hubEligible ? (AGG.hubOnTimeCnt / AGG.hubEligible * 100) : 100);
    add(vList, hubP95Ok >= 92 ? 'good' : 'warn', `허브 p95 on-time ${hubP95Ok.toFixed(1)}%`);

    const tempViolRate = (AGG.coldReq ? AGG.tempViol / AGG.coldReq * 100 : 0);
    add(vList, tempViolRate <= 2 ? 'good' : 'bad', `콜드체인 위반율 ${tempViolRate.toFixed(2)}%`);

    const netMargin = (AGG.salesSum ? AGG.netProfitSum / AGG.salesSum * 100 : 0);
    add(vList, netMargin >= Number(qs('targetNetMargin').value) ? 'good' : 'warn', `순이익률 ${netMargin.toFixed(2)}% vs 목표 ${Number(qs('targetNetMargin').value).toFixed(1)}%`);

    // Risks
    if (AGG.campDispatchBreachCnt > 0) add(rList, 'warn', `캠프 디스패치 p95 초과 ${AGG.campDispatchBreachCnt.toLocaleString('ko-KR')}건`);
    if (tempViolRate > 2) add(rList, 'bad', `온도 위반 과다 (${tempViolRate.toFixed(2)}%) — 냉장/냉동 라인 점검 필요`);
    if ((AGG.stockoutCnt / Math.max(1, AGG.total) * 100) > 3) add(rList, 'warn', `품절률 ${(AGG.stockoutCnt / AGG.total * 100).toFixed(2)}% — 수요예측/보충 로직 재점검`);
    if ((AGG.returnCnt / Math.max(1, AGG.total) * 100) > 5) add(rList, 'warn', `반품률 ${(AGG.returnCnt / AGG.total * 100).toFixed(2)}% 상승`);
    if (AGG.lossOrderCnt / Math.max(1, AGG.total) > 0.10) add(rList, 'bad', `적자 주문 비중 ${(AGG.lossOrderCnt / AGG.total * 100).toFixed(1)}% — 배송비/물류비 정책 재산정`);

    if (AGG.jejuTotal > 0) {
      const jw = AGG.jejuWeatherRiskCnt / AGG.jejuTotal * 100;
      if (jw > 12) add(rList, 'warn', `제주 악천후 영향 ${jw.toFixed(1)}% — 항공/선박 대체 SLA 확보 필요`);
    }

    // Performance & reality metrics
    add(pList, 'good', `누적 처리 ${AGG.total.toLocaleString('ko-KR')} rows, 메모리 보관 ${DATA.length.toLocaleString('ko-KR')} rows`);
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime || Date.now())) / 1000;
    if (AGG.total > 0 && elapsed > 1) add(pList, 'good', `평균 처리속도 ${(AGG.total / elapsed).toFixed(1)} rows/s`);
    add(pList, 'good', `AI 이탈 모델 정확도 ${(AGG.aiAccEqual / Math.max(1, AGG.total) * 100).toFixed(1)}% (TP:${AGG.cm_tp}, FP:${AGG.cm_fp}, TN:${AGG.cm_tn}, FN:${AGG.cm_fn})`);
    if (AGG.qualIssueCnt > 0) add(pList, 'warn', `품질 이슈 반품 ${AGG.qualIssueCnt.toLocaleString('ko-KR')}건`);
    if (AGG.misShipCnt > 0) add(pList, 'warn', `오배송 반품 ${AGG.misShipCnt.toLocaleString('ko-KR')}건`);

    const okCount = vList.querySelectorAll('.alert.good').length;
    const warnCount = vList.querySelectorAll('.alert.warn,.alert.bad').length;
    const summary = warnCount === 0 ? `검증 OK (${okCount} 항목)` : `경고/위험 ${warnCount}건, OK ${okCount}건`;
    const cls = warnCount === 0 ? 'ok' : (warnCount <= 2 ? 'running' : 'ng');
    const pill = qs('validateSummary');
    pill.textContent = summary;
    pill.className = 'pill ' + cls;
  }

  /* ---------- CSV Export ---------- */
  function escapeCSV(v) {
    if (v === null || v === undefined) return '';
    const s = String(v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function csvHeader(keys) {
    return keys.map(prettyHeader).join(',');
  }

  function serializeRow(keys, row) {
    return keys.map(k => escapeCSV(row[k])).join(',');
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);
  }

  async function exportCSV() {
    if (!TABLE_KEYS || DATA.length === 0) return;
    setStatus('EXPORTING', 'running');
    showProgress(true);
    updateExportProgress(0, DATA.length);

    const CHUNK = 20000;
    const parts = [csvHeader(TABLE_KEYS) + '\n'];
    for (let i = 0; i < DATA.length; i += CHUNK) {
      const slice = DATA.slice(i, i + CHUNK);
      const lines = slice.map(r => serializeRow(TABLE_KEYS, r)).join('\n') + '\n';
      parts.push(lines);
      updateExportProgress(Math.min(i + CHUNK, DATA.length), DATA.length);
      await new Promise(r => setTimeout(r, 0)); // yield
    }
    const blob = new Blob(parts, {type: 'text/csv;charset=utf-8'});
    downloadBlob(blob, `coupang_sim_${Date.now()}.csv`);
    setStatus('READY', 'ok');
    showProgress(false);
  }

  async function exportCSVGzip() {
    if (typeof CompressionStream === 'undefined') { // Fallback
      await exportCSV();
      return;
    }
    if (!TABLE_KEYS || DATA.length === 0) return;
    setStatus('EXPORTING (GZIP)', 'running');
    showProgress(true);
    updateExportProgress(0, DATA.length);

    const encoder = new TextEncoder();
    const passThrough = new TransformStream();
    const writer = passThrough.writable.getWriter();
    // stream write
    writer.write(encoder.encode(csvHeader(TABLE_KEYS) + '\n'));
    const CHUNK = 30000;
    for (let i = 0; i < DATA.length; i += CHUNK) {
      const slice = DATA.slice(i, i + CHUNK);
      const lines = slice.map(r => serializeRow(TABLE_KEYS, r)).join('\n') + '\n';
      await writer.write(encoder.encode(lines));
      updateExportProgress(Math.min(i + CHUNK, DATA.length), DATA.length);
      await new Promise(r => setTimeout(r, 0));
    }
    await writer.close();

    // compress
    const compressedStream = passThrough.readable.pipeThrough(new CompressionStream('gzip'));
    const blob = await new Response(compressedStream).blob();
    downloadBlob(blob, `coupang_sim_${Date.now()}.csv.gz`);
    setStatus('READY', 'ok');
    showProgress(false);
  }

  /* ---------- Worker (generator) ---------- */
  function createWorker() {
    const code = `
      const RNG = (seed)=>{ // mulberry32
        let t = seed>>>0;
        return ()=>{ t+=0x6D2B79F5; let r=t; r=Math.imul(r^r>>>15, r|1); r^=r+Math.imul(r^r>>>7, r|61); return ((r^r>>>14)>>>0)/4294967296; };
      };
      function randn(r){ // Box-Muller
        let u=0,v=0; while(u===0)u=r(); while(v===0)v=r(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
      }
      function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
      function pickWeighted(r, items){ const sum=items.reduce((a,b)=>a+b[0],0); let x=r()*sum; for(const [w,v] of items){ if((x-=w)<=0) return v; } return items[items.length-1][1]; }
      function pick(r, arr){ return arr[Math.floor(r()*arr.length)]; }

      const REGIONS = [
        {region:'서울특별시', cities:['강남구','송파구','강서구','관악구','노원구','성북구']},
        {region:'경기도', cities:['수원시','용인시','고양시','성남시','김포시','하남시']},
        {region:'인천광역시', cities:['남동구','연수구','서구']},
        {region:'부산광역시', cities:['해운대구','사하구','부산진구']},
        {region:'대구광역시', cities:['수성구','달서구']},
        {region:'광주광역시', cities:['광산구','북구']},
        {region:'대전광역시', cities:['유성구','서구']},
        {region:'세종특별자치시', cities:['새롬동','아름동']},
        {region:'충청북도', cities:['청주시','충주시']},
        {region:'충청남도', cities:['천안시','아산시']},
        {region:'전북특별자치도', cities:['전주시','군산시']},
        {region:'전라남도', cities:['순천시','여수시']},
        {region:'경상북도', cities:['포항시','경주시']},
        {region:'경상남도', cities:['창원시','김해시']},
        {region:'강원특별자치도', cities:['춘천시','원주시']},
        {region:'제주특별자치도', cities:['제주시','서귀포시']}
      ];
      const PRODUCT = [
        {cat:'식품', sub:['과자','음료','라면','쌀','생수'], fresh:false, cold:false},
        {cat:'신선식품', sub:['과일','채소','정육','수산'], fresh:true, cold:true},
        {cat:'냉동식품', sub:['냉동피자','만두','아이스크림'], fresh:true, cold:true},
        {cat:'생활용품', sub:['샴푸','세제','물티슈'], fresh:false, cold:false},
        {cat:'가전소형', sub:['전동칫솔','헤어드라이어','믹서기'], fresh:false, cold:false},
        {cat:'패션', sub:['상의','하의','양말'], fresh:false, cold:false},
      ];
      const VEHICLE_TYPES=['1톤탑차','다마스','라보','EV밴','아이스박스밴'];
      const DRIVER_GRADE=['A','B','C'];
      const WOW_TIERS=['WOW_BASIC','WOW_PLUS'];

      function tsString(d){ return new Date(d).toISOString(); }

      onmessage = async (e)=>{
        const {cmd} = e.data||{};
        if(cmd==='start'){ await run(e.data.params); }
        else if(cmd==='stop'){ self.__cancelled=true; }
      };

      async function run(params){
        const {
          startYear, endYear, userCount, orderCount, chunkSize, rocketRate, wowRate,
          targetNetMargin, fastMode, dials, seed
        } = params;

        const rand = RNG(seed||123456789);
        const startTS = Date.UTC(startYear,0,1);
        const endTS = Date.UTC(endYear,11,31,23,59,59);
        const spanDays = Math.max(1, Math.round((endTS-startTS)/86400000));

        // customer profiles
        const customers=[];
        for(let i=0;i<userCount;i++){
          const rid = pickWeighted(rand, [
            [35,'서울특별시'],[28,'경기도'],[7,'인천광역시'],[8,'부산광역시'],[6,'대구광역시'],[3,'광주광역시'],
            [3,'대전광역시'],[1,'세종특별자치시'],[3,'충청북도'],[3,'충청남도'],[2,'전북특별자치도'],[2,'전라남도'],
            [2,'경상북도'],[3,'경상남도'],[2,'강원특별자치도'],[2,'제주특별자치도']
          ]);
          const cities = REGIONS.find(r=>r.region===rid).cities;
          const city = pick(rand, cities);
          const district = '동'+String(Math.floor(rand()*20)+1).padStart(2,'0');
          const wow = rand()< (wowRate/100);
          const tier = wow? (rand()<0.22?'WOW_PLUS':'WOW_BASIC'): null;
          const cac = 2000 + Math.floor(rand()*6000);
          customers.push({
            id: 'C' + String(i+1).padStart(7,'0'), region: rid, city: city, district: district,
            wow: wow, wow_join: null, wow_tier: tier, cac: cac,
            ltv: 0, first_ts: null, last_ts: null,
            breach30: [], breach60: [], // timestamps
            last_campaign_ts: null, last_campaign_cost: 0, last_campaign_id: null,
            cohort_month: null
          });
        }

        // order allocation per customer (Poisson-ish)
        const lambda = orderCount/userCount;
        const ordersPerCustomer = customers.map(()=>Math.max(0, Math.round(lambda + randn(rand)*Math.sqrt(lambda||1))));
        // adjust to exact sum
        let sum=ordersPerCustomer.reduce((a,b)=>a+b,0);
        while(sum<orderCount){ ordersPerCustomer[Math.floor(rand()*ordersPerCustomer.length)]++; sum++; }
        while(sum>orderCount){ const idx=Math.floor(rand()*ordersPerCustomer.length); if(ordersPerCustomer[idx]>0){ ordersPerCustomer[idx]--; sum--; } }

        const rowsOut=[];
        const chunkFlush = async(force=false)=>{
          if(rowsOut.length>=chunkSize || (force && rowsOut.length)){
            postMessage({type:'rows', rows: rowsOut.splice(0, rowsOut.length)});
            await new Promise(r=>setTimeout(r,0));
          }
        };

        let processed=0;
        for(let ci=0; ci<customers.length; ci++){
          if(self.__cancelled) break;
          const c = customers[ci];
          const nOrders = ordersPerCustomer[ci];
          if(nOrders===0) continue;

          // seed first order day
          let t = startTS + Math.floor(rand()*spanDays)*86400000 + Math.floor(rand()*24)*3600000 + Math.floor(rand()*60)*60000;

          // user-level behavior knobs
          const isVIP = rand()<0.12;
          const baseAOV = isVIP? (50000 + rand()*90000) : (25000 + rand()*40000);
          const buyFreqTilt = clamp(lambda + randn(rand)*0.6, 0.1, 30); // λ variance for spacing
          const wowLikely = c.wow || (rand()< (wowRate/100)*0.2);

          for(let oi=0; oi<nOrders; oi++){
            if(self.__cancelled) break;

            // inter-purchase time ~ LogNormal/Gamma-ish (days)
            const gapDays = Math.max(0.2, (Math.exp(randn(rand)*0.6 + 1.2) - 1)); // ~ skewed right
            t += gapDays*86400000;

            if(t>endTS) t = endTS - Math.floor(rand()*10)*3600000;

            // time-of-day: peak 20~22시
            const hour = (rand()<0.45)? (19 + Math.floor(rand()*3)) : Math.floor(rand()*24);
            const minute = Math.floor(rand()*60);
            const orderTS = new Date(new Date(t).setUTCHours(hour, minute, Math.floor(rand()*60), 0)).getTime();

            // region & distances
            const region=c.region, city=c.city, district=c.district;
            const baseDist = pickWeighted(rand, [[30,3],[40,7],[20,12],[8,20],[2,35]]); // base hub-km
            const isJeju = region==='제주특별자치도';
            const weatherScore = isJeju? (0.3 + rand()*0.5) : (rand()*0.6); // jeju harsher tail

            // delivery mode
            const rocket = rand()< (rocketRate/100);
            let mode='일반배송';
            if(rocket){
              mode = pickWeighted(rand, [[50,'로켓배송'],[20,'로켓당일'],[20,'로켓새벽'],[10,'로켓프레시']]);
            }

            // product
            const p = pickWeighted(rand, [
              [24,PRODUCT[0]],[22,PRODUCT[1]],[10,PRODUCT[2]],[22,PRODUCT[3]],[12,PRODUCT[4]],[10,PRODUCT[5]]
            ]);
            const sku = 'SKU-' + p.cat + '-' + pick(rand, p.sub);

            const qty = Math.max(1, Math.round( (p.fresh?1:1.3) + rand()*3 ));
            const unitPrice = Math.round( (p.cat==='가전소형'? (70000+rand()*120000) : (p.cat==='패션'? (18000+rand()*35000) : (8000+rand()*20000))) / 10 )*10;
            const orderAmount = unitPrice * qty;

            // coldchain & temp violation
            const needCold = p.cold?1: (rand()<0.05?1:0);
            const tempViol = needCold && (rand() < clamp(dials.temp_hi - (rocket?0.004:0) + (isJeju?0.006:0), 0, 1));
            const coldQuality = needCold? Math.round(clamp(96 + randn(rand)*3 - (tempViol?8:0), 70, 100)) : 100;
            const targetTemp = needCold? (p.cat==='냉동식품'?-18:4): null;
            const actualTemp = needCold? (targetTemp + (tempViol? (p.cat==='냉동식품'? 8+rand()*6 : 6+rand()*6) : (rand()*2-1))): null;

            // WOW membership (conversion within 90d)
            if(!c.wow && wowLikely && rand()<0.04 && (!c.first_ts || (orderTS - c.first_ts) < 90*86400000)){
              c.wow = true; c.wow_join = orderTS; c.wow_tier = rand()<0.25?'WOW_PLUS':'WOW_BASIC';
            }

            // ship/fulfillment times (minutes)
            const pickSec = Math.round(clamp( (needCold? 38:30) + randn(rand)*8 - (rocket?4:0), 12, 120 ));
            const packSec = Math.round(clamp( (needCold? 32:26) + randn(rand)*6 - (rocket?3:0), 10, 100 ));
            const procErr = clamp(0.004 + (needCold?0.002:0) + (rand()*0.004), 0.001, 0.03);
            const autoLevel = pickWeighted(rand, [[18,'AI_OPTIMIZED'],[42,'AUTO'],[32,'SEMI_AUTO'],[8,'MANUAL']]);
            const wmsScore = Math.round( clamp( autoLevel==='AI_OPTIMIZED'? 92 + rand()*6 : autoLevel==='AUTO'? 82+rand()*8 : autoLevel==='SEMI_AUTO'? 65+rand()*10 : 48+rand()*12, 30, 100 ) );

            // Network timeline
            const o2sMin = clamp( rocket? (20 + rand()*40) : (80 + rand()*240), 5, 600 );
            const fcExit = orderTS + o2sMin*60000;
            const hubIn  = fcExit + (10 + rand()*60)*60000;
            const hubDwell = Math.round( clamp( 35 + randn(rand)*20 + (weatherScore*30) - (autoLevel==='AI_OPTIMIZED'?10:0), 10, 240 ) );
            const hubOut = hubIn + hubDwell*60000;
            const campIn = hubOut + (10 + rand()*60)*60000;
            const campS1 = Math.round(clamp( 18 + randn(rand)*12 + (weatherScore*15), 5, 180 ));
            const campS2 = Math.round(clamp( 25 + randn(rand)*10 - (autoLevel==='AI_OPTIMIZED'?6:0), 5, 180 ));
            const campS3 = Math.round(clamp( 15 + randn(rand)*10 + (weatherScore*12), 3, 180 ));
            const loadStart = campIn + campS1*60000;
            const loadEnd   = loadStart + campS2*60000;
            const ofd       = loadEnd + campS3*60000;

            // delivery timing: planned vs actual
            const promisedHours = mode==='로켓당일'? 12 : mode==='로켓새벽'? 8 : rocket? 24 : 48 + Math.floor(rand()*24);
            const plannedShip = orderTS + (rocket? 60*60000 : 6*3600000);
            const plannedDel  = orderTS + promisedHours*3600000 + (needCold? 0 : 0);
            const actualDel   = ofd + (20 + rand()*120)*60000;
            const delayed = actualDel > plannedDel + 10*60000 ? 1 : 0;
            const slaBreach = delayed || (tempViol? (rand()<0.25?1:0) : 0);

            // delivery fee & logistics cost
            const freeShip = c.wow || (orderAmount>=19800 && rocket);
            const custCharge = freeShip? 0 : pickWeighted(rand, [[50,1500],[35,2500],[15,4500]]);
            const distance = baseDist + (rand()*8) + (isJeju? 20+rand()*30 : 0);
            const variable = (rocket? 1400: 1800) + distance*60 + (needCold? 600:0) + (isJeju? 1200:0);
            const actualLogi = Math.round(variable);
            const fuelEfficiency = (pickWeighted(rand, [[60,8.8],[25,7.5],[10,6.5],[5,3.8]])).toFixed(2);
            const loadFactor = Math.round(clamp( 68 + randn(rand)*12 + (rocket?6:0), 35, 98 ));

            // profits (very rough P&L)
            const cogs = orderAmount * pickWeighted(rand, [[40,0.62],[40,0.68],[20,0.74]]);
            const grossProfit = orderAmount - cogs - (freeShip? 0 : 0);
            const otherOps = orderAmount * 0.06; // marketing+ops
            const netProfit = Math.round(grossProfit - actualLogi - otherOps + custCharge);
            const isLoss = netProfit<0?1:0;

            // return
            const baseReturn = p.cat==='패션'?0.07 : p.cat==='가전소형'?0.035 : p.fresh?0.018 : 0.028;
            const retFlag = rand()< baseReturn ? 1:0;
            const retReason = retFlag? pickWeighted(rand, [
              [35,'단순변심'],[22,'사이즈/규격 문제'],[16,'오배송'],[14,'상품 불량/파손'],[7,'변질/온도이슈'],[6,'기타']
            ]) : '';
            const retCost = retFlag? Math.round( orderAmount* pickWeighted(rand, [[50,0.12],[35,0.18],[15,0.28]]) + (needCold?1200:500) ) : 0;
            const resellable = retFlag? (retReason.includes('단순')||retReason.includes('사이즈')? (rand()<0.65?1:0) : (rand()<0.28?1:0)) : 0;
            const resellWhy = resellable? '패키지 양호': (retFlag? '훼손/신선도 저하':'');

            // inventory / WMS
            const invTurn = clamp( (p.fresh? 18+rand()*15 : 8+rand()*10), 1, 50 );
            const stockout = rand()<0.02?1:0;
            const overstock = rand()< clamp(dials.over_hi,0,1) ? 1:0;
            const invAcc = Math.round( clamp( 97.5 + randn(rand)*1.2 - (overstock?1.2:0) - (stockout?0.8:0), 88, 100 ) );

            // churn proxy
            const churnRisk = (Date.now()-orderTS>75*86400000) || (retFlag&&resellable===0) || isLoss? (rand()<0.6?1:0) : (rand()<0.12?1:0);
            const churnScore = clamp( (churnRisk?0.7:0.3) + rand()*0.2, 0, 1 );

            // routing score
            const routeScore = Math.round( clamp( 76 + randn(rand)*10 + (autoLevel==='AI_OPTIMIZED'? +6:0) - (weatherScore*10), 40, 100 ) );

            // campaign / winback: if long silence before this order
            let treatment_flag=0, campaign_id=null, coupon_code=null, coupon_cost=0, extra_ship_cost=0, extra_full_cost=0;
            let winback_30d_flag=0, net_rev_30d=0, net_rev_90d=0, net_rev_180d=0, roi_30d=null, clv_roi_90d=null, clv_roi_180d=null, payback_days=null;
            if(c.last_ts){
              const gap = (orderTS - c.last_ts)/86400000;
              if(gap>35 && rand()<0.45){
                // triggered a campaign BEFORE current order
                c.last_campaign_ts = orderTS - Math.floor(rand()*7)*86400000;
                c.last_campaign_id = 'CMP-'+Math.floor(rand()*9999).toString().padStart(4,'0');
                treatment_flag=1; campaign_id=c.last_campaign_id;
                coupon_code = 'C-'+Math.floor(rand()*1e6).toString(36).toUpperCase();
                coupon_cost = Math.round( pickWeighted(rand, [[60,1500],[30,3000],[10,5000]]) );
                extra_ship_cost = freeShip? 0 : 0; // keep 0; 정책상 WOW 무료 우선
                extra_full_cost = Math.round(rand()*300);
                c.last_campaign_cost = coupon_cost + extra_ship_cost + extra_full_cost;
              }
              // if campaign exists in last 30d, treat this order as response
              if(c.last_campaign_ts && (orderTS - c.last_campaign_ts)<=30*86400000){
                winback_30d_flag = 1;
                net_rev_30d = Math.max(0, netProfit - c.last_campaign_cost);
                roi_30d = (c.last_campaign_cost>0)? (net_rev_30d/c.last_campaign_cost).toFixed(2) : null;
                payback_days = Math.max(0, Math.round( (orderTS - c.last_campaign_ts)/86400000 ));
              }
              if(c.last_campaign_ts && (orderTS - c.last_campaign_ts)<=90*86400000){
                net_rev_90d = Math.max(0, netProfit - c.last_campaign_cost);
                clv_roi_90d = (c.last_campaign_cost>0)? (net_rev_90d/c.last_campaign_cost).toFixed(2):null;
              }
              if(c.last_campaign_ts && (orderTS - c.last_campaign_ts)<=180*86400000){
                net_rev_180d = Math.max(0, netProfit - c.last_campaign_cost);
                clv_roi_180d = (c.last_campaign_cost>0)? (net_rev_180d/c.last_campaign_cost).toFixed(2):null;
              }
            }

            // breach counters (rolling 30/60d)
            const nowTS = orderTS;
            const isBreach = (slaBreach?1:0) || (tempViol?1:0);
            c.breach30 = c.breach30.filter(ts=> nowTS-ts<=30*86400000);
            c.breach60 = c.breach60.filter(ts=> nowTS-ts<=60*86400000);
            if(isBreach){ c.breach30.push(nowTS); c.breach60.push(nowTS); }
            const highBreach60 = c.breach60.length>=2 ? 1:0;

            // churn band (days since last)
            const daysSinceLast = c.last_ts? Math.round((orderTS-c.last_ts)/86400000) : 0;
            const churnBand = daysSinceLast>=90? '90d+' : daysSinceLast>=60? '60-89d' : daysSinceLast>=30? '30-59d' : daysSinceLast>0? '1-29d':'NEW';

            // cohort & active
            if(!c.first_ts){ c.first_ts = orderTS; c.cohort_month = tsString(new Date(Date.UTC(new Date(orderTS).getUTCFullYear(), new Date(orderTS).getUTCMonth(), 1))); }
            const is_active_d7 = (orderTS - c.first_ts)<=7*86400000 ? 1:0;
            const is_active_d30 = (orderTS - c.first_ts)<=30*86400000 ? 1:0;

            // WOW tenure
            const wowTenureDays = c.wow && c.wow_join? Math.round((orderTS-c.wow_join)/86400000) : 0;
            const onboardingQuality = Math.round( clamp( 70 + randn(rand)*12 + (is_active_d7?10:0) + (c.wow?6:0), 40, 100) );

            // customer finance
            c.ltv += Math.max(0, netProfit);
            const ltvToCAC = (c.cac>0)? (c.ltv/c.cac).toFixed(2) : '0.00';
            const ltvQuartile = c.ltv>400000?4: c.ltv>200000?3: c.ltv>80000?2:1;

            // network meta
            const routeType = pickWeighted(rand, [[55,'정시'],[25,'완화'],[12,'우회'],[8,'리커버리']]);
            const sortHub = pick(rand, ['동탄MH','대구MH','김포MH','덕평MH','부산MH']);
            const fcName = pick(rand, ['덕평FC','김천FC','대구FC','용인FC','광주FC']);
            const campName = pick(rand, ['서울C1','서울C2','인천C1','부산C1','대전C1','대구C1']);

            const row = {
              // core ids/timestamps
              Order_ID: 'O'+Math.floor(rand()*1e12).toString(36).toUpperCase(),
              Customer_ID: c.id,
              Order_Date: new Date(orderTS).toISOString().slice(0,10),
              Order_Timestamp: tsString(orderTS),
              Order_Hour: new Date(orderTS).getUTCHours(),
              Delivery_Mode: mode,
              Planned_Ship_Timestamp: tsString(plannedShip),
              Actual_Ship_Timestamp: tsString(fcExit),
              Planned_Delivery_Timestamp: tsString(plannedDel),
              Delivery_Timestamp: tsString(actualDel),
              Planned_Delivery_Date: new Date(plannedDel).toISOString().slice(0,10),
              Actual_Delivery_Date: new Date(actualDel).toISOString().slice(0,10),

              // statuses
              Is_Delayed: delayed,
              Delay_Hours: Math.max(0, Math.round((actualDel-plannedDel)/3600000)),
              SLA_Breach: slaBreach,
              Delivery_Status: delayed? 'Delayed':'Delivered',
              Fast_Ship_30min: o2sMin<=30?1:0,
              Order_To_Ship_Minutes: Math.round(o2sMin),

              // geo
              Region: region, City: city, District: district,
              Address: city+' '+district, Exact_Address: '',

              // network / centers
              Fulfillment_Center: fcName, Delivery_Center: campName, Is_Mega_Hub: sortHub.includes('MH')?1:0,
              Base_Distance_km: Math.round(baseDist*10)/10, Distance_km: Math.round(distance*10)/10,

              // customer & WOW
              Is_WOW_Member: c.wow?1:0, WOW_Tier: c.wow? c.wow_tier:null,
              WOW_Join_Date: c.wow_join? new Date(c.wow_join).toISOString().slice(0,10): null,
              WOW_Tenure_Days: wowTenureDays,

              Customer_Segment: isVIP?'VIP':'GEN',

              // product
              Product_Category: p.cat, SKU: sku, ABC_Category: pick(rand,['A','B','C']),
              Unit_Price: unitPrice, Quantity: qty, Order_Amount: orderAmount,

              // cold chain
              Is_Fresh_Food: p.fresh?1:0, Is_Cold_Chain_Required: needCold?1:0,
              Target_Temperature: targetTemp, Actual_Temperature: actualTemp,
              Temperature_Violation: tempViol?1:0, Cold_Chain_Quality_Score: coldQuality,

              // fleet
              Vehicle_ID: 'V'+Math.floor(rand()*1e7).toString(36).toUpperCase(),
              Vehicle_Type: pick(rand,VEHICLE_TYPES),
              Vehicle_Capacity: pickWeighted(rand, [[40,700],[40,1000],[20,1400]]),
              Driver_ID: 'D'+Math.floor(rand()*1e6).toString(36).toUpperCase(),
              Driver_Grade: pick(rand,DRIVER_GRADE),
              Load_Factor: loadFactor,
              Fuel_Efficiency: Number(fuelEfficiency),
              Routing_Score: routeScore, GPS_Tracking: 'Enabled',

              // finance
              Actual_Logistics_Cost: actualLogi,
              Customer_Delivery_Charge: custCharge,
              Gross_Profit: Math.round(grossProfit),
              Net_Profit: netProfit,
              CAC: c.cac,
              Customer_LTV: Math.round(c.ltv),
              LTV_to_CAC: ltvToCAC,

              clv_quartile: ltvQuartile, clv_quartile_label: 'Q'+ltvQuartile,
              cust_breach_30d_cnt: c.breach30.length, cust_breach_60d_cnt: c.breach60.length, is_high_breach_60d: highBreach60,

              // returns
              Return_Flag: retFlag, Return_Reason: retReason, Return_Cost: retCost,
              Is_Resellable: resellable, Resellability_Reason: resellWhy,

              // inventory
              Current_Stock: Math.round(20+rand()*200),
              Reorder_Point: Math.round(10+rand()*50),
              Stockout_Flag: stockout,
              Overstock_Flag: overstock,
              Inventory_Turnover: Math.round(invTurn*10)/10,
              Inventory_Accuracy: invAcc,

              // automation & WMS
              Automation_Level: autoLevel,
              Picking_Time_Seconds: pickSec,
              Packing_Time_Seconds: packSec,
              Total_Process_Time: pickSec+packSec,
              WMS_Usage: rand()<0.82? 'Active':'Idle',
              OMS_Usage: 'Active',
              WMS_Advanced_Score: wmsScore,
              Service_Quality_Score: Math.round( clamp( 88 + randn(rand)*6 - (delayed?5:0) - (tempViol?6:0), 60, 100 ) ),
              Customer_NPS: Math.round( clamp( 48 + randn(rand)*20 + (delayed?-10:0) + (resellable?+4:0), -100, 100 ) ),
              Processing_Error_Rate: procErr,

              // weather
              Weather_Condition: weatherScore>0.6? '악천후' : weatherScore>0.3? '보통':'양호',
              Weather_Severity_Score: Math.round(weatherScore*100)/100,
              Is_Weather_Risk: weatherScore>0.6?1:0,

              // churn model
              Churn_Flag: churnRisk?1:0,
              Predicted_Churn_Score: Number(churnScore.toFixed(3)),

              // booleans
              Is_Rocket_Delivery: rocket?1:0,
              Is_Same_Day_Delivery: mode==='로켓당일'?1:0,
              Is_Dawn_Delivery: mode==='로켓새벽'?1:0,
              Is_Fresh_Delivery: mode==='로켓프레시'?1:0,
              Is_Premium_Order: isVIP?1:0,
              Is_Bulk_Order: qty>=6?1:0,
              Is_Weekend_Order: [0,6].includes(new Date(orderTS).getUTCDay())?1:0,
              Is_Peak_Hour_Order: (hour>=19 && hour<=21)?1:0,
              Is_Free_Shipping: freeShip?1:0,
              Is_Long_Distance: distance>30?1:0,
              Is_High_LTV: c.ltv>150000?1:0,
              Is_Churn_Risk: churnRisk?1:0,
              Is_VIP_Customer: isVIP?1:0,
              Is_Loss_Order: isLoss,

              // inbound & storage (lightweight)
              Receiving_Date: new Date(orderTS-2*86400000).toISOString().slice(0,10),
              Putaway_Date: new Date(orderTS-86400000).toISOString().slice(0,10),
              Lot_ID: 'LOT'+Math.floor(rand()*1e8).toString(36).toUpperCase(),
              Expiry_Date: p.fresh? new Date(orderTS + (5+Math.floor(rand()*20))*86400000).toISOString().slice(0,10) : null,
              Bin: 'B-'+Math.floor(rand()*200),
              Slot: 'S-'+Math.floor(rand()*500),
              Unit_Cost: Math.round(unitPrice* pickWeighted(rand, [[40,0.6],[40,0.68],[20,0.74]]) ),

              Daily_OnHand_Snapshot: Math.round(100+rand()*900),
              Safety_Stock: Math.round(25+rand()*75),
              Forecast_Demand: Math.round(80+rand()*220),
              ASN_ID: 'ASN'+Math.floor(rand()*1e9).toString(36).toUpperCase(),
              PO_ID: 'PO'+Math.floor(rand()*1e9).toString(36).toUpperCase(),
              Replenishment_Type: pick(rand,['Auto','Manual']),

              // FC detailed steps
              Picking_Start_TS: tsString(orderTS + 10*60000),
              Picking_End_TS: tsString(orderTS + 10*60000 + pickSec*1000),
              Packing_Start_TS: tsString(orderTS + 15*60000 + pickSec*1000),
              Packing_End_TS: tsString(orderTS + 15*60000 + pickSec*1000 + packSec*1000),

              QC_Start_TS: tsString(orderTS + 20*60000),
              QC_End_TS: tsString(orderTS + 20*60000 + 5*60000),
              Label_Start_TS: tsString(orderTS + 26*60000),
              Label_End_TS: tsString(orderTS + 29*60000),
              Staging_In_TS: tsString(orderTS + 35*60000),
              Staging_Out_TS: tsString(orderTS + 55*60000),
              Dock_Assign_TS: tsString(orderTS + 45*60000),
              Dock_Arrive_TS: tsString(orderTS + 50*60000),
              Dock_Release_TS: tsString(orderTS + 60*60000),
              Security_Gate_Out_TS: tsString(orderTS + 65*60000),

              qc_min: 5, label_min: 3, staging_min: 20, dock_wait_min: 10,
              fc_total_dwell_min: Math.round(o2sMin + 20 + pickSec/60 + packSec/60),
              residual_fc_internal_min: Math.round( pickSec/60 + packSec/60 ),

              // Network timestamps
              __net_FC_Exit_TS: tsString(fcExit),
              __net_Hub_In_TS: tsString(hubIn),
              __net_Hub_Out_TS: tsString(hubOut),
              __net_Camp_In_TS: tsString(campIn),
              __net_Loadout_Start_TS: tsString(loadStart),
              __net_Loadout_End_TS: tsString(loadEnd),
              __net_OFD_TS: tsString(ofd),
              __net_Route_Type: routeType,
              __net_Sortation_Hub_Name: sortHub,

              __net_FC_Dwell_Min: Math.round(o2sMin),
              __net_Hub_Dwell_Min: hubDwell,
              __net_Camp_Dwell_Min: campS1+campS2+campS3,

              // Cohort / CRM / Exec
              first_order_ts: tsString(c.first_ts),
              cohort_month: c.cohort_month,
              active_dt: tsString(orderTS),
              is_active_d7: is_active_d7,
              is_active_d30: is_active_d30,
              repurchase_d90: (c.first_ts && (orderTS-c.first_ts)<=90*86400000 && oi>0)?1:0,
              repurchase_d180: (c.first_ts && (orderTS-c.first_ts)<=180*86400000 && oi>0)?1:0,
              wow_conversion_within_90d: (c.wow && c.wow_join && (c.wow_join - c.first_ts)<=90*86400000)?1:0,
              onboarding_quality: onboardingQuality,
              last_order_ts: c.last_ts? tsString(c.last_ts): null,
              days_since_last_order: daysSinceLast,
              churn_band: churnBand,
              visit_30d: Math.round( clamp( 3 + rand()*10 + (isVIP?+4:0), 0, 100 )),
              login_30d: Math.round( clamp( 2 + rand()*8 + (c.wow?+3:0), 0, 100 )),
              push_open_30d: Math.round( clamp( 1 + rand()*6, 0, 100 )),
              wishlist_30d: Math.round( clamp( rand()*5, 0, 50 )),
              interest_score_30d: Math.round( clamp( 40 + randn(rand)*15 + (isVIP?+10:0), 0, 100 )),
              treatment_flag, campaign_id, coupon_code,
              coupon_cost, extra_shipping_cost: extra_ship_cost, extra_fulfillment_cost: extra_full_cost,
              winback_30d_flag, net_rev_30d, net_rev_90d, net_rev_180d, roi_30d, clv_roi_90d, clv_roi_180d, payback_days,
              ltv_cac_ratio_exec: ltvToCAC,

              // meta
              q_missing_key: 0,
              sim_version: 'v2025-11+ops+clv',
              sim_seed: seed,
              dial_snapshot_json: JSON.stringify(dials),
              generated_at: new Date().toISOString()
            };

            rowsOut.push(row);
            c.last_ts = orderTS;

            processed++;
            if(processed%1000===0) postMessage({ type: 'progress', processed, total: orderCount });

            if(rowsOut.length>=${CHUNK_CONFIG.defaultSize}) await chunkFlush(false);
          } // orders

          await chunkFlush(false);
        } // customers

        await chunkFlush(true);
        postMessage({type:'done', processed});
      }
    `;
    const blob = new Blob([code], {type: 'application/javascript'});
    return new Worker(URL.createObjectURL(blob));
  }

  /* ---------- Controls & wiring ---------- */
  const DIALS = {
    loss_lo: Number(qs('dial_loss_lo').value),
    loss_hi: Number(qs('dial_loss_hi').value),
    temp_lo: Number(qs('dial_temp_lo').value),
    temp_hi: Number(qs('dial_temp_hi').value),
    jeju_lo: Number(qs('dial_jeju_lo').value),
    jeju_hi: Number(qs('dial_jeju_hi').value),
    over_lo: Number(qs('dial_over_lo').value),
    over_hi: Number(qs('dial_over_hi').value),
    exp_lo: Number(qs('dial_exp_lo').value),
    exp_hi: Number(qs('dial_exp_hi').value)
  };

  function readDials() {
    DIALS.loss_lo = Number(qs('dial_loss_lo').value);
    DIALS.loss_hi = Number(qs('dial_loss_hi').value);
    DIALS.temp_lo = Number(qs('dial_temp_lo').value);
    DIALS.temp_hi = Number(qs('dial_temp_hi').value);
    DIALS.jeju_lo = Number(qs('dial_jeju_lo').value);
    DIALS.jeju_hi = Number(qs('dial_jeju_hi').value);
    DIALS.over_lo = Number(qs('dial_over_lo').value);
    DIALS.over_hi = Number(qs('dial_over_hi').value);
    DIALS.exp_lo = Number(qs('dial_exp_lo').value);
    DIALS.exp_hi = Number(qs('dial_exp_hi').value);
  }

  function resetAggAll() {
    DATA.length = 0;
    TABLE_KEYS = null;
    Guardrails.store.clear();
    const keys = Object.keys(AGG);
    for (const k of keys) {
      if (AGG[k] instanceof Set) AGG[k].clear();
      else if (typeof AGG[k] === 'number') AGG[k] = 0;
      else AGG[k] = (AGG[k] instanceof Set) ? new Set() : 0;
    }
    updateKPIsFromAgg();
    updateValidationAndRiskFromAgg();
    const tbody = qs('tbl').querySelector('tbody');
    tbody.innerHTML = '';
  }

  function populateYears() {
    const now = new Date().getUTCFullYear();
    const ys = [now - 5, now - 4, now - 3, now - 2, now - 1, now, now + 1];
    const sY = qs('startYear'), eY = qs('endYear');
    sY.innerHTML = '';
    eY.innerHTML = '';
    ys.forEach(y => {
      const o1 = document.createElement('option');
      o1.value = y;
      o1.textContent = y;
      sY.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = y;
      o2.textContent = y;
      eY.appendChild(o2);
    });
    sY.value = now - 1;
    eY.value = now;
  }

  function toggleTunePanel() {
    const p = qs('tunePanel');
    p.style.display = (p.style.display === 'none' ? 'block' : 'none');
  }

  function startGeneration() {
    if (PROCESSING_STATE.isRunning) return;
    readDials();
    resetAggAll();

    const startYear = Number(qs('startYear').value);
    const endYear = Number(qs('endYear').value);
    const userCount = Number(qs('userCount').value);
    const orderCount = Number(qs('orderCount').value);
    const chunkSize = Number(qs('chunkSize').value);
    const rocketRate = Number(qs('rocketRate').value);
    const wowRate = Number(qs('wowRate').value);
    const targetNetMargin = Number(qs('targetNetMargin').value);
    FAST_MODE = qs('fastMode').checked;

    WORKER = createWorker();
    PROCESSING_STATE = {
      isRunning: true,
      shouldStop: false,
      startTime: Date.now(),
      processedRows: 0,
      totalRows: orderCount
    };
    setStatus('RUNNING', 'running');
    showProgress(true);
    setDisabled('btnStart', true);
    setDisabled('btnStop', false);
    setDisabled('btnCsv', true);
    setDisabled('btnCsvTurbo', true);

    WORKER.onmessage = (e) => {
      const {type} = e.data || {};
      if (type === 'rows') {
        ingestRows(e.data.rows);
      } else if (type === 'progress') {
        PROCESSING_STATE.processedRows = e.data.processed;
        PROCESSING_STATE.totalRows = e.data.total;
        updateProgressFromState('Generating');
      } else if (type === 'done') {
        PROCESSING_STATE.isRunning = false;
        setStatus('DONE', 'ok');
        showProgress(false);
        setDisabled('btnStart', false);
        setDisabled('btnStop', true);
        setDisabled('btnCsv', false);
        setDisabled('btnCsvTurbo', false);
        try {
          WORKER.terminate();
        } catch (_) {
        }
      }
    };

    WORKER.postMessage({
      cmd: 'start', params: {
        startYear, endYear, userCount, orderCount, chunkSize, rocketRate, wowRate, targetNetMargin,
        fastMode: FAST_MODE, dials: {...DIALS}, seed: Math.floor(Math.random() * 1e9)
      }
    });
  }

  function stopGeneration() {
    if (WORKER) {
      try {
        WORKER.postMessage({cmd: 'stop'});
        WORKER.terminate();
      } catch (_) {
      }
      WORKER = null;
    }
    PROCESSING_STATE.isRunning = false;
    setStatus('STOPPED', 'ng');
    showProgress(false);
    setDisabled('btnStart', false);
    setDisabled('btnStop', true);
    setDisabled('btnCsv', DATA.length === 0);
    setDisabled('btnCsvTurbo', DATA.length === 0);
  }

  /* ---------- Event bindings ---------- */
  qs('btnStart').addEventListener('click', startGeneration);
  qs('btnStop').addEventListener('click', stopGeneration);
  qs('btnCsv').addEventListener('click', exportCSV);
  qs('btnCsvTurbo').addEventListener('click', exportCSVGzip);
  qs('btnTune').addEventListener('click', toggleTunePanel);
  qs('btnApplyDials').addEventListener('click', () => {
    readDials();
    qs('tuneStatus').textContent = 'APPLIED';
    setTimeout(() => qs('tuneStatus').textContent = 'DIALS READY', 1000);
  });
  qs('btnResetDials').addEventListener('click', () => {
    qs('dial_loss_lo').value = '0.07';
    qs('dial_loss_hi').value = '0.12';
    qs('dial_temp_lo').value = '0.01';
    qs('dial_temp_hi').value = '0.02';
    qs('dial_jeju_lo').value = '0.10';
    qs('dial_jeju_hi').value = '0.15';
    qs('dial_over_lo').value = '0.15';
    qs('dial_over_hi').value = '0.25';
    qs('dial_exp_lo').value = '0.005';
    qs('dial_exp_hi').value = '0.01';
    readDials();
    qs('tuneStatus').textContent = 'RESET';
    setTimeout(() => qs('tuneStatus').textContent = 'DIALS READY', 1000);
  });

  // init
  populateYears();
  setDisabled('btnCsv', true);
  setDisabled('btnCsvTurbo', true);
  setStatus('READY', 'ok');
</script>




</body>
</html>
