<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ - í˜„ì‹¤ì„± 95% | Coupang Logistics Reality Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #fff;
      --ink: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --pri: #2563eb;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --vio: #8b5cf6;
      --cyan: #06b6d4;
      --rocket: #ff6b35;
      --wow: #9333ea;
      --fresh: #059669
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px
    }

    .header {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #9333ea 100%);
      color: #fff;
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 20px;
      box-shadow: 0 12px 32px rgba(255, 107, 53, .25);
      position: relative;
      overflow: hidden
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, .05) 10px, rgba(255, 255, 255, .05) 20px);
      animation: slide 20s linear infinite
    }

    @keyframes slide {
      0% {
        transform: translateX(-50px)
      }
      100% {
        transform: translateX(50px)
      }
    }

    .header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
      position: relative;
      z-index: 1
    }

    .header .sub {
      opacity: .9;
      font-size: 14px;
      position: relative;
      z-index: 1
    }

    .header .reality-badge {
      position: absolute;
      top: 20px;
      right: 30px;
      background: rgba(255, 255, 255, .2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(255, 255, 255, .3)
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 6px 20px rgba(2, 6, 23, .08)
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end
    }

    .ctrl {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .ctrl label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600
    }

    .ctrl input, .ctrl select {
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      min-width: 130px
    }

    .btn {
      background: var(--pri);
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all .3s
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, .3)
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none
    }

    .btn.secondary {
      background: #374151
    }

    .btn.danger {
      background: var(--bad)
    }

    .btn.rocket {
      background: var(--rocket)
    }

    .btn.wow {
      background: var(--wow)
    }

    .progress-container {
      margin: 12px 0;
      display: none
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: var(--line);
      border-radius: 6px;
      overflow: hidden
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, var(--rocket), var(--wow));
      width: 0%;
      transition: width .3s ease
    }

    .progress-text {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
      font-weight: 600
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px
    }

    .kpi-grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      position: relative;
      transition: transform .3s
    }

    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(2, 6, 23, .12)
    }

    .kpi h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .4px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .kpi .v {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px
    }

    .kpi .meta {
      font-size: 11px;
      color: var(--muted)
    }

    .kpi.primary {
      border-top: 4px solid var(--pri)
    }

    .kpi.good {
      border-top: 4px solid var(--good)
    }

    .kpi.warn {
      border-top: 4px solid var(--warn)
    }

    .kpi.bad {
      border-top: 4px solid var(--bad)
    }

    .kpi.rocket {
      border-top: 4px solid var(--rocket)
    }

    .kpi.wow {
      border-top: 4px solid var(--wow)
    }

    .kpi.fresh {
      border-top: 4px solid var(--fresh)
    }

    .kpi.cyan {
      border-top: 4px solid var(--cyan)
    }

    .rocket-badge, .wow-badge, .fresh-badge {
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700
    }

    .rocket-badge {
      background: var(--rocket)
    }

    .wow-badge {
      background: var(--wow)
    }

    .fresh-badge {
      background: var(--fresh)
    }

    .sections {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));
      gap: 18px;
      margin-top: 12px
    }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px
    }

    .section h3 {
      margin: 0 0 12px 0;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .alerts {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 280px;
      overflow: auto
    }

    .alert {
      padding: 12px 15px;
      border-radius: 12px;
      font-size: 13px;
      border: 1px solid;
      transition: all .3s
    }

    .alert:hover {
      transform: translateX(4px)
    }

    .alert.good {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #065f46
    }

    .alert.warn {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e
    }

    .alert.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b
    }

    .alert.rocket {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #c2410c
    }

    .table-wrap {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 0;
      margin-top: 18px;
      overflow: hidden
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      border-bottom: 2px solid var(--line)
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      white-space: nowrap
    }

    th {
      font-weight: 700;
      color: var(--ink)
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600
    }

    .pill.ok {
      background: #dcfce7;
      color: #065f46
    }

    .pill.ng {
      background: #fee2e2;
      color: #991b1b
    }

    .pill.running {
      background: #dbeafe;
      color: #1e40af
    }

    .delivery-mode {
      font-weight: 600
    }

    .delivery-mode.rocket {
      color: var(--rocket)
    }

    .delivery-mode.dawn {
      color: var(--wow)
    }

    .delivery-mode.fresh {
      color: var(--fresh)
    }

    .wow-member {
      background: linear-gradient(45deg, var(--wow), var(--pri));
      color: #fff;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px
    }

    .temp-indicator {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px
    }

    .temp-frozen {
      background: #3b82f6;
      color: #fff
    }

    .temp-cold {
      background: #06b6d4;
      color: #fff
    }

    .temp-normal {
      background: #6b7280;
      color: #fff
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: flex-start
      }

      .ctrl input, .ctrl select {
        min-width: 280px
      }

      .sections {
        grid-template-columns:1fr
      }

      .kpi-grid {
        grid-template-columns:repeat(auto-fit, minmax(250px, 1fr))
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1
      }
      50% {
        opacity: .7
      }
    }

    .pulse {
      animation: pulse 2s infinite
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="reality-badge">í˜„ì‹¤ì„± 95%</div>
    <h1>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ (Coupang Logistics Reality Simulator)</h1>
    <div class="sub">ğŸ¯ ë¡œì¼“ë°°ì†¡Â·ì‹ ì„ ì‹í’ˆÂ·WOWÂ·AIìë™í™” | FCÂ·í—ˆë¸Œ ë¶„ë¦¬ | í—ˆë¸Œ ê²½ìœ  íƒ€ì„ë¼ì¸ | ì…ê³ Â·ì ì¹˜Â·Lot/ìœ í†µê¸°í•œ ì»¬ëŸ¼ ì¶”ê°€</div>
  </div>

  <div class="panel">
    <div class="controls">
      <div class="ctrl"><label>ì‹œì‘ë…„ë„ / Start Year</label><select id="startYear"></select></div>
      <div class="ctrl"><label>ì¢…ë£Œë…„ë„ / End Year</label><select id="endYear"></select></div>
      <div class="ctrl"><label>ê³ ê° ìˆ˜ / #Users</label><input id="userCount" type="number" min="100" max="200000"
                                                           value="15000"></div>
      <div class="ctrl"><label>ì£¼ë¬¸ ìˆ˜ / #Orders</label><input id="orderCount" type="number" min="500" max="10000000"
                                                            step="1000" value="75000"></div>
      <div class="ctrl"><label>ì²­í¬ í¬ê¸° / Chunk Size</label><input id="chunkSize" type="number" min="500" max="15000"
                                                                step="500" value="3000"></div>
      <div class="ctrl"><label>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘ / Rocket Rate (%)</label><input id="rocketRate" type="number" min="35" max="90"
                                                                       value="55"></div>
      <div class="ctrl"><label>WOW ê°€ì…ë¥  / WOW Rate (%)</label><input id="wowRate" type="number" min="60" max="100"
                                                                    value="80"></div>
      <div class="ctrl">
        <label>ëª©í‘œ ìˆœì´ìµë¥ (%)</label>
        <input id="targetNetMargin" type="number" step="0.1" value="3.2" min="-20" max="30">
      </div>

      <button class="btn rocket" id="btnStart">â–¶ï¸ ë°ì´í„° ìƒì„± / Generate</button>


      <button class="btn secondary" id="btnTune">âš™ï¸ DIALS</button>

      <button class="btn danger" id="btnStop" disabled style="display:none">â¹ï¸ ì¤‘ë‹¨ / Stop</button>
      <button class="btn wow" id="btnCsv" disabled>ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ / Download CSV</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘... / Processing...</div>
      <div class="progress-stats"><span id="progressStats">-</span><span id="progressETA">ì˜ˆìƒ ì™„ë£Œ: - / ETA: -</span></div>
    </div>
  </div>

  <div class="panel" id="tunePanel" style="display:none">
    <div class="controls" style="align-items:flex-start">
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœì†Œ</label><input id="dial_loss_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.07"></div>
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœëŒ€</label><input id="dial_loss_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.12"></div>

      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœì†Œ</label><input id="dial_temp_lo" type="number" step="0.001" min="0" max="1"
                                                      value="0.01"></div>
      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœëŒ€</label><input id="dial_temp_hi" type="number" step="0.001" min="0" max="1"
                                                      value="0.02"></div>

      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœì†Œ</label><input id="dial_jeju_lo" type="number" step="0.001" min="0" max="1"
                                                       value="0.10"></div>
      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœëŒ€</label><input id="dial_jeju_hi" type="number" step="0.001" min="0" max="1"
                                                       value="0.15"></div>

      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœì†Œ</label><input id="dial_over_lo" type="number" step="0.001" min="0" max="1"
                                                    value="0.15"></div>
      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœëŒ€</label><input id="dial_over_hi" type="number" step="0.001" min="0" max="1"
                                                    value="0.25"></div>

      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœì†Œ</label><input id="dial_exp_lo" type="number" step="0.001" min="0" max="1"
                                                        value="0.005"></div>
      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœëŒ€</label><input id="dial_exp_hi" type="number" step="0.001" min="0" max="1"
                                                        value="0.01"></div>
    </div>

    <div class="controls">
      <button class="btn wow" id="btnApplyDials">ì ìš©</button>
      <button class="btn secondary" id="btnResetDials">ì´ˆê¸°í™”</button>
      <div id="tuneStatus" class="pill ok">DIALS READY</div>
    </div>
  </div>


  <!-- KPI ì„¹ì…˜ (ì›ë³¸ ìœ ì§€) -->
  <div class="sections">
    <div class="section">
      <h3>ğŸš€ ë¡œì¼“ë°°ì†¡ ì„±ê³¼ / Rocket Delivery Performance</h3>
      <div class="kpi-grid">
        <div class="kpi rocket"><h4>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘</h4>
          <div class="v" id="k_rocketShare">-</div>
          <div class="meta">% of total orders</div>
        </div>
        <div class="kpi rocket"><h4>ë¡œì¼“ë‹¹ì¼ ì„±ê³µë¥ </h4>
          <div class="v" id="k_rocketSameDayRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>ë¡œì¼“ìƒˆë²½ ì •ì‹œìœ¨</h4>
          <div class="v" id="k_rocketDawnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi rocket"><h4>30ë¶„ë‚´ ì¶œê³ ìœ¨</h4>
          <div class="v" id="k_fastShipRate">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>

    <!-- âœ… FC Fulfillment KPIs -->
    <div class="section">
      <h3>ğŸ“¦ ì¶œê³ Â·í’€í•„ë¨¼íŠ¸ / Fulfillment</h3>
      <div class="kpi-grid">
        <div class="kpi primary">
          <h4>ì •ì‹œ ì¶œê³ ìœ¨ / ON-TIME SHIPMENT</h4>
          <div class="v" id="k_fcOnTimeShip">-</div>
          <div class="meta">ëª©í‘œ â‰¥ 96%</div>
        </div>
        <div class="kpi">
          <h4>í‰ê·  ì¶œê³  ì‹œê°„ / AVG SHIP TIME</h4>
          <div class="v" id="k_fcAvgShipHour">-</div>
          <div class="meta">ì‹œê°„</div>
        </div>
        <div class="kpi">
          <h4>í”¼í‚¹ ì†ë„ / PICKING SPEED</h4>
          <div class="v" id="k_fcPickSecPerItem">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi">
          <h4>íŒ¨í‚¹ ì†ë„ / PACKING SPEED</h4>
          <div class="v" id="k_fcPackSecPerItem">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi good">
          <h4>í’€í•„ë¨¼íŠ¸ íš¨ìœ¨ / FULFILLMENT EFFICIENCY</h4>
          <div class="v" id="k_fcEfficiency">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow">
          <h4>60ë¶„ë‚´ ì¶œê³ ìœ¨ / &lt;60MIN SHIP RATE</h4>
          <div class="v" id="k_fcShipUnder60">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ğŸŒŸ WOW ë©¤ë²„ì‹­ & í”„ë¦¬ë¯¸ì—„</h3>
      <div class="kpi-grid">
        <div class="kpi wow"><h4>WOW ê°€ì…ë¥ </h4>
          <div class="v" id="k_wowShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>WOW Plus ë¹„ì¤‘</h4>
          <div class="v" id="k_wowPlusShare">0</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi wow"><h4>WOW vs ë¹„íšŒì› AOV ì°¨ì´</h4>
          <div class="v" id="k_wowAovGap">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi warn"><h4>WOW ì´íƒˆ ìœ„í—˜ ê³ ê°</h4>
          <div class="v" id="k_wowChurnRisk">-</div>
          <div class="meta">ëª…</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>â„ï¸ ì‹ ì„ ì‹í’ˆ & ì½œë“œì²´ì¸</h3>
      <div class="kpi-grid">
        <div class="kpi fresh"><h4>ì‹ ì„ ì‹í’ˆ ë¹„ì¤‘</h4>
          <div class="v" id="k_freshShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>ì½œë“œì²´ì¸ ì¤€ìˆ˜ìœ¨</h4>
          <div class="v" id="k_coldChainRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi warn"><h4>ì˜¨ë„ ìœ„ë°˜ìœ¨</h4>
          <div class="v" id="k_tempViolation">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi fresh"><h4>ëƒ‰ë™ì‹í’ˆ í’ˆì§ˆ ì ìˆ˜</h4>
          <div class="v" id="k_frozenQuality">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ­ í—ˆë¸Œ&ìŠ¤í¬í¬ ë¬¼ë¥˜ë§</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ë©”ê°€í—ˆë¸Œ ì²˜ë¦¬ ë¹„ì¤‘</h4>
          <div class="v" id="k_megaHubShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi primary"><h4>ìˆ˜ë„ê¶Œ ì»¤ë²„ë¦¬ì§€</h4>
          <div class="v" id="k_seoulCoverage">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>í‰ê·  ë°°ì†¡ ê±°ë¦¬</h4>
          <div class="v" id="k_avgDistance">-</div>
          <div class="meta">km</div>
        </div>
        <div class="kpi primary"><h4>ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±</h4>
          <div class="v" id="k_networkEff">-</div>
          <div class="meta">ì </div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ¤– AI & ìë™í™” ìˆ˜ì¤€</h3>
      <div class="kpi-grid">
        <div class="kpi cyan"><h4>AI ìµœì í™” ë¹„ìœ¨</h4>
          <div class="v" id="k_aiOptimized">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi cyan"><h4>ìë™ í”¼í‚¹ìœ¨</h4>
          <div class="v" id="k_autoPickRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>í‰ê·  í”¼í‚¹ ì‹œê°„</h4>
          <div class="v" id="k_avgPickTime">-</div>
          <div class="meta">ì´ˆ</div>
        </div>
        <div class="kpi cyan"><h4>WMS ê³ ë„í™” ì ìˆ˜</h4>
          <div class="v" id="k_wmsAdvanced">-</div>
          <div class="meta">/100</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ’° ë§¤ì¶œÂ·ìˆ˜ìµ</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì´ ë§¤ì¶œ</h4>
          <div class="v" id="k_totalSales">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi good"><h4>ìˆœì´ìµë¥ </h4>
          <div class="v" id="k_netMargin">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>í‰ê· ì£¼ë¬¸ê¸ˆì•¡</h4>
          <div class="v" id="k_aov">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi"><h4>ARPPU</h4>
          <div class="v" id="k_arppu">-</div>
          <div class="meta">â‚©</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ‘¥ ê³ ê°</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC</h4>
          <div class="v" id="k_ltvCac">-</div>
        </div>
        <div class="kpi"><h4>ìœ ì§€ìœ¨</h4>
          <div class="v" id="k_retention">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì´íƒˆë¥ </h4>
          <div class="v" id="k_churn">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>AI ì´íƒˆ ì˜ˆì¸¡ ì •í™•ë„</h4>
          <div class="v" id="k_ai">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸšš ë°°ì†¡Â·ë¬¼ë¥˜</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>ì •ì‹œìœ¨</h4>
          <div class="v" id="k_onTime">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>SLA ìœ„ë°˜ìœ¨</h4>
          <div class="v" id="k_sla">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì ì¬ìœ¨</h4>
          <div class="v" id="k_load">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì—°ë¹„</h4>
          <div class="v" id="k_fuel">-</div>
          <div class="meta">km/L</div>
        </div>
        <div class="kpi"><h4>ë¼ìš°íŒ… ì ìˆ˜</h4>
          <div class="v" id="k_route">-</div>
          <div class="meta">/100</div>
        </div>
        <div class="kpi warn"><h4>ë°°ì†¡ ì˜ˆì™¸ìœ¨</h4>
          <div class="v" id="k_exception">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ“¦ ë°˜í’ˆ</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>ë°˜í’ˆë¥ </h4>
          <div class="v" id="k_returnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ë°˜í’ˆ ì†ì‹¤ë¥ </h4>
          <div class="v" id="k_returnCost">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬íŒë§¤ ê°€ëŠ¥ë¥ </h4>
          <div class="v" id="k_resell">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ­ WMSÂ·ì¬ê³ </h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>ì¬ê³  íšŒì „ìœ¨</h4>
          <div class="v" id="k_invTurn">-</div>
          <div class="meta">íšŒ</div>
        </div>
        <div class="kpi"><h4>í’ˆì ˆë¥ </h4>
          <div class="v" id="k_stockout">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ê³¼ì¬ê³  ë¹„ìœ¨</h4>
          <div class="v" id="k_overstock">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì •í™•ë„</h4>
          <div class="v" id="k_invAcc">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì†ì‹¤ë¥ </h4>
          <div class="v" id="k_shrink">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>WMS í™œìš©ë¥ </h4>
          <div class="v" id="k_wms">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sections">
    <div class="section">
      <h3>âœ… ì¿ íŒ¡ íŠ¹í™” ì •í•©ì„± ê²€ì‚¬</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section">
      <h3>âš ï¸ ì¿ íŒ¡ ë³µí•© ìœ„í—˜ ìš”ì†Œ</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section">
      <h3>ğŸ“Š ì²˜ë¦¬ ì„±ëŠ¥ & í˜„ì‹¤ì„± ì§€í‘œ</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* =========================================================
     ì‹œë®¬ë ˆì´í„° ì œì•½/ê¶Œì¥(ìš”ì•½)
     - ì…ê³ /ì ì¹˜ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìœ¼ë©´ ì¬ê³ ì—°ë ¹Â·FEFOÂ·ë¦¬í”Œë ˆë‹ˆì‹œ LT ì •ë°€ ë¶„ì„ì— ì œì•½
     - ë¡œì¼€ì´ì…˜(Bin/Slot) ì—†ìœ¼ë©´ í”¼í‚¹ ë™ì„ /ì ì¬ ìµœì í™” í•œê³„
     - ì›ê°€(COGS) ë¶€ì¬ ì‹œ ì¬ê³ ê°€ì¹˜/ì •í™•í•œ ë§ˆì§„ ì‚°ì¶œ í•œê³„
     - íŠ¸ëœì­ì…˜ ë¡œê·¸ ë¯¸í¡ ì‹œ ì¼ë³„ ìˆ˜ë¶ˆ/ìŠ¤ëƒ…ìƒ· ì¬êµ¬ì„± ë‚œì´ë„â†‘
     â–¶ ë³¸ ë²„ì „ì€ ë‹¤ìŒ ì»¬ëŸ¼ì„ ì¶”ê°€í•´ ë³´ì™„:
       Receiving_Date, Putaway_Date, Lot_ID, Expiry_Date, Bin, Slot,
       Unit_Cost, Daily_OnHand_Snapshot, Safety_Stock, Forecast_Demand,
       ASN_ID, PO_ID, Replenishment_Type
     ========================================================= */

  /* -------------------------
     0) ìƒìˆ˜/ë§¤í•‘
  --------------------------*/

  // â–¶ FC ì¶œê³  SLA(ë¶„): ì£¼ë¬¸â†’FC ì¶œê³ (__net_FC_Exit_TS)ê¹Œì§€ í—ˆìš© ì‹œê°„
  const SHIP_SLA_MIN = {
    'ë¡œì¼“ë‹¹ì¼': 60,
    'ë¡œì¼“ìƒˆë²½': 90,
    'ë¡œì¼“ìµì¼': 90,
    'ë¡œì¼“í”„ë ˆì‹œ': 60,
    'ì¼ë°˜íƒë°°': 120,
    DEFAULT: 90
  };

  const DELIVERY_MODES = {
    'ë¡œì¼“ë‹¹ì¼': {delayRate: 0.005, baseDays: 0, cutoffHour: 20, regions: ['ìˆ˜ë„ê¶Œ'], wowOnly: false, cost: 1.2},
    'ë¡œì¼“ìƒˆë²½': {delayRate: 0.008, baseDays: 1, regions: ['ìˆ˜ë„ê¶Œ', 'ì˜ë‚¨', 'ì¶©ì²­'], wowOnly: false, cost: 1.1},
    'ë¡œì¼“ìµì¼': {delayRate: 0.012, baseDays: 1, regions: ['ì „êµ­'], wowOnly: false, cost: 1.0},
    'ë¡œì¼“í”„ë ˆì‹œ': {
      delayRate: 0.015,
      baseDays: 0,
      cutoffHour: 18,
      regions: ['ìˆ˜ë„ê¶Œ'],
      wowOnly: false,
      cost: 1.3,
      coldChain: true
    },
    'ì¼ë°˜íƒë°°': {delayRate: 0.035, baseDays: 2, regions: ['ì „êµ­'], wowOnly: false, cost: 0.8}
  };

  const REGIONS = ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ', 'ëŒ€ì „ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ê²½ê¸°ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„', 'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¼ë‚¨ë„', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„', 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'];

  const CITIES_BY_REGION = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ë§ˆí¬êµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘êµ¬', 'ì¢…ë¡œêµ¬', 'ì˜ë“±í¬êµ¬', 'ê°•ì„œêµ¬', 'ì–‘ì²œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´€ì•…êµ¬', 'ë™ì‘êµ¬', 'ê°•ë¶êµ¬', 'ì„±ë¶êµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ì€í‰êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ê°•ë™êµ¬'],
    'ë¶€ì‚°ê´‘ì—­ì‹œ': ['í•´ìš´ëŒ€êµ¬', 'ìˆ˜ì˜êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ì¤‘êµ¬', 'ì„œêµ¬', 'ì‚¬í•˜êµ¬', 'ê¸ˆì •êµ¬', 'ì—°ì œêµ¬', 'ë™ë˜êµ¬', 'ë¶êµ¬', 'ì‚¬ìƒêµ¬', 'ê°•ì„œêµ¬', 'ê¸°ì¥êµ°'],
    'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ìˆ˜ì„±êµ¬', 'ë‹¬ì„œêµ¬', 'ë‹¬ì„±êµ°'],
    'ì¸ì²œê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë™êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ì—°ìˆ˜êµ¬', 'ë‚¨ë™êµ¬', 'ë¶€í‰êµ¬', 'ê³„ì–‘êµ¬', 'ì„œêµ¬', 'ê°•í™”êµ°', 'ì˜¹ì§„êµ°'],
    'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°êµ¬'],
    'ëŒ€ì „ê´‘ì—­ì‹œ': ['ë™êµ¬', 'ì¤‘êµ¬', 'ì„œêµ¬', 'ìœ ì„±êµ¬', 'ëŒ€ë•êµ¬'],
    'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ì¤‘êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬', 'ë¶êµ¬', 'ìš¸ì£¼êµ°'],
    'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
    'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ', 'ì„±ë‚¨ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì•ˆì‚°ì‹œ', 'ìš©ì¸ì‹œ', 'ë¶€ì²œì‹œ', 'ê´‘ëª…ì‹œ', 'í‰íƒì‹œ', 'ê³¼ì²œì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì‹œí¥ì‹œ', 'êµ°í¬ì‹œ', 'ì˜ì™•ì‹œ', 'í•˜ë‚¨ì‹œ', 'ì´ì²œì‹œ', 'ì•ˆì„±ì‹œ', 'ê¹€í¬ì‹œ', 'í™”ì„±ì‹œ', 'ê´‘ì£¼ì‹œ', 'ì—¬ì£¼ì‹œ', 'ì–‘í‰êµ°', 'ê°€í‰êµ°', 'ì—°ì²œêµ°', 'ê³ ì–‘ì‹œ', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ì–‘ì£¼ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'íŒŒì£¼ì‹œ', 'í¬ì²œì‹œ'],
    'ê°•ì›íŠ¹ë³„ìì¹˜ë„': ['ì¶˜ì²œì‹œ', 'ì›ì£¼ì‹œ', 'ê°•ë¦‰ì‹œ', 'ë™í•´ì‹œ', 'íƒœë°±ì‹œ', 'ì†ì´ˆì‹œ', 'ì‚¼ì²™ì‹œ', 'í™ì²œêµ°', 'íš¡ì„±êµ°', 'ì˜ì›”êµ°', 'í‰ì°½êµ°', 'ì •ì„ êµ°', 'ì² ì›êµ°', 'í™”ì²œêµ°', 'ì–‘êµ¬êµ°', 'ì¸ì œêµ°', 'ê³ ì„±êµ°', 'ì–‘ì–‘êµ°'],
    'ì¶©ì²­ë¶ë„': ['ì²­ì£¼ì‹œ', 'ì¶©ì£¼ì‹œ', 'ì œì²œì‹œ', 'ë³´ì€êµ°', 'ì˜¥ì²œêµ°', 'ì˜ë™êµ°', 'ì¦í‰êµ°', 'ì§„ì²œêµ°', 'ê´´ì‚°êµ°', 'ìŒì„±êµ°', 'ë‹¨ì–‘êµ°'],
    'ì¶©ì²­ë‚¨ë„': ['ì²œì•ˆì‹œ', 'ê³µì£¼ì‹œ', 'ë³´ë ¹ì‹œ', 'ì•„ì‚°ì‹œ', 'ì„œì‚°ì‹œ', 'ë…¼ì‚°ì‹œ', 'ê³„ë£¡ì‹œ', 'ë‹¹ì§„ì‹œ', 'ê¸ˆì‚°êµ°', 'ë¶€ì—¬êµ°', 'ì„œì²œêµ°', 'ì²­ì–‘êµ°', 'í™ì„±êµ°', 'ì˜ˆì‚°êµ°', 'íƒœì•ˆêµ°'],
    'ì „ë¶íŠ¹ë³„ìì¹˜ë„': ['ì „ì£¼ì‹œ', 'êµ°ì‚°ì‹œ', 'ìµì‚°ì‹œ', 'ì •ìì‹œ', 'ë‚¨ì›ì‹œ', 'ê¹€ì œì‹œ', 'ì™„ì£¼êµ°', 'ì§„ì•ˆêµ°', 'ë¬´ì£¼êµ°', 'ì¥ìˆ˜êµ°', 'ì„ì‹¤êµ°', 'ìˆœì°½êµ°', 'ê³ ì°½êµ°', 'ë¶€ì•ˆêµ°'],
    'ì „ë¼ë‚¨ë„': ['ëª©í¬ì‹œ', 'ì—¬ìˆ˜ì‹œ', 'ìˆœì²œì‹œ', 'ë‚˜ì£¼ì‹œ', 'ê´‘ì–‘ì‹œ', 'ë‹´ì–‘êµ°', 'ê³¡ì„±êµ°', 'êµ¬ë¡€êµ°', 'ê³ í¥êµ°', 'ë³´ì„±êµ°', 'í™”ìˆœêµ°', 'ì¥í¥êµ°', 'ê°•ì§„êµ°', 'í•´ë‚¨êµ°', 'ì˜ì•”êµ°', 'ë¬´ì•ˆêµ°', 'í•¨í‰êµ°', 'ì˜ê´‘êµ°', 'ì¥ì„±êµ°', 'ì™„ë„êµ°', 'ì§„ë„êµ°', 'ì‹ ì•ˆêµ°'],
    'ê²½ìƒë¶ë„': ['í¬í•­ì‹œ', 'ê²½ì£¼ì‹œ', 'ê¹€ì²œì‹œ', 'ì•ˆë™ì‹œ', 'êµ¬ë¯¸ì‹œ', 'ì˜ì£¼ì‹œ', 'ì˜ì²œì‹œ', 'ìƒì£¼ì‹œ', 'ë¬¸ê²½ì‹œ', 'ê²½ì‚°ì‹œ', 'êµ°ìœ„êµ°', 'ì˜ì„±êµ°', 'ì²­ì†¡êµ°', 'ì˜ì–‘êµ°', 'ì˜ë•êµ°', 'ì²­ë„êµ°', 'ê³ ë ¹êµ°', 'ì„±ì£¼êµ°', 'ì¹ ê³¡êµ°', 'ì˜ˆì²œêµ°', 'ë´‰í™”êµ°', 'ìš¸ì§„êµ°', 'ìš¸ë¦‰êµ°'],
    'ê²½ìƒë‚¨ë„': ['ì°½ì›ì‹œ', 'ì§„ì£¼ì‹œ', 'í†µì˜ì‹œ', 'ì‚¬ì²œì‹œ', 'ê¹€í•´ì‹œ', 'ë°€ì–‘ì‹œ', 'ê±°ì œì‹œ', 'ì–‘ì‚°ì‹œ', 'ì˜ë ¹êµ°', 'í•¨ì•ˆêµ°', 'ì°½ë…•êµ°', 'ê³ ì„±êµ°', 'ë‚¨í•´êµ°', 'í•˜ë™êµ°', 'ì‚°ì²­êµ°', 'í•¨ì–‘êµ°', 'ê±°ì°½êµ°', 'í•©ì²œêµ°'],
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì œì£¼ì‹œ', 'ì„œê·€í¬ì‹œ']
  };

  const DISTRICTS_BY_CITY = {
    'ê°•ë‚¨êµ¬': ['ì—­ì‚¼ë™', 'ê°œí¬ë™', 'ì²­ë‹´ë™', 'ì‚¼ì„±ë™', 'ëŒ€ì¹˜ë™', 'ì‹ ì‚¬ë™', 'ë…¼í˜„ë™', 'ì••êµ¬ì •ë™', 'ì„¸ê³¡ë™', 'ìê³¡ë™'],
    'ì„œì´ˆêµ¬': ['ì„œì´ˆë™', 'ì ì›ë™', 'ë°˜í¬ë™', 'ë°©ë°°ë™', 'ì–‘ì¬ë™', 'ë‚´ê³¡ë™'],
    'ì†¡íŒŒêµ¬': ['ì ì‹¤ë™', 'ì„ì´Œë™', 'ì‚¼ì „ë™', 'ê°€ë½ë™', 'ë¬¸ì •ë™', 'ì¥ì§€ë™', 'ë°©ì´ë™', 'ì˜¤ê¸ˆë™', 'ê±°ì—¬ë™'],
    'ë§ˆí¬êµ¬': ['ê³µë•ë™', 'ì•„í˜„ë™', 'ìš©ê°•ë™', 'ëŒ€í¥ë™', 'ì‹ ìˆ˜ë™', 'ì„œê°•ë™', 'ì„œêµë™', 'í•©ì •ë™', 'ë§ì›ë™', 'ì—°ë‚¨ë™', 'ì„±ì‚°ë™', 'ìƒì•”ë™'],
    'í•´ìš´ëŒ€êµ¬': ['í•´ìš´ëŒ€ë™', 'ì¤‘ë™', 'ì¢Œë™', 'ìš°ë™', 'ì†¡ì •ë™', 'ì¬ì†¡ë™', 'ë°˜ì—¬ë™', 'ë°˜ì†¡ë™'],
    'ë¶€ì‚°ì§„êµ¬': ['ë¶€ì „ë™', 'ì—°ì§€ë™', 'ì´ˆìë™', 'ì–‘ì •ë™', 'ì „í¬ë™', 'ë²”ì²œë™', 'ë‹¹ê°ë™', 'ê°œê¸ˆë™'],
    'ìˆ˜ì›ì‹œ': ['ì˜í†µêµ¬', 'íŒ”ë‹¬êµ¬', 'ì¥ì•ˆêµ¬', 'ê¶Œì„ êµ¬'], 'ì„±ë‚¨ì‹œ': ['ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ë¶„ë‹¹êµ¬'],
    'ê³ ì–‘ì‹œ': ['ë•ì–‘êµ¬', 'ì¼ì‚°ë™êµ¬', 'ì¼ì‚°ì„œêµ¬'], 'ìš©ì¸ì‹œ': ['ì²˜ì¸êµ¬', 'ê¸°í¥êµ¬', 'ìˆ˜ì§€êµ¬'],
    'ëŒ€êµ¬ì¤‘êµ¬': ['ì¤‘ì•™ë¡œ', 'ë™ì„±ë¡œ', 'ì‚¼ë•ë™', 'ë‚¨ì‚°ë™'],
    'ì¸ì²œì—°ìˆ˜êµ¬': ['ì—°ìˆ˜ë™', 'ì²­í•™ë™', 'ì˜¥ë ¨ë™', 'ì„ í•™ë™'],
    'ê´‘ì£¼ì„œêµ¬': ['ì¹˜í‰ë™', 'ìƒë¬´ë™', 'ë†ì„±ë™', 'í™”ì •ë™'],
    'ëŒ€ì „ìœ ì„±êµ¬': ['ë´‰ëª…ë™', 'êµ¬ì¦‰ë™', 'ì˜¨ì²œë™', 'ë…¸ì€ë™'],
    'ì œì£¼ì‹œ': ['ì¼ë„ë™', 'ì´ë„ë™', 'ì‚¼ë„ë™', 'ìš©ë‹´ë™', 'ê±´ì…ë™', 'í™”ë¶ë™', 'ì‚¼ì–‘ë™', 'ì• ì›”ì', 'í•œë¦¼ì', 'êµ¬ì¢Œì', 'ì¡°ì²œì', 'í•œê²½ë©´', 'ì¶”ìë©´'],
    'ì„œê·€í¬ì‹œ': ['ì„œê·€ë™', 'ëŒ€ë¥œë™', 'ì¤‘ë¬¸ë™', 'íš¨ëˆë™', 'ì˜ì²œë™', 'ë™í™ë™', 'ì„œí™ë™', 'ëŒ€ì •ì', 'ë‚¨ì›ì', 'ì„±ì‚°ì', 'ì•ˆë•ë©´', 'í‘œì„ ë©´']
  };

  // ë©”ê°€í—ˆë¸Œ/í—ˆë¸Œ ì»¤ë²„ë¦¬ì§€
  const MEGA_HUBS = ['ê¹€í¬ë©”ê°€í—ˆë¸Œ', 'ê³¤ì§€ì•”ë©”ê°€í—ˆë¸Œ', 'ë•í‰í—ˆë¸Œ', 'í‰íƒí—ˆë¸Œ'];
  const HUB_COVERAGE = {
    'ê¹€í¬ë©”ê°€í—ˆë¸Œ': ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ì¸ì²œê´‘ì—­ì‹œ', 'ê²½ê¸°ë„'],
    'ê³¤ì§€ì•”ë©”ê°€í—ˆë¸Œ': ['ê²½ê¸°ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„', 'ì¶©ì²­ë¶ë„'],
    'ë•í‰í—ˆë¸Œ': ['ê²½ê¸°ë„', 'ì¶©ì²­ë‚¨ë„', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'],
    'í‰íƒí—ˆë¸Œ': ['ê²½ê¸°ë„', 'ì¶©ì²­ë‚¨ë„', 'ì¶©ì²­ë¶ë„']
  };
  // ì§€ì—­ ì „ìš© FC (Region -> FC)
  const FC_SITES = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': 'ì„œìš¸ë™ë¶€FC', 'ì¸ì²œê´‘ì—­ì‹œ': 'ì¸ì²œFC', 'ê²½ê¸°ë„': 'ê²½ê¸°ë‚¨ë¶€FC',
    'ë¶€ì‚°ê´‘ì—­ì‹œ': 'ë¶€ì‚°FC', 'ëŒ€êµ¬ê´‘ì—­ì‹œ': 'ëŒ€êµ¬FC', 'ê´‘ì£¼ê´‘ì—­ì‹œ': 'ê´‘ì£¼FC',
    'ëŒ€ì „ê´‘ì—­ì‹œ': 'ëŒ€ì „FC', 'ìš¸ì‚°ê´‘ì—­ì‹œ': 'ìš¸ì‚°FC', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': 'ì„¸ì¢…FC',
    'ê°•ì›íŠ¹ë³„ìì¹˜ë„': 'ê°•ì›FC', 'ì¶©ì²­ë¶ë„': 'ì¶©ë¶FC', 'ì¶©ì²­ë‚¨ë„': 'ì¶©ë‚¨FC',
    'ì „ë¶íŠ¹ë³„ìì¹˜ë„': 'ì „ë¶FC', 'ì „ë¼ë‚¨ë„': 'ì „ë‚¨FC', 'ê²½ìƒë¶ë„': 'ê²½ë¶FC', 'ê²½ìƒë‚¨ë„': 'ê²½ë‚¨FC',
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': 'ì œì£¼FC'
  };

  const REGION_LOGISTICS = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': {avgDistance: 12, perKmCost: 85, baseCost: 2200, populationWeight: 0.25},
    'ê²½ê¸°ë„': {avgDistance: 18, perKmCost: 90, baseCost: 2400, populationWeight: 0.22},
    'ë¶€ì‚°ê´‘ì—­ì‹œ': {avgDistance: 22, perKmCost: 95, baseCost: 2800, populationWeight: 0.08},
    'ì¸ì²œê´‘ì—­ì‹œ': {avgDistance: 16, perKmCost: 88, baseCost: 2300, populationWeight: 0.06},
    'ëŒ€êµ¬ê´‘ì—­ì‹œ': {avgDistance: 20, perKmCost: 92, baseCost: 2700, populationWeight: 0.05},
    'ëŒ€ì „ê´‘ì—­ì‹œ': {avgDistance: 19, perKmCost: 90, baseCost: 2600, populationWeight: 0.03},
    'ê´‘ì£¼ê´‘ì—­ì‹œ': {avgDistance: 25, perKmCost: 100, baseCost: 3000, populationWeight: 0.03},
    'ìš¸ì‚°ê´‘ì—­ì‹œ': {avgDistance: 24, perKmCost: 98, baseCost: 2900, populationWeight: 0.02},
    'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': {avgDistance: 18, perKmCost: 88, baseCost: 2500, populationWeight: 0.01},
    'ê°•ì›íŠ¹ë³„ìì¹˜ë„': {avgDistance: 35, perKmCost: 110, baseCost: 3500, populationWeight: 0.03},
    'ì¶©ì²­ë¶ë„': {avgDistance: 28, perKmCost: 95, baseCost: 3100, populationWeight: 0.03},
    'ì¶©ì²­ë‚¨ë„': {avgDistance: 26, perKmCost: 93, baseCost: 2900, populationWeight: 0.04},
    'ì „ë¶íŠ¹ë³„ìì¹˜ë„': {avgDistance: 30, perKmCost: 105, baseCost: 3200, populationWeight: 0.04},
    'ì „ë¼ë‚¨ë„': {avgDistance: 32, perKmCost: 108, baseCost: 3400, populationWeight: 0.04},
    'ê²½ìƒë¶ë„': {avgDistance: 29, perKmCost: 100, baseCost: 3100, populationWeight: 0.05},
    'ê²½ìƒë‚¨ë„': {avgDistance: 27, perKmCost: 98, baseCost: 3000, populationWeight: 0.06},
    'ì œì£¼íŠ¹ë³„ìì¹˜ë„': {avgDistance: 40, perKmCost: 220, baseCost: 4800, populationWeight: 0.01}
  };

  const WEATHER_CONDITIONS = ['ë§‘ìŒ', 'íë¦¼', 'ë¹„', 'ëˆˆ', 'ì•ˆê°œ', 'ê°•í’'];

  function weatherSeverity(cond) {
    const m = {'ë§‘ìŒ': 0.02, 'íë¦¼': 0.15, 'ë¹„': 0.45, 'ëˆˆ': 0.75, 'ì•ˆê°œ': 0.35, 'ê°•í’': 0.55};
    return m[cond] || 0.2;
  }

  const COUPANG_CATEGORIES = {
    'íŒ¨ì…˜ì˜ë¥˜': {
      returnRate: 0.18,
      margin: 0.42,
      price: [12000, 89000],
      freshFood: false,
      skus: ['FASHION001', 'CLOTH002', 'SHOES003', 'BAG004', 'ACC005'],
      coldChain: false,
      tempRange: [15, 25]
    },
    'ë·°í‹°': {
      returnRate: 0.08,
      margin: 0.38,
      price: [8000, 65000],
      freshFood: false,
      skus: ['BEAUTY001', 'COSMETIC002', 'SKINCARE003', 'PERFUME004'],
      coldChain: false,
      tempRange: [5, 35]
    },
    'ê°€ì „ë””ì§€í„¸': {
      returnRate: 0.04,
      margin: 0.18,
      price: [35000, 850000],
      freshFood: false,
      skus: ['ELEC001', 'MOBILE002', 'LAPTOP003', 'TV004', 'APPLIANCE005'],
      coldChain: false,
      tempRange: [0, 40]
    },
    'ì‹ ì„ ì‹í’ˆ': {
      returnRate: 0.03,
      margin: 0.25,
      price: [3000, 28000],
      freshFood: true,
      skus: ['FRESH001', 'VEGGIE002', 'FRUIT003', 'MEAT004', 'SEAFOOD005'],
      coldChain: true,
      tempRange: [2, 8]
    },
    'ëƒ‰ë™ì‹í’ˆ': {
      returnRate: 0.02,
      margin: 0.22,
      price: [5000, 35000],
      freshFood: true,
      skus: ['FROZEN001', 'ICECREAM002', 'DUMPLING003', 'FISH004'],
      coldChain: true,
      tempRange: [-20, -15]
    },
    'ìƒí™œìš©í’ˆ': {
      returnRate: 0.05,
      margin: 0.35,
      price: [2000, 45000],
      freshFood: false,
      skus: ['HOUSEHOLD001', 'CLEAN002', 'BATH003', 'KITCHEN004'],
      coldChain: false,
      tempRange: [10, 30]
    },
    'ë°˜ë ¤ë™ë¬¼': {
      returnRate: 0.06,
      margin: 0.32,
      price: [8000, 75000],
      freshFood: false,
      skus: ['PET001', 'FOOD002', 'TOY003', 'CARE004'],
      coldChain: false,
      tempRange: [15, 30]
    },
    'ë„ì„œë¬¸êµ¬': {
      returnRate: 0.03,
      margin: 0.45,
      price: [3000, 35000],
      freshFood: false,
      skus: ['BOOK001', 'STATIONERY002', 'OFFICE003', 'ART004'],
      coldChain: false,
      tempRange: [10, 35]
    },
    'ìŠ¤í¬ì¸ ': {
      returnRate: 0.07,
      margin: 0.28,
      price: [15000, 120000],
      freshFood: false,
      skus: ['SPORT001', 'FITNESS002', 'OUTDOOR003', 'GOLF004'],
      coldChain: false,
      tempRange: [5, 40]
    },
    'ê±´ê°•ì‹í’ˆ': {
      returnRate: 0.04,
      margin: 0.55,
      price: [12000, 95000],
      freshFood: false,
      skus: ['HEALTH001', 'VITAMIN002', 'PROTEIN003', 'SUPPLEMENT004'],
      coldChain: false,
      tempRange: [15, 25]
    }
  };

  const ABC_DISTRIBUTION = {A: 0.15, B: 0.35, C: 0.5};
  const VEHICLES = [
    {type: 'ì˜¤í† ë°”ì´', capacity: 15, fuelEff: [28, 45], regions: ['ë„ì‹¬']},
    {type: 'ì†Œí˜•ë°´', capacity: 50, fuelEff: [11, 16], regions: ['ì „ì²´']},
    {type: 'ì¤‘í˜•íŠ¸ëŸ­', capacity: 200, fuelEff: [7, 11], regions: ['ì „ì²´']},
    {type: 'ëŒ€í˜•íŠ¸ëŸ­', capacity: 500, fuelEff: [5, 8], regions: ['ê°„ì„ ']},
    {type: 'ì „ê¸°ì°¨', capacity: 40, fuelEff: [4.5, 6.8], regions: ['ë„ì‹¬']}
  ];
  const DRIVER_GRADES = ['ì‹ ì…', 'ì¼ë°˜', 'ìˆ™ë ¨', 'ë² í…Œë‘', 'MVP'];
  const RETURN_REASONS = ['ë‹¨ìˆœë³€ì‹¬', 'ìƒí’ˆë¶ˆëŸ‰', 'ë°°ì†¡ì§€ì—°', 'ì˜¤ë°°ì†¡', 'íŒŒì†', 'ì„¤ëª…ë¶ˆì¼ì¹˜', 'ì‚¬ì´ì¦ˆë¶ˆì¼ì¹˜', 'ê¸°íƒ€'];

  const WOW_TIERS = {
    'WOW_BASIC': {
      freeShippingThreshold: 0,
      deliveryDiscount: 0.0,
      ltvMultiplier: 2.0,
      priorityShipping: true,
      returnBenefit: 1.2
    }
  };
  const AUTOMATION_LEVELS = {
    'MANUAL': {pickingTime: 45, packingTime: 25, errorRate: 0.008, regions: ['ì œì£¼íŠ¹ë³„ìì¹˜ë„', 'ê°•ì›íŠ¹ë³„ìì¹˜ë„']},
    'SEMI_AUTO': {pickingTime: 28, packingTime: 18, errorRate: 0.005, regions: ['ì „ë¼ë‚¨ë„', 'ê²½ìƒë¶ë„', 'ì¶©ì²­ë¶ë„']},
    'AUTO': {pickingTime: 15, packingTime: 12, errorRate: 0.003, regions: ['ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ê´‘ì£¼ê´‘ì—­ì‹œ']},
    'AI_OPTIMIZED': {pickingTime: 8, packingTime: 6, errorRate: 0.001, regions: ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ']}
  };

  /* ====== (ì¶”ê°€) ë¶„í¬ ì¬ì¡°ì • ë‹¤ì´ì–¼ ====== */
  let DIALS = {
    lossOrderTarget: [0.07, 0.12],
    tempViolationTarget: [0.01, 0.02],
    jejuWeatherExposureTarget: [0.10, 0.15],
    overstockTarget: [0.15, 0.25],
    expiryImminentTarget: [0.005, 0.01]
  };
  let CAL = {
    costBias: 1.0,
    tempViolationBase: 0.015,
    jejuWeatherScale: 1.0,
    overstockProb: 0.22,
    expiryImminentRate: 0.008
  };
  let ENABLE_AUTOTUNE = false; // ê¸°ë³¸ì€ OFF, ì²´í¬ë°•ìŠ¤ ì¼¤ ë•Œë§Œ ON
  /* ====== (ì¶”ê°€ ë) ====== */

  /* ìœ í‹¸ */
  const rnd = (a, b) => Math.random() * (b - a) + a;
  const irnd = (a, b) => Math.floor(rnd(a, b + 1));
  const pick = arr => arr[irnd(0, arr.length - 1)];
  const weightedPick = (weights) => {
    const t = Object.values(weights).reduce((s, w) => s + w, 0);
    const r = Math.random() * t;
    let c = 0;
    for (const [k, w] of Object.entries(weights)) {
      c += w;
      if (r <= c) return k
    }
    return Object.keys(weights)[0]
  };
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const pad = (n, len = 2) => String(n).padStart(len, '0');
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  const HOURLY_ORDER_PATTERN = {
    0: 0.008,
    1: 0.005,
    2: 0.003,
    3: 0.002,
    4: 0.002,
    5: 0.003,
    6: 0.008,
    7: 0.015,
    8: 0.025,
    9: 0.035,
    10: 0.045,
    11: 0.052,
    12: 0.058,
    13: 0.048,
    14: 0.042,
    15: 0.055,
    16: 0.065,
    17: 0.075,
    18: 0.085,
    19: 0.125,
    20: 0.135,
    21: 0.095,
    22: 0.068,
    23: 0.035
  };

  function getOrderHour() {
    const entries = Object.entries(HOURLY_ORDER_PATTERN).map(([h, p]) => [parseInt(h), p]);
    const total = entries.reduce((s, [, p]) => s + p, 0);
    const r = Math.random();
    let cum = 0;
    for (const [h, p] of entries) {
      cum += p / total;
      if (r <= cum) return h
    }
    return 23
  }

  /* ë§¤í¬ë¡œ ì§€ì—­/ë‚ ì”¨ */
  function macroRegionBySiDo(region) {
    if (['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ'].includes(region)) return 'ìˆ˜ë„ê¶Œ';
    if (['ë¶€ì‚°ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ìš¸ì‚°ê´‘ì—­ì‹œ', 'ê²½ìƒë¶ë„', 'ê²½ìƒë‚¨ë„'].includes(region)) return 'ì˜ë‚¨';
    if (['ëŒ€ì „ê´‘ì—­ì‹œ', 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ì¶©ì²­ë¶ë„', 'ì¶©ì²­ë‚¨ë„'].includes(region)) return 'ì¶©ì²­';
    if (['ê´‘ì£¼ê´‘ì—­ì‹œ', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¼ë‚¨ë„'].includes(region)) return 'í˜¸ë‚¨';
    if (['ê°•ì›íŠ¹ë³„ìì¹˜ë„'].includes(region)) return 'ê°•ì›';
    if (['ì œì£¼íŠ¹ë³„ìì¹˜ë„'].includes(region)) return 'ì œì£¼';
    return 'ê¸°íƒ€';
  }

  /* (êµì²´) pickWeather: ì œì£¼ ì•…ì²œí›„ ê³¼ë‹¤ ë…¸ì¶œ ë³´ì • */
  function pickWeather(region, month) {
    let w = {'ë§‘ìŒ': 0.40, 'íë¦¼': 0.22, 'ë¹„': 0.18, 'ëˆˆ': 0.06, 'ì•ˆê°œ': 0.06, 'ê°•í’': 0.08};
    if ([6, 7, 8].includes(month)) {
      w['ë¹„'] += 0.10;
      w['ê°•í’'] += 0.03;
      w['ë§‘ìŒ'] -= 0.08;
    }
    if ([12, 1, 2].includes(month)) {
      w['ëˆˆ'] += 0.07;
      w['ë§‘ìŒ'] -= 0.04;
    }
    if (region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„') {
      w['ê°•í’'] = Math.max(0.01, (w['ê°•í’'] + 0.02) * CAL.jejuWeatherScale);
      w['ëˆˆ'] = Math.max(0, w['ëˆˆ'] - 0.05);
    }
    const macro = macroRegionBySiDo(region);
    if (['ì˜ë‚¨', 'í˜¸ë‚¨'].includes(macro)) w['ê°•í’'] += 0.02;

    const s = Object.values(w).reduce((a, b) => a + b, 0);
    let r = Math.random() * s, acc = 0;
    for (const k of Object.keys(w)) {
      acc += w[k];
      if (r <= acc) return k;
    }
    return 'ë§‘ìŒ';
  }

  /* ì…ê³ /ì ì¹˜/ë¡œì¼€ì´ì…˜/ìœ í†µê¸°í•œ/ìˆ˜ìš” */
  function selectFulfillmentCenter(region) {
    return FC_SITES[region] || 'ì§€ì—­FC';
  }

  function genBinSlot() {
    const aisle = pad(irnd(1, 40)), bay = pad(irnd(1, 30)), level = pad(irnd(1, 5)), slot = pad(irnd(1, 20));
    return {Bin: `A${aisle}-B${bay}-L${level}`, Slot: `S${slot}`};
  }

  /* (êµì²´) genLotAndExpiry: ë§Œë£Œ ì‚¬ìš© ê¸ˆì§€ + ì„ë°• ë¹„ìœ¨ ì œì–´ */
  function genLotAndExpiry(category, orderDate, receivingDate) {
    const cold = COUPANG_CATEGORIES[category].coldChain;
    if (!cold) return {Lot_ID: null, Expiry_Date: null};
    const lot = `LOT${irnd(100000, 999999)}`;
    let daysAhead = 90;
    if (category === 'ì‹ ì„ ì‹í’ˆ') daysAhead = irnd(3, 10);
    else if (category === 'ëƒ‰ë™ì‹í’ˆ') daysAhead = irnd(180, 365);
    let expiry = new Date(receivingDate.getTime() + daysAhead * 86400000);
    if (expiry <= orderDate) {
      expiry = new Date(orderDate.getTime() + irnd(2, 5) * 86400000);
    }
    if (Math.random() < CAL.expiryImminentRate) {
      expiry = new Date(orderDate.getTime() + irnd(0, 1) * 86400000);
    }
    return {Lot_ID: lot, Expiry_Date: expiry.toISOString().split('T')[0]};
  }

  function estimateUnitCost(category, unitPrice) {
    const margin = COUPANG_CATEGORIES[category].margin || 0.3;
    return Math.round(unitPrice * (1 - margin) * rnd(0.97, 1.03));
  }

  function forecastByABC(abc) {
    if (abc === 'A') return irnd(20, 60);
    if (abc === 'B') return irnd(8, 25);
    return irnd(2, 8);
  }

  function safetyStockCalc(forecastPerDay, leadDays) {
    const z = 1.28; // ~90% ì„œë¹„ìŠ¤ ë ˆë²¨
    const sigma = forecastPerDay * 0.3; // ìˆ˜ìš” í‘œì¤€í¸ì°¨ ê°€ì •
    return Math.max(0, Math.round(z * sigma * Math.sqrt(Math.max(1, leadDays))));
  }

  /* -------------------------
     1) ì „ì—­ ìƒíƒœ
  --------------------------*/
  let DATA = [];
  let MONTHLY_BY_CUST = {};
  let VALIDATION_ISSUES = [];
  let PERFORMANCE_METRICS = {};
  let COUPANG_REALITY_METRICS = {};
  let PROCESSING_STATE = {
    isRunning: false,
    shouldStop: false,
    startTime: null,
    processedRows: 0,
    totalRows: 0,
    currentChunk: 0,
    totalChunks: 0
  };
  const CHUNK_CONFIG = {defaultSize: 3000, maxMemoryRows: 150000, batchUpdateInterval: 3, gcInterval: 8};
  let ROCKET_PLAN = [];

  function buildRocketPlan(total, ratePct) {
    const k = Math.round(total * (ratePct / 100));
    const arr = Array(total).fill(false).map((_, i) => i < k);
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  /* -------------------------
     2) ë°ì´í„° ìƒì„±
  --------------------------*/
  function preAssignCustomerProfiles(uniqueCustomers, wowRate) {
    const profiles = {};
    const wowPlan = buildRocketPlan(uniqueCustomers, wowRate);
    for (let i = 0; i < uniqueCustomers; i++) {
      const custId = `CUST${String(100000 + i).padStart(7, '0')}`;
      const isWow = wowPlan[i] ? 1 : 0;
      profiles[custId] = {
        isWow,
        wowTier: isWow ? 'WOW_BASIC' : null,
        churnFlag: Math.random() < 0.08 ? 1 : 0,
        joinDate: isWow ? new Date(Date.now() - irnd(30, 1095) * 86400000) : null,
        preferredRegion: selectRegionWeighted()
      };
    }
    return profiles;
  }

  function selectRegionWeighted() {
    const w = {};
    Object.entries(REGION_LOGISTICS).forEach(([r, d]) => w[r] = d.populationWeight);
    return weightedPick(w);
  }

  function getAutomationLevel(region) {
    for (const [level, config] of Object.entries(AUTOMATION_LEVELS)) {
      if (config.regions.includes(region)) return level;
    }
    if (region.includes('ì„œìš¸') || region.includes('ê²½ê¸°') || region.includes('ì¸ì²œ')) return Math.random() < 0.6 ? 'AI_OPTIMIZED' : 'AUTO';
    return 'SEMI_AUTO';
  }

  function estimateLogisticsCost(row) {
    const reg = REGION_LOGISTICS[row.Region] || {baseCost: 3000, perKmCost: 100};
    const baseCost = reg.baseCost;
    const distanceCost = (row.Distance_km || 0) * reg.perKmCost;
    const modeCfg = DELIVERY_MODES[row.Delivery_Mode] || {cost: 1.0};
    const weather = typeof row.Weather_Severity_Score === 'number' ? row.Weather_Severity_Score : 0.2;
    const weatherMultiplier = weather > 0.6 ? 1.25 : (weather > 0.3 ? 1.1 : 1.0);
    const peakMultiplier = row.Is_Peak_Hour_Order === 1 ? 1.15 : 1.0;
    const islandMultiplier = row.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' ? (weather > 0.6 ? 1.8 : 1.5) : 1.0;
    const handlingBase = 500;
    return Math.round((baseCost + distanceCost + handlingBase) * modeCfg.cost * weatherMultiplier * peakMultiplier * islandMultiplier);
  }

  /* â–¶ 1í–‰ ìƒì„± */
  function generateCoupangRealisticRow(index, totalUsers, yearStart, yearEnd, customerProfiles, forceRocket) {
    const custIndex = index % totalUsers;
    const custId = `CUST${String(100000 + custIndex).padStart(7, '0')}`;
    const customerProfile = customerProfiles[custId];

    const region = Math.random() < 0.7 ? customerProfile.preferredRegion : selectRegionWeighted();
    const availableCities = CITIES_BY_REGION[region] || ['ê¸°íƒ€ì‹œ'];
    const city = pick(availableCities);
    const availableDistricts = DISTRICTS_BY_CITY[city] || ['ê¸°íƒ€êµ¬'];
    const district = pick(availableDistricts);
    const address = generateAddress(region, city, district);
    const distanceKm = calculateDistance(region, city);

    const categoryKeys = Object.keys(COUPANG_CATEGORIES);
    const month = irnd(1, 12);
    let categoryWeights = {};
    categoryKeys.forEach(cat => {
      let w = 1;
      if (cat === 'ì‹ ì„ ì‹í’ˆ' && [6, 7, 8].includes(month)) w = 1.8;
      if (cat === 'ëƒ‰ë™ì‹í’ˆ' && [12, 1, 2].includes(month)) w = 1.5;
      if (cat === 'íŒ¨ì…˜ì˜ë¥˜' && [3, 4, 9, 10].includes(month)) w = 1.4;
      categoryWeights[cat] = w;
    });
    const selectedCategory = weightedPick(categoryWeights);
    const categoryData = COUPANG_CATEGORIES[selectedCategory];
    const sku = pick(categoryData.skus);
    const unitPrice = irnd(categoryData.price[0], categoryData.price[1]);
    const quantity = Math.random() < 0.7 ? 1 : irnd(2, 5);
    const orderAmount = unitPrice * quantity;

    const abcRand = Math.random();
    const abcGrade = abcRand < ABC_DISTRIBUTION.A ? 'A' : (abcRand < ABC_DISTRIBUTION.A + ABC_DISTRIBUTION.B ? 'B' : 'C');

    const year = irnd(yearStart, yearEnd);
    const orderHour = getOrderHour();
    const orderDate = new Date(year, month - 1, irnd(1, 28), orderHour, irnd(0, 59), irnd(0, 59));

    /* ë¡œì¼“/ì¼ë°˜ ê°€ìš©ì„± (ë§¤í¬ë¡œ ì§€ì—­) */
    let availableModes;
    const mReg = macroRegionBySiDo(region);
    if (forceRocket) {
      availableModes = ['ë¡œì¼“ë‹¹ì¼', 'ë¡œì¼“ìƒˆë²½', 'ë¡œì¼“ìµì¼', 'ë¡œì¼“í”„ë ˆì‹œ'].filter(mode => {
        const cfg = DELIVERY_MODES[mode];
        return cfg.regions.includes('ì „êµ­') || cfg.regions.includes(region) || cfg.regions.includes(mReg);
      });
      if (mReg !== 'ìˆ˜ë„ê¶Œ') availableModes = availableModes.filter(m => m !== 'ë¡œì¼“ë‹¹ì¼');
      if (categoryData.freshFood && availableModes.includes('ë¡œì¼“í”„ë ˆì‹œ') && Math.random() < 0.6) availableModes = ['ë¡œì¼“í”„ë ˆì‹œ'];
      if (!availableModes.length) availableModes = ['ë¡œì¼“ìµì¼'];
    } else {
      availableModes = ['ì¼ë°˜íƒë°°'];
    }
    const deliveryMode = pick(availableModes);
    const modeConfig = DELIVERY_MODES[deliveryMode];

    // ê³„íš ë°°ì†¡ì‹œê°„
    const plannedDelivery = new Date(orderDate);
    if (deliveryMode === 'ë¡œì¼“ë‹¹ì¼') {
      const cutoffHour = modeConfig.cutoffHour;
      if (orderDate.getHours() >= cutoffHour) {
        plannedDelivery.setDate(plannedDelivery.getDate() + 1);
        plannedDelivery.setHours(6 + irnd(0, 3), irnd(0, 59), 0, 0);
      } else {
        const h = Math.max(3, cutoffHour - orderDate.getHours() + irnd(-1, 2));
        plannedDelivery.setHours(orderDate.getHours() + h, irnd(0, 59), 0, 0);
      }
    } else if (deliveryMode === 'ë¡œì¼“ìƒˆë²½') {
      plannedDelivery.setDate(plannedDelivery.getDate() + modeConfig.baseDays);
      plannedDelivery.setHours(6, irnd(0, 30), 0, 0);
    } else {
      plannedDelivery.setDate(plannedDelivery.getDate() + modeConfig.baseDays);
      plannedDelivery.setHours(irnd(9, 18), irnd(0, 59), 0, 0);
    }

    // ì§€ì—°/ì‹¤ì œ ë„ì°©
    const weather = pickWeather(region, month);
    const weatherSev = weatherSeverity(weather);
    const isPeakTime = orderDate.getHours() >= 19 && orderDate.getHours() <= 21;
    const isWeekend = [0, 6].includes(orderDate.getDay());
    let actualDelayRate = modeConfig.delayRate;
    if (weatherSev > 0.4) actualDelayRate *= 1.8;
    if (isPeakTime) actualDelayRate *= 1.3;
    if (isWeekend) actualDelayRate *= 0.8;
    if (region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„') actualDelayRate *= 2.2;

    const isDelayed = Math.random() < actualDelayRate;
    let actualDelivery = new Date(plannedDelivery);
    let delayHours = 0;
    if (isDelayed) {
      const baseDelay = deliveryMode.includes('ë¡œì¼“') ? irnd(4, 24) : irnd(12, 48);
      delayHours = baseDelay + (weatherSev > 0.6 ? irnd(0, 24) : 0);
      actualDelivery.setHours(actualDelivery.getHours() + delayHours);
    } else {
      const early = deliveryMode.includes('ë¡œì¼“') ? rnd(0, 4) : rnd(0, 2);
      actualDelivery.setTime(actualDelivery.getTime() - early * 3600000);
    }

    // ìš´ì†¡/ì ì¬/ì—°ë¹„/ë¼ìš°íŒ…
    const suitableVehicles = VEHICLES.filter(v => v.regions.includes('ì „ì²´') || (v.regions.includes('ë„ì‹¬') && ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ë¶€ì‚°ê´‘ì—­ì‹œ'].includes(region)));
    const vehicle = pick(suitableVehicles);
    const vehicleId = `V${irnd(10000, 99999)}`;
    const driverId = `D${irnd(1000, 9999)}`;
    const driverGrade = pick(DRIVER_GRADES);
    const baseLoadFactor = Math.random() < 0.3 ? rnd(40, 70) : rnd(70, 95);
    const loadFactor = Math.round(clamp(baseLoadFactor, 20, 100));
    const fuelEfficiency = rnd(vehicle.fuelEff[0], vehicle.fuelEff[1]);
    const automationLevel = getAutomationLevel(region);
    const baseRouting = automationLevel === 'AI_OPTIMIZED' ? rnd(88, 98) : automationLevel === 'AUTO' ? rnd(78, 92) : automationLevel === 'SEMI_AUTO' ? rnd(65, 85) : rnd(50, 75);
    const routingScore = Math.round(baseRouting);

    // â–¶ ë¬¼ë¥˜ë¹„ (ì¶”ì • + í˜„ì‹¤ ë…¸ì´ì¦ˆ + ë³´ì •)
    const regionLogistics = REGION_LOGISTICS[region];
    const baseCost = regionLogistics.baseCost;
    const distanceCost = distanceKm * regionLogistics.perKmCost;
    const modeCostMultiplier = modeConfig.cost;
    const weatherMultiplier = weatherSev > 0.6 ? 1.25 : (weatherSev > 0.3 ? 1.1 : 1.0);
    const peakMultiplier = isPeakTime ? 1.15 : 1.0;
    const handlingBase = 500;
    const islandMultiplier = region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' ? (weatherSev > 0.6 ? 1.8 : 1.5) : 1.0;
    const estCost = Math.round((baseCost + distanceCost + handlingBase) * modeCostMultiplier * weatherMultiplier * peakMultiplier * islandMultiplier);
    const driverFactor = 1 + rnd(-0.05, 0.05);
    const vehicleFactor = (vehicle.type === 'ëŒ€í˜•íŠ¸ëŸ­' ? 1.08 : (vehicle.type === 'ì˜¤í† ë°”ì´' ? 0.92 : 1.0));
    const hubFactor = (Math.random() < 0.5 && (Math.random() < 0.65)) ? 1 + rnd(0.02, 0.08) : 1.0;
    const congestion = isPeakTime ? irnd(0, 400) : 0;
    const weatherSurcharge = (weather === 'ê°•í’' || weather === 'ëˆˆ') ? irnd(200, 700) : 0;
    const jitter = irnd(-150, 150);
    const actualLogisticsCost = Math.max(0, Math.round((estCost * driverFactor * vehicleFactor * hubFactor + congestion + weatherSurcharge + jitter) * CAL.costBias));

    // ê³ ê° ë°°ì†¡ë¹„ (WOW ë¬´ë£Œ ìš°ì„ )
    let customerDeliveryCharge = 0;
    if (customerProfile.isWow === 0 && orderAmount < 50000) {
      customerDeliveryCharge = deliveryMode.includes('ë¡œì¼“') ? 3500 : 3000;
    }
    customerDeliveryCharge = Math.round(customerDeliveryCharge);

    // ì˜¨ë„/ì½œë“œì²´ì¸
    const tempData = generateTemperatureData(selectedCategory, categoryData.coldChain);

    // ë°˜í’ˆ
    let returnRate = categoryData.returnRate;
    if (tempData.violation) returnRate *= 2.5;
    if (isDelayed && deliveryMode.includes('ë¡œì¼“')) returnRate *= 1.8;
    const returnFlag = Math.random() < returnRate ? 1 : 0;
    const returnReason = returnFlag ? pick(RETURN_REASONS) : null;
    const returnCost = returnFlag ? Math.round(orderAmount * rnd(0.1, 0.25)) : 0;

    let resellable = null, resellReason = null;
    if (returnFlag) {
      if (tempData.violation) {
        resellable = 0;
        resellReason = 'ì˜¨ë„ê´€ë¦¬ì‹¤íŒ¨';
      } else if (['ë‹¨ìˆœë³€ì‹¬', 'ê¸°íƒ€'].includes(returnReason)) {
        resellable = Math.random() < 0.92 ? 1 : 0;
        resellReason = resellable ? 'ì •ìƒìƒí’ˆ' : 'í¬ì¥ì†ìƒ';
      } else {
        resellable = Math.random() < 0.45 ? 1 : 0;
        resellReason = resellable ? 'ë¶€ë¶„ìˆ˜ë¦¬ê°€ëŠ¥' : 'ìƒí’ˆì†ìƒ';
      }
    }

    // ì¬ê³ 
    const currentStock = abcGrade === 'A' ? irnd(200, 800) : (abcGrade === 'B' ? irnd(50, 300) : irnd(10, 100));
    const reorderPoint = Math.round(currentStock * (abcGrade === 'A' ? 0.4 : abcGrade === 'B' ? 0.3 : 0.2));
    const stockTurnover = abcGrade === 'A' ? rnd(12, 20) : (abcGrade === 'B' ? rnd(6, 12) : rnd(2, 8));
    const stockoutFlag = Math.random() < (abcGrade === 'A' ? 0.015 : abcGrade === 'B' ? 0.04 : 0.08) ? 1 : 0;
    const overstockFlag = Math.random() < (CAL.overstockProb ?? 0.22) ? 1 : 0;

    // ì‘ì—…ì‹œê°„(ì´ˆ)
    const automationConfig = AUTOMATION_LEVELS[automationLevel];
    const pickingTime = automationConfig.pickingTime + rnd(-3, 5);
    const packingTime = automationConfig.packingTime + rnd(-2, 3);
    const totalProcessTime = Math.round((pickingTime + packingTime) * 10) / 10;

    // ì¶œê³  ì†ë„ ëª©í‘œì¹˜ ê¸°ë°˜ (ê¸°ì¡´ ë¶„í¬ ìœ ì§€)
    const SLA = SHIP_SLA_MIN[deliveryMode] ?? SHIP_SLA_MIN.DEFAULT;
    let orderToShipMinutes;
    if (Math.random() < 0.90) orderToShipMinutes = irnd(10, Math.floor(SLA * 0.8));
    else orderToShipMinutes = irnd(Math.floor(SLA * 0.8) + 1, Math.floor(SLA * 1.2));
    const autoBoost = automationLevel === 'AI_OPTIMIZED' ? 0.85 : automationLevel === 'AUTO' ? 0.93 : automationLevel === 'SEMI_AUTO' ? 1.00 : 1.05;
    const peakPenalty = (orderHour >= 19 && orderHour <= 21) ? 1.06 : 1.0;
    orderToShipMinutes = Math.round(orderToShipMinutes * autoBoost * peakPenalty);

    // === (ì‹ ê·œ) í”¼í‚¹/íŒ¨í‚¹ íƒ€ì„ìŠ¤íƒ¬í”„ + FC ì¶œê³  ì¬ì •ë ¬ ===
    const pickStart = new Date(orderDate.getTime() + irnd(5, 15) * 60000);
    const pickEnd = new Date(pickStart.getTime() + Math.max(5, pickingTime) * 1000);
    const packStart = new Date(pickEnd.getTime() + irnd(2, 12) * 60000);
    const packEnd = new Date(packStart.getTime() + Math.max(4, packingTime) * 1000);

    // Ship SLA ë§ˆê°
    const shipSlaDue = new Date(orderDate.getTime() + SLA * 60000);

    // ê¸°ì¡´ ë¶„í¬ë¥¼ ìµœëŒ€í•œ ë³´ì „í•˜ë©´ì„œ, FC ì¶œê³ ëŠ” ë°˜ë“œì‹œ íŒ¨í‚¹ ì¢…ë£Œ ì´í›„ë¡œ ì¡°ì •
    let fcExit = new Date(orderDate.getTime() + Math.max(orderToShipMinutes, 5) * 60000);
    const minBufferMin = irnd(3, 10);
    if (fcExit < new Date(packEnd.getTime() + minBufferMin * 60000)) {
      fcExit = new Date(packEnd.getTime() + minBufferMin * 60000);
    }
    orderToShipMinutes = Math.round((fcExit - orderDate) / 60000); // ì¬ê³„ì‚°
    const fastShipFlag = orderToShipMinutes <= 30 ? 1 : 0;
    const fcSlaBreach = fcExit > shipSlaDue ? 1 : 0;

    // CAC/LTV
    const baseCac = customerProfile.isWow ? irnd(3500, 7000) : irnd(1200, 2800);
    const wowTierConfig = customerProfile.wowTier ? WOW_TIERS[customerProfile.wowTier] : {ltvMultiplier: 1.5};
    const customerLTV = Math.round(orderAmount * wowTierConfig.ltvMultiplier * rnd(2.8, 4.2));

    // ìˆ˜ìµì„±
    const grossProfit = Math.round(orderAmount * categoryData.margin);
    const inventoryCarryingCost = Math.round(currentStock * unitPrice * 0.002 / 12);
    const stockoutCost = stockoutFlag ? Math.round(orderAmount * 0.08) : 0;
    const qualityCost = tempData.violation ? Math.round(orderAmount * 0.05) : 0;
    const netProfit = grossProfit - actualLogisticsCost - returnCost - inventoryCarryingCost - stockoutCost - qualityCost;

    // ì´íƒˆ ì˜ˆì¸¡
    let churnScore = customerProfile.churnFlag ? rnd(0.65, 0.95) : rnd(0.05, 0.55);
    if (isDelayed && deliveryMode.includes('ë¡œì¼“')) churnScore += 0.15;
    if (returnFlag && !resellable) churnScore += 0.1;
    churnScore = Math.min(0.98, Math.round(churnScore * 1000) / 1000);

    // í’ˆì§ˆ/WMS
    const serviceQualityScore = Math.round((100 - (isDelayed ? 15 : 0) - (returnFlag ? 10 : 0) - (tempData.violation ? 20 : 0)) * (automationLevel === 'AI_OPTIMIZED' ? 1.05 : 1.0));
    const wmsUsage = automationLevel === 'MANUAL' ? 'Legacy' : 'Active';
    const omsUsage = Math.random() < 0.95 ? 'Active' : 'Manual';
    const wmsAdvancedScore = automationLevel === 'AI_OPTIMIZED' ? rnd(88, 96) : automationLevel === 'AUTO' ? rnd(75, 87) : automationLevel === 'SEMI_AUTO' ? rnd(55, 74) : rnd(30, 54);

    const monthlyKey = `${custId}-${year}-${pad(orderDate.getMonth() + 1)}`;

    // í”Œë˜ê·¸
    const isRocketDelivery = deliveryMode.includes('ë¡œì¼“') ? 1 : 0;
    const isSameDayDelivery = deliveryMode === 'ë¡œì¼“ë‹¹ì¼' ? 1 : 0;
    const isDawnDelivery = deliveryMode === 'ë¡œì¼“ìƒˆë²½' ? 1 : 0;
    const isFreshDelivery = deliveryMode === 'ë¡œì¼“í”„ë ˆì‹œ' ? 1 : 0;
    const isFreshFood = categoryData.freshFood ? 1 : 0;
    const isColdChainRequired = categoryData.coldChain ? 1 : 0;
    const isTempViolation = tempData.violation ? 1 : 0;
    const isWowMember = customerProfile.isWow;
    const isPremiumOrder = orderAmount >= 100000 ? 1 : 0;
    const isBulkOrder = quantity >= 3 ? 1 : 0;
    const isWeekendOrder = isWeekend ? 1 : 0;
    const isPeakHourOrder = isPeakTime ? 1 : 0;
    const isFreeShipping = customerDeliveryCharge === 0 ? 1 : 0;
    const isWeatherRisk = weatherSev > 0.4 ? 1 : 0;
    const isLongDistance = distanceKm > 30 ? 1 : 0;
    const isHighLTV = customerLTV >= 200000 ? 1 : 0;
    const isChurnRisk = churnScore > 0.7 ? 1 : 0;
    const isVIP = (isHighLTV && isWowMember) ? 1 : 0;
    const isLossOrder = netProfit < 0 ? 1 : 0;
    const isAIOptimized = automationLevel === 'AI_OPTIMIZED' ? 1 : 0;

    /* â–¶ FCâ†’(í—ˆë¸Œ)â†’ìº í”„ ë„¤íŠ¸ì›Œí¬ */
    const viaHub = forceRocket && deliveryMode !== 'ë¡œì¼“í”„ë ˆì‹œ' && region !== 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' && Math.random() < 0.65;
    const transitHub = viaHub ? (MEGA_HUBS.find(h => (HUB_COVERAGE[h] || []).includes(region)) || 'ì§€ì—­ì„œë¸Œí—ˆë¸Œ') : null;
    const hubIn = viaHub ? new Date(fcExit.getTime() + irnd(60, 240) * 60000) : null;
    const hubOut = viaHub ? new Date(hubIn.getTime() + irnd(30, 120) * 60000) : null;
    const campIn = new Date((viaHub ? hubOut : fcExit).getTime() + irnd(30, 120) * 60000);
    const loadStart = new Date(campIn.getTime() + irnd(10, 40) * 60000);
    const loadEnd = new Date(loadStart.getTime() + irnd(10, 30) * 60000);
    const ofd = new Date(loadEnd.getTime() + irnd(5, 20) * 60000);
    if (actualDelivery < ofd) {
      actualDelivery = new Date(ofd.getTime() + irnd(20, 180) * 60000);
    }

    const fulfillmentCenter = selectFulfillmentCenter(region);
    const isMegaHub = transitHub ? (MEGA_HUBS.includes(transitHub) ? 1 : 0) : 0;

    /* â–¶ (ì‹ ê·œ) Receiving/Putaway/ë¡œì¼€ì´ì…˜/COGS/ìˆ˜ìš”Â·ì•ˆì „ì¬ê³ /ASNÂ·PO/FEFO */
    const forecastDemand = forecastByABC(abcGrade);
    const replLeadDays = categoryData.coldChain ? irnd(1, 3) : irnd(2, 7);
    const receivingOffsetDays = categoryData.coldChain ? irnd(1, 5) : irnd(5, 30);
    const receivingDate = new Date(orderDate.getTime() - receivingOffsetDays * 86400000);
    const putawayDate = new Date(receivingDate.getTime() + irnd(1, 48) * 3600000);
    const lotInfo = genLotAndExpiry(selectedCategory, orderDate, receivingDate);
    const binSlot = genBinSlot();
    const unitCost = estimateUnitCost(selectedCategory, unitPrice);
    const dailyOnHandSnapshot = currentStock;
    const safetyStock = safetyStockCalc(forecastDemand, replLeadDays);
    const asnId = `ASN${irnd(1000000, 9999999)}`;
    const poId = `PO${irnd(1000000, 9999999)}`;
    const replenishmentType = categoryData.coldChain ? (Math.random() < 0.5 ? 'CrossDock' : 'Regular')
      : (Math.random() < 0.1 ? 'VendorManaged' : (Math.random() < 0.2 ? 'Backorder' : 'Regular'));

    return {
      Order_ID: `ORD${String(1000000 + index).padStart(8, '0')}`,
      Order_Date: `${year}-${pad(orderDate.getMonth() + 1)}-${pad(orderDate.getDate())}`,
      Order_Timestamp: orderDate.toISOString(),
      Order_Hour: orderDate.getHours(),

      Delivery_Mode: deliveryMode,
      Planned_Delivery_Date: `${plannedDelivery.getFullYear()}-${pad(plannedDelivery.getMonth() + 1)}-${pad(plannedDelivery.getDate())}`,
      Actual_Delivery_Date: `${actualDelivery.getFullYear()}-${pad(actualDelivery.getMonth() + 1)}-${pad(actualDelivery.getDate())}`,
      Delivery_Timestamp: actualDelivery.toISOString(),
      Is_Delayed: isDelayed ? 1 : 0,
      Delay_Hours: delayHours,
      SLA_Breach: isDelayed ? 1 : 0, // ë°°ì†¡ SLA ìœ„ë°˜
      Delivery_Status: isDelayed ? 'Late' : 'On-Time',
      Fast_Ship_30min: fastShipFlag,
      Order_To_Ship_Minutes: orderToShipMinutes,

      Region: region,
      City: city,
      District: district,
      Address: address,
      Fulfillment_Center: fulfillmentCenter,
      Is_Mega_Hub: isMegaHub,
      Distance_km: distanceKm,

      Customer_ID: custId,
      Is_WOW_Member: isWowMember,
      WOW_Tier: customerProfile.wowTier,
      WOW_Join_Date: customerProfile.joinDate ? customerProfile.joinDate.toISOString().split('T')[0] : null,
      WOW_Tenure_Days: customerProfile.joinDate ? Math.floor((orderDate - customerProfile.joinDate) / 86400000) : 0,
      Customer_Segment: customerLTV >= 300000 ? 'Platinum' : customerLTV >= 180000 ? 'Gold' : customerLTV >= 80000 ? 'Silver' : 'Bronze',

      Product_Category: selectedCategory,
      SKU: sku,
      ABC_Category: abcGrade,
      Unit_Price: unitPrice,
      Quantity: quantity,
      Order_Amount: orderAmount,
      Is_Fresh_Food: isFreshFood,
      Is_Cold_Chain_Required: isColdChainRequired,

      Target_Temperature: tempData.targetTemp,
      Actual_Temperature: tempData.actualTemp,
      Temperature_Violation: isTempViolation,
      Cold_Chain_Quality_Score: tempData.quality,

      Vehicle_ID: vehicleId,
      Vehicle_Type: vehicle.type,
      Vehicle_Capacity: vehicle.capacity,
      Driver_ID: driverId,
      Driver_Grade: driverGrade,
      Load_Factor: loadFactor,
      Fuel_Efficiency: Math.round(fuelEfficiency * 10) / 10,
      Routing_Score: routingScore,
      GPS_Tracking: Math.random() < 0.96 ? 1 : 0,

      Actual_Logistics_Cost: actualLogisticsCost,
      Customer_Delivery_Charge: customerDeliveryCharge,
      Gross_Profit: grossProfit,
      Net_Profit: netProfit,
      CAC: baseCac,
      Customer_LTV: customerLTV,
      LTV_to_CAC: Math.round((customerLTV / Math.max(baseCac, 1)) * 100) / 100,

      Return_Flag: returnFlag,
      Return_Reason: returnReason,
      Return_Cost: returnCost,
      Is_Resellable: resellable,
      Resellability_Reason: resellReason,

      Current_Stock: currentStock,
      Reorder_Point: reorderPoint,
      Stockout_Flag: stockoutFlag,
      Overstock_Flag: overstockFlag,
      Inventory_Turnover: Math.round(stockTurnover * 10) / 10,
      Inventory_Accuracy: Math.round(rnd(0.94, 0.999) * 1000) / 1000,

      Automation_Level: automationLevel,
      Picking_Time_Seconds: Math.round(pickingTime),
      Packing_Time_Seconds: Math.round(packingTime),
      Total_Process_Time: totalProcessTime,
      WMS_Usage: wmsUsage,
      OMS_Usage: omsUsage,
      WMS_Advanced_Score: Math.round(wmsAdvancedScore),

      Service_Quality_Score: serviceQualityScore,
      Customer_NPS: Math.round(serviceQualityScore * 0.85 + rnd(-5, 10)),
      Processing_Error_Rate: automationConfig.errorRate,

      Weather_Condition: weather,
      Weather_Severity_Score: Math.round(weatherSev * 100) / 100,

      Churn_Flag: customerProfile.churnFlag,
      Predicted_Churn_Score: churnScore,

      Is_Rocket_Delivery: isRocketDelivery,
      Is_Same_Day_Delivery: isSameDayDelivery,
      Is_Dawn_Delivery: isDawnDelivery,
      Is_Fresh_Delivery: isFreshDelivery,
      Is_Premium_Order: isPremiumOrder,
      Is_Bulk_Order: isBulkOrder,
      Is_Weekend_Order: isWeekendOrder,
      Is_Peak_Hour_Order: isPeakHourOrder,
      Is_Free_Shipping: isFreeShipping,
      Is_Weather_Risk: isWeatherRisk,
      Is_Long_Distance: isLongDistance,
      Is_High_LTV: isHighLTV,
      Is_Churn_Risk: isChurnRisk,
      Is_VIP_Customer: isVIP,
      Is_Loss_Order: isLossOrder,
      Is_AI_Optimized: isAIOptimized,

      _monthlyKey: monthlyKey,
      _automationLevel: automationLevel,
      _customerProfile: customerProfile,

      /* ë„¤íŠ¸ì›Œí¬ (CSVìš©) */
      __net_Route_Type: viaHub ? 'VIA_HUB' : 'DIRECT',
      __net_Sortation_Hub_Name: transitHub,
      __net_FC_Exit_TS: fcExit.toISOString(),
      __net_Hub_In_TS: hubIn ? hubIn.toISOString() : null,
      __net_Hub_Out_TS: hubOut ? hubOut.toISOString() : null,
      __net_Camp_In_TS: campIn.toISOString(),
      __net_Loadout_Start_TS: loadStart.toISOString(),
      __net_Loadout_End_TS: loadEnd.toISOString(),
      __net_OFD_TS: ofd.toISOString(),
      __net_FC_Dwell_Min: Math.round((fcExit - orderDate) / 60000),
      __net_Hub_Dwell_Min: viaHub ? Math.round((hubOut - hubIn) / 60000) : 0,
      __net_Camp_Dwell_Min: Math.round((ofd - campIn) / 60000),

      /* (ì‹ ê·œ) ì¬ê³ Â·ì…ê³ Â·ë¡œì¼€ì´ì…˜Â·ìˆ˜ìš”/ì•ˆì „ì¬ê³ Â·ASN/PO/FEFO */
      Receiving_Date: receivingDate.toISOString().split('T')[0],
      Putaway_Date: putawayDate.toISOString().split('T')[0],
      Lot_ID: lotInfo.Lot_ID,
      Expiry_Date: lotInfo.Expiry_Date,
      Bin: binSlot.Bin,
      Slot: binSlot.Slot,
      Unit_Cost: unitCost,
      Daily_OnHand_Snapshot: dailyOnHandSnapshot,
      Safety_Stock: safetyStock,
      Forecast_Demand: forecastDemand,
      ASN_ID: asnId,
      PO_ID: poId,
      Replenishment_Type: replenishmentType,

      /* (ì‹ ê·œ) FC ê³µì • íƒ€ì„ìŠ¤íƒ¬í”„ & SLA ë§ˆê°(ì¶œê³ ) */
      Picking_Start_TS: pickStart.toISOString(),
      Picking_End_TS: pickEnd.toISOString(),
      Packing_Start_TS: packStart.toISOString(),
      Packing_End_TS: packEnd.toISOString(),
      Ship_SLA_Due_TS: shipSlaDue.toISOString(),
      FC_SLA_Breach: fcSlaBreach
    };
  }

  /* (êµì²´) generateTemperatureData: ìœ„ë°˜ìœ¨ 1~2%ë¡œ ê³ ì • */
  function generateTemperatureData(category, coldChain) {
    if (!coldChain) return {temp: null, violation: false, quality: null};
    const target = COUPANG_CATEGORIES[category].tempRange;
    const targetTemp = rnd(target[0], target[1]);
    let actualTemp = targetTemp + rnd(-2, 2);
    let violation = Math.random() < CAL.tempViolationBase;
    if (violation) {
      if (Math.random() < 0.5) actualTemp = target[1] + rnd(4, 8);
      else actualTemp = target[0] - rnd(4, 8);
    }
    const quality = violation ? rnd(60, 85) : rnd(85, 98);
    return {
      targetTemp: Math.round(targetTemp * 10) / 10,
      actualTemp: Math.round(actualTemp * 10) / 10,
      violation,
      quality: Math.round(quality)
    };
  }

  function calculateDistance(region, city) {
    const base = REGION_LOGISTICS[region]?.avgDistance || 25;
    const variation = rnd(-0.3, 0.3);
    return Math.max(3, Math.round(base * (1 + variation)));
  }

  function generateAddress(region, city, district) {
    const roadNames = ['ë¬¼ë¥˜ë¡œ', 'ë°°ì†¡ëŒ€ë¡œ', 'ì¿ íŒ¡ê¸¸', 'ë¡œì¼“ë¡œ', 'í—ˆë¸ŒëŒ€ë¡œ', 'ì„¼í„°ë¡œ'];
    const roadNo = irnd(1, 999), building = irnd(1, 150);
    return `${city} ${district} ${pick(roadNames)} ${roadNo}-${building}`;
  }

  /* ì²­í¬ */
  async function generateCoupangDataChunk(startIdx, chunkSize, totalUsers, yearStart, yearEnd, customerProfiles) {
    const chunk = [];
    const chunkMonthly = {};
    for (let i = 0; i < chunkSize; i++) {
      if (PROCESSING_STATE.shouldStop) break;
      const idx = startIdx + i;
      const forceRocket = ROCKET_PLAN[idx];
      const row = generateCoupangRealisticRow(idx, totalUsers, yearStart, yearEnd, customerProfiles, forceRocket);
      chunk.push(row);
      const mk = row._monthlyKey;
      chunkMonthly[mk] = (chunkMonthly[mk] || 0) + row.Order_Amount;
      if (i % 150 === 0) await sleep(0);
    }
    return {chunk, chunkMonthly};
  }

  /* ë©”ì¸ */
  async function generateCoupangRealisticData(totalOrders, totalUsers, yearStart, yearEnd, chunkSize, rocketRate, wowRate) {
    DATA = [];
    MONTHLY_BY_CUST = {};
    VALIDATION_ISSUES = [];
    PERFORMANCE_METRICS = {};
    COUPANG_REALITY_METRICS = {};
    PROCESSING_STATE = {
      isRunning: true, shouldStop: false, startTime: performance.now(),
      processedRows: 0, totalRows: totalOrders, currentChunk: 0, totalChunks: Math.ceil(totalOrders / chunkSize)
    };
    updateUIState('running');
    try {
      const customerProfiles = preAssignCustomerProfiles(totalUsers, wowRate);
      ROCKET_PLAN = buildRocketPlan(totalOrders, rocketRate);

      for (let chunkIdx = 0; chunkIdx < PROCESSING_STATE.totalChunks; chunkIdx++) {
        if (PROCESSING_STATE.shouldStop) break;
        const startIdx = chunkIdx * chunkSize;
        const currentChunkSize = Math.min(chunkSize, totalOrders - startIdx);
        const {
          chunk,
          chunkMonthly
        } = await generateCoupangDataChunk(startIdx, currentChunkSize, totalUsers, yearStart, yearEnd, customerProfiles);

        if (DATA.length + chunk.length > CHUNK_CONFIG.maxMemoryRows) {
          DATA = DATA.slice(-Math.floor(CHUNK_CONFIG.maxMemoryRows * 0.6)).concat(chunk);
        } else {
          DATA = DATA.concat(chunk);
        }

        Object.entries(chunkMonthly).forEach(([k, v]) => {
          MONTHLY_BY_CUST[k] = (MONTHLY_BY_CUST[k] || 0) + v;
        });
        PROCESSING_STATE.processedRows = startIdx + currentChunkSize;
        PROCESSING_STATE.currentChunk = chunkIdx + 1;

        if (chunkIdx % CHUNK_CONFIG.batchUpdateInterval === 0 || chunkIdx === PROCESSING_STATE.totalChunks - 1) {
          updateProgress();
          if (chunkIdx % (CHUNK_CONFIG.batchUpdateInterval * 2) === 0) {
            const partial = DATA.slice(-10000);
            updateCoupangKPI(calculateCoupangKPIs(partial));
            updateFulfillmentKPI(calculateFulfillmentKPIs(partial));
            autotuneDistributions();
          }
        }
        if (chunkIdx % CHUNK_CONFIG.gcInterval === 0) await sleep(15);
        await sleep(1);
      }

      if (!PROCESSING_STATE.shouldStop) {
        const _tNet = parseFloat(document.getElementById('targetNetMargin')?.value || '3.2');
        recalibrateIndustryStandards({netMarginPct: _tNet, ltvCacCenter: 3.5, ltvCacMin: 2.5, ltvCacMax: 5.0});
        applyDials(false);

        const ltvValues = DATA.map(r => r.Customer_LTV || 0);
        const qs = calculateQuartiles(ltvValues);
        DATA.forEach(r => {
          const q = assignQuartile(r.Customer_LTV || 0, qs);
          r.CLV_Quartile = q;
          r.CLV_Quartile_Label = `Q${q}`;
        });
        const finalKPI = calculateCoupangKPIs(DATA);
        updateCoupangKPI(finalKPI);
        updateFulfillmentKPI(calculateFulfillmentKPIs(DATA));

        autotuneDistributions();

        COUPANG_REALITY_METRICS = calculateRealityMetrics();
        await runCoupangValidations();
        renderCoupangValidations();
        renderCoupangRisks();
        renderCoupangTable();

        const endTime = performance.now();
        PERFORMANCE_METRICS = {
          totalTime: Math.round(endTime - PROCESSING_STATE.startTime),
          rowsPerSecond: Math.round(totalOrders / ((endTime - PROCESSING_STATE.startTime) / 1000)),
          chunksProcessed: PROCESSING_STATE.totalChunks,
          memoryEfficiency: Math.round((DATA.length / totalOrders) * 100),
          realityScore: COUPANG_REALITY_METRICS.overallScore
        };
        renderPerformanceMetrics();
        document.getElementById('btnCsv').disabled = false;
        updateUIState('completed');
      } else {
        updateUIState('stopped');
      }
    } catch (err) {
      console.error('ì¿ íŒ¡ ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', err);
      updateUIState('error');
      alert('ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + err.message);
    }
    PROCESSING_STATE.isRunning = false;
  }

  /* -------------------------
     3) KPI ê³„ì‚° (ì›ë³¸ ìœ ì§€)
  --------------------------*/

  // â–¶ FC KPI ê³„ì‚° (ì£¼ë¬¸â†’FC ì¶œê³  ê´€ì )
  function calculateFulfillmentKPIs(rows) {
    if (!rows?.length) {
      return {
        onTimeShip: 0, avgShipHours: 0, pickSecPerItem: 0,
        packSecPerItem: 0, efficiency: 0, shipUnder60: 0
      };
    }

    const shipped = rows.filter(r => r.__net_FC_Exit_TS && r.Order_Timestamp);
    if (!shipped.length) {
      return {onTimeShip: 0, avgShipHours: 0, pickSecPerItem: 0, packSecPerItem: 0, efficiency: 0, shipUnder60: 0};
    }

    const shipMins = shipped.map(r => {
      const t0 = new Date(r.Order_Timestamp);
      const t1 = new Date(r.__net_FC_Exit_TS);
      return Math.max(0, (t1 - t0) / 60000);
    });

    const onTimeCnt = shipped.reduce((acc, r, i) => {
      const sla = SHIP_SLA_MIN[r.Delivery_Mode] ?? SHIP_SLA_MIN.DEFAULT;
      return acc + (shipMins[i] <= sla ? 1 : 0);
    }, 0);
    const onTimeShip = Math.round((onTimeCnt / shipped.length) * 1000) / 10;

    const avgShipHours = Math.round((shipMins.reduce((s, v) => s + v, 0) / shipped.length) / 60 * 10) / 10;

    const totalPickSec = shipped.reduce((s, r) => s + (r.Picking_Time_Seconds ?? 0), 0);
    const totalPackSec = shipped.reduce((s, r) => s + (r.Packing_Time_Seconds ?? 0), 0);
    const totalQty = shipped.reduce((s, r) => s + Math.max(1, (r.Quantity ?? 1)), 0);
    const pickSecPerItem = Math.round((totalPickSec / Math.max(1, totalQty)) * 10) / 10;
    const packSecPerItem = Math.round((totalPackSec / Math.max(1, totalQty)) * 10) / 10;

    const TARGET_PICK_SEC = 35;
    const TARGET_PACK_SEC = 20;
    const avgProcessSec = (totalPickSec + totalPackSec) / shipped.length;
    let efficiency = ((TARGET_PICK_SEC + TARGET_PACK_SEC) / Math.max(1, avgProcessSec)) * 100;
    efficiency = Math.max(0, Math.min(100, Math.round(efficiency * 10) / 10));

    const shipUnder60 = Math.round((shipped.filter((r, i) =>
      (r.Order_To_Ship_Minutes ?? shipMins[i]) <= 60
    ).length / shipped.length) * 1000) / 10;

    return {onTimeShip, avgShipHours, pickSecPerItem, packSecPerItem, efficiency, shipUnder60};
  }

  // â–¶ FC KPI í™”ë©´ ë°˜ì˜
  function updateFulfillmentKPI(k) {
    if (!k) return;
    setText('k_fcOnTimeShip', fmtPct(k.onTimeShip));
    setText('k_fcAvgShipHour', (k.avgShipHours ?? 0).toFixed(1));
    setText('k_fcPickSecPerItem', (k.pickSecPerItem ?? 0).toFixed(0));
    setText('k_fcPackSecPerItem', (k.packSecPerItem ?? 0).toFixed(0));
    setText('k_fcEfficiency', fmtPct(k.efficiency));
    setText('k_fcShipUnder60', fmtPct(k.shipUnder60));
  }

  function calculateCoupangKPIs(rows) {
    if (!rows.length) return {};
    const totalOrders = rows.length;
    const totalSales = rows.reduce((s, r) => s + r.Order_Amount, 0);
    const totalNetProfit = rows.reduce((s, r) => s + r.Net_Profit, 0);
    const netMargin = totalSales > 0 ? Math.round((totalNetProfit / totalSales) * 1000) / 10 : 0;
    const avgOrderValue = Math.round(totalSales / Math.max(totalOrders, 1));

    const rocketOrders = rows.filter(r => r.Is_Rocket_Delivery === 1);
    const rocketShare = Math.round((rocketOrders.length / totalOrders) * 1000) / 10;
    const sameDayOrders = rows.filter(r => r.Is_Same_Day_Delivery === 1);
    const rocketSameDayRate = sameDayOrders.length > 0 ? Math.round((sameDayOrders.filter(r => r.SLA_Breach === 0).length / sameDayOrders.length) * 1000) / 10 : 0;
    const dawnOrders = rows.filter(r => r.Is_Dawn_Delivery === 1);
    const rocketDawnRate = dawnOrders.length > 0 ? Math.round((dawnOrders.filter(r => r.SLA_Breach === 0).length / dawnOrders.length) * 1000) / 10 : 0;
    const fastShipRate = Math.round((rows.filter(r => r.Fast_Ship_30min === 1).length / totalOrders) * 1000) / 10;

    const wowOrders = rows.filter(r => r.Is_WOW_Member === 1);
    const wowShare = Math.round((wowOrders.length / totalOrders) * 1000) / 10;
    const wowPlusShare = 0;
    const wowAov = wowOrders.length > 0 ? Math.round(wowOrders.reduce((s, r) => s + r.Order_Amount, 0) / wowOrders.length) : 0;
    const nonWowOrders = rows.filter(r => r.Is_WOW_Member === 0);
    const nonWowAov = nonWowOrders.length > 0 ? Math.round(nonWowOrders.reduce((s, r) => s + r.Order_Amount, 0) / nonWowOrders.length) : 0;
    const wowAovGap = wowAov - nonWowAov;
    const wowChurnRisk = rows.filter(r => r.Is_WOW_Member === 1 && r.Is_Churn_Risk === 1).length;

    const freshOrders = rows.filter(r => r.Is_Fresh_Food === 1);
    const freshShare = Math.round((freshOrders.length / totalOrders) * 1000) / 10;
    const coldChainOrders = rows.filter(r => r.Is_Cold_Chain_Required === 1);
    const coldChainCompliant = coldChainOrders.filter(r => r.Temperature_Violation === 0);
    const coldChainRate = coldChainOrders.length > 0 ? Math.round((coldChainCompliant.length / coldChainOrders.length) * 1000) / 10 : 0;
    const tempViolation = coldChainOrders.length > 0 ? Math.round((coldChainOrders.filter(r => r.Temperature_Violation === 1).length / coldChainOrders.length) * 1000) / 10 : 0;
    const frozenOrders = rows.filter(r => r.Product_Category === 'ëƒ‰ë™ì‹í’ˆ');
    const frozenQuality = frozenOrders.length > 0 ? Math.round(frozenOrders.reduce((s, r) => s + (r.Cold_Chain_Quality_Score || 90), 0) / frozenOrders.length) : 90;

    const megaHubOrders = rows.filter(r => r.Is_Mega_Hub === 1);
    const megaHubShare = Math.round((megaHubOrders.length / totalOrders) * 1000) / 10;
    const seoulOrders = rows.filter(r => r.Region.includes('ì„œìš¸') || r.Region.includes('ê²½ê¸°') || r.Region.includes('ì¸ì²œ'));
    const seoulCoverage = Math.round((seoulOrders.length / totalOrders) * 1000) / 10;
    const avgDistance = Math.round(rows.reduce((s, r) => s + r.Distance_km, 0) / totalOrders * 10) / 10;
    const networkEff = Math.round(rows.reduce((s, r) => s + r.Routing_Score, 0) / totalOrders);

    const aiOptimized = Math.round((rows.filter(r => r.Is_AI_Optimized === 1).length / totalOrders) * 1000) / 10;
    const autoPickRate = Math.round((rows.filter(r => ['AUTO', 'AI_OPTIMIZED'].includes(r.Automation_Level)).length / totalOrders) * 1000) / 10;
    const avgPickTime = Math.round(rows.reduce((s, r) => s + r.Picking_Time_Seconds, 0) / totalOrders);
    const wmsAdvanced = Math.round(rows.reduce((s, r) => s + (r.WMS_Advanced_Score || 70), 0) / totalOrders);

    const onTimeRate = Math.round((rows.filter(r => r.SLA_Breach === 0).length / totalOrders) * 1000) / 10;
    const slaRate = 100 - onTimeRate;
    const load = Math.round(rows.reduce((s, r) => s + r.Load_Factor, 0) / totalOrders);
    const fuel = Math.round(rows.reduce((s, r) => s + r.Fuel_Efficiency, 0) / totalOrders * 10) / 10;
    const route = networkEff;
    const exceptionRate = Math.round((rows.filter(r => r.Return_Reason && ['ì˜¤ë°°ì†¡', 'íŒŒì†'].includes(r.Return_Reason)).length / totalOrders) * 1000) / 10;

    const returnOrders = rows.filter(r => r.Return_Flag === 1);
    const returnRate = Math.round((returnOrders.length / totalOrders) * 1000) / 10;
    const totalReturnCost = returnOrders.reduce((s, r) => s + r.Return_Cost, 0);
    const returnCostRate = totalSales > 0 ? Math.round((totalReturnCost / totalSales) * 1000) / 10 : 0;
    const resellRate = returnOrders.length > 0 ? Math.round((returnOrders.filter(r => r.Is_Resellable === 1).length / returnOrders.length) * 1000) / 10 : 0;

    const invTurn = Math.round(rows.reduce((s, r) => s + r.Inventory_Turnover, 0) / totalOrders * 10) / 10;
    const stockoutRate = Math.round((rows.filter(r => r.Stockout_Flag === 1).length / totalOrders) * 1000) / 10;
    const overstockRate = Math.round((rows.filter(r => r.Overstock_Flag === 1).length / totalOrders) * 1000) / 10;
    const invAcc = Math.round(rows.reduce((s, r) => s + r.Inventory_Accuracy, 0) / totalOrders * 1000) / 10;

    const totalCarryingCost = rows.reduce((s, r) => s + ((r.Current_Stock * r.Unit_Price * 0.002 / 12) || 0), 0);
    const shrink = totalSales > 0 ? Math.round((totalCarryingCost / totalSales) * 1000) / 10 : 0;
    const wmsUtil = Math.round((rows.filter(r => r.WMS_Usage === 'Active').length / totalOrders) * 1000) / 10;

    const uniqueCustomers = new Set(rows.map(r => r.Customer_ID)).size;
    const avgLTV = Math.round(rows.reduce((s, r) => s + r.Customer_LTV, 0) / totalOrders);
    const avgCAC = Math.round(rows.reduce((s, r) => s + r.CAC, 0) / totalOrders);
    const ltvCac = avgCAC > 0 ? Math.round((avgLTV / avgCAC) * 100) / 100 : 0;

    const churnCustomers = new Set(rows.filter(r => r.Churn_Flag === 1).map(r => r.Customer_ID)).size;
    const churnRate = uniqueCustomers > 0 ? Math.round((churnCustomers / uniqueCustomers) * 1000) / 10 : 0;
    const retention = Math.round((100 - churnRate) * 10) / 10;
    const correctPred = rows.filter(r => (r.Churn_Flag === 1 && r.Predicted_Churn_Score > 0.7) || (r.Churn_Flag === 0 && r.Predicted_Churn_Score <= 0.7));
    const aiAcc = Math.round((correctPred.length / totalOrders) * 1000) / 10;

    const monthlyTotals = Object.values(MONTHLY_BY_CUST);
    const arppu = monthlyTotals.length > 0 ? Math.round(monthlyTotals.reduce((s, a) => s + a, 0) / monthlyTotals.length) : 0;

    return {
      totalSales, netMargin, aov: avgOrderValue, arppu,
      rocketShare, rocketSameDayRate, rocketDawnRate, fastShipRate,
      wowShare, wowPlusShare, wowAovGap, wowChurnRisk,
      freshShare, coldChainRate, tempViolation, frozenQuality,
      megaHubShare, seoulCoverage, avgDistance, networkEff,
      aiOptimized, autoPickRate, avgPickTime, wmsAdvanced,
      onTimeRate, slaRate, load, fuel, route, exceptionRate,
      returnRate, returnCostRate, resellRate,
      invTurn, stockoutRate, overstockRate, invAcc, shrink, wmsUtil,
      ltvCac, retention, churnRate, aiAcc
    };
  }

  function calculateQuartiles(values) {
    if (!values.length) return {q1: 0, q2: 0, q3: 0};
    const s = [...values].sort((a, b) => a - b);
    const q1 = s[Math.floor(s.length * 0.25)] || 0;
    const q2 = s[Math.floor(s.length * 0.5)] || 0;
    const q3 = s[Math.floor(s.length * 0.75)] || 0;
    return {q1, q2, q3};
  }

  function assignQuartile(v, qs) {
    if (v <= qs.q1) return 1;
    if (v <= qs.q2) return 2;
    if (v <= qs.q3) return 3;
    return 4;
  }

  function calculateRealityMetrics() {
    if (!DATA.length) return {overallScore: 0};
    const total = DATA.length;
    const rocketShare = DATA.filter(r => r.Is_Rocket_Delivery === 1).length / total;
    const wowShare = DATA.filter(r => r.Is_WOW_Member === 1).length / total;
    const freshShare = DATA.filter(r => r.Is_Fresh_Food === 1).length / total;
    const seoulShare = DATA.filter(r => r.Region.includes('ì„œìš¸') || r.Region.includes('ê²½ê¸°')).length / total;
    const aiOptimizedShare = DATA.filter(r => r.Is_AI_Optimized === 1).length / total;
    const tempViolationRate = DATA.filter(r => r.Temperature_Violation === 1).length / Math.max(DATA.filter(r => r.Is_Cold_Chain_Required === 1).length, 1);
    let realityScore = 0, maxScore = 0;
    const rocketTarget = 0.55, rocketDev = Math.abs(rocketShare - rocketTarget) / rocketTarget;
    realityScore += Math.max(0, 20 - rocketDev * 20);
    maxScore += 20;
    const wowTarget = 0.80, wowDev = Math.abs(wowShare - wowTarget) / wowTarget;
    realityScore += Math.max(0, 20 - wowDev * 20);
    maxScore += 20;
    const freshTarget = 0.12, freshDev = Math.abs(freshShare - freshTarget) / freshTarget;
    realityScore += Math.max(0, 15 - freshDev * 15);
    maxScore += 15;
    const seoulTarget = 0.50, seoulDev = Math.abs(seoulShare - seoulTarget) / seoulTarget;
    realityScore += Math.max(0, 15 - seoulDev * 15);
    maxScore += 15;
    const aiTarget = 0.35, aiDev = Math.abs(aiOptimizedShare - aiTarget) / aiTarget;
    realityScore += Math.max(0, 15 - aiDev * 15);
    maxScore += 15;
    const tempTarget = 0.01;
    const tempScore = tempViolationRate <= tempTarget ? 15 : Math.max(0, 15 - (tempViolationRate - tempTarget) * 1000);
    realityScore += tempScore;
    maxScore += 15;
    return {
      overallScore: Math.round((realityScore / maxScore) * 100),
      rocketShare: Math.round(rocketShare * 100),
      wowShare: Math.round(wowShare * 100),
      freshShare: Math.round(freshShare * 100),
      seoulShare: Math.round(seoulShare * 100),
      aiOptimizedShare: Math.round(aiOptimizedShare * 100),
      tempViolationRate: Math.round(tempViolationRate * 1000) / 10
    };
  }

  /* -------------------------
     4) ì •í•©ì„± ê²€ì¦
  --------------------------*/
  async function runCoupangValidations() {
    const issues = [];
    const sampleSize = Math.min(DATA.length, 8000);
    const picked = new Set();
    while (picked.size < sampleSize) picked.add(irnd(0, DATA.length - 1));
    const sampleData = Array.from(picked).map(i => DATA[i]);

    const errs = sampleData.filter(r => r.Actual_Logistics_Cost != null).map(r => {
      const exp = estimateLogisticsCost(r);
      return Math.abs(r.Actual_Logistics_Cost - exp) / Math.max(exp, 1);
    });
    const mean = errs.reduce((a, b) => a + b, 0) / Math.max(errs.length, 1);
    const sigma = Math.sqrt(errs.reduce((a, b) => a + (b - mean) ** 2, 0) / Math.max(errs.length, 1));

    for (let i = 0; i < sampleData.length; i++) {
      const row = sampleData[i];

      if (row.Is_Rocket_Delivery === 1) {
        if (row.Is_Same_Day_Delivery === 1 && !['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ'].includes(row.Region)) {
          issues.push({level: 'bad', msg: `ë¡œì¼“ë‹¹ì¼ ì„œë¹„ìŠ¤ ì§€ì—­ ìœ„ë°˜: ${row.Order_ID} (${row.Region})`});
        }
      }

      if (row.Is_Cold_Chain_Required === 1) {
        if (row.Target_Temperature == null || row.Actual_Temperature == null) {
          issues.push({level: 'bad', msg: `ì½œë“œì²´ì¸ ì˜¨ë„ ë°ì´í„° ëˆ„ë½: ${row.Order_ID}`});
        }
        if (row.Expiry_Date) {
          const exp = new Date(row.Expiry_Date), ord = new Date(row.Order_Timestamp);
          if (exp < ord) issues.push({level: 'bad', msg: `ìœ í†µê¸°í•œ ê²½ê³¼ ì¬ê³  ì‚¬ìš©: ${row.Order_ID}`});
          if ((exp - ord) / 86400000 <= 1) issues.push({level: 'warn', msg: `ìœ í†µê¸°í•œ ì„ë°• ì¶œê³ (24h ì´ë‚´): ${row.Order_ID}`});
        }
      }

      if (row.Is_WOW_Member === 1 && row.Customer_Delivery_Charge > 0) {
        issues.push({level: 'bad', msg: `WOW íšŒì› ë°°ì†¡ë¹„ ì²­êµ¬: ${row.Order_ID}`});
      }

      const exp = estimateLogisticsCost(row);
      const rel = Math.abs(row.Actual_Logistics_Cost - exp) / Math.max(exp, 1);
      let baseThresh = 0.45;
      if (row.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' || (row.Distance_km || 0) > 30) baseThresh = 0.65;
      const dyn = Math.max(baseThresh, 3 * sigma);
      if (rel > dyn) issues.push({
        level: 'warn',
        msg: `ë¬¼ë¥˜ë¹„ìš© í¸ì°¨ í¼: ${row.Order_ID} (ì˜ˆìƒ:${exp}, ì‹¤ì œ:${row.Actual_Logistics_Cost})`
      });

      try {
        const tOrder = new Date(row.Order_Timestamp);
        const tFC = row.__net_FC_Exit_TS ? new Date(row.__net_FC_Exit_TS) : null;
        const tHubIn = row.__net_Hub_In_TS ? new Date(row.__net_Hub_In_TS) : null;
        const tHubOut = row.__net_Hub_Out_TS ? new Date(row.__net_Hub_Out_TS) : null;
        const tCamp = row.__net_Camp_In_TS ? new Date(row.__net_Camp_In_TS) : null;
        const tLoadS = row.__net_Loadout_Start_TS ? new Date(row.__net_Loadout_Start_TS) : null;
        const tLoadE = row.__net_Loadout_End_TS ? new Date(row.__net_Loadout_End_TS) : null;
        const tOFD = row.__net_OFD_TS ? new Date(row.__net_OFD_TS) : null;
        const tActual = row.Delivery_Timestamp ? new Date(row.Delivery_Timestamp) : null;

        const pickS = row.Picking_Start_TS ? new Date(row.Picking_Start_TS) : null;
        const pickE = row.Picking_End_TS ? new Date(row.Picking_End_TS) : null;
        const packS = row.Packing_Start_TS ? new Date(row.Packing_Start_TS) : null;
        const packE = row.Packing_End_TS ? new Date(row.Packing_End_TS) : null;
        const slaDue = row.Ship_SLA_Due_TS ? new Date(row.Ship_SLA_Due_TS) : null;

        const okNet = tOrder && tFC && tCamp && tLoadS && tLoadE && tOFD && tActual &&
          (tOrder <= tFC) && (!tHubIn || (tFC <= tHubIn)) &&
          (!tHubOut || (tHubIn <= tHubOut)) &&
          (tHubOut ? (tHubOut <= tCamp) : (tFC <= tCamp)) &&
          (tCamp <= tLoadS) && (tLoadS <= tLoadE) && (tLoadE <= tOFD) && (tOFD <= tActual);
        if (!okNet) issues.push({level: 'bad', msg: `íƒ€ì„ë¼ì¸ ë¶ˆì¼ì¹˜: ${row.Order_ID}`});

        const okFC = pickS && pickE && packS && packE &&
          (tOrder <= pickS) && (pickS <= pickE) && (pickE <= packS) && (packS <= packE) && (packE <= tFC);
        if (!okFC) issues.push({level: 'bad', msg: `FC ê³µì • íƒ€ì„ìŠ¤íƒ¬í”„ ë¶ˆì¼ì¹˜: ${row.Order_ID}`});

        if (slaDue && tFC) {
          const breach = tFC > slaDue ? 1 : 0;
          if (breach !== (row.FC_SLA_Breach ?? 0)) {
            issues.push({level: 'warn', msg: `FC SLA ë¸Œë¦¬ì¹˜ í”Œë˜ê·¸/ê³„ì‚° ë¶ˆì¼ì¹˜: ${row.Order_ID}`});
          }
        }
      } catch (e) {
        issues.push({level: 'warn', msg: `íƒ€ì„ë¼ì¸ íŒŒì‹± ì‹¤íŒ¨: ${row.Order_ID}`});
      }

      if (row.Receiving_Date && row.Putaway_Date) {
        const rcv = new Date(row.Receiving_Date), put = new Date(row.Putaway_Date), ord = new Date(row.Order_Timestamp);
        if (put < rcv) {
          issues.push({level: 'bad', msg: `ì ì¹˜ì¼ < ì…ê³ ì¼ (ì„ í›„ê´€ê³„ ì˜¤ë¥˜): ${row.Order_ID}`});
        }
        if (rcv > ord) {
          issues.push({level: 'bad', msg: `ì£¼ë¬¸ì¼ ì´ì „ì— ì…ê³ ë˜ì§€ ì•ŠìŒ (ì‹œì  ì˜¤ë¥˜): ${row.Order_ID}`});
        }
      }

      if ((row.Bin == null || row.Slot == null) && row.Automation_Level !== 'MANUAL') {
        issues.push({level: 'warn', msg: `ë¡œì¼€ì´ì…˜ ì •ë³´ ëˆ„ë½(ìë™í™” ìµœì í™” í•œê³„): ${row.Order_ID}`});
      }

      if (row.Unit_Cost == null) {
        issues.push({level: 'warn', msg: `Unit_Cost(COGS) ì—†ìŒ: ${row.Order_ID}`});
      } else if (row.Unit_Cost > row.Unit_Price * 1.05) {
        issues.push({level: 'warn', msg: `ì›ê°€ê°€ íŒë§¤ê°€ë¥¼ ì´ˆê³¼(ë§ˆì§„ ì••ë°•) : ${row.Order_ID}`});
      }

      if (row.Forecast_Demand == null) {
        issues.push({level: 'warn', msg: `Forecast_Demand ì—†ìŒ(ë¦¬í”Œë ˆë‹ˆì‹œ ìµœì í™” ì œí•œ): ${row.Order_ID}`});
      }
      if (row.Safety_Stock == null) {
        issues.push({level: 'warn', msg: `Safety_Stock ì—†ìŒ(ì„œë¹„ìŠ¤ë ˆë²¨ ê´€ë¦¬ ì œí•œ): ${row.Order_ID}`});
      }
      if (typeof row.Daily_OnHand_Snapshot === 'number' && typeof row.Safety_Stock === 'number') {
        if (row.Daily_OnHand_Snapshot < 0) {
          issues.push({level: 'bad', msg: `OnHand ìŠ¤ëƒ…ìƒ· ìŒìˆ˜: ${row.Order_ID}`});
        } else if (row.Daily_OnHand_Snapshot < row.Safety_Stock && row.Stockout_Flag === 0) {
          issues.push({level: 'warn', msg: `ì•ˆì „ì¬ê³  ë¯¸ë‹¬ì¸ë° í’ˆì ˆí”Œë˜ê·¸=0: ${row.Order_ID}`});
        }
      }

      if (row.Lot_ID && !row.Expiry_Date) {
        issues.push({level: 'warn', msg: `Lot_IDëŠ” ìˆìœ¼ë‚˜ Expiry_Date ì—†ìŒ: ${row.Order_ID}`});
      }
      if (row.Expiry_Date) {
        const exp2 = new Date(row.Expiry_Date), rcv2 = row.Receiving_Date ? new Date(row.Receiving_Date) : null;
        if (rcv2 && exp2 < rcv2) {
          issues.push({level: 'bad', msg: `ìœ í†µê¸°í•œì´ ì…ê³ ì¼ë³´ë‹¤ ì´ì „ (ë°ì´í„° ì˜¤ë¥˜): ${row.Order_ID}`});
        }
      }

      if (!row.ASN_ID || !row.PO_ID) {
        issues.push({level: 'warn', msg: `ASN/PO ì‹ë³„ì ëˆ„ë½: ${row.Order_ID}`});
      }
    }

    const uniq = new Map();
    for (const it of issues) {
      const key = it.msg.replace(/ORD\d+/g, 'ORD*');
      if (!uniq.has(key)) uniq.set(key, {...it, count: 1});
      else uniq.get(key).count++;
    }

    VALIDATION_ISSUES = Array.from(uniq.values()).sort((a, b) => {
      const rank = {bad: 3, warn: 2, good: 1};
      if (rank[b.level] !== rank[a.level]) return rank[b.level] - rank[a.level];
      return b.count - a.count;
    });

    return VALIDATION_ISSUES;
  }

  function renderCoupangValidations() {
    const list = document.getElementById('validateList');
    const sum = document.getElementById('validateSummary');
    list.innerHTML = '';

    if (!VALIDATION_ISSUES || !VALIDATION_ISSUES.length) {
      sum.textContent = 'ëª¨ë“  í•µì‹¬ ê·œì¹™ ì¶©ì¡± (ìƒ˜í”Œì— ì¤‘ëŒ€í•œ ìœ„ë°˜ ì—†ìŒ)';
      sum.className = 'pill ok';
      return;
    }

    let bad = 0, warn = 0;
    VALIDATION_ISSUES.forEach(it => {
      if (it.level === 'bad') bad += it.count;
      else if (it.level === 'warn') warn += it.count;
    });

    sum.textContent = `ìœ„í—˜: ${bad}ê±´ Â· ê²½ê³ : ${warn}ê±´ Â· ì´ ${VALIDATION_ISSUES.reduce((s, v) => s + v.count, 0)}ê±´`;
    sum.className = bad ? 'pill ng' : 'pill ok';

    VALIDATION_ISSUES.slice(0, 100).forEach(it => {
      const div = document.createElement('div');
      div.className = `alert ${it.level === 'bad' ? 'bad' : 'warn'}`;
      div.textContent = `${it.msg.replace('ORD*', 'ë‹¤ìˆ˜')} (${it.count}íšŒ)`;
      list.appendChild(div);
    });
  }

  /* -------------------------
     5) ìœ„í—˜(ë¦¬ìŠ¤í¬) ì§„ë‹¨
  --------------------------*/
  function deriveRisksFromKPI(kpi) {
    if (!kpi || !DATA.length) return [];
    const risks = [];

    if (kpi.netMargin < 2.0) {
      risks.push({level: 'bad', msg: `ìˆœì´ìµë¥  ${kpi.netMargin}% (ì„ê³„ < 2.5%) â€“ ë¬¼ë¥˜ë¹„/ë°˜í’ˆë¹„/ê°€ê²©ì •ì±… ì¬ì ê²€ í•„ìš”`});
    } else if (kpi.netMargin < 3.0) {
      risks.push({level: 'warn', msg: `ìˆœì´ìµë¥  ${kpi.netMargin}% â€“ ë§ˆì§„ ì¿ ì…˜ ì•½í•¨`});
    }

    if (kpi.onTimeRate < 92) risks.push({level: 'bad', msg: `ì •ì‹œìœ¨ ${kpi.onTimeRate}% (ëª©í‘œ â‰¥ 95%)`});
    else if (kpi.onTimeRate < 95) risks.push({level: 'warn', msg: `ì •ì‹œìœ¨ ${kpi.onTimeRate}% â€“ ê°œì„  ì—¬ì§€ ì¡´ì¬`});

    if (kpi.rocketSameDayRate && kpi.rocketSameDayRate < 90) {
      risks.push({level: 'warn', msg: `ë¡œì¼“ë‹¹ì¼ ì •ì‹œìœ¨ ${kpi.rocketSameDayRate}% â€“ ìº í”„ ì¶œì°¨/í—ˆë¸Œ ì²´ë¥˜ ìµœì í™” í•„ìš”`});
    }
    if (kpi.fastShipRate < 30) {
      risks.push({level: 'warn', msg: `30ë¶„ ë‚´ ì¶œê³ ìœ¨ ${kpi.fastShipRate}% â€“ í”¼í‚¹/íŒ¨í‚¹ ìë™í™” ë³‘ëª©`});
    }

    if (kpi.tempViolation > 2) risks.push({level: 'bad', msg: `ì˜¨ë„ ìœ„ë°˜ìœ¨ ${kpi.tempViolation}% â€“ ì‹ ì„ /ëƒ‰ë™ íŒŒì´í”„ë¼ì¸ ì ê²€`});
    else if (kpi.tempViolation > 1.5) risks.push({level: 'warn', msg: `ì˜¨ë„ ìœ„ë°˜ìœ¨ ${kpi.tempViolation}% â€“ ê²½ê³„ì¹˜ ì ‘ê·¼`});

    if (kpi.overstockRate > 25) risks.push({level: 'bad', msg: `ê³¼ì¬ê³  ë¹„ìœ¨ ${kpi.overstockRate}% â€“ ìˆ˜ìš”ì˜ˆì¸¡/ë¦¬ë“œíƒ€ì„ ë³´ì • í•„ìš”`});
    else if (kpi.overstockRate > 20) risks.push({level: 'warn', msg: `ê³¼ì¬ê³  ë¹„ìœ¨ ${kpi.overstockRate}% â€“ ì ì§„ì  ì¶•ì†Œ ê¶Œì¥`});
    if (kpi.stockoutRate > 6) risks.push({level: 'warn', msg: `í’ˆì ˆë¥  ${kpi.stockoutRate}% â€“ ì•ˆì „ì¬ê³ /ë³´ì¶©ì •ì±… ì¬ì¡°ì •`});

    if (kpi.returnRate > 10) risks.push({level: 'bad', msg: `ë°˜í’ˆë¥  ${kpi.returnRate}% â€“ í’ˆì§ˆ/í¬ì¥/ê¸°ëŒ€ë¶ˆì¼ì¹˜ ì˜í–¥`});
    else if (kpi.returnRate > 7) risks.push({level: 'warn', msg: `ë°˜í’ˆë¥  ${kpi.returnRate}% â€“ ê°ì¶• ì—¬ì§€`});

    if (kpi.ltvCac < 3.0) risks.push({level: 'warn', msg: `LTV:CAC ${kpi.ltvCac} â€“ íšë“ë¹„ ëŒ€ë¹„ ìƒì• ê°€ì¹˜ê°€ ë‚®ìŒ`});
    if (kpi.aiAcc < 80) risks.push({level: 'warn', msg: `AI ì´íƒˆ ì˜ˆì¸¡ ì •í™•ë„ ${kpi.aiAcc}% â€“ í”¼ì³ ì—”ì§€ë‹ˆì–´ë§/ë¼ë²¨ í’ˆì§ˆ ì ê²€`});

    if (kpi.load < 70) risks.push({level: 'warn', msg: `ì ì¬ìœ¨ ${kpi.load}% â€“ ë¼ìš°íŒ…/ì»·ì˜¤í”„ ì •ì±… ì¡°ì • í•„ìš”`});

    const jeju = DATA.filter(r => r.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„');
    if (jeju.length) {
      const jejuSevere = jeju.filter(r => ['ê°•í’', 'ë¹„', 'ì•ˆê°œ'].includes(r.Weather_Condition)).length / jeju.length * 100;
      if (jejuSevere > 15) risks.push({level: 'warn', msg: `ì œì£¼ ì•…ì²œí›„ ë…¸ì¶œ ${jejuSevere.toFixed(1)}% â€“ í—ˆë¸Œ/ì„ ë°• ì—°ê³„ ë²„í¼ í•„ìš”`});
    }

    return risks.sort((a, b) => (a.level === 'bad' ? -1 : 1));
  }

  function renderCoupangRisks() {
    const cont = document.getElementById('riskList');
    cont.innerHTML = '';
    const kpi = calculateCoupangKPIs(DATA.slice(-Math.min(30000, DATA.length)));
    const risks = deriveRisksFromKPI(kpi);

    if (!risks.length) {
      const ok = document.createElement('div');
      ok.className = 'alert good';
      ok.textContent = 'ì£¼ìš” ë¦¬ìŠ¤í¬ ì—†ìŒ â€“ ì§€í‘œ ì•ˆì •';
      cont.appendChild(ok);
      return;
    }
    risks.slice(0, 20).forEach(r => {
      const div = document.createElement('div');
      div.className = `alert ${r.level === 'bad' ? 'bad' : 'warn'}`;
      div.textContent = r.msg;
      cont.appendChild(div);
    });
  }

  /* -------------------------
     6) ìë™ ë¯¸ì„¸íŠœë‹ (Autotune)
  --------------------------*/
  function autotuneDistributions() {
    if (!ENABLE_AUTOTUNE || DATA.length < 3000) return;

    const sample = DATA.slice(-Math.min(20000, DATA.length));
    const lossRate = sample.filter(r => r.Is_Loss_Order === 1).length / sample.length;
    const coldRows = sample.filter(r => r.Is_Cold_Chain_Required === 1);
    const tempRate = coldRows.length ? coldRows.filter(r => r.Temperature_Violation === 1).length / coldRows.length : 0;
    const jejuRows = sample.filter(r => r.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„');
    const jejuExposure = jejuRows.length ? jejuRows.filter(r => ['ê°•í’', 'ë¹„', 'ì•ˆê°œ'].includes(r.Weather_Condition)).length / jejuRows.length : 0;
    const overstockRate = sample.filter(r => r.Overstock_Flag === 1).length / sample.length;

    const inRange = (v, [lo, hi]) => v >= lo && v <= hi;

    // ë¬¼ë¥˜ë¹„ ìŠ¤ì¼€ì¼: ì ì ì£¼ë¬¸ìœ¨ íƒ€ê¹ƒ
    if (!inRange(lossRate, DIALS.lossOrderTarget)) {
      const [lo, hi] = DIALS.lossOrderTarget;
      if (lossRate < lo) CAL.costBias = clamp(CAL.costBias * 1.02, 0.85, 1.35);
      else if (lossRate > hi) CAL.costBias = clamp(CAL.costBias * 0.98, 0.85, 1.35);
    }

    // ì˜¨ë„ ìœ„ë°˜ìœ¨
    if (!inRange(tempRate, DIALS.tempViolationTarget)) {
      const [lo, hi] = DIALS.tempViolationTarget;
      if (tempRate < lo) CAL.tempViolationBase = clamp(CAL.tempViolationBase * 1.05, 0.005, 0.05);
      else if (tempRate > hi) CAL.tempViolationBase = clamp(CAL.tempViolationBase * 0.95, 0.005, 0.05);
    }

    // ì œì£¼ ì•…ì²œí›„ ë…¸ì¶œ
    if (!inRange(jejuExposure, DIALS.jejuWeatherExposureTarget)) {
      const [lo, hi] = DIALS.jejuWeatherExposureTarget;
      if (jejuExposure < lo) CAL.jejuWeatherScale = clamp(CAL.jejuWeatherScale * 1.05, 0.6, 1.8);
      else if (jejuExposure > hi) CAL.jejuWeatherScale = clamp(CAL.jejuWeatherScale * 0.95, 0.6, 1.8);
    }

    // ê³¼ì¬ê³  ë¹„ìœ¨
    if (!inRange(overstockRate, DIALS.overstockTarget)) {
      const [lo, hi] = DIALS.overstockTarget;
      if (overstockRate < lo) CAL.overstockProb = clamp(CAL.overstockProb * 1.05, 0.05, 0.6);
      else if (overstockRate > hi) CAL.overstockProb = clamp(CAL.overstockProb * 0.95, 0.05, 0.6);
    }
  }

  /* -------------------------
     7) ë³´ì •/í‘œì‹œ/ë„ìš°ë¯¸
  --------------------------*/
  function recalibrateIndustryStandards(targets) {
    const k = calculateCoupangKPIs(DATA);
    if (!k || !isFinite(k.netMargin)) return;
    // ìˆœì´ìµë¥ ì„ íƒ€ê¹ƒìœ¼ë¡œ ë¯¸ì„¸ ë³´ì • (ë¬¼ë¥˜ë¹„ ìŠ¤ì¼€ì¼ ì¡°ì •)
    const diff = (k.netMargin - (targets.netMarginPct ?? 3.0)) / 100;
    CAL.costBias = clamp(CAL.costBias * (1 + diff * -0.6), 0.8, 1.35);
  }

  function updateCoupangKPI(k) {
    if (!k) return;
    setText('k_totalSales', fmtKRW(k.totalSales));
    setText('k_netMargin', fmtPct(k.netMargin));
    setText('k_aov', fmtKRW(k.aov));
    setText('k_arppu', fmtKRW(k.arppu));

    setText('k_rocketShare', fmtPct(k.rocketShare));
    setText('k_rocketSameDayRate', fmtPct(k.rocketSameDayRate));
    setText('k_rocketDawnRate', fmtPct(k.rocketDawnRate));
    setText('k_fastShipRate', fmtPct(k.fastShipRate));

    setText('k_wowShare', fmtPct(k.wowShare));
    setText('k_wowPlusShare', fmtPct(k.wowPlusShare));
    setText('k_wowAovGap', fmtKRW(k.wowAovGap));
    setText('k_wowChurnRisk', (k.wowChurnRisk ?? 0).toLocaleString('ko-KR'));

    setText('k_freshShare', fmtPct(k.freshShare));
    setText('k_coldChainRate', fmtPct(k.coldChainRate));
    setText('k_tempViolation', fmtPct(k.tempViolation));
    setText('k_frozenQuality', (k.frozenQuality ?? 0).toString());

    setText('k_megaHubShare', fmtPct(k.megaHubShare));
    setText('k_seoulCoverage', fmtPct(k.seoulCoverage));
    setText('k_avgDistance', (k.avgDistance ?? 0).toFixed(1));
    setText('k_networkEff', (k.networkEff ?? 0).toString());

    setText('k_aiOptimized', fmtPct(k.aiOptimized));
    setText('k_autoPickRate', fmtPct(k.autoPickRate));
    setText('k_avgPickTime', (k.avgPickTime ?? 0).toString());
    setText('k_wmsAdvanced', (k.wmsAdvanced ?? 0).toString());

    setText('k_onTime', fmtPct(k.onTimeRate));
    setText('k_sla', fmtPct(k.slaRate));
    setText('k_load', (k.load ?? 0).toString());
    setText('k_fuel', (k.fuel ?? 0).toFixed(1));
    setText('k_route', (k.route ?? 0).toString());
    setText('k_exception', fmtPct(k.exceptionRate));

    setText('k_returnRate', fmtPct(k.returnRate));
    setText('k_returnCost', fmtPct(k.returnCostRate));
    setText('k_resell', fmtPct(k.resellRate));

    setText('k_invTurn', (k.invTurn ?? 0).toFixed(1));
    setText('k_stockout', fmtPct(k.stockoutRate));
    setText('k_overstock', fmtPct(k.overstockRate));
    setText('k_invAcc', (k.invAcc ?? 0).toFixed(1));
    setText('k_shrink', fmtPct(k.shrink));
    setText('k_wms', fmtPct(k.wmsUtil));

    setText('k_ltvCac', (k.ltvCac ?? 0).toString());
    setText('k_retention', fmtPct(k.retention));
    setText('k_churn', fmtPct(k.churnRate));
    setText('k_ai', fmtPct(k.aiAcc));
  }

  function setText(id, v) {
    const el = document.getElementById(id);
    if (el) el.textContent = v ?? '-';
  }

  function fmtPct(v) {
    if (v == null || isNaN(v)) return '-';
    return `${(+v).toFixed(1)}%`;
  }

  function fmtKRW(n) {
    if (n == null || isNaN(n)) return '-';
    return 'â‚©' + Math.round(n).toLocaleString('ko-KR');
  }

  function updateProgress() {
    const {processedRows, totalRows, currentChunk, totalChunks, startTime} = PROCESSING_STATE;
    const pct = totalRows ? Math.min(100, Math.round(processedRows / totalRows * 100)) : 0;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').textContent = `ì²˜ë¦¬ ì¤‘... ${pct}%`;
    document.getElementById('progressStats').textContent = `${processedRows.toLocaleString()} / ${totalRows.toLocaleString()} rows Â· ${currentChunk}/${totalChunks} chunks`;
    const elapsed = (performance.now() - startTime) / 1000;
    const eps = processedRows / Math.max(elapsed, 1e-6);
    const remain = totalRows - processedRows;
    const eta = remain / Math.max(eps, 1);
    document.getElementById('progressETA').textContent = `ì˜ˆìƒ ì™„ë£Œ: ${formatETA(eta)}`;
  }

  function formatETA(sec) {
    if (!isFinite(sec) || sec < 0) return '-';
    if (sec < 60) return `${Math.round(sec)}ì´ˆ`;
    const m = Math.floor(sec / 60), s = Math.round(sec % 60);
    if (m < 60) return `${m}ë¶„ ${s}ì´ˆ`;
    const h = Math.floor(m / 60), m2 = m % 60;
    return `${h}ì‹œê°„ ${m2}ë¶„`;
  }

  function updateUIState(state) {
    const btnGen = document.getElementById('btnGen');
    const btnStop = document.getElementById('btnStop');
    const btnCsv = document.getElementById('btnCsv');
    const status = document.getElementById('status');
    const pc = document.getElementById('progressContainer');
    if (state === 'running') {
      btnGen.disabled = true;
      btnStop.disabled = false;
      btnStop.style.display = '';
      btnCsv.disabled = true;
      status.textContent = 'RUNNING';
      status.className = 'pill running';
      pc.style.display = '';
    } else if (state === 'completed') {
      btnGen.disabled = false;
      btnStop.disabled = true;
      btnStop.style.display = 'none';
      btnCsv.disabled = false;
      status.textContent = 'COMPLETED';
      status.className = 'pill ok';
      pc.style.display = '';
    } else if (state === 'stopped') {
      btnGen.disabled = false;
      btnStop.disabled = true;
      btnStop.style.display = 'none';
      btnCsv.disabled = DATA.length === 0;
      status.textContent = 'STOPPED';
      status.className = 'pill ng';
      pc.style.display = '';
    } else if (state === 'error') {
      btnGen.disabled = false;
      btnStop.disabled = true;
      btnStop.style.display = 'none';
      btnCsv.disabled = true;
      status.textContent = 'ERROR';
      status.className = 'pill ng';
      pc.style.display = '';
    } else {
      btnGen.disabled = false;
      btnStop.disabled = true;
      btnStop.style.display = 'none';
      btnCsv.disabled = DATA.length === 0;
      status.textContent = 'READY';
      status.className = 'pill ok';
      pc.style.display = 'none';
    }
  }

  function renderPerformanceMetrics() {
    const cont = document.getElementById('perfList');
    cont.innerHTML = '';
    const add = (text, cls = '') => {
      const d = document.createElement('div');
      d.className = `alert ${cls || 'rocket'}`;
      d.textContent = text;
      cont.appendChild(d);
    };
    if (!PERFORMANCE_METRICS || !Object.keys(PERFORMANCE_METRICS).length) {
      add('ì•„ì§ ìˆ˜ì§‘ëœ ì„±ëŠ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');
      return;
    }
    add(`ì´ ì²˜ë¦¬ì‹œê°„: ${(PERFORMANCE_METRICS.totalTime / 1000).toFixed(1)}s`);
    add(`ì²˜ë¦¬ì†ë„: ${PERFORMANCE_METRICS.rowsPerSecond.toLocaleString()} rows/sec`);
    add(`ì²­í¬ ìˆ˜: ${PERFORMANCE_METRICS.chunksProcessed}`);
    add(`ë©”ëª¨ë¦¬ íš¨ìœ¨: ${PERFORMANCE_METRICS.memoryEfficiency}%`);
    add(`í˜„ì‹¤ì„± ì ìˆ˜: ${PERFORMANCE_METRICS.realityScore}/100`, 'good');
  }

  function renderCoupangTable() {
    const thead = document.querySelector('#tbl thead');
    const tbody = document.querySelector('#tbl tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    if (!DATA.length) return;

    // ê°€ë…ì„±ì„ ìœ„í•œ ê¸°ë³¸ í‘œì‹œ ì»¬ëŸ¼ (CSVëŠ” ì „ì²´ ì»¬ëŸ¼ í¬í•¨)
    const BASE_COLS = [
      'Order_ID', 'Order_Timestamp', 'Delivery_Mode', 'Region', 'City', 'District', 'Fulfillment_Center',
      'Is_WOW_Member', 'Product_Category', 'SKU', 'Quantity', 'Order_Amount',
      '__net_FC_Exit_TS', '__net_Hub_In_TS', '__net_Hub_Out_TS', '__net_Camp_In_TS', '__net_OFD_TS', 'Delivery_Timestamp',
      'Is_Delayed', 'SLA_Breach', 'FC_SLA_Breach', 'Order_To_Ship_Minutes', 'Distance_km',
      'Picking_Start_TS', 'Picking_End_TS', 'Packing_Start_TS', 'Packing_End_TS',
      'Lot_ID', 'Expiry_Date', 'Bin', 'Slot', 'Unit_Cost'
    ];
    const cols = BASE_COLS.filter(c => c in DATA[0]);

    // header
    const trh = document.createElement('tr');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    // body (ìµœëŒ€ 500í–‰ ë¯¸ë¦¬ë³´ê¸°)
    const N = Math.min(500, DATA.length);
    for (let i = 0; i < N; i++) {
      const r = DATA[i];
      const tr = document.createElement('tr');
      cols.forEach(c => {
        const td = document.createElement('td');
        let v = r[c];
        if (c === 'Order_Amount' || c === 'Unit_Cost') v = fmtKRW(v);
        if (c === 'Is_WOW_Member' || c.startsWith('Is_') || c.endsWith('_Breach')) v = v ? '1' : '0';
        td.textContent = v == null ? '' : v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
  }

  function buildCSV() {
    if (!DATA.length) return '';
    // ì „ì²´ ì»¬ëŸ¼ ì§‘í•©
    const colSet = new Set();
    DATA.forEach(r => Object.keys(r).forEach(k => {
      if (!k.startsWith('_')) colSet.add(k);
    })); // ë‚´ë¶€ í‚¤(_*) ì œì™¸
    // ë³´ê¸° ì¢‹ì€ ì„ í–‰ ì»¬ëŸ¼ ìˆœì„œ ì§€ì •
    const PREF = [
      'Order_ID', 'Order_Date', 'Order_Timestamp', 'Order_Hour',
      'Customer_ID', 'Is_WOW_Member', 'WOW_Tier', 'WOW_Join_Date', 'WOW_Tenure_Days', 'Customer_Segment',
      'Delivery_Mode', 'Planned_Delivery_Date', 'Actual_Delivery_Date', 'Delivery_Timestamp',
      'SLA_Breach', 'Is_Delayed', 'Delay_Hours', 'Delivery_Status',
      'FC_SLA_Breach', 'Ship_SLA_Due_TS', 'Order_To_Ship_Minutes', 'Fast_Ship_30min',
      'Region', 'City', 'District', 'Address', 'Fulfillment_Center', 'Is_Mega_Hub', 'Distance_km',
      'Product_Category', 'SKU', 'ABC_Category', 'Unit_Price', 'Quantity', 'Order_Amount', 'Is_Fresh_Food', 'Is_Cold_Chain_Required',
      'Target_Temperature', 'Actual_Temperature', 'Temperature_Violation', 'Cold_Chain_Quality_Score',
      'Picking_Start_TS', 'Picking_End_TS', 'Packing_Start_TS', 'Packing_End_TS',
      '__net_Route_Type', '__net_Sortation_Hub_Name', '__net_FC_Exit_TS', '__net_Hub_In_TS', '__net_Hub_Out_TS', '__net_Camp_In_TS', '__net_Loadout_Start_TS', '__net_Loadout_End_TS', '__net_OFD_TS', '__net_FC_Dwell_Min', '__net_Hub_Dwell_Min', '__net_Camp_Dwell_Min',
      'Receiving_Date', 'Putaway_Date', 'Lot_ID', 'Expiry_Date', 'Bin', 'Slot', 'Unit_Cost', 'Daily_OnHand_Snapshot', 'Safety_Stock', 'Forecast_Demand', 'ASN_ID', 'PO_ID', 'Replenishment_Type',
      'Vehicle_ID', 'Vehicle_Type', 'Vehicle_Capacity', 'Driver_ID', 'Driver_Grade', 'Load_Factor', 'Fuel_Efficiency', 'Routing_Score', 'GPS_Tracking',
      'Actual_Logistics_Cost', 'Customer_Delivery_Charge', 'Gross_Profit', 'Net_Profit', 'CAC', 'Customer_LTV', 'LTV_to_CAC',
      'Return_Flag', 'Return_Reason', 'Return_Cost', 'Is_Resellable', 'Resellability_Reason',
      'Current_Stock', 'Reorder_Point', 'Stockout_Flag', 'Overstock_Flag', 'Inventory_Turnover', 'Inventory_Accuracy',
      'Automation_Level', 'Total_Process_Time', 'WMS_Usage', 'OMS_Usage', 'WMS_Advanced_Score',
      'Service_Quality_Score', 'Customer_NPS', 'Processing_Error_Rate',
      'Weather_Condition', 'Weather_Severity_Score',
      'Churn_Flag', 'Predicted_Churn_Score', 'Is_Rocket_Delivery', 'Is_Same_Day_Delivery', 'Is_Dawn_Delivery', 'Is_Fresh_Delivery',
      'Is_Premium_Order', 'Is_Bulk_Order', 'Is_Weekend_Order', 'Is_Peak_Hour_Order', 'Is_Free_Shipping', 'Is_Weather_Risk', 'Is_Long_Distance', 'Is_High_LTV', 'Is_Churn_Risk', 'Is_VIP_Customer', 'Is_Loss_Order', 'Is_AI_Optimized',
      'CLV_Quartile', 'CLV_Quartile_Label'
    ];
    const cols = [...PREF, ...[...colSet].filter(c => !PREF.includes(c))];

    const esc = (s) => {
      if (s == null) return '';
      const str = String(s);
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
      return str;
    };
    let csv = cols.join(',') + '\n';
    for (const r of DATA) {
      csv += cols.map(c => esc(r[c])).join(',') + '\n';
    }
    return csv;
  }

  function downloadCSV() {
    const csv = buildCSV();
    if (!csv) return;
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
    a.href = url;
    a.download = `coupang_logistics_sim_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  /* -------------------------
     8) ì´ˆê¸°í™” & ì´ë²¤íŠ¸
  --------------------------*/
  function initYearOptions() {
    const sy = document.getElementById('startYear');
    const ey = document.getElementById('endYear');
    const now = new Date().getFullYear();
    const years = [];
    for (let y = now - 6; y <= now; y++) years.push(y);
    sy.innerHTML = '';
    ey.innerHTML = '';
    years.forEach(y => {
      const o1 = document.createElement('option');
      o1.value = y;
      o1.textContent = y;
      sy.appendChild(o1);
      const o2 = document.createElement('option');
      o2.value = y;
      o2.textContent = y;
      ey.appendChild(o2);
    });
    sy.value = now - 2;
    ey.value = now;
  }

  document.getElementById('btnGen').addEventListener('click', async () => {
    if (PROCESSING_STATE.isRunning) return;
    const totalOrders = parseInt(document.getElementById('orderCount').value, 10) || 5000;
    const totalUsers = parseInt(document.getElementById('userCount').value, 10) || Math.max(1000, Math.round(totalOrders * 0.2));
    const chunkSize = parseInt(document.getElementById('chunkSize').value, 10) || CHUNK_CONFIG.defaultSize;
    const startYear = parseInt(document.getElementById('startYear').value, 10);
    const endYear = parseInt(document.getElementById('endYear').value, 10);
    const rocketRate = parseFloat(document.getElementById('rocketRate').value) || 55;
    const wowRate = parseFloat(document.getElementById('wowRate').value) || 80;
    PROCESSING_STATE.shouldStop = false;
    await generateCoupangRealisticData(totalOrders, totalUsers, startYear, endYear, chunkSize, rocketRate, wowRate);
  });

  document.getElementById('btnStop').addEventListener('click', () => {
    PROCESSING_STATE.shouldStop = true;
    updateUIState('stopped');
  });

  document.getElementById('btnCsv').addEventListener('click', downloadCSV);

  window.addEventListener('load', () => {
    initYearOptions();
    updateUIState('ready');
  });


  // ---- UTIL ----
  const $ = (id) => document.getElementById(id);
  const num = (id, d = 0) => {
    const v = parseFloat($(id)?.value);
    return isNaN(v) ? d : v;
  };
  const clamp01 = (v) => Math.max(0, Math.min(1, v));

  // ---- ëª©í‘œ ìˆœì´ìµë¥  ----
  function applyNetMarginTarget(updateUI = true) {
    const target = num('targetNetMargin', 3.2);
    recalibrateIndustryStandards({netMarginPct: target, ltvCacCenter: 3.5, ltvCacMin: 2.5, ltvCacMax: 5.0});
    try {
      localStorage.setItem('targetNetMargin', String(target));
    } catch (e) {
    }
    if (updateUI && (window.DATA?.length || 0) > 0) {
      const k = calculateCoupangKPIs(DATA);
      updateCoupangKPI(k);
      updateFulfillmentKPI(calculateFulfillmentKPIs(DATA));
      renderCoupangRisks();
      const s = $('status');
      if (s) {
        s.className = 'pill ok';
        s.textContent = 'TARGET APPLIED';
      }
    }
  }

  // ---- DIALS I/O ----
  function readDialsFromUI() {
    return {
      lossOrderTarget: [clamp01(num('dial_loss_lo', 0.07)), clamp01(num('dial_loss_hi', 0.12))],
      tempViolationTarget: [clamp01(num('dial_temp_lo', 0.01)), clamp01(num('dial_temp_hi', 0.02))],
      jejuWeatherExposureTarget: [clamp01(num('dial_jeju_lo', 0.10)), clamp01(num('dial_jeju_hi', 0.15))],
      overstockTarget: [clamp01(num('dial_over_lo', 0.15)), clamp01(num('dial_over_hi', 0.25))],
      expiryImminentTarget: [clamp01(num('dial_exp_lo', 0.005)), clamp01(num('dial_exp_hi', 0.01))]
    };
  }

  function writeDialsToUI(d) {
    if (!d) return;
    $('dial_loss_lo').value = d.lossOrderTarget[0];
    $('dial_loss_hi').value = d.lossOrderTarget[1];
    $('dial_temp_lo').value = d.tempViolationTarget[0];
    $('dial_temp_hi').value = d.tempViolationTarget[1];
    $('dial_jeju_lo').value = d.jejuWeatherExposureTarget[0];
    $('dial_jeju_hi').value = d.jejuWeatherExposureTarget[1];
    $('dial_over_lo').value = d.overstockTarget[0];
    $('dial_over_hi').value = d.overstockTarget[1];
    $('dial_exp_lo').value = d.expiryImminentTarget[0];
    $('dial_exp_hi').value = d.expiryImminentTarget[1];
  }

  function defaultDials() {
    return {
      lossOrderTarget: [0.07, 0.12],
      tempViolationTarget: [0.01, 0.02],
      jejuWeatherExposureTarget: [0.10, 0.15],
      overstockTarget: [0.15, 0.25],
      expiryImminentTarget: [0.005, 0.01]
    };
  }

  function applyDials(updateUI = true) {
    const d = readDialsFromUI();
    DIALS = d; // â† 1ë‹¨ê³„ì—ì„œ letìœ¼ë¡œ ë°”ê¿¨ê¸° ë•Œë¬¸ì— ì¬í• ë‹¹ ê°€ëŠ¥
    try {
      localStorage.setItem('DIALS_JSON', JSON.stringify(d));
    } catch (e) {
    }
    const t = $('tuneStatus');
    if (t) {
      t.className = 'pill ok';
      t.textContent = 'DIALS APPLIED';
    }
    if (updateUI && (window.DATA?.length || 0) > 0) {
      autotuneDistributions(); // ì¦‰ì‹œ 1íšŒ íŠœë‹
      const k = calculateCoupangKPIs(DATA);
      updateCoupangKPI(k);
      updateFulfillmentKPI(calculateFulfillmentKPIs(DATA));
      renderCoupangRisks();
    }
  }

  function resetDialsToDefault(updateUI = true) {
    const d = defaultDials();
    writeDialsToUI(d);
    applyDials(updateUI);
  }

  function loadTuningFromStorage() {
    try {
      const savedTarget = localStorage.getItem('targetNetMargin');
      if (savedTarget != null && $('targetNetMargin')) $('targetNetMargin').value = savedTarget;

      const raw = localStorage.getItem('DIALS_JSON');
      const d = raw ? JSON.parse(raw) : defaultDials();
      writeDialsToUI(d);
      DIALS = d; // ë©”ëª¨ë¦¬ì—ë„ ë°˜ì˜
    } catch (e) {
      writeDialsToUI(defaultDials());
    }
  }

  // ---- UI ë°”ì¸ë”© ----
  document.addEventListener('DOMContentLoaded', () => {
    if ($('targetNetMargin')) {
      $('targetNetMargin').addEventListener('change', () => applyNetMarginTarget(true));
      $('targetNetMargin').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyNetMarginTarget(true);
      });
    }

    if ($('btnTune') && $('tunePanel')) {
      $('btnTune').addEventListener('click', () => {
        const p = $('tunePanel');
        p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
      });
    }

    if ($('btnApplyDials')) $('btnApplyDials').addEventListener('click', () => applyDials(true));
    if ($('btnResetDials')) $('btnResetDials').addEventListener('click', () => resetDialsToDefault(true));

    loadTuningFromStorage();
  });


</script>

<script>
  // === DIALS ê¸€ë£¨: í† ê¸€/ì ìš©/ì´ˆê¸°í™” + ìë™íŠœë‹ + ìˆœì´ìµë¥  ëª©í‘œ ë³´ì • ===
  (() => {
    const el = id => document.getElementById(id);
    const DIALS_DEFAULT = JSON.parse(JSON.stringify(DIALS));
    const CAL_DEFAULT = JSON.parse(JSON.stringify(CAL));
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const mid = ([a, b]) => (a + b) / 2;

    function readDialInputs() {
      const v = id => parseFloat(el(id).value);
      return {
        loss: [v('dial_loss_lo'), v('dial_loss_hi')],
        temp: [v('dial_temp_lo'), v('dial_temp_hi')],
        jeju: [v('dial_jeju_lo'), v('dial_jeju_hi')],
        over: [v('dial_over_lo'), v('dial_over_hi')],
        exp: [v('dial_exp_lo'), v('dial_exp_hi')],
      };
    }

    function measureCurrentRates() {
      const rows = DATA || [];
      const total = rows.length || 1;
      const cold = rows.filter(r => r.Is_Cold_Chain_Required === 1);
      const jeju = rows.filter(r => r.Region === 'ì œì£¼íŠ¹ë³„ìì¹˜ë„');
      const severeJeju = jeju.filter(r => (r.Weather_Severity_Score ?? 0) > 0.6);
      const expImminent = cold.filter(r => {
        if (!r.Expiry_Date) return false;
        const ord = new Date(r.Order_Timestamp);
        const exp = new Date(r.Expiry_Date);
        return (exp - ord) / 86400000 <= 1.0;
      });

      return {
        loss: rows.filter(r => r.Is_Loss_Order === 1).length / total,
        temp: cold.length ? cold.filter(r => r.Temperature_Violation === 1).length / cold.length : 0,
        jeju: jeju.length ? severeJeju.length / jeju.length : 0,
        over: rows.filter(r => r.Overstock_Flag === 1).length / total,
        exp: cold.length ? expImminent.length / cold.length : 0
      };
    }

    // â–¶ Apply: í™”ë©´ ì…ë ¥ê°’ â†’ DIALS/CAL ë°˜ì˜
    window.applyDials = function (recalcKPIs = true) {
      const inp = readDialInputs();
      DIALS.lossOrderTarget = inp.loss;
      DIALS.tempViolationTarget = inp.temp;
      DIALS.jejuWeatherExposureTarget = inp.jeju;
      DIALS.overstockTarget = inp.over;
      DIALS.expiryImminentTarget = inp.exp;

      const cur = measureCurrentRates();

      if ((DATA?.length || 0) > 1000) {
        const lossMid = mid(DIALS.lossOrderTarget);
        if (cur.loss > 0) CAL.costBias = clamp(CAL.costBias * (lossMid / cur.loss), 0.6, 1.8);

        const tempMid = mid(DIALS.tempViolationTarget);
        CAL.tempViolationBase = clamp(CAL.tempViolationBase * ((tempMid || 0.0001) / Math.max(cur.temp, 0.0001)), 0.002, 0.08);

        const jejuMid = mid(DIALS.jejuWeatherExposureTarget);
        CAL.jejuWeatherScale = clamp(CAL.jejuWeatherScale * ((jejuMid || 0.0001) / Math.max(cur.jeju, 0.0001)), 0.5, 2.5);

        const overMid = mid(DIALS.overstockTarget);
        CAL.overstockProb = clamp(CAL.overstockProb * ((overMid || 0.0001) / Math.max(cur.over, 0.0001)), 0.05, 0.6);

        const expMid = mid(DIALS.expiryImminentTarget);
        CAL.expiryImminentRate = clamp(CAL.expiryImminentRate * ((expMid || 0.0001) / Math.max(cur.exp, 0.0001)), 0.001, 0.2);
      } else {
        // ë°ì´í„°ê°€ ì•„ì§ ì—†ìœ¼ë©´ í•©ë¦¬ì  ê¸°ë³¸ì¹˜ë¡œ ì„¸íŒ…
        CAL.tempViolationBase = mid(DIALS.tempViolationTarget);
        CAL.jejuWeatherScale = clamp(1.0 + (mid(DIALS.jejuWeatherExposureTarget) - 0.12) / 0.12, 0.5, 2.0);
        CAL.overstockProb = mid(DIALS.overstockTarget);
        CAL.expiryImminentRate = mid(DIALS.expiryImminentTarget);
        CAL.costBias = clamp(1.0 * (mid(DIALS.lossOrderTarget) / 0.10), 0.6, 1.8);
      }

      const s = el('tuneStatus');
      if (s) {
        s.textContent = `APPLIED (costBias=${CAL.costBias.toFixed(2)}, jejuÃ—${CAL.jejuWeatherScale.toFixed(2)})`;
        s.className = 'pill running';
      }

      if (recalcKPIs && (DATA?.length || 0) > 0) {
        updateCoupangKPI(calculateCoupangKPIs(DATA));
        updateFulfillmentKPI(calculateFulfillmentKPIs(DATA));
      }
    };

    // â–¶ Autotune: ì²­í¬ë§ˆë‹¤ ì²œì²œíˆ ëª©í‘œë¡œ ìˆ˜ë ´
    window.autotuneDistributions = function () {
      if (!ENABLE_AUTOTUNE) return;
      if ((DATA?.length || 0) < 2000) return;

      const cur = measureCurrentRates();
      const tgt = {
        loss: mid(DIALS.lossOrderTarget),
        temp: mid(DIALS.tempViolationTarget),
        jeju: mid(DIALS.jejuWeatherExposureTarget),
        over: mid(DIALS.overstockTarget),
        exp: mid(DIALS.expiryImminentTarget)
      };

      const step = 0.10; // 10%ì”© ë³´ì •
      if (cur.loss > 0) CAL.costBias = clamp(CAL.costBias * (1 + step * ((tgt.loss / cur.loss) - 1)), 0.6, 1.8);
      CAL.tempViolationBase = clamp(CAL.tempViolationBase * (1 + step * ((tgt.temp / Math.max(cur.temp, 0.0001)) - 1)), 0.002, 0.08);
      CAL.jejuWeatherScale = clamp(CAL.jejuWeatherScale * (1 + step * ((tgt.jeju / Math.max(cur.jeju, 0.0001)) - 1)), 0.5, 2.5);
      CAL.overstockProb = clamp(CAL.overstockProb * (1 + step * ((tgt.over / Math.max(cur.over, 0.0001)) - 1)), 0.05, 0.6);
      CAL.expiryImminentRate = clamp(CAL.expiryImminentRate * (1 + step * ((tgt.exp / Math.max(cur.exp, 0.0001)) - 1)), 0.001, 0.2);

      const s = el('tuneStatus');
      if (s) {
        s.textContent = `AUTO-TUNINGâ€¦ (lossâ‰ˆ${(cur.loss * 100).toFixed(1)}%â†’${(tgt.loss * 100).toFixed(1)}%)`;
        s.className = 'pill running';
      }
    };

    // â–¶ ìˆœì´ìµë¥  ëª©í‘œì¹˜ ì…ë ¥ ë°˜ì˜(ìƒë‹¨ ì…ë ¥)
    window.recalibrateIndustryStandards = function ({
                                                      netMarginPct = 3.0,
                                                      ltvCacCenter = 3.5,
                                                      ltvCacMin = 2.5,
                                                      ltvCacMax = 5.0
                                                    } = {}) {
      const rows = DATA || [];
      const cur = rows.length ? calculateCoupangKPIs(rows).netMargin : null; // %
      if (cur != null && cur !== 0) {
        const ratio = (cur || 0.01) / (netMarginPct || 0.01);
        CAL.costBias = clamp(CAL.costBias * ratio, 0.6, 1.8);
      }
      const st = el('status');
      if (st) st.textContent = `TARGET NET MARGIN=${netMarginPct.toFixed(1)}%`;
    };

    // â–¶ UI ì´ë²¤íŠ¸ ë°”ì¸ë”©
    el('btnTune')?.addEventListener('click', () => {
      const p = el('tunePanel');
      if (!p) return;
      p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
    });

    el('btnApplyDials')?.addEventListener('click', () => applyDials(true));

    el('btnResetDials')?.addEventListener('click', () => {
      Object.assign(DIALS, JSON.parse(JSON.stringify(DIALS_DEFAULT)));
      Object.assign(CAL, JSON.parse(JSON.stringify(CAL_DEFAULT)));
      const set = (id, val) => {
        const e = el(id);
        if (e) e.value = val;
      };
      set('dial_loss_lo', DIALS.lossOrderTarget[0]);
      set('dial_loss_hi', DIALS.lossOrderTarget[1]);
      set('dial_temp_lo', DIALS.tempViolationTarget[0]);
      set('dial_temp_hi', DIALS.tempViolationTarget[1]);
      set('dial_jeju_lo', DIALS.jejuWeatherExposureTarget[0]);
      set('dial_jeju_hi', DIALS.jejuWeatherExposureTarget[1]);
      set('dial_over_lo', DIALS.overstockTarget[0]);
      set('dial_over_hi', DIALS.overstockTarget[1]);
      set('dial_exp_lo', DIALS.expiryImminentTarget[0]);
      set('dial_exp_hi', DIALS.expiryImminentTarget[1]);
      const s = el('tuneStatus');
      if (s) {
        s.textContent = 'RESET TO DEFAULTS';
        s.className = 'pill ok';
      }
    });

    el('targetNetMargin')?.addEventListener('change', (e) => {
      const v = parseFloat(e.target.value || '3.0');
      recalibrateIndustryStandards({netMarginPct: v});
    });
  })();




</script>
<script>
  // === ì´ˆê¸°í™”(ë…„ë„ ë“œë¡­ë‹¤ìš´) + ì‹œì‘/ì¤‘ë‹¨ + DIALS ì ìš© ì œì–´ ===
  (() => {
    const $ = id => document.getElementById(id);

    // â‘  ë…„ë„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    function populateYearSelects() {
      const now = new Date().getFullYear();
      const from = now - 7; // ìµœê·¼ 8ë…„
      const sy = $('startYear');
      const ey = $('endYear');
      if (!sy || !ey) return;

      sy.innerHTML = '';
      ey.innerHTML = '';
      for (let y = from; y <= now; y++) {
        sy.add(new Option(String(y), String(y)));
        ey.add(new Option(String(y), String(y)));
      }
      // ê¸°ë³¸ê°’: ìµœê·¼ 3ë…„ ë²”ìœ„
      sy.value = String(now - 2);
      ey.value = String(now);
    }

    // startYear â‰¤ endYear ìœ ì§€
    function bindYearGuards() {
      const sy = $('startYear');
      const ey = $('endYear');
      if (!sy || !ey) return;

      sy.addEventListener('change', () => {
        const s = parseInt(sy.value, 10);
        const e = parseInt(ey.value, 10);
        if (e < s) ey.value = String(s);
      });
      ey.addEventListener('change', () => {
        const s = parseInt($('startYear').value, 10);
        const e = parseInt(ey.value, 10);
        if (s > e) $('startYear').value = String(e);
      });
    }

    // â‘¡ ë°ì´í„° ìƒì„± ë²„íŠ¼
    function bindStartButton() {
      const btn = $('btnStart');
      if (!btn) return;

      // CAL/DIALS ê¸°ë³¸ ìŠ¤ëƒ…ìƒ· (DIALS ë¯¸ì ìš© ìƒì„± ì‹œ ë³µêµ¬ìš©)
      window.__CAL_SNAPSHOT__ = window.__CAL_SNAPSHOT__ || JSON.parse(JSON.stringify(CAL || {}));
      window.__DIALS_SNAPSHOT__ = window.__DIALS_SNAPSHOT__ || JSON.parse(JSON.stringify(DIALS || {}));

      btn.addEventListener('click', () => {
        const sy = parseInt(($('startYear')?.value ?? '2022'), 10);
        const ey = parseInt(($('endYear')?.value ?? String(sy)), 10);
        const users  = parseInt(($('userCount')?.value ?? '15000'), 10);
        const orders = parseInt(($('orderCount')?.value ?? '75000'), 10);
        const chunk  = parseInt(($('chunkSize')?.value ?? '3000'), 10);
        const rocket = parseFloat(($('rocketRate')?.value ?? '55'));
        const wow    = parseFloat(($('wowRate')?.value ?? '80'));

        // DIALS ì ìš© ì—¬ë¶€
        const doUseDials = $('useDials')?.checked === true;

        if (doUseDials) {
          // ì‚¬ìš©ìê°€ ì§ì ‘ ì ìš©í•œ ë‹¤ì´ì–¼ì„ ì‚¬ìš© + ìë™ì•ˆì •í™” ON
          ENABLE_AUTOTUNE = true;
          if (typeof applyDials === 'function') applyDials(false); // KPI ì¬ê³„ì‚°ì€ ìƒì„± í›„ ì´ë¯¸ ë¨
        } else {
          // ë‹¤ì´ì–¼ ì˜í–¥ ì œê±°: ìë™ì•ˆì •í™” OFF + CALì„ ì´ˆê¸° ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ë³µê·€
          ENABLE_AUTOTUNE = false;
          if (window.__CAL_SNAPSHOT__) Object.assign(CAL, JSON.parse(JSON.stringify(window.__CAL_SNAPSHOT__)));
          // DIALS ê°’ì€ ë³´ì¡´(ì²´í¬ë°•ìŠ¤ ì¼°ì„ ë•Œë§Œ ì ìš©ë¨)
        }

        // CSV ë²„íŠ¼ì€ ìƒˆ ëŸ¬ë‹ ì‹œì‘ ì‹œ ë¹„í™œì„±í™”
        const csvBtn = $('btnCsv');
        if (csvBtn) csvBtn.disabled = true;

        // ìƒì„± ì‹œì‘
        generateCoupangRealisticData(orders, users, sy, ey, chunk, rocket, wow);
      });
    }

    // â‘¢ ì¤‘ë‹¨ ë²„íŠ¼(ì´ë¯¸ ì¡´ì¬í•˜ëŠ” shouldStop í”Œë˜ê·¸ ì‚¬ìš©)
    function bindStopButton() {
      const b = $('btnStop');
      if (!b) return;
      b.addEventListener('click', () => {
        if (window.PROCESSING_STATE) window.PROCESSING_STATE.shouldStop = true;
      });
    }

    // DOM ì¤€ë¹„ í›„ ì‹¤í–‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        populateYearSelects();
        bindYearGuards();
        bindStartButton();
        bindStopButton();
      });
    } else {
      populateYearSelects();
      bindYearGuards();
      bindStartButton();
      bindStopButton();
    }
  })();
</script>

<script>
  /* =========================================================
     Coupang Logistics Reality - Compat Shim (non-destructive)
     - Keeps ALL existing code intact
     - Adds year dropdowns, optional DIALS, button visibility
     - Idempotent, conflict-safe, guarded calls
     - Namespace: window.__CLR__
     ========================================================= */
  (() => {
    // ----- Namespace & Guards -----
    const NS = window.__CLR__ = window.__CLR__ || { bound: {}, snap: {} };
    const $  = (id) => document.getElementById(id);
    const fn = (name) => (typeof window[name] === 'function') ? window[name] : null;

    // Take snapshots only once (for CAL/DIALS restore)
    function ensureSnapshots() {
      if (!NS.snap.did) {
        try {
          if (window.CAL)   NS.snap.CAL   = JSON.parse(JSON.stringify(window.CAL));
          if (window.DIALS) NS.snap.DIALS = JSON.parse(JSON.stringify(window.DIALS));
        } catch (_) {}
        NS.snap.did = true;
      }
    }

    // ----- Year dropdown population -----
    function populateYearSelects() {
      const sy = $('startYear'), ey = $('endYear');
      if (!sy || !ey) return;

      // If already populated, keep user choices
      const hadOptions = sy.options.length > 0 && ey.options.length > 0;
      const prevSy = sy.value, prevEy = ey.value;

      const now = new Date().getFullYear();
      const from = now - 7; // last 8 years inclusive
      sy.innerHTML = ''; ey.innerHTML = '';
      for (let y = from; y <= now; y++) {
        sy.add(new Option(String(y), String(y)));
        ey.add(new Option(String(y), String(y)));
      }

      if (hadOptions && prevSy && prevEy) {
        // Try restore
        sy.value = prevSy;
        ey.value = prevEy;
      } else {
        // Reasonable defaults
        sy.value = String(now - 2);
        ey.value = String(now);
      }

      // Guard: start <= end
      if (parseInt(sy.value, 10) > parseInt(ey.value, 10)) sy.value = ey.value;
    }

    function guardYearRelations() {
      const sy = $('startYear'), ey = $('endYear');
      if (!sy || !ey || NS.bound.yearGuards) return;
      sy.addEventListener('change', () => {
        if (parseInt(ey.value, 10) < parseInt(sy.value, 10)) ey.value = sy.value;
      });
      ey.addEventListener('change', () => {
        if (parseInt(sy.value, 10) > parseInt(ey.value, 10)) sy.value = ey.value;
      });
      NS.bound.yearGuards = true;
    }

    // ----- Ensure "DIALS ì ìš©" checkbox exists (default OFF) -----
    function ensureDialsCheckbox() {
      if ($('useDials')) return;
      const container = document.querySelector('.panel .controls');
      const anchor = $('btnStart');
      if (!container || !anchor) return;

      const div = document.createElement('div');
      div.className = 'ctrl';
      div.innerHTML = '<label>DIALS ì ìš©</label><input id="useDials" type="checkbox">';
      container.insertBefore(div, anchor); // before the Generate button
    }

    // ----- Buttons: visibility + safe bindings -----
    function showButtons() {
      const start = $('btnStart');
      const stop  = $('btnStop');
      const tune  = $('btnTune');

      if (start) { start.style.display = 'inline-block'; start.disabled = false; }
      if (stop)  { stop.style.display  = 'inline-block'; }
      if (tune)  { tune.style.display  = 'inline-block'; }
    }

    function bindStart() {
      const start = $('btnStart');
      if (!start || NS.bound.start) return;
      NS.bound.start = true;

      ensureSnapshots();

      start.addEventListener('click', () => {
        // Read inputs with fallbacks
        const sy   = parseInt(($('startYear')?.value ?? new Date().getFullYear() - 2), 10);
        const ey   = parseInt(($('endYear')?.value   ?? new Date().getFullYear()), 10);
        const users   = parseInt(($('userCount')?.value  ?? '15000'), 10);
        const orders  = parseInt(($('orderCount')?.value ?? '75000'), 10);
        const chunk   = parseInt(($('chunkSize')?.value  ?? '3000'), 10);
        const rocket  = parseFloat(($('rocketRate')?.value ?? '55'));
        const wow     = parseFloat(($('wowRate')?.value    ?? '80'));
        const targetNM= parseFloat(($('targetNetMargin')?.value ?? '3.2'));
        const useDials = $('useDials')?.checked === true;

        // CSV ë²„íŠ¼(ìˆë‹¤ë©´) ì ì‹œ ë¹„í™œì„±í™”
        const csvBtn = $('btnCsv'); if (csvBtn) csvBtn.disabled = true;

        // DIALS ì ìš© ì—¬ë¶€ ì œì–´
        try {
          if (useDials) {
            // ì‚¬ìš©ìê°€ ì›í•  ë•Œë§Œ ì ìš©
            window.ENABLE_AUTOTUNE = true;
            if (fn('applyDials')) window.applyDials(false);
          } else {
            // ë¯¸ì ìš©: ìë™ íŠœë‹ OFF + CAL ì›ë³µ
            window.ENABLE_AUTOTUNE = false;
            if (NS.snap.CAL && window.CAL) Object.assign(window.CAL, JSON.parse(JSON.stringify(NS.snap.CAL)));
          }
        } catch (e) {
          console.warn('[CLR] DIALS handling warning:', e);
        }

        // ì‹¤í–‰
        if (fn('generateCoupangRealisticData')) {
          window.generateCoupangRealisticData(orders, users, sy, ey, chunk, rocket, wow);
        } else {
          alert('generateCoupangRealisticData í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
      });
    }

    function bindTuneToggle() {
      const tune = $('btnTune'), panel = $('tunePanel');
      if (!tune || !panel || NS.bound.tune) return;
      NS.bound.tune = true;

      tune.addEventListener('click', () => {
        const cur = panel.style.display;
        panel.style.display = (cur === 'none' || !cur) ? 'block' : 'none';
      });
    }

    function bindStop() {
      const stop = $('btnStop');
      if (!stop || NS.bound.stop) return;
      NS.bound.stop = true;

      stop.addEventListener('click', () => {
        try {
          if (window.PROCESSING_STATE) window.PROCESSING_STATE.shouldStop = true;
          (fn('updateUIState') || (()=>{}))('stopping');
        } catch (e) {
          console.warn('[CLR] stop handling warning:', e);
        }
      });
    }

    // ----- Init (idempotent) -----
    function init() {
      if (NS.bound.init) return;
      NS.bound.init = true;

      try {
        showButtons();
        ensureDialsCheckbox();
        populateYearSelects();
        guardYearRelations();
        bindStart();
        bindTuneToggle();
        bindStop();
      } catch (e) {
        console.error('[CLR] init error:', e);
      }
    }

    (document.readyState === 'loading')
      ? document.addEventListener('DOMContentLoaded', init, { once: true })
      : init();
  })();
</script>

</body>
</html>

