<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸš€ ë¬¼ë¥˜ ì´ì»¤ë¨¸ìŠ¤ í†µí•© ëŒ€ì‹œë³´ë“œ | Logistics eCommerce Unified Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --pri: #2563eb;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --vio: #8b5cf6;
      --cyan: #06b6d4;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
      color: #fff;
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 18px;
      box-shadow: 0 8px 24px rgba(2, 6, 23, .15);
    }

    .header h1 {
      margin: 0 0 6px 0;
      font-size: 22px
    }

    .header .sub {
      opacity: .9;
      font-size: 13px
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      margin: 14px 0;
      box-shadow: 0 4px 14px rgba(2, 6, 23, .06);
    }

    .controls {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: flex-end
    }

    .ctrl {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .ctrl label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600
    }

    .ctrl input, .ctrl select {
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      min-width: 120px
    }

    .btn {
      background: var(--pri);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed
    }

    .btn.secondary {
      background: #374151
    }

    .btn.danger {
      background: var(--bad)
    }

    /* ì§„í–‰ë¥  í‘œì‹œ */
    .progress-container {
      margin: 10px 0;
      display: none
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--line);
      border-radius: 4px;
      overflow: hidden
    }

    .progress-fill {
      height: 100%;
      background: var(--pri);
      width: 0%;
      transition: width 0.3s ease
    }

    .progress-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      text-align: center
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px
    }

    .kpi-grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px
    }

    .kpi {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      position: relative
    }

    .kpi h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px
    }

    .kpi .v {
      font-size: 26px;
      font-weight: 800
    }

    .kpi .meta {
      font-size: 11px;
      color: var(--muted)
    }

    .kpi.primary {
      border-top: 4px solid var(--pri)
    }

    .kpi.good {
      border-top: 4px solid var(--good)
    }

    .kpi.warn {
      border-top: 4px solid var(--warn)
    }

    .kpi.bad {
      border-top: 4px solid var(--bad)
    }

    .kpi.vio {
      border-top: 4px solid var(--vio)
    }

    .kpi.cyan {
      border-top: 4px solid var(--cyan)
    }

    .sections {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(360px, 1fr));
      gap: 16px;
      margin-top: 10px
    }

    .section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px
    }

    .section h3 {
      margin: 0 0 10px 0;
      font-size: 16px
    }

    .alerts {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow: auto
    }

    .alert {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      border: 1px solid
    }

    .alert.good {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #065f46
    }

    .alert.warn {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e
    }

    .alert.bad {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b
    }

    .table-wrap {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 0;
      margin-top: 16px;
      overflow: hidden
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      border-bottom: 1px solid var(--line)
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      white-space: nowrap
    }

    tbody {
      max-height: 520px;
      overflow: auto
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px
    }

    .pill.ok {
      background: #dcfce7;
      color: #065f46
    }

    .pill.ng {
      background: #fee2e2;
      color: #991b1b
    }

    .pill.running {
      background: #dbeafe;
      color: #1e40af
    }

    @media (max-width: 720px) {
      .controls {
        flex-direction: column;
        align-items: flex-start
      }

      .ctrl input, .ctrl select {
        min-width: 220px
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>ğŸš€ ë¬¼ë¥˜ ì´ì»¤ë¨¸ìŠ¤ í†µí•© ëŒ€ì‹œë³´ë“œ (í˜„ì‹¤ ë°˜ì˜ ìµœì í™”)</h1>
    <div class="sub">ì‹¤ì œ ì—…ê³„ ë°ì´í„° ê¸°ë°˜ | ìë™í™” í”¼í‚¹ ì‹œìŠ¤í…œ ë°˜ì˜ | ì •ì‹œ ì¶œê³ ìœ¨ ë¶„ì„ | Real Industry Standards Reflected</div>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div class="panel">
    <div class="controls">
      <div class="ctrl">
        <label>ì‹œì‘ë…„ë„ / Start Year</label>
        <select id="startYear"></select>
      </div>
      <div class="ctrl">
        <label>ì¢…ë£Œë…„ë„ / End Year</label>
        <select id="endYear"></select>
      </div>
      <div class="ctrl">
        <label>ê³ ê° ìˆ˜ / #Users</label>
        <input id="userCount" type="number" min="50" max="100000" value="10000">
      </div>
      <div class="ctrl">
        <label>ì£¼ë¬¸ ìˆ˜ / #Orders</label>
        <input id="orderCount" type="number" min="100" max="10000000" step="1000" value="50000">
      </div>
      <div class="ctrl">
        <label>ì²­í¬ í¬ê¸° / Chunk Size</label>
        <input id="chunkSize" type="number" min="100" max="10000" step="100" value="2000">
      </div>
      <button class="btn" id="btnGen">ğŸ”„ ë°ì´í„° ìƒì„± / Generate</button>
      <button class="btn danger" id="btnStop" disabled style="display:none">â¹ï¸ ì¤‘ë‹¨ / Stop</button>
      <button class="btn secondary" id="btnCsv" disabled>ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ / Download CSV</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>

    <!-- ì§„í–‰ë¥  í‘œì‹œ -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘... / Processing...</div>
      <div class="progress-stats">
        <span id="progressStats">-</span>
        <span id="progressETA">ì˜ˆìƒ ì™„ë£Œ: - / ETA: -</span>
      </div>
    </div>
  </div>

  <!-- KPI ì„¹ì…˜ -->
  <div class="sections">
    <div class="section">
      <h3>ğŸ’° ë§¤ì¶œÂ·ìˆ˜ìµ / Sales & Profit</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì´ ë§¤ì¶œ / Total Sales</h4>
          <div class="v" id="k_totalSales">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi good"><h4>ìˆœì´ìµë¥  / Net Margin Rate</h4>
          <div class="v" id="k_netMargin">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>í‰ê· ì£¼ë¬¸ê¸ˆì•¡ / AOV</h4>
          <div class="v" id="k_aov">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi"><h4>ARPPU / ARPPU</h4>
          <div class="v" id="k_arppu">-</div>
          <div class="meta">â‚©</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ‘¥ ê³ ê° / Customer</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC ë¹„ìœ¨ / LTV:CAC</h4>
          <div class="v" id="k_ltvCac">-</div>
        </div>
        <div class="kpi"><h4>ìœ ì§€ìœ¨ / Retention Rate</h4>
          <div class="v" id="k_retention">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì´íƒˆë¥  / Churn Rate</h4>
          <div class="v" id="k_churn">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>AI ì´íƒˆ ì˜ˆì¸¡ ì •í™•ë„ / AI Churn Accuracy</h4>
          <div class="v" id="k_ai">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸšš ë°°ì†¡Â·ë¬¼ë¥˜ / Logistics</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>ì •ì‹œìœ¨ / On-Time Rate</h4>
          <div class="v" id="k_onTime">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>SLA ìœ„ë°˜ìœ¨ / SLA Breach</h4>
          <div class="v" id="k_sla">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì ì¬ìœ¨ / Load Factor</h4>
          <div class="v" id="k_load">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì—°ë¹„ / Fuel Efficiency</h4>
          <div class="v" id="k_fuel">-</div>
          <div class="meta">km/L</div>
        </div>
        <div class="kpi"><h4>ë¼ìš°íŒ… ì ìˆ˜ / Routing Score</h4>
          <div class="v" id="k_route">-</div>
          <div class="meta">/100</div>
        </div>
        <div class="kpi warn"><h4>ë°°ì†¡ ì˜ˆì™¸ìœ¨ / Delivery Exception</h4>
          <div class="v" id="k_exception">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ“¦ ì¶œê³ Â·í’€í•„ë¨¼íŠ¸ / Fulfillment</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>ì •ì‹œ ì¶œê³ ìœ¨ / On-Time Shipment</h4>
          <h4>ì •ì‹œ ì¶œê³ ìœ¨ / On-Time Shipment <span class="pill" style="margin-left:6px">ëª©í‘œ â‰¥ 96%</span></h4>
          <div class="v" id="k_onTimeShip">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>í‰ê·  ì¶œê³  ì‹œê°„ / Avg Ship Time</h4>
          <div class="v" id="k_avgShipTime">-</div>
          <div class="meta">ì‹œê°„</div>
        </div>
        <div class="kpi"><h4>í”¼í‚¹ ì†ë„ / Picking Speed</h4>
          <div class="v" id="k_pickSpeed">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi"><h4>íŒ¨í‚¹ ì†ë„ / Packing Speed</h4>
          <div class="v" id="k_packSpeed">-</div>
          <div class="meta">ì´ˆ/ê°œ</div>
        </div>
        <div class="kpi"><h4>í’€í•„ë¨¼íŠ¸ íš¨ìœ¨ / Fulfillment Efficiency</h4>
          <div class="v" id="k_fulfillEff">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi cyan"><h4>60ë¶„ë‚´ ì¶œê³ ìœ¨ / <60min Ship Rate</h4>
          <div class="v" id="k_ship60">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ“¦ ë°˜í’ˆ / Returns</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>ë°˜í’ˆë¥  / Return Rate</h4>
          <div class="v" id="k_returnRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ë°˜í’ˆ ì†ì‹¤ë¥  / Return Cost Rate</h4>
          <div class="v" id="k_returnCost">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬íŒë§¤ ê°€ëŠ¥ë¥  / Resellable Rate</h4>
          <div class="v" id="k_resell">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸŒŸ WOW / Membership</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>WOW ë¹„ì¤‘ / WOW Share</h4>
          <div class="v" id="k_wowShare">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>WOW AOV / WOW AOV</h4>
          <div class="v" id="k_wowAov">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi"><h4>ë¹„íšŒì› AOV / Non-WOW AOV</h4>
          <div class="v" id="k_nonWowAov">-</div>
          <div class="meta">â‚©</div>
        </div>
        <div class="kpi"><h4>WOW ì¬ê³ íšŒì „ ê¸°ì—¬ / WOW Inv. Turnover Contrib</h4>
          <div class="v" id="k_wowInv">-</div>
          <div class="meta">íšŒ</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>ğŸ­ WMSÂ·ì¬ê³  / WMSÂ·Inventory</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>ì¬ê³  íšŒì „ìœ¨ / Inventory Turnover</h4>
          <div class="v" id="k_invTurn">-</div>
          <div class="meta">íšŒ</div>
        </div>
        <div class="kpi"><h4>í’ˆì ˆë¥  / Stockout Rate</h4>
          <div class="v" id="k_stockout">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ê³¼ì¬ê³  ë¹„ìœ¨ / Overstock Rate</h4>
          <div class="v" id="k_overstock">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì •í™•ë„ / Inventory Accuracy</h4>
          <div class="v" id="k_invAcc">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>ì¬ê³  ì†ì‹¤ë¥  / Shrinkage</h4>
          <div class="v" id="k_shrink">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>WMS í™œìš©ë¥  / WMS Utilization</h4>
          <div class="v" id="k_wms">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi good"><h4>ìë™í™” í™œìš©ë¥  / Automation Rate</h4>
          <div class="v" id="k_autoRate">-</div>
          <div class="meta">%</div>
        </div>
        <div class="kpi"><h4>OMS ì—°ë™ íš¨ìœ¨ / OMS Integration Eff</h4>
          <div class="v" id="k_omsEff">-</div>
          <div class="meta">%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²€ì¦ & ë³µí•© ìœ„í—˜ -->
  <div class="sections">
    <div class="section">
      <h3>âœ… ì •í•©ì„± ê²€ì‚¬ / Data Integrity Checks</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section">
      <h3>âš ï¸ ë³µí•© ìœ„í—˜ ìš”ì†Œ / Composite Risk</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section">
      <h3>ğŸ“Š ì²˜ë¦¬ ì„±ëŠ¥ / Performance Metrics</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <!-- ë°ì´í„° í…Œì´ë¸” -->
  <div class="table-wrap">
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* -------------------------
     0) ê³µí†µ ìƒìˆ˜Â·ë§µ (ë„ë©”ì¸ ê¸°ë°˜) - í˜„ì‹¤ ë°˜ì˜ ê°œì„ 
  --------------------------*/

  const SHIP_ON_TIME_TARGET = 96;     // ì—…ê³„ ê¶Œì¥ í•˜í•œ(%)
  const SHIP_ON_TIME_GOOD   = 98;     // ìš°ìˆ˜ ê¸°ì¤€(%)
  const SHIP_ON_TIME_GRACE_MIN = 10;  // ì •ì‹œ íŒì • í—ˆìš© ì§€ì—°(ë¶„)



  const DELIVERY_MODES = {
    'ë‹¹ì¼': {delayRate: 0.015, baseDays: 0, cutoffHour: 20},
    'ìƒˆë²½': {delayRate: 0.008, baseDays: 1},
    'ìµì¼': {delayRate: 0.025, baseDays: 1},
    'íƒë°°': {delayRate: 0.035, baseDays: 2}
  };
  const REGIONS = ['ìˆ˜ë„ê¶Œ', 'ì˜ë‚¨', 'í˜¸ë‚¨', 'ì¶©ì²­', 'ê°•ì›', 'ì œì£¼'];
  const CITIES_BY_REGION = {
    'ìˆ˜ë„ê¶Œ': ['ì„œìš¸', 'ì¸ì²œ', 'ì„±ë‚¨', 'ê³ ì–‘'],
    'ì˜ë‚¨': ['ë¶€ì‚°', 'ëŒ€êµ¬', 'ìš¸ì‚°', 'ì°½ì›'],
    'í˜¸ë‚¨': ['ê´‘ì£¼', 'ì „ì£¼', 'ì—¬ìˆ˜'],
    'ì¶©ì²­': ['ëŒ€ì „', 'ì²­ì£¼', 'ì²œì•ˆ'],
    'ê°•ì›': ['ì¶˜ì²œ', 'ì›ì£¼'],
    'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬ì‹œ']
  };
  const DISTRICTS_BY_CITY = {
    'ì„œìš¸': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ë§ˆí¬êµ¬', 'ìš©ì‚°êµ¬'],
    'ì¸ì²œ': ['ë‚¨ë™êµ¬', 'ë¶€í‰êµ¬', 'ì—°ìˆ˜êµ¬'],
    'ì„±ë‚¨': ['ë¶„ë‹¹êµ¬', 'ì¤‘ì›êµ¬', 'ìˆ˜ì •êµ¬'],
    'ê³ ì–‘': ['ì¼ì‚°ë™êµ¬', 'ì¼ì‚°ì„œêµ¬', 'ë•ì–‘êµ¬'],
    'ë¶€ì‚°': ['í•´ìš´ëŒ€êµ¬', 'ìˆ˜ì˜êµ¬', 'ë¶€ì‚°ì§„êµ¬', 'ë‚¨êµ¬'],
    'ëŒ€êµ¬': ['ì¤‘êµ¬', 'ë™êµ¬', 'ë‚¨êµ¬', 'ìˆ˜ì„±êµ¬'],
    'ìš¸ì‚°': ['ì¤‘êµ¬', 'ë‚¨êµ¬', 'ë™êµ¬'],
    'ì°½ì›': ['ì„±ì‚°êµ¬', 'ì˜ì°½êµ¬', 'ë§ˆì‚°í•©í¬êµ¬'],
    'ê´‘ì£¼': ['ë¶êµ¬', 'ë‚¨êµ¬', 'ì„œêµ¬'],
    'ì „ì£¼': ['ë•ì§„êµ¬', 'ì™„ì‚°êµ¬'],
    'ì—¬ìˆ˜': ['ì—¬ì²œë™', 'ëŒì‚°ì'],
    'ëŒ€ì „': ['ì„œêµ¬', 'ìœ ì„±êµ¬', 'ì¤‘êµ¬'],
    'ì²­ì£¼': ['í¥ë•êµ¬', 'ìƒë‹¹êµ¬'],
    'ì²œì•ˆ': ['ë™ë‚¨êµ¬', 'ì„œë¶êµ¬'],
    'ì¶˜ì²œ': ['ì‹ ë¶ì', 'í‡´ê³„ë™'],
    'ì›ì£¼': ['ë‹¨êµ¬ë™', 'ë¬´ì‹¤ë™'],
    'ì œì£¼ì‹œ': ['ì•„ë¼ë™', 'ë…¸í˜•ë™'],
    'ì„œê·€í¬ì‹œ': ['ì¤‘ë¬¸ë™', 'ì„œê·€ë™']
  };
  const FULFILLMENT_BY_CITY = {
    'ì„œìš¸': 'ì„œìš¸1ì„¼í„°', 'ì¸ì²œ': 'ì¸ì²œì„¼í„°', 'ì„±ë‚¨': 'ê²½ê¸°1ì„¼í„°', 'ê³ ì–‘': 'ê³ ì–‘ì„¼í„°',
    'ë¶€ì‚°': 'ë¶€ì‚°ì„¼í„°', 'ëŒ€êµ¬': 'ëŒ€êµ¬ì„¼í„°', 'ìš¸ì‚°': 'ìš¸ì‚°ì„¼í„°', 'ì°½ì›': 'ê²½ë‚¨ì„¼í„°',
    'ê´‘ì£¼': 'ê´‘ì£¼ì„¼í„°', 'ì „ì£¼': 'ì „ë¶ì„¼í„°', 'ì—¬ìˆ˜': 'ì—¬ìˆ˜ì„¼í„°',
    'ëŒ€ì „': 'ëŒ€ì „ì„¼í„°', 'ì²­ì£¼': 'ì¶©ì²­ì„¼í„°', 'ì²œì•ˆ': 'ì²œì•ˆì„¼í„°',
    'ì¶˜ì²œ': 'ê°•ì›ì„¼í„°', 'ì›ì£¼': 'ì›ì£¼ì„¼í„°',
    'ì œì£¼ì‹œ': 'ì œì£¼ì„¼í„°', 'ì„œê·€í¬ì‹œ': 'ì„œê·€í¬ì„¼í„°'
  };
  const REGION_COST = {
    'ìˆ˜ë„ê¶Œ': {avgDistance: 15, baseCost: 2500},
    'ì˜ë‚¨': {avgDistance: 25, baseCost: 3200},
    'í˜¸ë‚¨': {avgDistance: 28, baseCost: 3500},
    'ì¶©ì²­': {avgDistance: 20, baseCost: 3000},
    'ê°•ì›': {avgDistance: 32, baseCost: 3800},
    'ì œì£¼': {avgDistance: 35, baseCost: 4500}
  };
  const WEATHER_CONDITIONS = ['ë§‘ìŒ', 'íë¦¼', 'ë¹„', 'ëˆˆ'];

  function weatherSeverity(cond) {
    if (cond === 'ë§‘ìŒ') return 0.05;
    if (cond === 'íë¦¼') return 0.25;
    if (cond === 'ë¹„') return 0.65;
    if (cond === 'ëˆˆ') return 0.85;
    return 0.3;
  }

  const CATEGORY = {
    'ì˜ë¥˜': {
      returnRate: 0.12,
      margin: 0.35,
      price: [15000, 80000],
      skus: ['TOP001', 'PANTS002', 'SHOES003', 'ACC004'],
      pickComplexity: 1.0
    },
    'ê°€ì „': {
      returnRate: 0.03,
      margin: 0.15,
      price: [50000, 300000],
      skus: ['TV001', 'REF002', 'WASH003', 'AIR004'],
      pickComplexity: 1.8
    },
    'ì‹í’ˆ': {
      returnRate: 0.02,
      margin: 0.20,
      price: [5000, 25000],
      skus: ['SNACK001', 'DRINK002', 'FRESH003', 'FROZEN004'],
      pickComplexity: 0.8
    },
    'ìƒí™œìš©í’ˆ': {
      returnRate: 0.04,
      margin: 0.30,
      price: [8000, 35000],
      skus: ['CLEAN001', 'BATH002', 'KITCHEN003', 'ROOM004'],
      pickComplexity: 1.2
    },
    'ë°˜ë ¤ìš©í’ˆ': {
      returnRate: 0.06,
      margin: 0.28,
      price: [10000, 60000],
      skus: ['FOOD001', 'TOY002', 'CARE003', 'HEALTH004'],
      pickComplexity: 1.1
    },
    'ë¬¸êµ¬ë¥˜': {
      returnRate: 0.03,
      margin: 0.40,
      price: [3000, 15000],
      skus: ['PEN001', 'BOOK002', 'OFFICE003', 'ART004'],
      pickComplexity: 0.9
    }
  };
  const ABC_DIST = {A: 0.2, B: 0.3, C: 0.5};
  const VEHICLES = ['ì†Œí˜•ë°´', 'ì¤‘í˜•íŠ¸ëŸ­', 'ëŒ€í˜•íŠ¸ëŸ­', 'ì˜¤í† ë°”ì´'];
  const DRIVER_GRADE = ['ì‹ ì…', 'ìˆ™ë ¨', 'ë² í…Œë‘', 'MVP'];
  const RETURN_REASONS = ['ë‹¨ìˆœë³€ì‹¬', 'ìƒí’ˆë¶ˆëŸ‰', 'ë°°ì†¡ì§€ì—°', 'ì˜¤ë°°ì†¡', 'íŒŒì†', 'ê¸°íƒ€'];

  // ì—…ê³„ í‘œì¤€ í”¼í‚¹/íŒ¨í‚¹ ì‹œê°„ (í˜„ì‹¤ ë°˜ì˜)
  // [PATCH 1] AUTOMATION_LEVELS (ì‹œê°„ë§Œ ì¡°ì •)
  const AUTOMATION_LEVELS = {
    MANUAL: {pickTimePerItem: 32, packTimePerItem: 26, accuracy: 0.975, cost: 1.0},
    SEMI_AUTO: {pickTimePerItem: 18, packTimePerItem: 15, accuracy: 0.985, cost: 1.3},
    AUTOMATED: {pickTimePerItem: 6, packTimePerItem: 9, accuracy: 0.995, cost: 2.1},
    AI_OPTIMIZED: {pickTimePerItem: 5, packTimePerItem: 8, accuracy: 0.998, cost: 3.2}
  };


  // [PATCH 2] WMS_MATURITY (order_processing_timeÂ·system_uptimeë§Œ ì¡°ì •)
  const WMS_MATURITY = {
    LEGACY: {
      efficiency: 0.70,
      picking_accuracy: 0.978,
      inventory_sync: 0.90,
      order_processing_time: 70,
      system_uptime: 0.975
    },
    STANDARD: {
      efficiency: 0.86,
      picking_accuracy: 0.990,
      inventory_sync: 0.96,
      order_processing_time: 25,
      system_uptime: 0.988
    },
    ADVANCED: {
      efficiency: 0.95,
      picking_accuracy: 0.996,
      inventory_sync: 0.985,
      order_processing_time: 10,
      system_uptime: 0.997
    }
  };


  const OMS_MATURITY = {
    MANUAL: {order_accuracy: 0.94, processing_speed: 0.80, integration_score: 0.70, auto_allocation: 0.40},
    BASIC: {order_accuracy: 0.97, processing_speed: 0.90, integration_score: 0.85, auto_allocation: 0.75},
    ADVANCED: {order_accuracy: 0.99, processing_speed: 0.97, integration_score: 0.95, auto_allocation: 0.92}
  };

  /* ìœ í‹¸ í•¨ìˆ˜ */
  const rnd = (a, b) => Math.random() * (b - a) + a;
  const irnd = (a, b) => Math.floor(rnd(a, b));
  const pick = (arr) => arr[irnd(0, arr.length)];
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const pad = (n, len = 2) => String(n).padStart(len, '0');
  const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

  function calcQuartilesFromValues(values) {
    if (!values.length) return {q1: 0, q2: 0, q3: 0};
    const arr = [...values].sort((a, b) => a - b);
    const p = (k) => {
      if (arr.length === 1) return arr[0];
      const idx = (arr.length - 1) * k, lo = Math.floor(idx), hi = Math.ceil(idx);
      if (lo === hi) return arr[lo];
      return arr[lo] + (arr[hi] - arr[lo]) * (idx - lo);
    };
    return {q1: p(0.25), q2: p(0.50), q3: p(0.75)};
  }

  function toQuartile(x, qs) {
    const {q1, q2, q3} = qs;
    if (x <= q1) return 1;
    if (x <= q2) return 2;
    if (x <= q3) return 3;
    return 4;
  }

  function mapDistance(region) {
    const base = REGION_COST[region].avgDistance;
    return clamp(Math.round(base + irnd(-4, 5)), 5, 60);
  }

  function addressLine(city, district) {
    const roadNo = irnd(1, 200);
    const bldg = irnd(1, 50);
    return `${city} ${district} ë¬¼ë¥˜ë¡œ ${roadNo}-${bldg}`;
  }

  // ìë™í™” ìˆ˜ì¤€ ê²°ì • (ì—…ì²´ ê·œëª¨ì™€ ì§€ì—­ì— ë”°ë¼)
  function determineAutomationLevel(region, deliveryCenter) {
    // ìˆ˜ë„ê¶Œ ëŒ€í˜•ì„¼í„°: 80% í™•ë¥ ë¡œ ê³ ë„ ìë™í™”
    if (region === 'ìˆ˜ë„ê¶Œ' && deliveryCenter.includes('ì„œìš¸')) {
      const r = Math.random();
      if (r < 0.4) return 'AI_OPTIMIZED';
      if (r < 0.8) return 'AUTOMATED';
      return 'SEMI_AUTO';
    }
    // ê¸°íƒ€ ì£¼ìš” ë„ì‹œ: ì¤‘ê°„ ìˆ˜ì¤€ ìë™í™”
    if (['ì˜ë‚¨', 'ì¶©ì²­'].includes(region)) {
      const r = Math.random();
      if (r < 0.2) return 'AI_OPTIMIZED';
      if (r < 0.6) return 'AUTOMATED';
      if (r < 0.9) return 'SEMI_AUTO';
      return 'MANUAL';
    }
    // ì†Œê·œëª¨ ì§€ì—­: ë‚®ì€ ìë™í™”
    const r = Math.random();
    if (r < 0.1) return 'AUTOMATED';
    if (r < 0.4) return 'SEMI_AUTO';
    return 'MANUAL';
  }

  // WMS ì„±ìˆ™ë„ ê²°ì • (ìë™í™” ìˆ˜ì¤€ê³¼ ì—°ë™)
  function determineWMSMaturity(automationLevel, deliveryCenter) {
    if (automationLevel === 'AI_OPTIMIZED') return 'ADVANCED';
    if (automationLevel === 'AUTOMATED') return Math.random() < 0.7 ? 'ADVANCED' : 'STANDARD';
    if (automationLevel === 'SEMI_AUTO') return Math.random() < 0.6 ? 'STANDARD' : 'LEGACY';
    return Math.random() < 0.3 ? 'STANDARD' : 'LEGACY';
  }

  // OMS ì„±ìˆ™ë„ ê²°ì •
  function determineOMSMaturity(wmsMaturity) {
    if (wmsMaturity === 'ADVANCED') return Math.random() < 0.8 ? 'ADVANCED' : 'BASIC';
    if (wmsMaturity === 'STANDARD') return Math.random() < 0.6 ? 'BASIC' : 'MANUAL';
    return Math.random() < 0.4 ? 'BASIC' : 'MANUAL';
  }

  /* -------------------------
     1) ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
  --------------------------*/
  let DATA = [];
  let MONTHLY_BY_CUST = {};
  let VALIDATION_ISSUES = [];
  let PERFORMANCE_METRICS = {};

  // ì²˜ë¦¬ ìƒíƒœ ê´€ë¦¬
  let PROCESSING_STATE = {
    isRunning: false,
    shouldStop: false,
    startTime: null,
    processedRows: 0,
    totalRows: 0,
    currentChunk: 0,
    totalChunks: 0
  };

  // ì²­í¬ ì²˜ë¦¬ ì„¤ì •
  const CHUNK_CONFIG = {
    defaultSize: 2000,
    maxMemoryRows: 100000,
    batchUpdateInterval: 5,
    gcInterval: 10
  };

  /* -------------------------
     2) ì²­í¬ ê¸°ë°˜ ë°ì´í„° ìƒì„± - í˜„ì‹¤ ë°˜ì˜ ê°œì„ 
  --------------------------*/
  function preAssignChurn(uniqueCustomers) {
    const map = {};
    const churnCnt = Math.round(uniqueCustomers * 0.08);
    for (let i = 0; i < uniqueCustomers; i++) {
      map[`CUST${String(1000 + i).padStart(6, '0')}`] = 0;
    }
    const keys = Object.keys(map).sort(() => Math.random() - 0.5);
    for (let i = 0; i < churnCnt; i++) map[keys[i]] = 1;
    return map;
  }

  // ë‹¨ì¼ í–‰ ìƒì„± í•¨ìˆ˜ (í˜„ì‹¤ ë°˜ì˜ ëŒ€í­ ê°œì„ )
  function generateSingleRow(i, nUsers, yStart, yEnd, churnMap) {
    // ì§€ì—­/ë„ì‹œ/êµ¬
    const region = pick(REGIONS);
    const city = pick(CITIES_BY_REGION[region]);
    const district = pick(DISTRICTS_BY_CITY[city] || ['ê¸°íƒ€êµ¬']);
    const deliveryCenter = FULFILLMENT_BY_CITY[city] || 'ê¸°íƒ€ì„¼í„°';
    const distanceKm = mapDistance(region);
    const addr = addressLine(city, district);

    // ìë™í™” ë° ì‹œìŠ¤í…œ ì„±ìˆ™ë„ ê²°ì •
    const automationLevel = determineAutomationLevel(region, deliveryCenter);
    const wmsMaturity = determineWMSMaturity(automationLevel, deliveryCenter);
    const omsMaturity = determineOMSMaturity(wmsMaturity);

    const autoConfig = AUTOMATION_LEVELS[automationLevel];
    const wmsConfig = WMS_MATURITY[wmsMaturity];
    const omsConfig = OMS_MATURITY[omsMaturity];

    // ìƒí’ˆ, ê°€ê²©, ìˆ˜ëŸ‰
    const catKey = pick(Object.keys(CATEGORY));
    const cat = CATEGORY[catKey];
    const sku = pick(cat.skus);
    const price = irnd(cat.price[0], cat.price[1]);
    const qty = irnd(1, 4);
    const orderAmt = price * qty;

    // ABC ë“±ê¸‰
    const r = Math.random();
    const abc = r < ABC_DIST.A ? 'A' : (r < ABC_DIST.A + ABC_DIST.B ? 'B' : 'C');

    // ê³ ê°
    const custId = `CUST${String(1000 + (i % nUsers)).padStart(6, '0')}`;
    const isWOW = Math.random() < 0.65 ? 1 : 0;
    const wowJoin = isWOW ? new Date(Date.now() - irnd(10, 365) * 86400000) : null;

    // ì£¼ë¬¸ì‹œê°
    const year = irnd(yStart, yEnd + 1);
    const orderDate = new Date(year, irnd(0, 12), irnd(1, 29), irnd(8, 22), irnd(0, 60), irnd(0, 60));

    // **í•µì‹¬ ê°œì„ : í˜„ì‹¤ì ì¸ ì¶œê³  í”„ë¡œì„¸ìŠ¤ íƒ€ì„ë¼ì¸**

    // 1) ì£¼ë¬¸ ì ‘ìˆ˜ ì™„ë£Œ ì‹œê°„ (OMS ì²˜ë¦¬ ì‹œê°„)
    const orderCompleteDate = new Date(orderDate.getTime() + omsConfig.processing_speed * wmsConfig.order_processing_time * 60 * 1000);

    // 2) ì‹¤ì œ í”¼í‚¹/íŒ¨í‚¹ ì‹œê°„ ê³„ì‚° (ì—…ê³„ í‘œì¤€ ë°˜ì˜)
    const basePickTime = autoConfig.pickTimePerItem * qty * cat.pickComplexity; // ì´ˆ
    const basePackTime = autoConfig.packTimePerItem * qty; // ì´ˆ

    // ì‘ì—…ì ìˆ™ë ¨ë„ ë° ì‹œê°„ëŒ€ë³„ íš¨ìœ¨ì„± ë°˜ì˜
// [PATCH 4] hourEfficiency (ì•¼ê°„ 0.85 â†’ 0.95)
    const hourEfficiency = (orderDate.getHours() >= 9 && orderDate.getHours() <= 17) ? 1.0 : 0.95;

    const actualPickTime = Math.round(basePickTime / hourEfficiency);
    const actualPackTime = Math.round(basePackTime / hourEfficiency);

    // 3) ê³„íš ì¶œê³  ì‹œê°„ (ì£¼ë¬¸ì™„ë£Œ + í”¼í‚¹íŒ¨í‚¹ì‹œê°„ + ë²„í¼)
// [PATCH 3] fulfillmentBuffer (ìˆ«ìë§Œ ì¡°ì •)
    const fulfillmentBuffer =
      (wmsMaturity === 'ADVANCED' ? 5 :
        wmsMaturity === 'STANDARD' ? 10 : 20); // ê¸°ì¡´ 5/12/30 â†’ 5/10/20


    const plannedShipDate = new Date(orderCompleteDate.getTime() +
      (actualPickTime + actualPackTime) * 1000 + fulfillmentBuffer * 60 * 1000);

    // 4) ì‹¤ì œ ì¶œê³  ì‹œê°„ (ì§€ì—° ìš”ì¸ ë°˜ì˜)
    let actualShipDate = new Date(plannedShipDate);
    let shipDelayMinutes = 0;

    // ì¶œê³  ì§€ì—° ìš”ì¸ë“¤
// í™•ë¥  ì™„í™”
// [PATCH 5] ì§€ì—° ë°œìƒ í™•ë¥  ì™„í™”
// [ì¶”ê°€ PATCH A] ì§€ì—° ë°œìƒ í™•ë¥  ë” ì™„í™”
    const systemDowntime = Math.random() > wmsConfig.system_uptime ? 1 : 0;
    const inventoryIssue = Math.random() < (abc === 'A' ? 0.003 : 0.012) ? 1 : 0; // í™•ë¥  ë‚®ì¶¤
    const qualityCheck = orderAmt > 200000 && Math.random() < 0.08 ? 1 : 0;    // 10% â†’ 8%


// ì§€ì—° í­ ì¶•ì†Œ
// [ì¶”ê°€ PATCH B] ì§€ì—° ì‹œê°„ ë‹¨ì¶•
    if (systemDowntime) shipDelayMinutes += irnd(10, 30);  // ê¸°ì¡´ 15â€“40 â†’ 10â€“30
    if (inventoryIssue) shipDelayMinutes += irnd(15, 45);  // ê¸°ì¡´ 20â€“60 â†’ 15â€“45
    if (qualityCheck) shipDelayMinutes += irnd(5, 10);   // ê¸°ì¡´ 5â€“15 â†’ 5â€“10


// ì•¼ê°„ í”¼í¬ ì§€ì—° ê°€ì‚° ì¶•ì†Œ
    // [ì¶”ê°€ PATCH C] ì•¼ê°„ ì¶œê³  íš¨ìœ¨
    if (orderDate.getHours() >= 19) shipDelayMinutes += irnd(0, 5); // ê¸°ì¡´ 0â€“10 â†’ 0â€“5


// ì•¼ê°„ í”¼í¬ ì§€ì—° ì¶•ì†Œ
//     if (orderDate.getHours() >= 19) shipDelayMinutes += irnd(0, 20); // 0â€“60 â†’ 0â€“20


    actualShipDate.setMinutes(actualShipDate.getMinutes() + shipDelayMinutes);

    // 5) ë°°ì†¡ ê³„íš ë° ì‹¤ì œ ë°°ì†¡ (ê¸°ì¡´ ë¡œì§ í™œìš©í•˜ë˜ ì¶œê³  ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •)
    const mode = pick(Object.keys(DELIVERY_MODES));
    const modeCfg = DELIVERY_MODES[mode];

    // ê³„íš ë°°ì†¡ì¼ (ì¶œê³ ì¼ ê¸°ì¤€)
    const plannedDeliveryDate = new Date(actualShipDate);
    if (mode === 'ë‹¹ì¼') {
      // ë‹¹ì¼ë°°ì†¡ì€ ì¶œê³  í›„ ë‹¹ì¼ ë„ì°©
      plannedDeliveryDate.setHours(actualShipDate.getHours() + 4 + irnd(0, 4));
    } else {
      plannedDeliveryDate.setDate(plannedDeliveryDate.getDate() + modeCfg.baseDays);
      plannedDeliveryDate.setHours(mode === 'ìƒˆë²½' ? 6 + irnd(0, 2) : 8 + irnd(0, 12), irnd(0, 60), 0, 0);
    }

    // ë‚ ì”¨ ë° ë°°ì†¡ ì§€ì—°
    const weather = pick(WEATHER_CONDITIONS);
    const wsev = weatherSeverity(weather);
    const delayed = Math.random() < (modeCfg.delayRate + (wsev > 0.7 ? 0.02 : 0));
    const actualDeliveryDate = new Date(plannedDeliveryDate);
    let deliveryDelayHours = 0;

    if (delayed) {
      const bump = wsev >= 0.65 ? 6 : 0;
      deliveryDelayHours = irnd(2 + bump, 24 + bump);
      actualDeliveryDate.setHours(actualDeliveryDate.getHours() + deliveryDelayHours);
    }

    // ì°¨ëŸ‰/ê¸°ì‚¬
    const vType = pick(VEHICLES);
    const vehicleId = `V${irnd(1000, 9999)}`;
    const driverId = `D${irnd(100, 999)}`;
    const driverGrade = pick(DRIVER_GRADE);
    const loadFactor = clamp(Math.round((0.6 + rnd(0, 0.35)) * 100), 0, 100);
    const fuelEff = (() => {
      if (vType === 'ì˜¤í† ë°”ì´') return Math.round((25 + rnd(0, 10)) * 10) / 10;
      if (vType === 'ì†Œí˜•ë°´') return Math.round((12 + rnd(0, 5)) * 10) / 10;
      if (vType === 'ì¤‘í˜•íŠ¸ëŸ­') return Math.round((8 + rnd(0, 3)) * 10) / 10;
      return Math.round((6 + rnd(0, 2)) * 10) / 10;
    })();
    const routingScore = Math.round((0.8 + rnd(0, 0.15)) * 100);

    // ë¬¼ë¥˜ë¹„ (ê±°ë¦¬, ë¬´ê²Œ, ìë™í™” ìˆ˜ì¤€ ë°˜ì˜)
    const base = REGION_COST[region].baseCost;
    const weightKg = qty * (catKey === 'ê°€ì „' ? 3.5 : (catKey === 'ì‹í’ˆ' ? 1.2 : 0.8));
    const automationCostFactor = autoConfig.cost;
    const logisticsCost = Math.round(
      (base + (distanceKm * 15) + (weightKg * 50)) * automationCostFactor +
      (wsev * 200)
    );

    let custDeliveryCharge = 0;
    if (isWOW === 0 && orderAmt < 50000) custDeliveryCharge = 3000;

    // CAC / LTV ê³„ì‚° (ë©¤ë²„ì‹­ê³¼ ì£¼ë¬¸ íŒ¨í„´ ê¸°ë°˜)
    const baseCAC = isWOW ? irnd(2500, 5500) : irnd(800, 2000);
    const regionCACMultiplier = region === 'ìˆ˜ë„ê¶Œ' ? 1.2 : (region === 'ì œì£¼' ? 0.8 : 1.0);
    const CAC = Math.round(baseCAC * regionCACMultiplier);

    const margin = Math.floor(orderAmt * cat.margin);
    const returnFlag = Math.random() < cat.returnRate ? 1 : 0;
    const returnReason = returnFlag ? pick(RETURN_REASONS) : null;
    const returnCost = returnFlag ? Math.floor(orderAmt * 0.15) : 0;

    // ì¬ê³  ê´€ë¦¬ (ABC ë“±ê¸‰ê³¼ ìë™í™” ìˆ˜ì¤€ ë°˜ì˜)
    const baseStock = abc === 'A' ? irnd(200, 800) : (abc === 'B' ? irnd(100, 400) : irnd(50, 200));
    const automationStockMultiplier = automationLevel === 'AI_OPTIMIZED' ? 0.7 : (automationLevel === 'AUTOMATED' ? 0.85 : 1.0);
    const currentStock = Math.round(baseStock * automationStockMultiplier);
    const reorderPoint = Math.floor(currentStock * (abc === 'A' ? 0.4 : (abc === 'B' ? 0.35 : 0.3)));

    const stockTurn = abc === 'A' ? (8 + rnd(0, 4)) : (abc === 'B' ? (4 + rnd(0, 3)) : (2 + rnd(0, 2)));
    const stockout = Math.random() < (abc === 'A' ? 0.015 : (abc === 'B' ? 0.04 : 0.08)) ? 1 : 0;

    // ì •í™•ë„ (ìë™í™” ìˆ˜ì¤€ ë°˜ì˜)
    const invAcc = Math.round((wmsConfig.inventory_sync + rnd(-0.01, 0.01)) * 1000) / 1000;
    const pickingAcc = Math.round((autoConfig.accuracy + rnd(-0.005, 0.005)) * 1000) / 1000;

    // ì‹¤ì œ ì—…ê³„ í‘œì¤€ í”¼í‚¹/íŒ¨í‚¹ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
    const pickingTimeSec = actualPickTime;
    const packingTimeSec = actualPackTime;

    // ì‘ì—…ì ìƒì‚°ì„± (ì‹œê°„ë‹¹ ì²˜ë¦¬ ê±´ìˆ˜)
    const itemsPerHour = Math.round(3600 / (pickingTimeSec + packingTimeSec));

    // WMS/OMS íš¨ìœ¨ì„± ì§€í‘œ
    const wmsUtilizationRate = Math.round(wmsConfig.efficiency * 100);
    const omsIntegrationScore = Math.round(omsConfig.integration_score * 100);
    const autoAllocationRate = Math.round(omsConfig.auto_allocation * 100);

    // ì¬ê³  ê´€ë¦¬ ë¹„ìš©
    const inventoryCarryingCost = Math.floor((currentStock * price * 0.001) / 12);
    const stockoutCost = stockout ? Math.floor(orderAmt * 0.05) : 0;

    // ì´íƒˆ ê´€ë ¨
    const churnFlag = churnMap[custId];
    let churnScore = churnFlag ? (0.6 + rnd(0, 0.4)) : (rnd(0, 0.7));
    if (!churnFlag && Math.random() < 0.05) churnScore += 0.1;
    churnScore = Math.min(1, Math.round(churnScore * 1000) / 1000);

    // LTV ê³„ì‚° (ë©¤ë²„ì‹­, ì§€ì—­, ìë™í™” íš¨ìœ¨ì„± ë°˜ì˜)
    const baseMult = isWOW ? rnd(3.5, 5.5) : rnd(2.0, 3.5);
    const regionLTVMultiplier = region === 'ìˆ˜ë„ê¶Œ' ? 1.15 : (region === 'ì œì£¼' ? 0.9 : 1.0);
    const LTV = Math.round(orderAmt * baseMult * regionLTVMultiplier);

    const customerAOV = orderAmt;
    const grossProfit = margin;
    const monthlyCAC = CAC / 12;
    const fulfillmentCost = Math.round((pickingTimeSec + packingTimeSec) * 0.15); // ì‹œê°„ë‹¹ ì¸ê±´ë¹„ ë°˜ì˜
    const netProfit = Math.round(grossProfit - logisticsCost - returnCost - monthlyCAC - inventoryCarryingCost - stockoutCost - fulfillmentCost);

    // ì¬íŒë§¤ ê°€ëŠ¥ì„±
    let isResellable = null, resellReason = null;
    if (returnFlag) {
      if (['ë‹¨ìˆœë³€ì‹¬', 'ê¸°íƒ€'].includes(returnReason)) {
        isResellable = Math.random() < 0.95 ? 1 : 0;
        resellReason = isResellable ? 'ì •ìƒìƒí’ˆ' : 'í¬ì¥ì†ìƒ';
      } else if (['ìƒí’ˆë¶ˆëŸ‰', 'íŒŒì†'].includes(returnReason)) {
        isResellable = Math.random() < 0.20 ? 1 : 0;
        resellReason = isResellable ? 'ë¶€ë¶„ìˆ˜ë¦¬ê°€ëŠ¥' : 'ìƒí’ˆì†ìƒ';
      } else {
        isResellable = Math.random() < 0.60 ? 1 : 0;
        resellReason = isResellable ? 'ê²½ë¯¸í•œì†ìƒ' : 'ì¬í¬ì¥ë¶ˆê°€';
      }
    }

    // ì¶œê³  ê´€ë ¨ ì§€í‘œ
    const shipOnTime = shipDelayMinutes <= SHIP_ON_TIME_GRACE_MIN ? 1 : 0;

    const shipWithin60Min = (actualShipDate.getTime() - orderCompleteDate.getTime()) <= 60 * 60 * 1000 ? 1 : 0;
    const fulfillmentEfficiency = Math.round(((plannedShipDate.getTime() - orderCompleteDate.getTime()) /
      (actualShipDate.getTime() - orderCompleteDate.getTime())) * 100);

    // ë°°ì†¡ ê´€ë ¨
    const deliveryOnTime = deliveryDelayHours === 0 ? 1 : 0;
    const totalLeadTimeHours = Math.round((actualDeliveryDate.getTime() - orderDate.getTime()) / (1000 * 60 * 60));

    // KPIìš© ì›”ë³„ ì§‘ê³„ í‚¤
    const mKey = `${custId}-${orderDate.getFullYear()}-${pad(orderDate.getMonth() + 1)}`;

    // ë‹¤ì–‘í•œ í”Œë˜ê·¸ë“¤
    const isDelayed = deliveryDelayHours > 0 ? 1 : 0;
    const slaBreach = isDelayed ? 1 : 0;
    const isWeatherRisk = (weather === 'ë¹„' || weather === 'ëˆˆ') ? 1 : 0;
    const isLongDistance = distanceKm >= 30 ? 1 : 0;
    const isPremiumOrder = orderAmt >= 100000 ? 1 : 0;
    const isBulkOrder = qty >= 5 ? 1 : 0;
    const isFreeShipping = (custDeliveryCharge === 0) ? 1 : 0;
    const isSameDay = (mode === 'ë‹¹ì¼') ? 1 : 0;
    const isHighLTV = LTV >= 150000 ? 1 : 0;
    const isChurnRisk = churnScore > 0.7 ? 1 : 0;
    const isVIP = isHighLTV ? 1 : 0;
    const isLossOrder = netProfit < 0 ? 1 : 0;
    const isStockOutFlag = stockout;
    const isAGrade = abc === 'A' ? 1 : 0;
    const isOverStock = currentStock > reorderPoint * 3 ? 1 : 0;
    const isHighEff = (routingScore > 90 && loadFactor > 80) ? 1 : 0;
    const isAutomated = automationLevel !== 'MANUAL' ? 1 : 0;
    const isAIOptimized = automationLevel === 'AI_OPTIMIZED' ? 1 : 0;
    const isFastFulfillment = shipWithin60Min;
    const isQualityIssue = (returnFlag && ['ìƒí’ˆë¶ˆëŸ‰', 'íŒŒì†'].includes(returnReason)) ? 1 : 0;
    const isInventoryRisk = (stockout || isOverStock || invAcc < 0.97) ? 1 : 0;
    const deliveryStatus = (slaBreach === 1 || deliveryDelayHours > 0) ? 'Late' : 'On-Time';
    const shipmentStatus = shipOnTime ? 'On-Time' : 'Delayed';

    // í–‰ ê°ì²´ (ëŒ€í­ í™•ì¥ëœ ì»¬ëŸ¼ì…‹)
    return {
      // ì£¼ë¬¸Â·ì‹œê°„ íë¦„
      Order_ID: `ORD${String(1000 + i).padStart(6, '0')}`,
      Order_Date: `${orderDate.getFullYear()}-${pad(orderDate.getMonth() + 1)}-${pad(orderDate.getDate())}`,
      Order_Timestamp: orderDate.toISOString(),
      Order_Complete_Timestamp: orderCompleteDate.toISOString(),
      Planned_Ship_Date: `${plannedShipDate.getFullYear()}-${pad(plannedShipDate.getMonth() + 1)}-${pad(plannedShipDate.getDate())}`,
      Planned_Ship_Timestamp: plannedShipDate.toISOString(),
      Actual_Ship_Date: `${actualShipDate.getFullYear()}-${pad(actualShipDate.getMonth() + 1)}-${pad(actualShipDate.getDate())}`,
      Actual_Ship_Timestamp: actualShipDate.toISOString(),
      Planned_Delivery_Date: `${plannedDeliveryDate.getFullYear()}-${pad(plannedDeliveryDate.getMonth() + 1)}-${pad(plannedDeliveryDate.getDate())}`,
      Actual_Delivery_Date: `${actualDeliveryDate.getFullYear()}-${pad(actualDeliveryDate.getMonth() + 1)}-${pad(actualDeliveryDate.getDate())}`,
      Delivery_Timestamp: actualDeliveryDate.toISOString(),

      // ì‹œê°„ ì§€í‘œ
      Ship_Delay_Minutes: shipDelayMinutes,
      Delivery_Delay_Hours: deliveryDelayHours,
      Total_Lead_Time_Hours: totalLeadTimeHours,
      Order_Processing_Time_Minutes: Math.round((orderCompleteDate.getTime() - orderDate.getTime()) / (1000 * 60)),
      Fulfillment_Time_Minutes: Math.round((actualShipDate.getTime() - orderCompleteDate.getTime()) / (1000 * 60)),
      Transit_Time_Hours: Math.round((actualDeliveryDate.getTime() - actualShipDate.getTime()) / (1000 * 60 * 60)),

      // ìƒíƒœ
      Delivery_Mode: mode,
      Shipment_Status: shipmentStatus,
      Delivery_Status: deliveryStatus,
      SLA_Breach: slaBreach,

      // ì§€ì—­Â·ì£¼ì†ŒÂ·ì„¼í„°
      Region: region, City: city, District: district, Address: addr,
      Delivery_Center: deliveryCenter, Distance_km: distanceKm,

      // ê³ ê°Â·ë©¤ë²„ì‹­
      Customer_ID: custId,
      Is_WOW_Member: isWOW,
      WOW_Join_Date: isWOW ? wowJoin.toISOString().split('T')[0] : null,
      WOW_Tenure_Days: isWOW ? Math.floor((orderDate - wowJoin) / 86400000) : 0,
      Customer_Segment: (LTV >= 200000 ? 'Platinum' : (LTV >= 120000 ? 'Gold' : (LTV >= 60000 ? 'Silver' : 'Bronze'))),
      Customer_AOV: customerAOV,

      // ìƒí’ˆÂ·ê°€ê²©
      Product_Category: catKey, SKU: sku, ABC_Category: abc,
      Quantity: qty, Order_Amount: orderAmt, Weight_kg: weightKg,
      Margin_Rate: Math.round(cat.margin * 100),

      // ìš´ì†¡
      Vehicle_ID: vehicleId, Vehicle_Type: vType, Driver_ID: driverId, Driver_Grade: driverGrade,
      Load_Factor: loadFactor, Fuel_Efficiency: fuelEff, Routing_Score: routingScore,
      Real_Time_Tracking: Math.random() < 0.92 ? 1 : 0,

      // ìë™í™” ë° ì‹œìŠ¤í…œ
      Automation_Level: automationLevel,
      WMS_Maturity: wmsMaturity,
      OMS_Maturity: omsMaturity,
      WMS_Utilization_Rate: wmsUtilizationRate,
      OMS_Integration_Score: omsIntegrationScore,
      Auto_Allocation_Rate: autoAllocationRate,
      System_Downtime_Flag: systemDowntime,
      Inventory_Issue_Flag: inventoryIssue,
      Quality_Check_Flag: qualityCheck,

      // í˜„ì‹¤ì ì¸ í”¼í‚¹/íŒ¨í‚¹ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
      Picking_Time_Seconds: pickingTimeSec,
      Packing_Time_Seconds: packingTimeSec,
      Total_Fulfillment_Seconds: pickingTimeSec + packingTimeSec,
      Picking_Accuracy: pickingAcc,
      Worker_Items_Per_Hour: itemsPerHour,
      Fulfillment_Efficiency: fulfillmentEfficiency,

      // ë¹„ìš©
      Actual_Logistics_Cost: logisticsCost,
      Customer_Delivery_Charge: custDeliveryCharge,
      Fulfillment_Cost: fulfillmentCost,
      CAC: CAC, Gross_Profit: grossProfit,
      Inventory_Carrying_Cost: inventoryCarryingCost,
      Stockout_Cost: stockoutCost,
      Net_Profit: netProfit,

      // ë°˜í’ˆ
      Return_Flag: returnFlag, Return_Reason: returnReason, Return_Cost: returnCost,
      Is_Resellable: isResellable, Resellability_Reason: resellReason,

      // ì¬ê³ Â·WMS
      Inventory_Level: currentStock,
      Reorder_Point: reorderPoint,
      Inventory_Turnover: Math.round(stockTurn * 10) / 10,
      Stockout_Rate: Math.round((stockout ? 1 : 0) * 1000) / 10,
      Overstock_Rate: isOverStock ? 100 : 0,
      Inventory_Accuracy: invAcc,
      Demand_Forecast_Accuracy: Math.round(((abc === 'A' ? 0.92 : rnd(0.75, 0.95))) * 1000) / 1000,

      // ê³ ê° ê°€ì¹˜
      Customer_LTV: LTV, LTV_to_CAC: Math.round((LTV / Math.max(CAC, 1)) * 100) / 100,
      Churn_Flag: churnFlag, Predicted_Churn_Score: churnScore,

      // í’ˆì§ˆ/NPS
      Customer_NPS: irnd(60, 91),
      Service_Quality_Score: Math.round((0.8 + rnd(0, 0.15)) * 100),
      Claim_Processing_Hours: irnd(2, 50),

      // ë‚ ì”¨
      Weather_Condition: weather,
      Weather_Severity_Score: wsev,

      // ë¶„ì„ìš© í”Œë˜ê·¸ë“¤
      Is_Delayed: isDelayed,
      Is_Returned: returnFlag,
      Is_Premium_Order: isPremiumOrder,
      Is_Bulk_Order: isBulkOrder,
      Is_Weekend_Order: [0, 6].includes(orderDate.getDay()) ? 1 : 0,
      Is_Peak_Hour: (orderDate.getHours() >= 19 && orderDate.getHours() <= 21) ? 1 : 0,
      Is_Free_Shipping: isFreeShipping,
      Is_Same_Day: isSameDay,
      Is_Weather_Risk: isWeatherRisk,
      Is_Long_Distance: isLongDistance,
      Is_High_LTV: isHighLTV,
      Is_Churn_Risk: isChurnRisk,
      Is_VIP_Customer: isVIP,
      Is_Loss_Order: isLossOrder,
      Is_Stock_Out_Flag: isStockOutFlag,
      Is_A_Grade: isAGrade,
      Is_Over_Stock: isOverStock,
      Is_High_Efficiency: isHighEff,
      Is_Automated: isAutomated,
      Is_AI_Optimized: isAIOptimized,
      Is_Fast_Fulfillment: isFastFulfillment,
      Is_Ship_On_Time: shipOnTime,
      Is_Quality_Issue: isQualityIssue,
      Is_Inventory_Risk: isInventoryRisk,

      // ì›”ë³„ ì§‘ê³„ í‚¤ (ë‚´ë¶€ìš©)
      _monthlyKey: mKey
    };
  }

  // ì²­í¬ ìƒì„± í•¨ìˆ˜
  async function generateDataChunk(startIdx, chunkSize, nUsers, yStart, yEnd, churnMap) {
    const chunk = [];
    const chunkMonthly = {};

    for (let i = 0; i < chunkSize; i++) {
      if (PROCESSING_STATE.shouldStop) break;

      const row = generateSingleRow(startIdx + i, nUsers, yStart, yEnd, churnMap);
      chunk.push(row);

      // ì›”ë³„ ì§‘ê³„ ì¶”ê°€
      const mKey = row._monthlyKey;
      chunkMonthly[mKey] = (chunkMonthly[mKey] || 0) + row.Order_Amount;

      // ì£¼ê¸°ì ìœ¼ë¡œ CPU ì–‘ë³´
      if (i % 100 === 0) {
        await sleep(0);
      }
    }

    return {chunk, chunkMonthly};
  }

  // ë©”ì¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜
  async function generateDataInChunks(nOrders, nUsers, yStart, yEnd, chunkSize) {
    // ì´ˆê¸°í™”
    DATA = [];
    MONTHLY_BY_CUST = {};
    VALIDATION_ISSUES = [];
    PERFORMANCE_METRICS = {};

    PROCESSING_STATE = {
      isRunning: true,
      shouldStop: false,
      startTime: performance.now(),
      processedRows: 0,
      totalRows: nOrders,
      currentChunk: 0,
      totalChunks: Math.ceil(nOrders / chunkSize)
    };

    updateUIState('running');

    try {
      // ì´íƒˆ ê³ ê° ì‚¬ì „ í• ë‹¹
      const churnMap = preAssignChurn(nUsers);

      // ì²­í¬ë³„ ì²˜ë¦¬
      for (let chunkIdx = 0; chunkIdx < PROCESSING_STATE.totalChunks; chunkIdx++) {
        if (PROCESSING_STATE.shouldStop) break;

        const startIdx = chunkIdx * chunkSize;
        const currentChunkSize = Math.min(chunkSize, nOrders - startIdx);

        // ì²­í¬ ìƒì„±
        const {chunk, chunkMonthly} = await generateDataChunk(
          startIdx, currentChunkSize, nUsers, yStart, yEnd, churnMap
        );

        // ë°ì´í„° ì¶”ê°€ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
        if (DATA.length + chunk.length > CHUNK_CONFIG.maxMemoryRows) {
          // í…Œì´ë¸” í‘œì‹œìš©ìœ¼ë¡œ ìµœê·¼ ë°ì´í„°ë§Œ ìœ ì§€
          DATA = DATA.slice(-CHUNK_CONFIG.maxMemoryRows / 2).concat(chunk);
        } else {
          DATA = DATA.concat(chunk);
        }

        // ì›”ë³„ ì§‘ê³„ ì—…ë°ì´íŠ¸
        Object.keys(chunkMonthly).forEach(key => {
          MONTHLY_BY_CUST[key] = (MONTHLY_BY_CUST[key] || 0) + chunkMonthly[key];
        });

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        PROCESSING_STATE.processedRows = startIdx + currentChunkSize;
        PROCESSING_STATE.currentChunk = chunkIdx + 1;

        // ì£¼ê¸°ì  UI ì—…ë°ì´íŠ¸
        if (chunkIdx % CHUNK_CONFIG.batchUpdateInterval === 0 || chunkIdx === PROCESSING_STATE.totalChunks - 1) {
          updateProgress();

          // KPI ë¶€ë¶„ ì—…ë°ì´íŠ¸ (ì „ì²´ ë°ì´í„° ê¸°ì¤€)
          if (chunkIdx % (CHUNK_CONFIG.batchUpdateInterval * 2) === 0) {
            const partialKPI = calcKPIsFromPartialData();
            updateKPI(partialKPI);
          }
        }

        // ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ íŒíŠ¸
        if (chunkIdx % CHUNK_CONFIG.gcInterval === 0) {
          await sleep(10);
        }

        await sleep(1); // UI ë¸”ë¡œí‚¹ ë°©ì§€
      }

      // ìµœì¢… ì²˜ë¦¬
      if (!PROCESSING_STATE.shouldStop) {
        // CLV 4ë¶„ìœ„ ê³„ì‚°
        const clvValues = DATA.map(r => r.Customer_LTV || 0);
        const qs = calcQuartilesFromValues(clvValues);
        DATA.forEach(r => {
          const q = toQuartile(r.Customer_LTV || 0, qs);
          r.CLV_Quartile = q;
          r.CLV_Quartile_Label = `Q${q}`;
        });

        // ìµœì¢… KPI ê³„ì‚°
        const finalKPI = calcKPIs();
        updateKPI(finalKPI);

        // ê²€ì¦ ì‹¤í–‰
        await runValidations();
        renderValidations();
        renderRisks();
        renderTable();

        // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚°
        const endTime = performance.now();
        PERFORMANCE_METRICS = {
          totalTime: Math.round(endTime - PROCESSING_STATE.startTime),
          rowsPerSecond: Math.round(nOrders / ((endTime - PROCESSING_STATE.startTime) / 1000)),
          chunksProcessed: PROCESSING_STATE.totalChunks,
          memoryEfficiency: Math.round((DATA.length / nOrders) * 100)
        };
        renderPerformanceMetrics();

        document.getElementById('btnCsv').disabled = false;
        updateUIState('completed');
      } else {
        updateUIState('stopped');
      }

    } catch (error) {
      console.error('ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
      updateUIState('error');
      alert('ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }

    PROCESSING_STATE.isRunning = false;
  }

  /* -------------------------
     3) KPI ê³„ì‚° (ì‹ ê·œ ì§€í‘œ ì¶”ê°€)
  --------------------------*/
  function calcKPIs() {
    const rows = DATA;
    const totalOrders = rows.length;
    const totalSales = rows.reduce((s, r) => s + r.Order_Amount, 0);
    const totalNet = rows.reduce((s, r) => s + r.Net_Profit, 0);
    const netMargin = totalSales ? Math.round((totalNet / totalSales) * 1000) / 10 : 0;

    // ë°°ì†¡ ê´€ë ¨
    const onTime = rows.filter(r => r.SLA_Breach === 0).length;
    const onTimeRate = Math.round((onTime / totalOrders) * 1000) / 10;
    const slaRate = 100 - onTimeRate;

    // ì¶œê³  ê´€ë ¨ (ì‹ ê·œ)
    const shipOnTime = rows.filter(r => r.Is_Ship_On_Time === 1).length;
    const shipOnTimeRate = Math.round((shipOnTime / totalOrders) * 1000) / 10;
    const avgShipTime = Math.round(rows.reduce((s, r) => s + r.Fulfillment_Time_Minutes, 0) / Math.max(totalOrders, 1));
    const ship60 = rows.filter(r => r.Is_Fast_Fulfillment === 1).length;
    const ship60Rate = Math.round((ship60 / totalOrders) * 1000) / 10;

    // í”¼í‚¹/íŒ¨í‚¹ ì†ë„ (ì´ˆ ë‹¨ìœ„)
    const avgPickSpeed = Math.round(rows.reduce((s, r) => s + r.Picking_Time_Seconds, 0) / Math.max(totalOrders, 1));
    const avgPackSpeed = Math.round(rows.reduce((s, r) => s + r.Packing_Time_Seconds, 0) / Math.max(totalOrders, 1));

    // í’€í•„ë¨¼íŠ¸ íš¨ìœ¨ì„±
    const avgFulfillEff = Math.round(rows.reduce((s, r) => s + (r.Fulfillment_Efficiency || 100), 0) / Math.max(totalOrders, 1));

    const load = Math.round(rows.reduce((s, r) => s + r.Load_Factor, 0) / Math.max(totalOrders, 1));
    const fuel = Math.round((rows.reduce((s, r) => s + r.Fuel_Efficiency, 0) / Math.max(totalOrders, 1)) * 10) / 10;
    const route = Math.round(rows.reduce((s, r) => s + r.Routing_Score, 0) / Math.max(totalOrders, 1));
    const exceptions = rows.filter(r => r.Return_Reason && ['ì˜¤ë°°ì†¡', 'íŒŒì†'].includes(r.Return_Reason)).length;
    const exceptionRate = Math.round((exceptions / totalOrders) * 1000) / 10;

    const returns = rows.filter(r => r.Return_Flag === 1).length;
    const returnRate = Math.round((returns / totalOrders) * 1000) / 10;
    const returnCostRate = totalSales ? Math.round((rows.reduce((s, r) => s + r.Return_Cost, 0) / totalSales) * 1000) / 10 : 0;
    const resellable = rows.filter(r => r.Is_Resellable === 1).length;
    const resellRate = returns ? Math.round((resellable / returns) * 1000) / 10 : 0;

    const wow = rows.filter(r => r.Is_WOW_Member === 1);
    const nonwow = rows.filter(r => r.Is_WOW_Member === 0);
    const wowShare = Math.round((wow.length / Math.max(totalOrders, 1)) * 1000) / 10;
    const wowAOV = wow.length ? Math.round(wow.reduce((s, r) => s + r.Order_Amount, 0) / wow.length) : 0;
    const nonwowAOV = nonwow.length ? Math.round(nonwow.reduce((s, r) => s + r.Order_Amount, 0) / nonwow.length) : 0;

    // ì¬ê³  KPI
    const invTurn = Math.round((rows.reduce((s, r) => s + r.Inventory_Turnover, 0) / totalOrders) * 10) / 10;
    const stockoutRate = Math.round((rows.filter(r => r.Is_Stock_Out_Flag === 1).length / totalOrders) * 1000) / 10;
    const overstockRate = Math.round((rows.filter(r => r.Is_Over_Stock === 1).length / totalOrders) * 1000) / 10;
    const invAcc = Math.round((rows.reduce((s, r) => s + r.Inventory_Accuracy, 0) / totalOrders) * 1000) / 10;
    const shrink = totalSales ? Math.round((rows.reduce((s, r) => s + r.Inventory_Carrying_Cost + r.Stockout_Cost, 0) / totalSales) * 1000) / 10 : 0;
    const wmsUtil = Math.round((rows.reduce((s, r) => s + r.WMS_Utilization_Rate, 0) / totalOrders));

    // ìë™í™” ê´€ë ¨ (ì‹ ê·œ)
    const autoRate = Math.round((rows.filter(r => r.Is_Automated === 1).length / totalOrders) * 1000) / 10;
    const omsEff = Math.round(rows.reduce((s, r) => s + r.OMS_Integration_Score, 0) / Math.max(totalOrders, 1));

    // ê³ ê° KPI
    const avgLTV = Math.round(rows.reduce((s, r) => s + r.Customer_LTV, 0) / Math.max(totalOrders, 1));
    const avgCAC = Math.round(rows.reduce((s, r) => s + r.CAC, 0) / Math.max(totalOrders, 1));
    const ltvCac = avgCAC ? Math.round((avgLTV / avgCAC) * 100) / 100 : 0;
    const churnCust = new Set(rows.filter(r => r.Churn_Flag === 1).map(r => r.Customer_ID)).size;
    const uniqCust = new Set(rows.map(r => r.Customer_ID)).size;
    const churnRate = uniqCust ? Math.round((churnCust / uniqCust) * 1000) / 10 : 0;
    const retention = Math.round((100 - churnRate) * 10) / 10;

    // AI ì •í™•ë„
    const correct = rows.filter(r => (r.Churn_Flag === 1 && r.Predicted_Churn_Score > 0.7) || (r.Churn_Flag === 0 && r.Predicted_Churn_Score <= 0.7)).length;
    const aiAcc = Math.round((correct / totalOrders) * 1000) / 10;

    // ARPPU: ê³ ê°-ì›” ì§‘ê³„ í‰ê· 
    const monthlyTotals = Object.values(MONTHLY_BY_CUST);
    const arppu = monthlyTotals.length ? Math.round(monthlyTotals.reduce((s, a) => s + a, 0) / monthlyTotals.length) : 0;

    // WOW ì¬ê³ íšŒì „ ê¸°ì—¬
    const wowInv = wow.length ? Math.round((wow.reduce((s, r) => s + r.Inventory_Turnover, 0) / wow.length) * 10) / 10 : 0;

    return {
      totalSales, netMargin, aov: Math.round(totalSales / Math.max(totalOrders, 1)),
      arppu, ltvCac, retention, churnRate, aiAcc,
      onTimeRate, slaRate, load, fuel, route, exceptionRate,
      returnRate, returnCostRate, resellRate,
      wowShare, wowAOV, nonwowAOV, wowInv,
      invTurn, stockoutRate, overstockRate, invAcc, shrink, wmsUtil,
      // ì‹ ê·œ ì§€í‘œë“¤
      shipOnTimeRate, avgShipTime, avgPickSpeed, avgPackSpeed, avgFulfillEff, ship60Rate,
      autoRate, omsEff
    };
  }

  // ë¶€ë¶„ KPI ê³„ì‚° (ì§„í–‰ ì¤‘ í‘œì‹œìš©)
  function calcKPIsFromPartialData() {
    if (!DATA.length) return calcKPIs();

    // ìƒ˜í”Œë§ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
    const sampleSize = Math.min(DATA.length, 10000);
    const sampleRows = DATA.slice(-sampleSize);

    const totalOrders = sampleRows.length;
    const totalSales = sampleRows.reduce((s, r) => s + r.Order_Amount, 0);
    const avgOrderAmt = Math.round(totalSales / Math.max(totalOrders, 1));

    return {
      totalSales: Math.round((totalSales / sampleSize) * PROCESSING_STATE.processedRows),
      aov: avgOrderAmt,
      onTimeRate: Math.round((sampleRows.filter(r => r.SLA_Breach === 0).length / totalOrders) * 1000) / 10,
      returnRate: Math.round((sampleRows.filter(r => r.Return_Flag === 1).length / totalOrders) * 1000) / 10,
      wowShare: Math.round((sampleRows.filter(r => r.Is_WOW_Member === 1).length / totalOrders) * 1000) / 10,
      shipOnTimeRate: Math.round((sampleRows.filter(r => r.Is_Ship_On_Time === 1).length / totalOrders) * 1000) / 10
    };
  }

  /* -------------------------
     4) ê²€ì¦ ë° ìœ„í—˜ ìš”ì†Œ ë¶„ì„ (ì‹œê°„ íë¦„ ì •í•©ì„± ê°•í™”)
  --------------------------*/
  async function runValidations() {
    const issues = [];
    const rows = DATA.slice(-10000); // ìµœê·¼ 1ë§Œê±´ë§Œ ê²€ì¦ (ì„±ëŠ¥ìƒ)

    let validatedCount = 0;
    const totalToValidate = Math.min(rows.length, 5000);

    for (let i = 0; i < totalToValidate; i++) {
      const r = rows[i];

      // 1) ì‹œê°„ íë¦„ ë…¼ë¦¬ì  ì •í•©ì„± ê²€ì¦ (ê°•í™”)
      const orderTime = new Date(r.Order_Timestamp);
      const completeTime = new Date(r.Order_Complete_Timestamp);
      const plannedShipTime = new Date(r.Planned_Ship_Timestamp);
      const actualShipTime = new Date(r.Actual_Ship_Timestamp);
      const plannedDeliveryTime = new Date(r.Planned_Delivery_Date + 'T00:00:00+09:00');
      const actualDeliveryTime = new Date(r.Delivery_Timestamp);

      // ì‹œê°„ ìˆœì„œ ê²€ì¦
      if (!(orderTime <= completeTime)) issues.push({
        level: 'bad',
        msg: `Order complete before order time: ${r.Order_ID}`
      });
      if (!(completeTime <= plannedShipTime)) issues.push({
        level: 'bad',
        msg: `Planned ship before complete: ${r.Order_ID}`
      });
      if (!(plannedShipTime <= actualShipTime)) issues.push({
        level: 'warn',
        msg: `Actual ship before planned: ${r.Order_ID}`
      });
      if (!(actualShipTime <= actualDeliveryTime)) issues.push({
        level: 'bad',
        msg: `Delivery before shipment: ${r.Order_ID}`
      });

      // 2) ì‹œê°„ ê°„ê²© í•©ë¦¬ì„± ê²€ì¦
      const processingMin = (completeTime - orderTime) / (1000 * 60);
      const fulfillmentMin = (actualShipTime - completeTime) / (1000 * 60);
      const transitHours = (actualDeliveryTime - actualShipTime) / (1000 * 60 * 60);

      if (processingMin < 0 || processingMin > 480) issues.push({
        level: 'warn',
        msg: `Unrealistic processing time ${processingMin}min: ${r.Order_ID}`
      });
      if (fulfillmentMin < 5 || fulfillmentMin > 2880) issues.push({
        level: 'warn',
        msg: `Unrealistic fulfillment time ${fulfillmentMin}min: ${r.Order_ID}`
      });
      if (transitHours < 0.5 || transitHours > 168) issues.push({
        level: 'warn',
        msg: `Unrealistic transit time ${transitHours}h: ${r.Order_ID}`
      });

      // 3) ìë™í™” ìˆ˜ì¤€ê³¼ í”¼í‚¹ ì‹œê°„ ì •í•©ì„±
      const expectedPickTime = AUTOMATION_LEVELS[r.Automation_Level]?.pickTimePerItem || 45;
      const actualPickTimePerItem = r.Picking_Time_Seconds / r.Quantity;
      if (Math.abs(actualPickTimePerItem - expectedPickTime) > expectedPickTime * 0.5) {
        issues.push({level: 'warn', msg: `Pick time inconsistent with automation level: ${r.Order_ID}`});
      }

      // 4) WMS ì„±ìˆ™ë„ì™€ ì§€í‘œ ì •í•©ì„±
      const wmsConfig = WMS_MATURITY[r.WMS_Maturity];
      if (wmsConfig) {
        if (Math.abs(r.Picking_Accuracy - wmsConfig.picking_accuracy) > 0.02) {
          issues.push({level: 'warn', msg: `Picking accuracy inconsistent with WMS maturity: ${r.Order_ID}`});
        }
        if (Math.abs(r.WMS_Utilization_Rate - wmsConfig.efficiency * 100) > 15) {
          issues.push({level: 'warn', msg: `WMS utilization inconsistent: ${r.Order_ID}`});
        }
      }

      // 5) ê±°ë¦¬-ì„¼í„°-ì§€ì—­ ê²€ì¦
      if (!r.Delivery_Center) issues.push({level: 'bad', msg: `Missing center: ${r.Order_ID}`});
      if (r.Distance_km < 0 || r.Distance_km > 120) issues.push({
        level: 'warn',
        msg: `Suspicious distance ${r.Distance_km}km: ${r.Order_ID}`
      });

      // 6) SLA_Breach vs ì§€ì—°ì‹œê°„ ì •í•©ì„±
      if ((r.SLA_Breach === 1 && r.Delivery_Delay_Hours <= 0) || (r.SLA_Breach === 0 && r.Delivery_Delay_Hours > 0)) {
        issues.push({level: 'bad', msg: `SLA vs Delay mismatch: ${r.Order_ID}`});
      }

      // 7) WOW ë¬´ë£Œë°°ì†¡ ë¡œì§
      if (r.Is_WOW_Member === 1 && r.Customer_Delivery_Charge !== 0) issues.push({
        level: 'bad',
        msg: `WOW charged shipping: ${r.Order_ID}`
      });
      if (r.Is_WOW_Member === 1 && r.Actual_Logistics_Cost <= 0) issues.push({
        level: 'bad',
        msg: `WOW missing logistics cost: ${r.Order_ID}`
      });

      // 8) ì¬ê³  ìˆ˜ì¹˜
      if (r.Inventory_Level < 0) issues.push({level: 'bad', msg: `Negative inventory: ${r.Order_ID}`});
      if (r.Overstock_Rate > 100) issues.push({level: 'warn', msg: `Overstock rate >100%: ${r.Order_ID}`});

      // 9) ì—°ë¹„
      if (r.Fuel_Efficiency <= 0) issues.push({level: 'bad', msg: `Nonpositive fuel efficiency: ${r.Order_ID}`});

      // 10) 60ë¶„ ë‚´ ì¶œê³ ì™€ ì‹¤ì œ ì‹œê°„ ì •í•©ì„±
      const actualFulfillmentMin = r.Fulfillment_Time_Minutes;
      if (r.Is_Fast_Fulfillment === 1 && actualFulfillmentMin > 60) {
        issues.push({level: 'bad', msg: `Fast fulfillment flag but >60min: ${r.Order_ID}`});
      }

      validatedCount++;

      // ì£¼ê¸°ì ìœ¼ë¡œ CPU ì–‘ë³´
      if (i % 100 === 0) {
        await sleep(0);
      }

      if (PROCESSING_STATE.shouldStop) break;
    }

    VALIDATION_ISSUES = issues;

    // ì¶”ê°€ í†µê³„ ê²€ì¦
    const totalRows = rows.length;
    const wowRate = rows.filter(r => r.Is_WOW_Member === 1).length / totalRows;
    const returnRate = rows.filter(r => r.Return_Flag === 1).length / totalRows;
    const delayRate = rows.filter(r => r.Is_Delayed === 1).length / totalRows;
    const autoRate = rows.filter(r => r.Is_Automated === 1).length / totalRows;

    if (wowRate < 0.5 || wowRate > 0.8) {
      issues.push({
        level: 'warn',
        msg: `WOW membership rate ${Math.round(wowRate * 100)}% outside expected range (50-80%)`
      });
    }
    if (returnRate < 0.02 || returnRate > 0.15) {
      issues.push({level: 'warn', msg: `Return rate ${Math.round(returnRate * 100)}% outside expected range (2-15%)`});
    }
    if (delayRate < 0.01 || delayRate > 0.1) {
      issues.push({level: 'warn', msg: `Delay rate ${Math.round(delayRate * 100)}% outside expected range (1-10%)`});
    }
    if (autoRate < 0.3 || autoRate > 0.9) {
      issues.push({
        level: 'warn',
        msg: `Automation rate ${Math.round(autoRate * 100)}% outside expected range (30-90%)`
      });
    }

    return issues;
  }

  function compositeRisks() {
    const sampleRows = DATA.slice(-5000); // ì„±ëŠ¥ì„ ìœ„í•´ ìµœê·¼ 5ì²œê±´ë§Œ ë¶„ì„

    const longBadWeather = sampleRows.filter(r => r.Is_Long_Distance === 1 && r.Weather_Severity_Score >= 0.65);
    const longWOW = sampleRows.filter(r => r.Is_Long_Distance === 1 && r.Is_WOW_Member === 1);
    const badWeatherPremium = sampleRows.filter(r => r.Weather_Severity_Score >= 0.65 && r.Is_Premium_Order === 1);
    const highRiskCombo = sampleRows.filter(r => r.Is_Churn_Risk === 1 && r.Is_Loss_Order === 1);
    // ì‹ ê·œ ìœ„í—˜ ìš”ì†Œ
    const shipDelayStock = sampleRows.filter(r => r.Ship_Delay_Minutes > 60 && r.Is_Stock_Out_Flag === 1);
    const manualHighVol = sampleRows.filter(r => r.Automation_Level === 'MANUAL' && r.Is_Bulk_Order === 1);

    return {
      longBadWeather: longBadWeather.slice(0, 20).map(r => r.Order_ID),
      longWOW: longWOW.slice(0, 20).map(r => r.Order_ID),
      badWeatherPremium: badWeatherPremium.slice(0, 20).map(r => r.Order_ID),
      highRiskCombo: highRiskCombo.slice(0, 20).map(r => r.Order_ID),
      shipDelayStock: shipDelayStock.slice(0, 20).map(r => r.Order_ID),
      manualHighVol: manualHighVol.slice(0, 20).map(r => r.Order_ID),
      counts: {
        longBadWeather: longBadWeather.length,
        longWOW: longWOW.length,
        badWeatherPremium: badWeatherPremium.length,
        highRiskCombo: highRiskCombo.length,
        shipDelayStock: shipDelayStock.length,
        manualHighVol: manualHighVol.length
      }
    };
  }

  /* -------------------------
     5) UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì‹ ê·œ KPI ì¶”ê°€)
  --------------------------*/
  function setText(id, v, suffix = '') {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (v === undefined || v === null || Number.isNaN(v)) ? '-' : (typeof v === 'number' ? v.toLocaleString() : v);
    if (suffix) el.nextElementSibling && (el.nextElementSibling.textContent = suffix);
  }

  function updateKPI(k) {
    // ê¸°ì¡´ KPI
    setText('k_totalSales', Math.round(k.totalSales || 0));
    setText('k_netMargin', k.netMargin || 0);
    setText('k_aov', k.aov || 0);
    setText('k_arppu', k.arppu || 0);
    setText('k_ltvCac', k.ltvCac || 0);
    setText('k_retention', k.retention || 0);
    setText('k_churn', k.churnRate || 0);
    setText('k_ai', k.aiAcc || 0);
    setText('k_onTime', k.onTimeRate || 0);
    setText('k_sla', k.slaRate || 0);
    setText('k_load', k.load || 0);
    setText('k_fuel', k.fuel || 0);
    setText('k_route', k.route || 0);
    setText('k_exception', k.exceptionRate || 0);
    setText('k_returnRate', k.returnRate || 0);
    setText('k_returnCost', k.returnCostRate || 0);
    setText('k_resell', k.resellRate || 0);
    setText('k_wowShare', k.wowShare || 0);
    setText('k_wowAov', k.wowAOV || 0);
    setText('k_nonWowAov', k.nonwowAOV || 0);
    setText('k_wowInv', k.wowInv || 0);
    setText('k_invTurn', k.invTurn || 0);
    setText('k_stockout', k.stockoutRate || 0);
    setText('k_overstock', k.overstockRate || 0);
    setText('k_invAcc', k.invAcc || 0);
    setText('k_shrink', k.shrink || 0);
    setText('k_wms', k.wmsUtil || 0);

    // ì‹ ê·œ KPI
    setText('k_onTimeShip', k.shipOnTimeRate || 0);
    const shipCard = document.getElementById('k_onTimeShip')?.closest('.kpi');
    if (shipCard) {
      if (k.shipOnTimeRate >= SHIP_ON_TIME_GOOD)       shipCard.className = 'kpi good';
      else if (k.shipOnTimeRate >= SHIP_ON_TIME_TARGET) shipCard.className = 'kpi primary';
      else                                              shipCard.className = 'kpi warn';
    }

    setText('k_avgShipTime', k.avgShipTime || 0);
    setText('k_pickSpeed', k.avgPickSpeed || 0);
    setText('k_packSpeed', k.avgPackSpeed || 0);
    setText('k_fulfillEff', k.avgFulfillEff || 0);
    setText('k_ship60', k.ship60Rate || 0);
    setText('k_autoRate', k.autoRate || 0);
    setText('k_omsEff', k.omsEff || 0);
  }

  function updateProgress() {
    const progress = Math.round((PROCESSING_STATE.processedRows / PROCESSING_STATE.totalRows) * 100);
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressStats = document.getElementById('progressStats');
    const progressETA = document.getElementById('progressETA');

    if (progressFill) progressFill.style.width = `${progress}%`;
    if (progressText) progressText.textContent = `${progress}% ì™„ë£Œ (${PROCESSING_STATE.processedRows.toLocaleString()} / ${PROCESSING_STATE.totalRows.toLocaleString()}) | Processing ${progress}%`;

    if (progressStats) {
      const elapsed = performance.now() - PROCESSING_STATE.startTime;
      const rate = Math.round(PROCESSING_STATE.processedRows / (elapsed / 1000));
      progressStats.textContent = `${rate.toLocaleString()} rows/sec | ì²­í¬ ${PROCESSING_STATE.currentChunk}/${PROCESSING_STATE.totalChunks}`;
    }

    if (progressETA && PROCESSING_STATE.processedRows > 0) {
      const elapsed = performance.now() - PROCESSING_STATE.startTime;
      const remaining = (PROCESSING_STATE.totalRows - PROCESSING_STATE.processedRows);
      const rate = PROCESSING_STATE.processedRows / (elapsed / 1000);
      const etaSeconds = remaining / rate;
      const etaText = etaSeconds > 60 ? `${Math.round(etaSeconds / 60)}ë¶„` : `${Math.round(etaSeconds)}ì´ˆ`;
      progressETA.textContent = `ì˜ˆìƒ ì™„ë£Œ: ${etaText} | ETA: ${etaText}`;
    }
  }

  function updateUIState(state) {
    const status = document.getElementById('status');
    const btnGen = document.getElementById('btnGen');
    const btnStop = document.getElementById('btnStop');
    const progressContainer = document.getElementById('progressContainer');

    switch (state) {
      case 'running':
        status.textContent = 'PROCESSING';
        status.className = 'pill running';
        btnGen.disabled = true;
        btnStop.disabled = false;
        btnStop.style.display = 'inline-block';
        progressContainer.style.display = 'block';
        break;
      case 'completed':
        status.textContent = 'COMPLETED';
        status.className = 'pill ok';
        btnGen.disabled = false;
        btnStop.disabled = true;
        btnStop.style.display = 'none';
        break;
      case 'stopped':
        status.textContent = 'STOPPED';
        status.className = 'pill ng';
        btnGen.disabled = false;
        btnStop.disabled = true;
        btnStop.style.display = 'none';
        break;
      case 'error':
        status.textContent = 'ERROR';
        status.className = 'pill ng';
        btnGen.disabled = false;
        btnStop.disabled = true;
        btnStop.style.display = 'none';
        break;
      default:
        status.textContent = 'READY';
        status.className = 'pill ok';
        btnGen.disabled = false;
        btnStop.disabled = true;
        btnStop.style.display = 'none';
        progressContainer.style.display = 'none';
    }
  }

  function renderValidations() {
    const box = document.getElementById('validateList');
    const sum = document.getElementById('validateSummary');
    box.innerHTML = '';
    if (!VALIDATION_ISSUES.length) {
      sum.className = 'pill ok';
      sum.textContent = 'All checks passed (ëª¨ë“  ê²€ì¦ í†µê³¼)';
      box.innerHTML = `<div class="alert good">âœ… ë°ì´í„° ì •í•©ì„± ì´ìƒ ì—†ìŒ</div>`;
      return;
    }
    sum.className = 'pill ng';
    sum.textContent = `${VALIDATION_ISSUES.length} issue(s) found`;
    VALIDATION_ISSUES.slice(0, 100).forEach(it => {
      const div = document.createElement('div');
      div.className = `alert ${it.level === 'bad' ? 'bad' : 'warn'}`;
      div.textContent = it.msg;
      box.appendChild(div);
    });
  }

  function renderRisks() {
    const r = compositeRisks();
    const box = document.getElementById('riskList');
    box.innerHTML = '';
    const items = [
      {title: `ì¥ê±°ë¦¬+ì•…ì²œí›„ / Long Distance + Bad Weather`, count: r.counts.longBadWeather, list: r.longBadWeather},
      {title: `ì¥ê±°ë¦¬+WOW / Long Distance + WOW`, count: r.counts.longWOW, list: r.longWOW},
      {title: `ì•…ì²œí›„+ê³ ê°€ / Bad Weather + Premium`, count: r.counts.badWeatherPremium, list: r.badWeatherPremium},
      {title: `ì´íƒˆìœ„í—˜+ì†ì‹¤ì£¼ë¬¸ / Churn Risk + Loss Order`, count: r.counts.highRiskCombo, list: r.highRiskCombo},
      {title: `ì¶œê³ ì§€ì—°+í’ˆì ˆ / Ship Delay + Stockout`, count: r.counts.shipDelayStock, list: r.shipDelayStock},
      {title: `ìˆ˜ë™ì²˜ë¦¬+ëŒ€ëŸ‰ì£¼ë¬¸ / Manual + Bulk Order`, count: r.counts.manualHighVol, list: r.manualHighVol}
    ];
    items.forEach(it => {
      const div = document.createElement('div');
      div.className = it.count ? 'alert warn' : 'alert good';
      div.innerHTML = `<strong>${it.title}</strong> â€” ${it.count}ê±´<br>${it.list.join(', ')}`;
      box.appendChild(div);
    });
  }

  function renderPerformanceMetrics() {
    const box = document.getElementById('perfList');
    if (!box) return;

    box.innerHTML = '';

    if (Object.keys(PERFORMANCE_METRICS).length === 0) {
      box.innerHTML = '<div class="alert good">ì„±ëŠ¥ ë©”íŠ¸ë¦­ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</div>';
      return;
    }

    const metrics = [
      {
        title: `ì²˜ë¦¬ ì‹œê°„ / Total Time`,
        value: `${(PERFORMANCE_METRICS.totalTime / 1000).toFixed(1)}ì´ˆ`,
        level: PERFORMANCE_METRICS.totalTime < 60000 ? 'good' : 'warn'
      },
      {
        title: `ì²˜ë¦¬ ì†ë„ / Processing Rate`,
        value: `${PERFORMANCE_METRICS.rowsPerSecond.toLocaleString()} rows/sec`,
        level: PERFORMANCE_METRICS.rowsPerSecond > 1000 ? 'good' : 'warn'
      },
      {
        title: `ì²­í¬ ì²˜ë¦¬ / Chunks Processed`,
        value: `${PERFORMANCE_METRICS.chunksProcessed}ê°œ`,
        level: 'good'
      },
      {
        title: `ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± / Memory Efficiency`,
        value: `${PERFORMANCE_METRICS.memoryEfficiency}% ë©”ëª¨ë¦¬ ìœ ì§€`,
        level: PERFORMANCE_METRICS.memoryEfficiency < 50 ? 'good' : 'warn'
      }
    ];

    metrics.forEach(metric => {
      const div = document.createElement('div');
      div.className = `alert ${metric.level}`;
      div.innerHTML = `<strong>${metric.title}</strong>: ${metric.value}`;
      box.appendChild(div);
    });
  }

  /* -------------------------
     6) í…Œì´ë¸” & CSV (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
  --------------------------*/
  function renderTable() {
    const tbl = document.getElementById('tbl');
    const thead = tbl.querySelector('thead');
    const tbody = tbl.querySelector('tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    if (!DATA.length) {
      thead.innerHTML = '<tr><th>ë°ì´í„° ì—†ìŒ / No data</th></tr>';
      return;
    }
    const cols = Object.keys(DATA[0]).filter(c => !c.startsWith('_')); // ë‚´ë¶€ í•„ë“œ ì œì™¸

    // í—¤ë”
    const trh = document.createElement('tr');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    // ìµœê·¼ 500ê°œ í–‰ë§Œ í‘œì‹œ (ì„±ëŠ¥ìƒ)
    const displayRows = DATA.slice(-500);
    displayRows.forEach(r => {
      const tr = document.createElement('tr');
      cols.forEach(c => {
        const td = document.createElement('td');
        let v = r[c];
        if (v === null || v === undefined) v = '';
        if (typeof v === 'number' && Math.abs(v) >= 1000) v = v.toLocaleString();
        if (String(c).toLowerCase().includes('timestamp')) {
          try {
            v = new Date(r[c]).toLocaleString('ko-KR');
          } catch (_) {
          }
        }
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // í…Œì´ë¸” í•˜ë‹¨ì— í‘œì‹œ í–‰ìˆ˜ ì•ˆë‚´
    const infoRow = document.createElement('tr');
    const infoCell = document.createElement('td');
    infoCell.colSpan = cols.length;
    infoCell.style.textAlign = 'center';
    infoCell.style.fontStyle = 'italic';
    infoCell.style.color = 'var(--muted)';
    infoCell.textContent = `ìµœê·¼ ${displayRows.length}ê°œ í–‰ í‘œì‹œ ì¤‘ (ì „ì²´: ${PROCESSING_STATE.processedRows.toLocaleString()}ê°œ) | Showing recent ${displayRows.length} rows (Total: ${PROCESSING_STATE.processedRows.toLocaleString()})`;
    infoRow.appendChild(infoCell);
    tbody.appendChild(infoRow);
  }

  function downloadCSV() {
    if (!DATA.length) return;
    const cols = Object.keys(DATA[0]).filter(c => !c.startsWith('_'));
    const escape = s => `"${String(s ?? '').replace(/"/g, '""')}"`;

    // ëŒ€ìš©ëŸ‰ CSV ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ì²­í¬ ê¸°ë°˜ ì²˜ë¦¬
    const chunkSize = 10000;
    let csvContent = '\ufeff' + cols.join(',') + '\n';

    const totalRows = Math.min(DATA.length, 100000); // ìµœëŒ€ 10ë§Œê°œ í–‰ë§Œ ë‚´ë³´ë‚´ê¸°
    for (let i = 0; i < totalRows; i += chunkSize) {
      const chunk = DATA.slice(i, Math.min(i + chunkSize, totalRows));
      chunk.forEach(r => {
        csvContent += cols.map(c => escape(r[c])).join(',') + '\n';
      });
    }

    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logistics_dashboard_enhanced_${new Date().toISOString().slice(0, 10)}_${totalRows}rows.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  /* -------------------------
     7) ì´ˆê¸°í™” & ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  --------------------------*/
  function initYearSelects() {
    const s = document.getElementById('startYear');
    const e = document.getElementById('endYear');
    const now = new Date().getFullYear();
    [now - 5, now - 4, now - 3, now - 2, now - 1, now].forEach(y => {
      const o1 = new Option(y, y);
      const o2 = new Option(y, y);
      s.add(o1);
      e.add(o2);
    });
    s.value = now;
    e.value = now;
    s.addEventListener('change', () => {
      if (+s.value > +e.value) e.value = s.value;
    });
    e.addEventListener('change', () => {
      if (+e.value < +s.value) s.value = e.value;
    });
  }

  async function runAll() {
    const y1 = +document.getElementById('startYear').value;
    const y2 = +document.getElementById('endYear').value;
    const users = +document.getElementById('userCount').value;
    const orders = +document.getElementById('orderCount').value;
    const chunkSize = +document.getElementById('chunkSize').value;

    // ì…ë ¥ ê²€ì¦
    if (users < 50 || users > 100000) {
      alert('ê³ ê° ìˆ˜ëŠ” 50~100,000 ì‚¬ì´');
      return;
    }
    if (orders < 100 || orders > 10000000) {
      alert('ì£¼ë¬¸ ìˆ˜ëŠ” 100~10,000,000 ì‚¬ì´');
      return;
    }
    if (orders < users) {
      alert('ì£¼ë¬¸ ìˆ˜ëŠ” ê³ ê° ìˆ˜ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
      return;
    }
    if (chunkSize < 100 || chunkSize > 10000) {
      alert('ì²­í¬ í¬ê¸°ëŠ” 100~10,000 ì‚¬ì´');
      return;
    }

    // ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ê²½ê³ 
    if (orders > 100000) {
      const confirm = window.confirm(`${orders.toLocaleString()}ê°œì˜ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\nì²˜ë¦¬ ì‹œê°„ì´ ìˆ˜ ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
      if (!confirm) return;
    }

    await generateDataInChunks(orders, users, y1, y2, chunkSize);
  }

  function stopProcessing() {
    PROCESSING_STATE.shouldStop = true;
    updateUIState('stopped');
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document.getElementById('btnGen').addEventListener('click', runAll);
  document.getElementById('btnStop').addEventListener('click', stopProcessing);
  document.getElementById('btnCsv').addEventListener('click', downloadCSV);

  // ì²­í¬ í¬ê¸° ë™ì  ì¡°ì • (ì£¼ë¬¸ ìˆ˜ì— ë”°ë¼)
  document.getElementById('orderCount').addEventListener('change', function () {
    const orders = +this.value;
    const chunkSizeInput = document.getElementById('chunkSize');

    if (orders <= 10000) chunkSizeInput.value = 1000;
    else if (orders <= 100000) chunkSizeInput.value = 2000;
    else if (orders <= 1000000) chunkSizeInput.value = 5000;
    else chunkSizeInput.value = 10000;
  });

  // ì´ˆê¸°í™”
  initYearSelects();
  updateUIState('ready');

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë°ì´í„° ìƒì„± (ì‘ì€ ìƒ˜í”Œ)
  setTimeout(async () => {
    await generateDataInChunks(1000, 100, new Date().getFullYear(), new Date().getFullYear(), 500);
  }, 100);
</script>
</body>
</html>
