<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>🚀 쿠팡 물류 시뮬레이션 시스템 - v2025-11+ops+clv (Single File, FIXED)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #f7fafc; --card: #fff; --ink: #111827; --muted: #6b7280; --line: #e5e7eb;
      --pri: #2563eb; --good: #10b981; --warn: #f59e0b; --bad: #ef4444; --vio: #8b5cf6; --cyan: #06b6d4;
      --rocket: #ff6b35; --wow: #9333ea; --fresh: #059669
    }
    * { box-sizing: border-box }
    body { margin: 0; background: var(--bg); color: var(--ink); font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial }
    .wrap { max-width: 1800px; margin: 0 auto; padding: 20px }
    .header { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #9333ea 100%); color:#fff; border-radius:16px; padding:28px 32px; margin-bottom:20px; box-shadow:0 12px 32px rgba(255,107,53,.25); position:relative; overflow:hidden }
    .header::before { content:""; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:repeating-linear-gradient(45deg,transparent,transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px); animation:slide 20s linear infinite }
    @keyframes slide { 0% { transform: translateX(-50px)} 100% { transform: translateX(50px)} }
    .header h1 { margin:0 0 8px 0; font-size:24px; position:relative; z-index:1 }
    .header .sub { opacity:.9; font-size:14px; position:relative; z-index:1 }
    .header .reality-badge { position:absolute; top:20px; right:30px; background:rgba(255,255,255,.2); backdrop-filter:blur(10px); border-radius:12px; padding:8px 16px; font-size:12px; font-weight:700; border:1px solid rgba(255,255,255,.3) }
    .panel { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; margin:16px 0; box-shadow:0 6px 20px rgba(2,6,23,.08) }
    .controls { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end }
    .ctrl { display:flex; flex-direction:column; gap:6px }
    .ctrl label { font-size:12px; color:var(--muted); font-weight:600 }
    .ctrl input, .ctrl select { padding:8px 12px; border:1px solid var(--line); border-radius:10px; min-width:130px }
    .btn { background:var(--pri); color:#fff; border:none; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer; transition:all .3s }
    .btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(37,99,235,.3) }
    .btn:disabled { background:#9ca3af; cursor:not-allowed; transform:none }
    .btn.secondary { background:#374151 }
    .btn.danger { background:var(--bad) }
    .btn.rocket { background:var(--rocket) }
    .btn.wow { background:var(--wow) }
    .progress-container { margin:12px 0; display:none }
    .progress-bar { width:100%; height:10px; background:var(--line); border-radius:6px; overflow:hidden }
    .progress-fill { height:100%; background:linear-gradient(45deg, var(--rocket), var(--wow)); width:0%; transition:width .2s ease }
    .progress-text { font-size:13px; color:var(--muted); margin-top:6px; text-align:center; font-weight:600 }
    .progress-stats { display:flex; justify-content:space-between; font-size:11px; color:var(--muted); margin-top:6px }
    .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px }
    .kpi { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; position:relative; transition:transform .3s }
    .kpi:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(2,6,23,.12) }
    .kpi h4 { margin:0 0 10px 0; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; display:flex; align-items:center; gap:6px }
    .kpi .v { font-size:28px; font-weight:800; margin-bottom:4px }
    .kpi .meta { font-size:11px; color:var(--muted) }
    .kpi.primary { border-top:4px solid var(--pri) }
    .kpi.good { border-top:4px solid var(--good) }
    .kpi.warn { border-top:4px solid var(--warn) }
    .kpi.bad { border-top:4px solid var(--bad) }
    .kpi.rocket { border-top:4px solid var(--rocket) }
    .kpi.wow { border-top:4px solid var(--wow) }
    .kpi.fresh { border-top:4px solid var(--fresh) }
    .kpi.cyan { border-top:4px solid var(--cyan) }
    .pill { display:inline-block; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:600 }
    .pill.ok { background:#dcfce7; color:#065f46 }
    .pill.ng { background:#fee2e2; color:#991b1b }
    .pill.running { background:#dbeafe; color:#1e40af }
    .sections { display:grid; grid-template-columns:repeat(auto-fit, minmax(380px, 1fr)); gap:18px; margin-top:12px }
    .section { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px }
    .section h3 { margin:0 0 12px 0; font-size:17px; display:flex; align-items:center; gap:8px }
    .alerts { display:flex; flex-direction:column; gap:10px; max-height:280px; overflow:auto }
    .alert { padding:12px 15px; border-radius:12px; font-size:13px; border:1px solid; transition:all .3s }
    .alert:hover { transform:translateX(4px) }
    .alert.good { background:#ecfdf5; border-color:#a7f3d0; color:#065f46 }
    .alert.warn { background:#fffbeb; border-color:#fde68a; color:#92400e }
    .alert.bad { background:#fef2f2; border-color:#fecaca; color:#991b1b }
    .table-wrap { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:0; margin-top:18px; overflow:hidden }
    table { width:100%; border-collapse:collapse; font-size:12px }
    thead { position:sticky; top:0; background:#f9fafb; border-bottom:2px solid var(--line) }
    th, td { padding:8px 10px; border-bottom:1px solid var(--line); text-align:center; white-space:nowrap }
    th { font-weight:700; color:var(--ink) }
    .delivery-mode.rocket { color:var(--rocket); font-weight:600 }
    .delivery-mode.dawn { color:var(--wow); font-weight:600 }
    .delivery-mode.fresh { color:var(--fresh); font-weight:600 }
    @media (max-width: 768px) {
      .controls { flex-direction:column; align-items:flex-start }
      .ctrl input, .ctrl select { min-width:280px }
      .sections { grid-template-columns:1fr }
      .kpi-grid { grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)) }
    }
    .switch { position:relative; display:inline-block; width:44px; height:24px }
    .switch input { display:none }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#cbd5e1; border-radius:999px; transition:.2s }
    .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.2) }
    .switch input:checked + .slider { background:#22c55e }
    .switch input:checked + .slider:before { transform:translateX(20px) }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="reality-badge">현실성 95%</div>
    <h1>🚀 쿠팡 물류 시뮬레이션 시스템 (Coupang Logistics Reality Simulator)</h1>
    <div class="sub">🎯 로켓배송·신선식품·WOW·AI자동화 | FC·허브 분리 | 입고/적치/유통기한/로케이션 포함 — v2025-11+ops+clv (FIXED)</div>
  </div>

  <div class="panel">
    <div class="controls">
      <div class="ctrl"><label>시작년도 / Start Year</label><select id="startYear"></select></div>
      <div class="ctrl"><label>종료년도 / End Year</label><select id="endYear"></select></div>
      <div class="ctrl"><label>고객 수 / #Users</label><input id="userCount" type="number" min="100" max="200000" value="300"></div>
      <div class="ctrl"><label>주문 수 / #Orders</label><input id="orderCount" type="number" min="500" max="10000000" step="1000" value="10000"></div>
      <div class="ctrl"><label>청크 크기 / Chunk Size</label><input id="chunkSize" type="number" min="500" max="15000" step="500" value="3000"></div>
      <div class="ctrl"><label>로켓배송 비중 / Rocket Rate (%)</label><input id="rocketRate" type="number" min="35" max="90" value="55"></div>
      <div class="ctrl"><label>WOW 가입률 / WOW Rate (%)</label><input id="wowRate" type="number" min="60" max="100" value="80"></div>
      <div class="ctrl"><label>목표 순이익률(%)</label><input id="targetNetMargin" type="number" step="0.1" value="3.2" min="-20" max="30"></div>
      <div class="ctrl">
        <label>FAST MODE</label>
        <label class="switch"><input type="checkbox" id="fastMode"><span class="slider"></span></label>
      </div>
      <button class="btn rocket" id="btnStart">▶️ 데이터 생성 / Generate</button>
      <button class="btn secondary" id="btnTune">⚙️ DIALS</button>
      <button class="btn danger" id="btnStop" disabled>⏹️ 중단 / Stop</button>
      <button class="btn wow" id="btnCsv" disabled>📥 CSV 다운로드 / Download CSV</button>
      <button class="btn wow" id="btnCsvTurbo" disabled>⚡️ 초고속 CSV (GZIP)</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">처리 중... / Processing...</div>
      <div class="progress-stats"><span id="progressStats">-</span><span id="progressETA">예상 완료: - / ETA: -</span></div>
    </div>
  </div>

  <!-- DIALS -->
  <div class="panel" id="tunePanel" style="display:block">
    <div class="controls" style="align-items:flex-start">
      <div class="ctrl"><label>적자주문율 최소</label><input id="dial_loss_lo" type="number" step="0.001" min="0" max="1" value="0.07"></div>
      <div class="ctrl"><label>적자주문율 최대</label><input id="dial_loss_hi" type="number" step="0.001" min="0" max="1" value="0.12"></div>
      <div class="ctrl"><label>온도위반율 최소</label><input id="dial_temp_lo" type="number" step="0.001" min="0" max="1" value="0.01"></div>
      <div class="ctrl"><label>온도위반율 최대</label><input id="dial_temp_hi" type="number" step="0.001" min="0" max="1" value="0.02"></div>
      <div class="ctrl"><label>제주 악천후 최소</label><input id="dial_jeju_lo" type="number" step="0.001" min="0" max="1" value="0.10"></div>
      <div class="ctrl"><label>제주 악천후 최대</label><input id="dial_jeju_hi" type="number" step="0.001" min="0" max="1" value="0.15"></div>
      <div class="ctrl"><label>과재고 최소</label><input id="dial_over_lo" type="number" step="0.001" min="0" max="1" value="0.15"></div>
      <div class="ctrl"><label>과재고 최대</label><input id="dial_over_hi" type="number" step="0.001" min="0" max="1" value="0.25"></div>
      <div class="ctrl"><label>유통기한 임박 최소</label><input id="dial_exp_lo" type="number" step="0.001" min="0" max="1" value="0.005"></div>
      <div class="ctrl"><label>유통기한 임박 최대</label><input id="dial_exp_hi" type="number" step="0.001" min="0" max="1" value="0.01"></div>
    </div>
    <div class="controls">
      <button class="btn wow" id="btnApplyDials">적용</button>
      <button class="btn secondary" id="btnResetDials">초기화</button>
      <div id="tuneStatus" class="pill ok">DIALS READY</div>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">정책 메모: 배송비는 거리구간×모드×WOW에 따라 산출됩니다(예: WOW 대부분 무료, 비회원 1,500~4,500원). 날씨 가중치는 세그먼트키 제외/비용 포함(default).</div>
  </div>

  <!-- KPI 섹션 (동일) -->
  <div class="sections">
    <div class="section"><h3>🚀 로켓배송 성과</h3>
      <div class="kpi-grid">
        <div class="kpi rocket"><h4>로켓배송 비중</h4><div class="v" id="k_rocketShare">-</div><div class="meta">% of orders</div></div>
        <div class="kpi rocket"><h4>로켓당일 성공률</h4><div class="v" id="k_rocketSameDayRate">-</div><div class="meta">%</div></div>
        <div class="kpi rocket"><h4>로켓새벽 정시율</h4><div class="v" id="k_rocketDawnRate">-</div><div class="meta">%</div></div>
        <div class="kpi rocket"><h4>30분내 출고율</h4><div class="v" id="k_fastShipRate">-</div><div class="meta">%</div></div>
        <div class="kpi primary"><h4>허브 on-time (p95)</h4><div class="v" id="k_hubOnTimeP95">-</div><div class="meta">%</div></div>
        <div class="kpi primary"><h4>캠프 on-time (p95)</h4><div class="v" id="k_campOnTimeP95">-</div><div class="meta">%</div></div>
        <div class="kpi warn"><h4>camp_dispatch_breach 누적</h4><div class="v" id="k_campDispatchBreach">-</div><div class="meta">건</div></div>
      </div>
    </div>
    <div class="section"><h3>📦 출고·풀필먼트</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>정시 출고율</h4><div class="v" id="k_fcOnTimeShip">-</div><div class="meta">목표 ≥ 96%</div></div>
        <div class="kpi"><h4>평균 출고 시간</h4><div class="v" id="k_fcAvgShipHour">-</div><div class="meta">시간</div></div>
        <div class="kpi"><h4>피킹 속도</h4><div class="v" id="k_fcPickSecPerItem">-</div><div class="meta">초/개</div></div>
        <div class="kpi"><h4>패킹 속도</h4><div class="v" id="k_fcPackSecPerItem">-</div><div class="meta">초/개</div></div>
        <div class="kpi good"><h4>풀필먼트 효율</h4><div class="v" id="k_fcEfficiency">-</div><div class="meta">%</div></div>
        <div class="kpi wow"><h4>60분내 출고율</h4><div class="v" id="k_fcShipUnder60">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>FC 총 체류 평균</h4><div class="v" id="k_fcTotalDwellMinAvg">-</div><div class="meta">분</div></div>
      </div>
    </div>
    <div class="section"><h3>🌟 WOW 멤버십 & 프리미엄</h3>
      <div class="kpi-grid">
        <div class="kpi wow"><h4>WOW 가입률</h4><div class="v" id="k_wowShare">-</div><div class="meta">%</div></div>
        <div class="kpi wow"><h4>WOW Plus 비중</h4><div class="v" id="k_wowPlusShare">0</div><div class="meta">% (WOW 내부)</div></div>
        <div class="kpi wow"><h4>WOW vs 비회원 AOV 차이</h4><div class="v" id="k_wowAovGap">-</div><div class="meta">₩</div></div>
        <div class="kpi warn"><h4>WOW 이탈 위험 고객</h4><div class="v" id="k_wowChurnRisk">-</div><div class="meta">명</div></div>
        <div class="kpi"><h4>Q4-Top 고객 비중</h4><div class="v" id="k_clvTopQ4Share">-</div><div class="meta">% (고객 기준)</div></div>
        <div class="kpi"><h4>WOW vs 비회원 CLV 격차</h4><div class="v" id="k_clvWowGap">-</div><div class="meta">₩</div></div>
        <div class="kpi warn"><h4>최근60일 고위반 고객 비중</h4><div class="v" id="k_highBreach60Share">-</div><div class="meta">% (고객 기준)</div></div>
      </div>
    </div>
    <div class="section"><h3>❄️ 신선식품 & 콜드체인</h3>
      <div class="kpi-grid">
        <div class="kpi fresh"><h4>신선식품 비중</h4><div class="v" id="k_freshShare">-</div><div class="meta">%</div></div>
        <div class="kpi fresh"><h4>콜드체인 준수율</h4><div class="v" id="k_coldChainRate">-</div><div class="meta">%</div></div>
        <div class="kpi warn"><h4>온도 위반율</h4><div class="v" id="k_tempViolation">-</div><div class="meta">%</div></div>
        <div class="kpi fresh"><h4>냉동식품 품질 점수</h4><div class="v" id="k_frozenQuality">-</div><div class="meta">/100</div></div>
      </div>
    </div>
    <div class="section"><h3>🏭 허브&스포크 물류망</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>메가허브 처리 비중</h4><div class="v" id="k_megaHubShare">-</div><div class="meta">%</div></div>
        <div class="kpi primary"><h4>수도권 커버리지</h4><div class="v" id="k_seoulCoverage">-</div><div class="meta">%</div></div>
        <div class="kpi good"><h4>평균 배송 거리</h4><div class="v" id="k_avgDistance">-</div><div class="meta">km</div></div>
        <div class="kpi primary"><h4>네트워크 효율성</h4><div class="v" id="k_networkEff">-</div><div class="meta">점</div></div>
      </div>
    </div>
    <div class="section"><h3>🤖 AI & 자동화 수준</h3>
      <div class="kpi-grid">
        <div class="kpi cyan"><h4>AI 최적화 비율</h4><div class="v" id="k_aiOptimized">-</div><div class="meta">%</div></div>
        <div class="kpi cyan"><h4>자동 피킹율</h4><div class="v" id="k_autoPickRate">-</div><div class="meta">%</div></div>
        <div class="kpi good"><h4>평균 피킹 시간</h4><div class="v" id="k_avgPickTime">-</div><div class="meta">초</div></div>
        <div class="kpi cyan"><h4>WMS 고도화 점수</h4><div class="v" id="k_wmsAdvanced">-</div><div class="meta">/100</div></div>
      </div>
    </div>
    <div class="section"><h3>💰 매출·수익</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>총 매출</h4><div class="v" id="k_totalSales">-</div><div class="meta">₩</div></div>
        <div class="kpi good"><h4>순이익률</h4><div class="v" id="k_netMargin">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>평균주문금액</h4><div class="v" id="k_aov">-</div><div class="meta">₩</div></div>
        <div class="kpi"><h4>ARPPU</h4><div class="v" id="k_arppu">-</div><div class="meta">₩</div></div>
      </div>
    </div>
    <div class="section"><h3>👥 고객</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC</h4><div class="v" id="k_ltvCac">-</div></div>
        <div class="kpi"><h4>유지율</h4><div class="v" id="k_retention">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>이탈률</h4><div class="v" id="k_churn">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>AI 이탈 예측 정확도</h4><div class="v" id="k_ai">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>🚚 배송·물류</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>정시율</h4><div class="v" id="k_onTime">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>SLA 위반율</h4><div class="v" id="k_sla">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>적재율</h4><div class="v" id="k_load">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>연비</h4><div class="v" id="k_fuel">-</div><div class="meta">km/ℓ · km/kWh</div></div>
        <div class="kpi"><h4>라우팅 점수</h4><div class="v" id="k_route">-</div><div class="meta">/100</div></div>
        <div class="kpi warn"><h4>배송 예외율</h4><div class="v" id="k_exception">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>📦 반품</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>반품률</h4><div class="v" id="k_returnRate">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>반품 손실률</h4><div class="v" id="k_returnCost">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>재판매 가능률</h4><div class="v" id="k_resell">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>🏭 WMS·재고</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>재고 회전율</h4><div class="v" id="k_invTurn">-</div><div class="meta">회</div></div>
        <div class="kpi"><h4>품절률</h4><div class="v" id="k_stockout">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>과재고 비율</h4><div class="v" id="k_overstock">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>재고 정확도</h4><div class="v" id="k_invAcc">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>재고 손실률</h4><div class="v" id="k_shrink">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>WMS 활용률</h4><div class="v" id="k_wms">-</div><div class="meta">%</div></div>
      </div>
    </div>
  </div>

  <div class="sections">
    <div class="section"><h3>✅ 쿠팡 특화 정합성 검사</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section"><h3>⚠️ 쿠팡 복합 위험 요소</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section"><h3>📊 처리 성능 & 현실성 지표</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl"><thead></thead><tbody></tbody></table>
  </div>
</div>

<script>
  /* ============================================================
     Coupang Logistics Reality Simulator — Fixed Single File
     v2025-11+ops+clv —
     ▶ FIX: 워커 코드 문법/전송 누락으로 데이터 미생성 문제 해결
     ▶ FIX: CSV/테이블 헤더의 공백을 언더바로 출력
     ============================================================ */

  // ==========================
  // 0) 세션 정책 토글
  // ==========================
  const POLICY = { useWeatherInSegmentation: false, useWeatherInCost: true };

  // ==========================
  // 1) 네트워크 키
  // ==========================
  const NET_PREFIX = '__net_';
  const N = s => NET_PREFIX + s;
  const NET = Object.freeze({
    ROUTE_TYPE: N('Route_Type'),
    SORT_HUB_NAME: N('Sortation_Hub_Name'),
    FC_EXIT: N('FC_Exit_TS'),
    HUB_IN: N('Hub_In_TS'),
    HUB_OUT: N('Hub_Out_TS'),
    CAMP_IN: N('Camp_In_TS'),
    LOAD_START: N('Loadout_Start_TS'),
    LOAD_END: N('Loadout_End_TS'),
    OFD: N('OFD_TS'),
    FC_DWELL: N('FC_Dwell_Min'),
    HUB_DWELL: N('Hub_Dwell_Min'),
    CAMP_DWELL: N('Camp_Dwell_Min'),
  });

  // ==========================
  // 2) CSV 라벨/유틸
  // ==========================
  const CSV_SPECIAL_LABELS = {
    Order_ID:'Order ID', Order_Date:'Order Date', Order_Timestamp:'Order Timestamp', Order_Hour:'Order Hour',
    Delivery_Mode:'Delivery Mode', Planned_Delivery_Date:'Planned Delivery Date', Actual_Delivery_Date:'Actual Delivery Date',
    Delivery_Timestamp:'Delivery Timestamp', Planned_Delivery_Timestamp:'Planned Delivery Timestamp', Is_Delayed:'Is Delayed',
    Delay_Hours:'Delay Hours', SLA_Breach:'SLA Breach', Delivery_Status:'Delivery Status', Fast_Ship_30min:'Fast Ship 30min',
    Order_To_Ship_Minutes:'Order To Ship Minutes', Region:'Region', City:'City', District:'District', Address:'Address', Exact_Address:'Exact Address',
    Fulfillment_Center:'Fulfillment Center', Delivery_Center:'Delivery Center', Is_Mega_Hub:'Is Mega Hub', Base_Distance_km:'Base_Distance_km', Distance_km:'Distance km',
    Customer_ID:'Customer ID', Is_WOW_Member:'Is WOW Member', WOW_Tier:'WOW Tier', WOW_Join_Date:'WOW Join Date', WOW_Tenure_Days:'WOW Tenure Days',
    Customer_Segment:'Customer Segment', Product_Category:'Product Category', SKU:'SKU', ABC_Category:'ABC Category', Unit_Price:'Unit Price', Quantity:'Quantity',
    Order_Amount:'Order Amount', Is_Fresh_Food:'Is Fresh Food', Is_Cold_Chain_Required:'Is Cold Chain Required', Target_Temperature:'Target Temperature', Actual_Temperature:'Actual Temperature',
    Temperature_Violation:'Temperature Violation', Cold_Chain_Quality_Score:'Cold Chain Quality Score', Vehicle_ID:'Vehicle ID', Vehicle_Type:'Vehicle Type', Vehicle_Capacity:'Vehicle Capacity',
    Driver_ID:'Driver ID', Driver_Grade:'Driver Grade', Load_Factor:'Load Factor', Fuel_Efficiency:'Fuel Efficiency', Routing_Score:'Routing Score', GPS_Tracking:'GPS Tracking',
    Actual_Logistics_Cost:'Actual Logistics Cost', Customer_Delivery_Charge:'Customer Delivery Charge', Gross_Profit:'Gross Profit', Net_Profit:'Net Profit', CAC:'CAC', Customer_LTV:'Customer LTV',
    LTV_to_CAC:'LTV to CAC', clv_quartile:'CLV Quartile', clv_quartile_label:'CLV Quartile Label', cust_breach_30d_cnt:'Cust Breach 30d Cnt', cust_breach_60d_cnt:'Cust Breach 60d Cnt',
    is_high_breach_60d:'High Breach 60d Flag', Return_Flag:'Is Returned', Return_Reason:'Return Reason', Return_Cost:'Return Cost', Is_Resellable:'Is Resellable', Resellability_Reason:'Resellability Reason',
    Current_Stock:'Current Stock', Reorder_Point:'Reorder Point', Stockout_Flag:'Stockout Flag', Overstock_Flag:'Overstock Flag', Inventory_Turnover:'Inventory Turnover', Inventory_Accuracy:'Inventory Accuracy',
    Automation_Level:'Automation Level', Picking_Time_Seconds:'Picking Time Seconds', Packing_Time_Seconds:'Packing Time Seconds', Total_Process_Time:'Total Process Time', WMS_Usage:'WMS Usage', OMS_Usage:'OMS Usage',
    WMS_Advanced_Score:'WMS Advanced Score', Service_Quality_Score:'Service Quality Score', Customer_NPS:'Customer NPS', Processing_Error_Rate:'Processing Error Rate', Weather_Condition:'Weather Condition', Weather_Severity_Score:'Weather Severity Score',
    Churn_Flag:'Churn Flag', Predicted_Churn_Score:'Predicted Churn Score', Is_Rocket_Delivery:'Is Rocket Delivery', Is_Same_Day_Delivery:'Is Same Day Delivery', Is_Dawn_Delivery:'Is Dawn Delivery', Is_Fresh_Delivery:'Is Fresh Delivery',
    Is_Premium_Order:'Is Premium Order', Is_Bulk_Order:'Is Bulk Order', Is_Weekend_Order:'Is Weekend Order', Is_Peak_Hour_Order:'Is Peak Hour Order', Is_Free_Shipping:'Is Free Shipping', Is_Weather_Risk:'Is Weather Risk',
    Is_Long_Distance:'Is Long Distance', Is_High_LTV:'Is High LTV', Is_Churn_Risk:'Is Churn Risk', Is_VIP_Customer:'Is VIP Customer', Is_Loss_Order:'Is Loss Order', Is_AI_Optimized:'Is AI Optimized',
    Receiving_Date:'Receiving Date', Putaway_Date:'Putaway Date', Lot_ID:'Lot ID', Expiry_Date:'Expiry Date', Bin:'Bin', Slot:'Slot', Unit_Cost:'Unit Cost', Daily_OnHand_Snapshot:'Daily OnHand Snapshot', Safety_Stock:'Safety Stock', Forecast_Demand:'Forecast Demand',
    ASN_ID:'Asn Id', PO_ID:'Po Id', Replenishment_Type:'Replenishment Type', Picking_Start_TS:'Picking Start TS', Picking_End_TS:'Picking End TS', Packing_Start_TS:'Packing Start TS', Packing_End_TS:'Packing End TS',
    QC_Start_TS:'QC Start TS', QC_End_TS:'QC End TS', Label_Start_TS:'Label Start TS', Label_End_TS:'Label End TS', Staging_In_TS:'Staging In TS', Staging_Out_TS:'Staging Out TS',
    Dock_Assign_TS:'Dock Assign TS', Dock_Arrive_TS:'Dock Arrive TS', Dock_Release_TS:'Dock Release TS', Security_Gate_Out_TS:'Security Gate Out TS',
    qc_min:'QC Minutes', label_min:'Label Minutes', staging_min:'Staging Minutes', dock_wait_min:'Dock Wait Minutes', fc_total_dwell_min:'FC Total Dwell Minutes', residual_fc_internal_min:'Residual FC Internal Minutes',
    Planned_Ship_Timestamp:'Planned Ship Timestamp', Actual_Ship_Timestamp:'Actual Ship Timestamp', On_Time_Dispatch_Flag:'On-time Dispatch Flag',
    [NET.ROUTE_TYPE]:'Route Type', [NET.SORT_HUB_NAME]:'Sortation Hub Name', [NET.FC_EXIT]:'FC Exit TS', [NET.HUB_IN]:'Hub In TS', [NET.HUB_OUT]:'Hub Out TS', [NET.CAMP_IN]:'Camp In TS', [NET.LOAD_START]:'Loadout Start TS', [NET.LOAD_END]:'Loadout End TS', [NET.OFD]:'OFD TS',
    [NET.FC_DWELL]:'FC Dwell Min', [NET.HUB_DWELL]:'Hub Dwell Min', [NET.CAMP_DWELL]:'Camp Dwell Min',

    // derived / quality
    fc_dispatch_ts:'FC Dispatch TS', camp_depart_ts:'Camp Depart TS', o2s_min:'O2S Minutes', hub_total_dwell_min:'Hub Total Dwell (min)', camp_total_dwell_min:'Camp Total Dwell (min)',
    camp_s1_wait_min:'Camp S1 Wait (min)', camp_s2_work_min:'Camp S2 Work (min)', camp_s3_wait_min:'Camp S3 Wait (min)', camp_wait_min:'Camp Wait (S1+S3) (min)', camp_work_min:'Camp Work (S2) (min)',
    post_fc_transit_min:'Post FC Transit (min)', hub_exit_wait_min:'Hub Exit Wait (min)', fc_otd_flag:'FC OTD Flag', ofd_otd_flag:'OFD OTD Flag', sla_breach_flag:'SLA Breach (Recalc)',
    reason_category:'Reason Category', q_ts_order_error:'Q TS Order Error', q_negative_duration:'Q Negative Duration', q_outlier_flag:'Q Outlier', month:'month', week:'week',
    hub_dispatch_breach_flag:'Hub P95 Breach', camp_s1_breach_flag:'Camp S1 Breach', camp_s2_breach_flag:'Camp S2 Breach', camp_s3_breach_flag:'Camp S3 Breach',
    hub_on_time_flag:'Hub On-time (p95)', camp_on_time_flag:'Camp On-time (p95)', camp_dispatch_breach_flag:'Camp Dispatch Breach (OR)', first_touch_breach:'First Touch Breach', q_missing_key:'Q Missing Key',

    sim_version:'Sim Version', sim_seed:'Sim Seed', dial_snapshot_json:'Dials Snapshot', generated_at:'Generated At'
  };

  // 공백 → 언더바 라벨 변환 (CSV/테이블 헤더 공통)
  const labelUnderscore = (key) => String(CSV_SPECIAL_LABELS[key] || key).replace(/\s+/g, '_');

  function prettyHeader(key){ return labelUnderscore(key); }

  // ==========================
  // 3) 전역 상태/유틸
  // ==========================
  let DATA = []; let TABLE_KEYS = null; let WORKER = null; let FAST_MODE = false;
  const CHUNK_CONFIG = { defaultSize: 3000, maxMemoryRows: 150000, batchUpdateInterval: 3, gcInterval: 8 };
  const RENDER_MAX_ROWS = 2000;

  let PROCESSING_STATE = { isRunning:false, shouldStop:false, startTime:null, processedRows:0, totalRows:0 };

  let _throttleTS = 0; const _THROTTLE_MS = 100; const raf = (fn)=> window.requestAnimationFrame? requestAnimationFrame(fn) : setTimeout(fn,16);
  const qs = id=> document.getElementById(id);
  const setText = (id, txt)=>{ const el=qs(id); if(el) el.textContent = txt };
  const setDisabled = (id, flag)=>{ const el=qs(id); if(el) el.disabled = !!flag };
  const setDisplay = (id, show)=>{ const el=qs(id); if(el) el.style.display = show? '':'none' };
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  function formatCurrencyKRW(n){ if(!isFinite(n)) return '-'; return '₩' + Math.round(n).toLocaleString('ko-KR'); }
  function setStatus(text, cls='ok'){ const st=qs('status'); st.textContent=text; st.className='pill '+cls; }
  function showProgress(show){ setDisplay('progressContainer', show); }
  function _updateProgressUI(label, processed, total){
    const pct = Math.min(100, Math.round(processed/Math.max(1,total)*100));
    qs('progressFill').style.width = pct+'%';
    qs('progressText').textContent = `${label}... ${processed.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime||Date.now()))/1000;
    const rps = processed/Math.max(0.1, elapsed);
    qs('progressStats').textContent = `속도 ${rps.toFixed(1)} r/s`;
    const remain = (total-processed)/Math.max(0.1, rps);
    qs('progressETA').textContent = `예상 완료: ${remain.toFixed(0)}s`;
  }
  function updateProgressFromState(label='Generating'){
    const now=Date.now(); if(now - _throttleTS < _THROTTLE_MS) return; _throttleTS=now; raf(()=>_updateProgressUI(label, PROCESSING_STATE.processedRows, PROCESSING_STATE.totalRows));
  }
  function updateExportProgress(done, total){
    const pct = Math.min(100, Math.round(done/Math.max(1,total)*100));
    qs('progressFill').style.width=pct+'%';
    qs('progressText').textContent = `Exporting CSV... ${done.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pct}%)`;
    qs('progressStats').textContent = '청크 진행'; qs('progressETA').textContent='';
  }

  // ==========================
  // 4) 스트리밍 집계 (O(1))
  // ==========================
  const AGG = resetAgg();
  function resetAgg(){ return {
    total:0, rocket:0, sameDayTotal:0, sameDayOnTime:0, dawnTotal:0, dawnOnTime:0, fastShip30:0, shipUnder60:0, fcSlaBreach:0,
    shipMinutesSum:0, pickPerItemSum:0, packPerItemSum:0, procErrRateSum:0,
    wowCount:0, wowSales:0, nonWowSales:0, wowOrders:0, nonWowOrders:0, wowChurnRisk:0, wowPlusCount:0,
    freshCount:0, coldReq:0, tempViol:0, frozenQualitySum:0, frozenCnt:0,
    megaHub:0, metro:0, distanceSum:0, routingSum:0,
    aiOpt:0, autoPickScoreSum:0, pickTimeSum:0, wmsAdvSum:0,
    salesSum:0, netProfitSum:0,
    ltvSum:0, cacSum:0, uniqueCustomers:new Set(), churnRisk:0, aiAccEqual:0,
    onTime:0, delay:0, loadSum:0, fuelSum:0, routeSum:0, exception:0,
    returnCnt:0, returnCostSum:0, resellCnt:0,
    invTurnSum:0, stockoutCnt:0, overstockCnt:0, invAccSum:0, wmsActiveCnt:0,
    lossOrderCnt:0, jejuWeatherRiskCnt:0, jejuTotal:0, expiryImminentCnt:0,
    clvQ4Customers:new Set(), clvWowSum:0, clvWowN:0, clvNonWowSum:0, clvNonWowN:0,
    highBreach60Customers:new Set(), hubOnTimeCnt:0, hubEligible:0, campOnTimeCnt:0, campEligible:0, campDispatchBreachCnt:0,
    fcTotalDwellSum:0,
    cm_tp:0, cm_tn:0, cm_fp:0, cm_fn:0,
  }; }

  // ==========================
  // 5) 가드레일 저장소 (윈저 P99→P95)
  // ==========================
  const Guardrails = { store:new Map(), alpha:0.02, maxKeep:10000 };
  function macroRegionBySiDo(region){ if(['서울특별시','경기도','인천광역시'].includes(region)) return '수도권'; if(['부산광역시','대구광역시','울산광역시','경상북도','경상남도'].includes(region)) return '영남'; if(['대전광역시','세종특별자치시','충청북도','충청남도'].includes(region)) return '충청'; if(['광주광역시','전북특별자치도','전라남도'].includes(region)) return '호남'; if(['강원특별자치도'].includes(region)) return '강원'; if(['제주특별자치도'].includes(region)) return '제주'; return '기타'; }
  function daypart(h){ return (h>=19 && h<=21)? '피크':'비피크'; }
  function weatherBucket(s){ if(s<=0.3) return '≤0.3'; if(s<=0.6) return '0.3–0.6'; return '>0.6'; }
  function segmentKey(r){ const mode = r.Delivery_Mode||'NA'; const route = r[NET.ROUTE_TYPE]||'NA'; const macro = macroRegionBySiDo(r.Region||'NA'); const dp = daypart(Number(r.Order_Hour||0)); const wb = weatherBucket(Number(r.Weather_Severity_Score||0)); return POLICY.useWeatherInSegmentation? `${mode}|${route}|${macro}|${dp}|${wb}` : `${mode}|${route}|${macro}|${dp}`; }
  function winsorizeP99(values){ if(values.length===0) return []; const sorted=[...values].sort((a,b)=>a-b); const i99=Math.max(0, Math.min(sorted.length-1, Math.floor(sorted.length*0.99))); const p99=sorted[i99]; return sorted.map(v=> Math.min(v,p99)); }
  function quantileP(values,p){ if(values.length===0) return null; const a=[...values].sort((x,y)=>x-y); const pos=(a.length-1)*p; const lo=Math.floor(pos), hi=Math.ceil(pos); if(lo===hi) return a[lo]; return a[lo] + (a[hi]-a[lo])*(pos-lo); }
  function computeP95From(values){ if(values.length<20) return null; const w=winsorizeP99(values); return Math.round(quantileP(w,0.95)); }
  function ensureSeg(key){ if(!Guardrails.store.has(key)){ Guardrails.store.set(key,{ arrs:{hub:[],s1:[],s2:[],s3:[]}, p95:{hub:null,s1:null,s2:null,s3:null}, n:0 }); } return Guardrails.store.get(key); }
  function pushReservoir(arr,v,cap){ if(v==null || !isFinite(v)) return; if(arr.length<cap){ arr.push(v); return;} const j=Math.floor(Math.random()*(arr.length+1)); if(j<arr.length) arr[j]=v; }
  function updateGuardrailsWithRow(row){ if(Number(row.SLA_Breach)===1) return; const hub=safePos(row.hub_total_dwell_min); const s1=safePos(row.camp_s1_wait_min); const s2=safePos(row.camp_s2_work_min); const s3=safePos(row.camp_s3_wait_min); if(hub==null && s1==null && s2==null && s3==null) return; const key=segmentKey(row); const seg=ensureSeg(key); if(hub!=null) pushReservoir(seg.arrs.hub, hub, Guardrails.maxKeep); if(s1!=null) pushReservoir(seg.arrs.s1, s1, Guardrails.maxKeep); if(s2!=null) pushReservoir(seg.arrs.s2, s2, Guardrails.maxKeep); if(s3!=null) pushReservoir(seg.arrs.s3, s3, Guardrails.maxKeep); seg.n++; if(seg.arrs.hub.length>=500 || seg.arrs.s1.length>=500 || seg.arrs.s2.length>=500 || seg.arrs.s3.length>=500){ const p95_new={ hub:computeP95From(seg.arrs.hub), s1:computeP95From(seg.arrs.s1), s2:computeP95From(seg.arrs.s2), s3:computeP95From(seg.arrs.s3) }; for(const k of ['hub','s1','s2','s3']){ const prev=seg.p95[k]; const cur=p95_new[k]; if(cur==null) continue; seg.p95[k] = (prev==null)? cur : Math.round(prev*(1-Guardrails.alpha) + cur*Guardrails.alpha); } } }
  function findP95For(row){ const k=segmentKey(row); const seg=Guardrails.store.get(k); if(seg && (seg.p95.hub||seg.p95.s1||seg.p95.s2||seg.p95.s3)) return seg.p95; const macro=macroRegionBySiDo(row.Region||'NA'); let agg={hub:[],s1:[],s2:[],s3:[]}; Guardrails.store.forEach((v,key)=>{ if(key.includes(`|${macro}|`) || key.endsWith(`|${macro}`)){ for(const f of ['hub','s1','s2','s3']){ if(v.p95[f]!=null) agg[f].push(v.p95[f]); } } }); const macroP95={ hub: agg.hub.length? Math.round(agg.hub.reduce((a,b)=>a+b,0)/agg.hub.length):null, s1: agg.s1.length? Math.round(agg.s1.reduce((a,b)=>a+b,0)/agg.s1.length):null, s2: agg.s2.length? Math.round(agg.s2.reduce((a,b)=>a+b,0)/agg.s2.length):null, s3: agg.s3.length? Math.round(agg.s3.reduce((a,b)=>a+b,0)/agg.s3.length):null }; if(macroP95.hub||macroP95.s1||macroP95.s2||macroP95.s3) return macroP95; let global={hub:[],s1:[],s2:[],s3:[]}; Guardrails.store.forEach(v=>{ for(const f of ['hub','s1','s2','s3']){ if(v.p95[f]!=null) global[f].push(v.p95[f]); } }); return { hub: global.hub.length? Math.round(global.hub.reduce((a,b)=>a+b,0)/global.hub.length):null, s1: global.s1.length? Math.round(global.s1.reduce((a,b)=>a+b,0)/global.s1.length):null, s2: global.s2.length? Math.round(global.s2.reduce((a,b)=>a+b,0)/global.s2.length):null, s3: global.s3.length? Math.round(global.s3.reduce((a,b)=>a+b,0)/global.s3.length):null };
  }

  // ==========================
  // 6) 파생/품질/브리치 계산
  // ==========================
  function msToMinPos(ms){ if(ms==null||!isFinite(ms)) return null; const m=Math.round(ms/60000); return (m<0)? null : m; }
  function safePos(v){ if(v==null||!isFinite(v)) return null; return v<0? null: v; }
  function recalcTimelineDerived(r){
    const ts = k=> r[k]? new Date(r[k]).getTime() : null;
    const orderTS=ts('Order_Timestamp');
    const fcExit=ts(NET.FC_EXIT) || ts('Actual_Ship_Timestamp');
    const hubIn=ts(NET.HUB_IN); const hubOut=ts(NET.HUB_OUT); const campIn=ts(NET.CAMP_IN); const loadS=ts(NET.LOAD_START); const loadE=ts(NET.LOAD_END); const ofd=ts(NET.OFD);
    r.fc_dispatch_ts = fcExit? new Date(fcExit).toISOString(): null;
    r.camp_depart_ts = loadE? new Date(loadE).toISOString() : (ofd? new Date(ofd).toISOString(): null);
    r.o2s_min = (orderTS!=null && fcExit!=null)? msToMinPos(fcExit - orderTS) : null;
    r.hub_total_dwell_min = (hubIn!=null && hubOut!=null)? msToMinPos(hubOut - hubIn) : null;
    r.camp_total_dwell_min = (campIn!=null && ofd!=null)? msToMinPos(ofd - campIn) : null;
    r.camp_s1_wait_min = (campIn!=null && loadS!=null)? msToMinPos(loadS - campIn) : null;
    r.camp_s2_work_min = (loadS!=null && loadE!=null)? msToMinPos(loadE - loadS) : null;
    r.camp_s3_wait_min = (loadE!=null && ofd!=null)? msToMinPos(ofd - loadE) : null;
    r.camp_wait_min = (safePos(r.camp_s1_wait_min)||0) + (safePos(r.camp_s3_wait_min)||0);
    r.camp_work_min = safePos(r.camp_s2_work_min);
    r.post_fc_transit_min = (fcExit!=null)? msToMinPos(((campIn??hubIn)??null) - fcExit) : null;
    r.hub_exit_wait_min = (hubOut!=null && campIn!=null)? msToMinPos(campIn - hubOut) : null;
    const planShip=ts('Planned_Ship_Timestamp'); r.fc_otd_flag = (planShip!=null && fcExit!=null)? (fcExit<=planShip?1:0): null;
    const planDel=ts('Planned_Delivery_Timestamp'); const actDel=ts('Delivery_Timestamp');
    if(planDel!=null && actDel!=null){ r.ofd_otd_flag = (actDel <= (planDel + 10*60000))? 1:0; } else { r.ofd_otd_flag = null; }
    r.sla_breach_flag = (r.SLA_Breach!=null)? Number(r.SLA_Breach): null;
    r.reason_category = (r.Temperature_Violation? 'TEMP' : (r.Damage_Flag? 'DAMAGE' : (r.Mis_Ship_Flag? 'MISHIP' : (r.Is_Delayed? 'DELAY': null))));
    r.q_ts_order_error = ((orderTS && fcExit && fcExit<orderTS) || (hubOut && hubIn && hubOut<hubIn) || (loadS && campIn && loadS<campIn) || (loadE && loadS && loadE<loadS) || (ofd && loadE && ofd<loadE))? 1:0;
    r.q_negative_duration = ([r.o2s_min, r.hub_total_dwell_min, r.camp_total_dwell_min, r.camp_s1_wait_min, r.camp_s2_work_min, r.camp_s3_wait_min].some(x=> x!=null && x<0))? 1:0;
    const outlier = ((r.o2s_min!=null && r.o2s_min>1440) || (r.hub_total_dwell_min!=null && r.hub_total_dwell_min>720) || (r.camp_total_dwell_min!=null && r.camp_total_dwell_min>360));
    r.q_outlier_flag = outlier? 1:0;
    try{ const od=r.Order_Timestamp? new Date(r.Order_Timestamp): null; if(od){ r.month = Number(od.getMonth()+1); const onejan=new Date(od.getFullYear(),0,1); r.week=Math.floor((((od - onejan)/86400000)+onejan.getDay()+1)/7); } }catch(e){}
    return r;
  }
  function flagBreaches(row){
    const p95=findP95For(row);
    row.hub_dispatch_breach_flag = (p95.hub!=null && row.hub_total_dwell_min!=null && row.hub_total_dwell_min>p95.hub)?1:0;
    row.camp_s1_breach_flag = (p95.s1!=null && row.camp_s1_wait_min!=null && row.camp_s1_wait_min>p95.s1)?1:0;
    row.camp_s2_breach_flag = (p95.s2!=null && row.camp_s2_work_min!=null && row.camp_s2_work_min>p95.s2)?1:0;
    row.camp_s3_breach_flag = (p95.s3!=null && row.camp_s3_wait_min!=null && row.camp_s3_wait_min>p95.s3)?1:0;
    row.hub_on_time_flag = (p95.hub!=null && row.hub_total_dwell_min!=null)? (row.hub_total_dwell_min<=p95.hub?1:0) : null;
    const campRef = ((p95.s1??0)+(p95.s2??0)+(p95.s3??0))||null; const campNow = (row.camp_s1_wait_min??0)+(row.camp_s2_work_min??0)+(row.camp_s3_wait_min??0);
    row.camp_on_time_flag = (campRef!=null && isFinite(campNow))? (campNow<=campRef?1:0): null;
    row.camp_dispatch_breach_flag = (row.camp_s1_breach_flag || row.camp_s2_breach_flag || row.camp_s3_breach_flag)? 1:0;
    let first=null; if(row.hub_dispatch_breach_flag) first='HUB'; else if(row.camp_s1_breach_flag) first='CAMP_S1'; else if(row.camp_s2_breach_flag) first='CAMP_S2'; else if(row.camp_s3_breach_flag) first='CAMP_S3'; row.first_touch_breach=first;
    return row;
  }

  // ==========================
  // 7) 테이블 빌드/가상화 렌더
  // ==========================
  function buildTableHeader(keys){ const thead=qs('tbl').querySelector('thead'); thead.innerHTML=''; const tr=document.createElement('tr'); keys.forEach(k=>{ const th=document.createElement('th'); th.textContent=prettyHeader(k); tr.appendChild(th) }); thead.appendChild(tr); }
  function renderTableRowsVirtual(rows, keys){ const tbody=qs('tbl').querySelector('tbody'); const frag=document.createDocumentFragment(); for(const r of rows){ const tr=document.createElement('tr'); for(const k of keys){ const td=document.createElement('td'); const v=r[k]; td.textContent=(v===null||v===undefined)? '': v; if(k==='Delivery_Mode'){ td.className='delivery-mode '+(v==='로켓새벽'? 'dawn' : (v==='로켓프레시'? 'fresh' : (String(v).includes('로켓')? 'rocket':''))); } tr.appendChild(td);} frag.appendChild(tr);} tbody.appendChild(frag); const excess=tbody.children.length - RENDER_MAX_ROWS; if(excess>0){ for(let i=0;i<excess;i++) tbody.removeChild(tbody.firstChild); } }

  // ==========================
  // 8) 스트리밍 집계 & 패널 업데이트
  // ==========================
  function ingestRows(rows){ if(!rows||!rows.length) return;
    for(const r of rows){ recalcTimelineDerived(r); updateGuardrailsWithRow(r); flagBreaches(r); }
    if(!TABLE_KEYS){ const baseKeys=Object.keys(rows[0]); const extraKeys=[ 'fc_dispatch_ts','camp_depart_ts','o2s_min','hub_total_dwell_min','camp_total_dwell_min','camp_s1_wait_min','camp_s2_work_min','camp_s3_wait_min','camp_wait_min','camp_work_min','post_fc_transit_min','hub_exit_wait_min','fc_otd_flag','ofd_otd_flag','sla_breach_flag','hub_on_time_flag','camp_on_time_flag','camp_dispatch_breach_flag','hub_dispatch_breach_flag','camp_s1_breach_flag','camp_s2_breach_flag','camp_s3_breach_flag','first_touch_breach','reason_category','q_ts_order_error','q_negative_duration','q_outlier_flag','q_missing_key','sim_version','sim_seed','dial_snapshot_json','generated_at' ]; const set=new Set(baseKeys.concat(extraKeys)); TABLE_KEYS=[...set]; buildTableHeader(TABLE_KEYS); }
    for(const r of rows){ DATA.push(r); if(DATA.length>CHUNK_CONFIG.maxMemoryRows){ DATA.splice(0, DATA.length-CHUNK_CONFIG.maxMemoryRows); } }

    for(const r of rows){
      AGG.total++; if(r.Is_Rocket_Delivery===1) AGG.rocket++;
      if(r.Delivery_Mode==='로켓당일'){ AGG.sameDayTotal++; if(r.SLA_Breach===0) AGG.sameDayOnTime++; }
      if(r.Delivery_Mode==='로켓새벽'){ AGG.dawnTotal++; if(r.SLA_Breach===0) AGG.dawnOnTime++; }
      if(r.o2s_min!=null && r.o2s_min<=30) AGG.fastShip30++; if(r.o2s_min!=null && r.o2s_min<=60) AGG.shipUnder60++; if(Number(r.sla_breach_flag)===1) AGG.fcSlaBreach++;
      AGG.shipMinutesSum += (r.o2s_min||0);
      AGG.pickPerItemSum += (r.Picking_Time_Seconds/Math.max(1,r.Quantity));
      AGG.packPerItemSum += (r.Packing_Time_Seconds / Math.max(1, r.Quantity));
      AGG.procErrRateSum += (r.Processing_Error_Rate || 0);

      if (r.Is_WOW_Member === 1) {
        AGG.wowCount++;
        AGG.wowSales += (r.Order_Amount || 0);
        AGG.wowOrders++;
        if (r.Is_Churn_Risk === 1) AGG.wowChurnRisk++;
        if (r.WOW_Tier === 'WOW_PLUS') AGG.wowPlusCount++;
      } else {
        AGG.nonWowSales += (r.Order_Amount || 0);
        AGG.nonWowOrders++;
      }

      if (r.Is_Fresh_Food === 1) AGG.freshCount++;
      if (r.Is_Cold_Chain_Required === 1) {
        AGG.coldReq++;
        if (r.Temperature_Violation === 1) AGG.tempViol++;
      }
      if (r.Product_Category === '냉동식품' && isFinite(r.Cold_Chain_Quality_Score)) {
        AGG.frozenQualitySum += r.Cold_Chain_Quality_Score;
        AGG.frozenCnt++;
      }

      if (r.Is_Mega_Hub === 1) AGG.megaHub++;
      if (['서울특별시', '경기도', '인천광역시'].includes(r.Region)) AGG.metro++;
      AGG.distanceSum += (r.Distance_km || 0);
      AGG.routingSum += (r.Routing_Score || 0);

      if (r.Automation_Level === 'AI_OPTIMIZED') AGG.aiOpt++;
      AGG.autoPickScoreSum += (r.Automation_Level === 'AI_OPTIMIZED' ? 90 :
        r.Automation_Level === 'AUTO' ? 70 :
          r.Automation_Level === 'SEMI_AUTO' ? 40 : 10);
      AGG.pickTimeSum += (r.Picking_Time_Seconds || 0);
      AGG.wmsAdvSum += (r.WMS_Advanced_Score || 0);

      AGG.salesSum += (r.Order_Amount || 0);
      AGG.netProfitSum += (r.Net_Profit || 0);

      AGG.ltvSum += (r.Customer_LTV || 0);
      AGG.cacSum += (r.CAC || 0);
      AGG.uniqueCustomers.add(r.Customer_ID);
      if (r.Is_Churn_Risk === 1) AGG.churnRisk++;
      if (r.Predicted_Churn_Score != null) {
        const pred = r.Predicted_Churn_Score >= 0.6 ? 1 : 0;
        const act = r.Churn_Flag === 1 ? 1 : 0;
        if (pred === 1 && act === 1) AGG.cm_tp++;
        else if (pred === 0 && act === 0) AGG.cm_tn++;
        else if (pred === 1 && act === 0) AGG.cm_fp++;
        else if (pred === 0 && act === 1) AGG.cm_fn++;
        if ((pred === 1) === (act === 1)) AGG.aiAccEqual++;
      }

      if (r.SLA_Breach === 0) AGG.onTime++; else AGG.delay++;
      AGG.loadSum += (r.Load_Factor || 0);
      AGG.fuelSum += (r.Fuel_Efficiency || 0);
      AGG.routeSum += (r.Routing_Score || 0);
      if (r.Temperature_Violation === 1 || Number(r.sla_breach_flag) === 1 || r.Return_Flag === 1) AGG.exception++;

      if (r.Return_Flag === 1) {
        AGG.returnCnt++;
        AGG.returnCostSum += (r.Return_Cost || 0);
        if (r.Is_Resellable === 1) AGG.resellCnt++;
      }

      AGG.invTurnSum += (r.Inventory_Turnover || 0);
      if (r.Stockout_Flag === 1) AGG.stockoutCnt++;
      if (r.Overstock_Flag === 1) AGG.overstockCnt++;
      AGG.invAccSum += (r.Inventory_Accuracy || 0);
      if (r.WMS_Usage === 'Active') AGG.wmsActiveCnt++;

      if (r.Is_Loss_Order === 1) AGG.lossOrderCnt++;
      if (r.Region === '제주특별자치도') {
        AGG.jejuTotal++;
        if (r.Is_Weather_Risk === 1) AGG.jejuWeatherRiskCnt++;
      }
      if (r.Expiry_Date) {
        const d = (new Date(r.Expiry_Date)) - (new Date(r.Order_Date));
        if (d <= 86400000 && d >= -31536000000) AGG.expiryImminentCnt++;
      }

      if (r.clv_quartile === 4) {
        AGG.clvQ4Customers.add(r.Customer_ID);
      }
      if (r.Is_WOW_Member === 1) {
        AGG.clvWowSum += r.Customer_LTV || 0;
        AGG.clvWowN++;
      } else {
        AGG.clvNonWowSum += r.Customer_LTV || 0;
        AGG.clvNonWowN++;
      }
      if (r.is_high_breach_60d === 1) {
        AGG.highBreach60Customers.add(r.Customer_ID);
      }
      if (r.hub_on_time_flag != null) {
        AGG.hubEligible++;
        if (r.hub_on_time_flag === 1) AGG.hubOnTimeCnt++;
      }
      if (r.camp_on_time_flag != null) {
        AGG.campEligible++;
        if (r.camp_on_time_flag === 1) AGG.campOnTimeCnt++;
      }
      if (r.camp_dispatch_breach_flag === 1) {
        AGG.campDispatchBreachCnt++;
      }
      if (Number.isFinite(r.fc_total_dwell_min)) AGG.fcTotalDwellSum += r.fc_total_dwell_min;
    }

    renderTableRowsVirtual(rows, TABLE_KEYS);
    updateKPIsFromAgg();
    updateValidationAndRiskFromAgg();

    PROCESSING_STATE.processedRows += rows.length;
    updateProgressFromState('Generating');
  }

  function updateKPIsFromAgg() {
    const total = Math.max(1, AGG.total);
    const fmtPct = v => (isFinite(v) ? (Number(v).toFixed(1) + '%') : '-');

    const rocketShare = (AGG.rocket / total * 100);
    const sameDaySuccess = (AGG.sameDayTotal ? AGG.sameDayOnTime / AGG.sameDayTotal * 100 : 0);
    const dawnOnTime = (AGG.dawnTotal ? AGG.dawnOnTime / AGG.dawnTotal * 100 : 0);
    const fastShip = (AGG.fastShip30 / total * 100);

    const fcOnTime = 100 - (AGG.fcSlaBreach / total * 100);
    const avgShipHr = ((AGG.shipMinutesSum / total) / 60);
    const pickSecPerItem = (AGG.pickPerItemSum / total);
    const packSecPerItem = (AGG.packPerItemSum / total);
    const effFulfill = clamp(100 - ((AGG.procErrRateSum / total) * 100 * 2), 0, 100);
    const shipUnder60 = (AGG.shipUnder60 / total * 100);

    const wowShare = (AGG.wowCount / total * 100);
    const wowPlusShare = (AGG.wowCount ? (AGG.wowPlusCount / AGG.wowCount * 100) : 0);
    const wowAov = (AGG.wowOrders ? AGG.wowSales / AGG.wowOrders : 0);
    const nonWowAov = (AGG.nonWowOrders ? AGG.nonWowSales / AGG.nonWowOrders : 0);
    const wowAovGap = (wowAov - nonWowAov);

    const freshShare = (AGG.freshCount / total * 100);
    const coldChainRate = (AGG.coldReq ? (1 - AGG.tempViol / AGG.coldReq) * 100 : 100);
    const tempViolRate = (AGG.coldReq ? (AGG.tempViol / AGG.coldReq * 100) : 0);
    const frozenQuality = (AGG.frozenCnt ? AGG.frozenQualitySum / AGG.frozenCnt : 0);

    const megaHubShare = (AGG.megaHub / total * 100);
    const metroCoverage = (AGG.metro / total * 100);
    const avgDist = (AGG.distanceSum / total);
    const networkEff = (AGG.routingSum / total);

    const aiOptimized = (AGG.aiOpt / total * 100);
    const autoPickRate = (AGG.autoPickScoreSum / total);
    const avgPickTime = (AGG.pickTimeSum / total);
    const wmsAdvanced = (AGG.wmsAdvSum / total);

    const totalSales = AGG.salesSum;
    const netMargin = (AGG.salesSum ? AGG.netProfitSum / AGG.salesSum * 100 : 0);
    const aov = (AGG.salesSum / total);
    const uniqueCust = Math.max(1, AGG.uniqueCustomers.size);
    const arppu = (AGG.salesSum / uniqueCust);

    const ltvAvg = (AGG.ltvSum / total);
    const cacAvg = (AGG.cacSum / total);
    const ltvCac = (cacAvg ? (ltvAvg / cacAvg).toFixed(2) : '0.00');

    const churnRate = (AGG.churnRisk / total * 100);
    const aiAcc = (AGG.aiAccEqual / total * 100);

    const onTime = (AGG.onTime / total * 100);
    const sla = (AGG.fcSlaBreach / total * 100);
    const load = (AGG.loadSum / total);
    const fuel = (AGG.fuelSum / total);
    const route = (AGG.routeSum / total);
    const exception = (AGG.exception / total * 100);

    const retRate = (AGG.returnCnt / total * 100);
    const retCostRate = (AGG.salesSum ? AGG.returnCostSum / AGG.salesSum * 100 : 0);
    const resell = (AGG.returnCnt ? AGG.resellCnt / AGG.returnCnt * 100 : 0);

    const invTurn = (AGG.invTurnSum / total);
    const stockout = (AGG.stockoutCnt / total * 100);
    const overstock = (AGG.overstockCnt / total * 100);
    const invAcc = (AGG.invAccSum / total);
    const shrink = (100 - invAcc);
    const wmsUse = (AGG.wmsActiveCnt / total * 100);

    const clvTopQ4Share = (AGG.clvQ4Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const clvWowAvg = (AGG.clvWowN ? AGG.clvWowSum / AGG.clvWowN : 0);
    const clvNonWowAvg = (AGG.clvNonWowN ? AGG.clvNonWowSum / AGG.clvNonWowN : 0);
    const clvWowGap = clvWowAvg - clvNonWowAvg;
    const highBreach60Share = (AGG.highBreach60Customers.size / Math.max(1, AGG.uniqueCustomers.size)) * 100;
    const hubOnTimeP95 = (AGG.hubEligible ? AGG.hubOnTimeCnt / AGG.hubEligible * 100 : 0);
    const campOnTimeP95 = (AGG.campEligible ? AGG.campOnTimeCnt / AGG.campEligible * 100 : 0);
    const fcTotalDwellAvg = (AGG.total ? AGG.fcTotalDwellSum / AGG.total : 0);

    setText('k_rocketShare', fmtPct(rocketShare));
    setText('k_rocketSameDayRate', fmtPct(sameDaySuccess));
    setText('k_rocketDawnRate', fmtPct(dawnOnTime));
    setText('k_fastShipRate', fmtPct(fastShip));
    setText('k_hubOnTimeP95', fmtPct(hubOnTimeP95));
    setText('k_campOnTimeP95', fmtPct(campOnTimeP95));
    setText('k_campDispatchBreach', (AGG.campDispatchBreachCnt || 0).toLocaleString('ko-KR'));

    setText('k_fcOnTimeShip', fmtPct(fcOnTime));
    setText('k_fcAvgShipHour', (avgShipHr || 0).toFixed(2));
    setText('k_fcPickSecPerItem', (pickSecPerItem || 0).toFixed(1));
    setText('k_fcPackSecPerItem', (packSecPerItem || 0).toFixed(1));
    setText('k_fcEfficiency', (effFulfill || 0).toFixed(1));
    setText('k_fcShipUnder60', fmtPct(shipUnder60));
    setText('k_fcTotalDwellMinAvg', (fcTotalDwellAvg || 0).toFixed(1));

    setText('k_wowShare', fmtPct(wowShare));
    setText('k_wowPlusShare', (wowPlusShare || 0).toFixed(1));
    setText('k_wowAovGap', formatCurrencyKRW(wowAovGap));
    setText('k_wowChurnRisk', (AGG.wowChurnRisk || 0).toLocaleString('ko-KR'));

    setText('k_clvTopQ4Share', fmtPct(clvTopQ4Share));
    setText('k_clvWowGap', formatCurrencyKRW(clvWowGap));
    setText('k_highBreach60Share', fmtPct(highBreach60Share));

    setText('k_freshShare', fmtPct(freshShare));
    setText('k_coldChainRate', fmtPct(coldChainRate));
    setText('k_tempViolation', fmtPct(tempViolRate));
    setText('k_frozenQuality', (frozenQuality || 0).toFixed(0));

    setText('k_megaHubShare', fmtPct(megaHubShare));
    setText('k_seoulCoverage', fmtPct(metroCoverage));
    setText('k_avgDistance', (avgDist || 0).toFixed(1));
    setText('k_networkEff', (networkEff || 0).toFixed(0));

    setText('k_aiOptimized', fmtPct(aiOptimized));
    setText('k_autoPickRate', (autoPickRate || 0).toFixed(1));
    setText('k_avgPickTime', (avgPickTime || 0).toFixed(1));
    setText('k_wmsAdvanced', (wmsAdvanced || 0).toFixed(0));

    setText('k_totalSales', formatCurrencyKRW(totalSales));
    setText('k_netMargin', (netMargin || 0).toFixed(2));
    setText('k_aov', formatCurrencyKRW(aov));
    setText('k_arppu', formatCurrencyKRW(arppu));

    setText('k_ltvCac', ltvCac);
    setText('k_retention', (100 - churnRate).toFixed(1));
    setText('k_churn', churnRate.toFixed(1));
    setText('k_ai', aiAcc.toFixed(1));

    setText('k_onTime', fmtPct(onTime));
    setText('k_sla', fmtPct(sla));
    setText('k_load', (load || 0).toFixed(1));
    setText('k_fuel', (fuel || 0).toFixed(2));
    setText('k_route', (route || 0).toFixed(0));
    setText('k_exception', fmtPct(exception));

    setText('k_returnRate', fmtPct(retRate));
    setText('k_returnCost', (retCostRate || 0).toFixed(2));
    setText('k_resell', fmtPct(resell));

    setText('k_invTurn', (invTurn || 0).toFixed(1));
    setText('k_stockout', fmtPct(stockout));
    setText('k_overstock', fmtPct(overstock));
    setText('k_invAcc', (invAcc || 0).toFixed(1));
    setText('k_shrink', (shrink || 0).toFixed(1));
    setText('k_wms', fmtPct(wmsUse));
  }

  function updateValidationAndRiskFromAgg() {
    const list = qs('validateList'); list.innerHTML = '';
    const risk = qs('riskList'); risk.innerHTML = '';
    const perf = qs('perfList'); perf.innerHTML = '';
    if (AGG.total === 0) { qs('validateSummary').textContent = '-'; return; }

    const total = AGG.total;
    const tempViolRate = (AGG.coldReq ? AGG.tempViol / AGG.coldReq : 0);
    const lossRate = (AGG.lossOrderCnt / total);
    const jejuRate = (AGG.jejuTotal ? AGG.jejuWeatherRiskCnt / AGG.jejuTotal : 0);
    const overStockRate = (AGG.overstockCnt / total);
    const expirySoonRate = (AGG.expiryImminentCnt / total);

    const DIALS_CUR = {
      tempHi: parseFloat(qs('dial_temp_hi').value),
      lossHi: parseFloat(qs('dial_loss_hi').value),
      jejuHi: parseFloat(qs('dial_jeju_hi').value),
      overHi: parseFloat(qs('dial_over_hi').value),
      expHi: parseFloat(qs('dial_exp_hi').value),
    };
    const pill = (text, type) => { const d=document.createElement('div'); d.className='alert '+type; d.textContent=text; return d; };

    const okText = `콜드체인 위반율 ${(tempViolRate * 100).toFixed(2)}% / 손실주문율 ${(lossRate * 100).toFixed(2)}%`;
    qs('validateSummary').textContent = okText;

    if (tempViolRate > DIALS_CUR.tempHi) risk.appendChild(pill(`콜드체인 위반율 상한 초과 (${(tempViolRate * 100).toFixed(2)}% > ${(DIALS_CUR.tempHi * 100).toFixed(1)}%)`, 'bad'));
    if (lossRate > DIALS_CUR.lossHi) risk.appendChild(pill(`적자주문율 상한 초과 (${(lossRate * 100).toFixed(2)}%)`, 'bad'));
    if (jejuRate > DIALS_CUR.jejuHi) risk.appendChild(pill(`제주 악천후 위험 상한 초과 (${(jejuRate * 100).toFixed(2)}%)`, 'warn'));
    if (overStockRate > DIALS_CUR.overHi) risk.appendChild(pill(`과재고 비중 상한 초과 (${(overStockRate * 100).toFixed(1)}%)`, 'warn'));
    if (expirySoonRate > DIALS_CUR.expHi) risk.appendChild(pill(`유통기한 임박 비중 상한 초과 (${(expirySoonRate * 100).toFixed(2)}%)`, 'warn'));

    // 최근 샘플 기반 품질 경고
    const sample = DATA.slice(-Math.min(DATA.length, 1200));
    let distAnom = 0, tsOrderErr = 0, negDur = 0, outlier = 0, otdOk = 0, otdTot = 0, campBreach = 0;
    for (const r of sample) {
      if (r.Base_Distance_km && r.Distance_km) {
        const minOk = r.Base_Distance_km * 0.4 - 5;
        const maxOk = r.Base_Distance_km * 2.5 + 20;
        if (r.Distance_km < minOk || r.Distance_km > maxOk) distAnom++;
      }
      if (r.q_ts_order_error === 1) tsOrderErr++;
      if (r.q_negative_duration === 1) negDur++;
      if (r.q_outlier_flag === 1) outlier++;
      if (r.ofd_otd_flag != null) {
        otdTot++;
        if (r.ofd_otd_flag === 1) otdOk++;
      }
      if (r.camp_dispatch_breach_flag === 1) campBreach++;
    }
    if (distAnom > 0) list.appendChild(pill(`거리-센터 일관성 경고: 샘플 ${sample.length}건 중 ${distAnom}건 이상치`, 'warn'));
    if (tsOrderErr > 0) list.appendChild(pill(`타임스탬프 순서 오류 ${tsOrderErr}건`, 'bad'));
    if (negDur > 0) list.appendChild(pill(`음수 지속시간 ${negDur}건`, 'bad'));
    if (outlier > 0) list.appendChild(pill(`이상치 플래그 ${outlier}건`, 'warn'));
    if (otdTot > 0) {
      const otdRate = (otdOk / otdTot * 100).toFixed(1);
      list.appendChild(pill(`OFD OTD 정시율(±10분) ${otdRate}% (표본 ${otdTot})`, 'good'));
    }

    if (campBreach > 0) risk.appendChild(pill(`캠프 디스패치 브리치 최근 누적 ${campBreach}건`, 'warn'));

    const highBreachShare = (AGG.highBreach60Customers.size / Math.max(1, AGG.uniqueCustomers.size));
    if (highBreachShare > 0.12) risk.appendChild(pill(`최근60일 고위반 고객 비중 ${(highBreachShare * 100).toFixed(1)}% (임계 12%)`, 'warn'));

    // 퍼포먼스
    const elapsed = (Date.now() - (PROCESSING_STATE.startTime || Date.now())) / 1000;
    const rps = PROCESSING_STATE.processedRows / Math.max(0.1, elapsed);
    const memRows = DATA.length;
    const estBytes = memRows * 800;
    perf.appendChild(pill(`처리속도 ~ ${rps.toFixed(1)} r/s · 표시행 ${Math.min(memRows, 2000)} / 보유 ${memRows}`, 'good'));
    perf.appendChild(pill(`메모리 보호: ~${(estBytes / 1e6).toFixed(1)} MB (행당 추정 0.8KB)`, 'good'));
  }

  // ==========================
  // 9) CSV 내보내기
  // ==========================
  function escapeCSV(v) {
    if (v == null) return '';
    const s = String(v).replace(/"/g, '""');
    return `"${s}"`;
  }
  function buildCSV(keys, rows) {
    const header = keys.map(k => escapeCSV(labelUnderscore(k))).join(',');
    let out = header + '\n';
    const BATCH = 5000;
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const line = keys.map(k => escapeCSV(r[k])).join(',');
      out += line + (i < rows.length - 1 ? '\n' : '');
      if ((i + 1) % BATCH === 0) updateExportProgress(i + 1, rows.length);
    }
    updateExportProgress(rows.length, rows.length);
    return out;
  }
  async function downloadCSV() {
    try {
      setStatus('EXPORTING CSV', 'running');
      showProgress(true);
      const csv = buildCSV(TABLE_KEYS || Object.keys(DATA[0] || {}), DATA);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `coupang_sim_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
      setStatus('CSV READY', 'ok'); showProgress(false);
    } catch (e) { console.error(e); setStatus('CSV ERROR', 'ng'); }
  }
  async function downloadCSVGzip() {
    try {
      if (!('CompressionStream' in window)) { alert('브라우저가 CompressionStream(gzip)을 지원하지 않습니다. 일반 CSV를 사용하세요.'); return; }
      setStatus('GZIP EXPORT', 'running'); showProgress(true);
      const csv = buildCSV(TABLE_KEYS || Object.keys(DATA[0] || {}), DATA);
      const enc = new TextEncoder();
      const cs = new CompressionStream('gzip');
      const writer = cs.writable.getWriter();
      writer.write(enc.encode(csv)); writer.close();
      const gzBlob = await new Response(cs.readable).blob();
      const url = URL.createObjectURL(gzBlob);
      const a = document.createElement('a'); a.href = url; a.download = `coupang_sim_${Date.now()}.csv.gz`; a.click();
      URL.revokeObjectURL(url);
      setStatus('CSV.GZ READY', 'ok'); showProgress(false);
    } catch (e) { console.error(e); setStatus('GZIP ERROR', 'ng'); }
  }

  // ==========================
  // 10) 데이터 생성 워커 (FIXED)
  // ==========================
  function createWorker() {
    const code = `
      let CFG=null; let RNG=null; let SIM_SEED=0; let STOP=false;
      const POLICY = { useWeatherInSegmentation: false, useWeatherInCost: true };

      onmessage = (e) => {
        const d = e.data || {};
        if (d.cmd === 'start') run(d.cfg);
        else if (d.cmd === 'stop') STOP = true;
      };

      function srand(seed){ SIM_SEED=seed>>>0; RNG=seeded(seed); }
      function seeded(seed){ let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return (s>>>0)/4294967296; }; }
      const R=()=>RNG();

      function pick(arr){ return arr[Math.floor(R()*arr.length)]; }
      function nrand(mean, sd){ let u=0,v=0; while(u===0)u=R(); while(v===0)v=R(); const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); return mean + z*sd; }
      function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi,v)); }
      function ts(ms){ return new Date(ms).toISOString(); }
      function addMin(t, m){ return t + Math.floor(m*60000 + (R()*59000-29500)); }
      function randInt(a,b){ return Math.floor(R()*(b-a+1))+a; }

      const MAP = [
        {Region:'서울특별시', City:'서울특별시', District:'강남구', FC:'FC-SEO-1', DC:'DC-SEO-NE', Base:12},
        {Region:'서울특별시', City:'서울특별시', District:'마포구', FC:'FC-SEO-2', DC:'DC-SEO-NW', Base:10},
        {Region:'경기도', City:'성남시', District:'분당구', FC:'FC-GYO-1', DC:'DC-GYO-SE', Base:22},
        {Region:'경기도', City:'고양시', District:'덕양구', FC:'FC-GYO-2', DC:'DC-GYO-NW', Base:28},
        {Region:'인천광역시', City:'인천광역시', District:'연수구', FC:'FC-INC-1', DC:'DC-INC-S', Base:35},
        {Region:'부산광역시', City:'부산광역시', District:'해운대구', FC:'FC-BUS-1', DC:'DC-BUS-E', Base:40},
        {Region:'대전광역시', City:'대전광역시', District:'유성구', FC:'FC-DJN-1', DC:'DC-DJN-W', Base:60},
        {Region:'제주특별자치도', City:'제주시', District:'애월읍', FC:'FC-JJU-1', DC:'DC-JJU-N', Base:290}
      ];
      const ROAD = ['테헤란로','서초대로','강변북로','송파대로','분당내곡로','광안로','유성대로','중앙로'];
      const BLDG = ['센터','타워','스퀘어','캐슬','트윈','하이츠'];

      function addrFor(m){ const road=pick(ROAD); const b=pick(BLDG); const no=randInt(1,200); const dong=randInt(1,30); const ho=randInt(1,20); return \`\${road} \${no} \${b} \${dong}동 \${ho}호\`; }
      function makeDistance(base){ const off = nrand(0, base*0.25); const sign = (R()<0.5?-1:1); const d = Math.max(3, base + sign*off); return Math.round(d*10)/10; }

      function computeDeliveryCharge(isWOW, mode, dist, aov){
        const bracket = dist>60?5: dist>40?4: dist>25?3: dist>12?2:1;
        if(isWOW){ if(mode==='일반택배' && dist>40) return 2000; return 0; }
        if(aov>=50000) return 0;
        const modeK = (mode==='일반택배'?1.0: mode==='로켓당일'?1.1: mode==='로켓새벽'?1.2: 1.0);
        const base = [0,1500,2200,3000,3800,4500][bracket];
        return Math.round(base*modeK/100)*100;
      }

      function buildUsers(n, wowRate){
        const users=[];
        for(let i=0;i<n;i++){
          const m=pick(MAP);
          const isWOW = (R()*100 < wowRate)?1:0;
          const tier = isWOW? (R()<0.2? 'WOW_PLUS':'WOW_BASIC') : 'NONE';
          const baseCLV = Math.max(20000, nrand(180000, 60000));
          users.push({
            Customer_ID: 'C'+String(i+1).padStart(6,'0'),
            Region: m.Region, City: m.City, District: m.District,
            Preferred_Map: m, WOW: isWOW, WOW_Tier:tier, CLV_Base: baseCLV,
            WOW_Join: Date.now() - Math.floor(R()*360*86400000)
          });
        }
        return users;
      }

      function clvQuartileLabel(ltv){
        if (ltv < 105000) return {q:1, label:'Q1-Low'};
        if (ltv < 170000) return {q:2, label:'Q2-Mid'};
        if (ltv < 240000) return {q:3, label:'Q3-High'};
        return {q:4, label:'Q4-Top'};
      }

      async function run(cfg){
        CFG = cfg; STOP=false; srand(CFG.seed || 12345);
        const USERS = buildUsers(CFG.userCount, CFG.wowRate);
        const start = Date.UTC(CFG.startYear,0,1), end = Date.UTC(CFG.endYear,11,31,23,59,59);
        const span = Math.max(1, end-start);

        const breachTs=new Map();
        const CHUNK = Math.max(500, CFG.chunkSize||3000);
        const totalRows = CFG.totalRows;
        let emitted=0;

        for(let i=0;i<totalRows;i++){
          if (STOP){ postMessage({type:'stopped'}); return; }
          const u = pick(USERS);
          const baseMap = u.Preferred_Map;
          const orderTS = start + Math.floor(R()*span);
          const orderDate = new Date(orderTS);
          const orderHour = orderDate.getHours();

          const mode = (R()*100<CFG.rocketRate? pick(['로켓당일','로켓새벽','로켓프레시']) : '일반택배');
          const routeType = (R()<0.7? 'HUB_SPOKE':'DIRECT');
          const sortHub = (routeType==='HUB_SPOKE'? 'MEGA-HUB-01':'');
          const cats=['가공식품','신선식품','냉동식품','생활용품','전자'];
          const cat=pick(cats);
          const qty = Math.max(1, Math.round(nrand(2,1.2)));
          const unit = Math.max(1500, Math.round(nrand(12000,6000)));
          const amount = qty*unit;

          const exact = addrFor(baseMap);
          const dist = makeDistance(baseMap.Base);

          const weatherS = clamp(nrand(0.35,0.2),0,1);
          const weatherName = weatherS>0.65? '눈' : weatherS>0.45? '비' : weatherS>0.30? '흐림' : '맑음';

          // FC 내부 타임라인
          const pickStart = addMin(orderTS, 10 + R()*30);
          const pickEnd   = addMin(pickStart, 5 + R()*10);
          const packStart = addMin(pickEnd, 1 + R()*5);
          const packEnd   = addMin(packStart, 3 + R()*8);
          const qcStart   = addMin(packEnd, 1 + R()*5);
          const qcEnd     = addMin(qcStart,  2 + R()*6);
          const labelS    = addMin(qcEnd,    1 + R()*4);
          const labelE    = addMin(labelS,   1 + R()*4);
          const stagingIn = addMin(labelE,   2 + R()*15);
          const stagingOut= addMin(stagingIn,5 + R()*20);
          const dockAssign= addMin(stagingOut, 2 + R()*10);
          const dockArr   = addMin(dockAssign, 5 + R()*15);
          const dockRel   = addMin(dockArr,    8 + R()*25);
          const gateOut   = addMin(dockRel,    5 + R()*10);

          const fcExitTS = gateOut;
          const hubInTS  = (routeType==='HUB_SPOKE')? addMin(fcExitTS, 45 + R()*60): null;
          const hubOutTS = hubInTS? addMin(hubInTS, 30 + R()*90): null;
          const campInTS = addMin((hubOutTS??fcExitTS), 30 + R()*60);
          const loadS    = addMin(campInTS, 10 + R()*40);
          const loadE    = addMin(loadS,    10 + R()*40);
          const ofdTS    = addMin(loadE,    20 + R()*60);

          const plannedShip = addMin(orderTS, 120 + R()*180);
          const baseMin = (mode==='일반택배'? (dist/35*60+240): (mode==='로켓당일'? 300: (mode==='로켓새벽'? 450: 420)));
          const plannedDelivery = addMin(plannedShip, baseMin);

          const inboundTS = addMin(orderTS - 86400000, Math.max(60, nrand(12*60, 4*60)));
          const fcTotalMin = Math.max(0, Math.round((fcExitTS - (pickStart||inboundTS)) / 60000));
          const residual = Math.max(0, fcTotalMin - Math.round((qcEnd-qcStart)/60000) - Math.round((labelE-labelS)/60000) - Math.round((stagingOut-stagingIn)/60000) - Math.round((dockRel-dockArr)/60000));

          const coldReq = (cat==='신선식품' || cat==='냉동식품')?1:0;
          const tempViol = coldReq? (R()< clamp(0.008 + weatherS*0.01, 0, 0.08) ? 1:0):0;
          const travelDelayMin = Math.max(0, Math.round((ofdTS - plannedDelivery)/60000));
          const slaBreach = travelDelayMin>10?1:0;

          // breach 누적
          if(slaBreach===1 || tempViol===1){
            const arr = breachTs.get(u.Customer_ID) || [];
            arr.push(ofdTS); breachTs.set(u.Customer_ID, arr);
          }
          const arr = breachTs.get(u.Customer_ID) || [];
          const ts60 = orderTS - 60*86400000, ts30 = orderTS - 30*86400000;
          while(arr.length && arr[0]<ts60) arr.shift();
          let c60=0,c30=0; for(const t of arr){ if(t<orderTS){ if(t>=ts60) c60++; if(t>=ts30) c30++; } }
          const highBreach60 = (c60>=2)?1:0;

          const ltv = Math.max(10000, Math.round(nrand(u.CLV_Base, u.CLV_Base*0.25)));
          const cac = Math.max(0, Math.round(nrand(2500, 900)));
          const charge = computeDeliveryCharge(u.WOW===1, mode, dist, amount);
          const actualCost = Math.round(900 + dist*70 + (mode==='로켓프레시'?600: (mode==='로켓새벽'?500: (mode==='로켓당일'?450:350))));
          const gross = amount - actualCost;
          const net = gross + charge - cac - (tempViol? 300: 0);

          const {q:clvQ, label:clvLbl} = clvQuartileLabel(ltv);
          const churnScore = clamp(nrand(0.25 + (1 - u.WOW)*0.15 + (highBreach60?0.2:0), 0.15), 0, 1);
          const churnFlag = churnScore>0.65?1:0;

          const isSameDay = (mode==='로켓당일')?1:0;
          const isDawn = (mode==='로켓새벽')?1:0;
          const isFreshDeliv = (mode==='로켓프레시')?1:0;
          const isPremium = (u.WOW_Tier==='WOW_PLUS')?1:0;
          const isBulk = qty>=6?1:0;
          const isWeekend = [0,6].includes(new Date(orderTS).getDay())?1:0;
          const isPeak = (orderHour>=19 && orderHour<=21)?1:0;
          const freeShip = (charge===0)?1:0;
          const weatherRisk = (weatherS>0.6)?1:0;
          const longDist = (dist>60)?1:0;
          const highLTV = (ltv>240000)?1:0;
          const isVIP = (clvQ===4 && u.WOW===1)?1:0;
          const lossOrder = (net<0)?1:0;
          const aiOpt = (R()<0.55)?1:0;

          const row = {
            sim_version:'v2025-11+ops+clv', sim_seed: SIM_SEED,
            dial_snapshot_json: JSON.stringify({lossHi:CFG.CAL?CFG.CAL.lossHi:null,tempHi:CFG.CAL?CFG.CAL.tempHi:null}),
            generated_at: ts(Date.now()),

            Order_ID: 'O'+String(i+1).padStart(7,'0'),
            Order_Date: ts(orderTS).slice(0,10), Order_Timestamp: ts(orderTS), Order_Hour: orderHour,
            Delivery_Mode: mode, Is_Rocket_Delivery: (mode!=='일반택배')?1:0,
            Planned_Delivery_Timestamp: ts(plannedDelivery), Delivery_Timestamp: ts(ofdTS),
            Is_Delayed: travelDelayMin>0?1:0, Delay_Hours: (travelDelayMin/60).toFixed(2), SLA_Breach: slaBreach,

            Region: u.Region, City: u.City, District: u.District,
            Address: u.City+' '+u.District, Exact_Address: exact,
            Fulfillment_Center: baseMap.FC, Delivery_Center: baseMap.DC, Is_Mega_Hub: (routeType==='HUB_SPOKE')?1:0,
            Base_Distance_km: baseMap.Base, Distance_km: dist,

            Customer_ID: u.Customer_ID, Is_WOW_Member: u.WOW, WOW_Tier: u.WOW_Tier,
            WOW_Join_Date: ts(u.WOW_Join), WOW_Tenure_Days: Math.floor((orderTS - u.WOW_Join)/86400000),

            Product_Category: cat, SKU: 'SKU-'+String(Math.floor(R()*90000)+10000), ABC_Category: pick(['A','B','C']),
            Unit_Price: unit, Quantity: qty, Order_Amount: amount,

            Is_Fresh_Food: (cat==='신선식품'||cat==='냉동식품')?1:0, Is_Cold_Chain_Required: coldReq,
            Target_Temperature: coldReq? (cat==='냉동식품'?-18:4): null,
            Actual_Temperature: coldReq? (cat==='냉동식품'? Math.round(nrand(-17,3)): Math.round(nrand(3,2))): null,
            Temperature_Violation: tempViol,
            Cold_Chain_Quality_Score: coldReq? Math.max(0, Math.min(100, Math.round(100 - tempViol*30 - (weatherS*8)))): null,

            Vehicle_ID: 'V'+String(Math.floor(R()*9000)+1000),
            Vehicle_Type: pick(['EV Van','Diesel Van','Bike','Cargo']),
            Vehicle_Capacity: Math.floor(nrand(100,30)),
            Driver_ID: 'D'+String(Math.floor(R()*90000)+10000),
            Driver_Grade: pick(['A','B','C']),
            Load_Factor: Math.max(0.3, Math.min(0.98, nrand(0.7,0.15))),
            Fuel_Efficiency: Math.max(4.5, Math.round(nrand(9.8,2.5)*10)/10),
            Routing_Score: Math.max(60, Math.round(nrand(82,10))),
            GPS_Tracking: 1,

            Actual_Logistics_Cost: actualCost,
            Customer_Delivery_Charge: charge,
            Gross_Profit: gross,
            Net_Profit: net,
            CAC: cac,
            Customer_LTV: ltv,
            LTV_to_CAC: cac>0? (ltv/cac): null,

            clv_quartile: clvQ, clv_quartile_label: clvLbl,
            cust_breach_30d_cnt: c30, cust_breach_60d_cnt: c60, is_high_breach_60d: highBreach60,

            Return_Flag: (R()<0.06?1:0),
            Return_Reason: null,
            Return_Cost: 0,
            Is_Resellable: 0,
            Resellability_Reason: null,

            Current_Stock: Math.max(0, Math.round(nrand(380, 140))),
            Reorder_Point: Math.max(20, Math.round(nrand(140, 60))),
            Stockout_Flag: 0,
            Overstock_Flag: 0,
            Inventory_Turnover: Math.max(1, Math.round(nrand(6,2))),
            Inventory_Accuracy: Math.max(80, Math.round(nrand(94, 3)*10)/10),

            Automation_Level: aiOpt? 'AI_OPTIMIZED' : (R()<0.3?'AUTO': (R()<0.6?'SEMI_AUTO':'MANUAL')),
            Picking_Time_Seconds: Math.max(10, Math.round(nrand(40,15))),
            Packing_Time_Seconds: Math.max(10, Math.round(nrand(55,20))),
            Total_Process_Time: null,
            WMS_Usage: (R()<0.9?'Active':'Idle'),
            OMS_Usage: 'Active',
            WMS_Advanced_Score: Math.max(60, Math.round(nrand(80,8))),
            Service_Quality_Score: Math.max(60, Math.round(nrand(85,7))),
            Customer_NPS: Math.max(20, Math.round(nrand(54,12))),
            Processing_Error_Rate: Math.max(0, Math.min(0.06, Math.abs(nrand(0.012,0.008)))),

            Weather_Condition: weatherName, Weather_Severity_Score: weatherS,

            Churn_Flag: churnFlag, Predicted_Churn_Score: churnScore,

            Is_Same_Day_Delivery: isSameDay, Is_Dawn_Delivery: isDawn, Is_Fresh_Delivery: isFreshDeliv,
            Is_Premium_Order: isPremium, Is_Bulk_Order: isBulk, Is_Weekend_Order: isWeekend, Is_Peak_Hour_Order: isPeak,
            Is_Free_Shipping: freeShip, Is_Weather_Risk: weatherRisk, Is_Long_Distance: longDist,
            Is_High_LTV: highLTV, Is_Churn_Risk: churnFlag, Is_VIP_Customer: isVIP, Is_Loss_Order: lossOrder, Is_AI_Optimized: aiOpt,

            Receiving_Date: ts(orderTS - 2*86400000),
            Putaway_Date: ts(orderTS - 1*86400000),
            Lot_ID: 'LOT'+String(Math.floor(R()*90000)+10000),
            Expiry_Date: (cat==='신선식품'||cat==='냉동식품')? ts(orderTS + randInt(7,20)*86400000): null,
            Bin: 'B'+randInt(1,100), Slot: 'S'+randInt(1,100),
            Unit_Cost: Math.max(1000, Math.round(unit*0.7*10)/10),
            Daily_OnHand_Snapshot: randInt(50,800),
            Safety_Stock: randInt(40,120),
            Forecast_Demand: randInt(80,260),
            ASN_ID: 'ASN'+randInt(100,9999),
            PO_ID: 'PO'+randInt(1000,9999),
            Replenishment_Type: pick(['Auto','Manual']),

            Picking_Start_TS: ts(pickStart),
            Picking_End_TS: ts(pickEnd),
            Packing_Start_TS: ts(packStart),
            Packing_End_TS: ts(packEnd),
            QC_Start_TS: ts(qcStart), QC_End_TS: ts(qcEnd),
            Label_Start_TS: ts(labelS), Label_End_TS: ts(labelE),
            Staging_In_TS: ts(stagingIn), Staging_Out_TS: ts(stagingOut),
            Dock_Assign_TS: ts(dockAssign), Dock_Arrive_TS: ts(dockArr), Dock_Release_TS: ts(dockRel),
            Security_Gate_Out_TS: ts(gateOut),

            qc_min: Math.round((qcEnd-qcStart)/60000),
            label_min: Math.round((labelE-labelS)/60000),
            staging_min: Math.round((stagingOut-stagingIn)/60000),
            dock_wait_min: Math.round((dockRel-dockArr)/60000),
            fc_total_dwell_min: fcTotalMin,
            residual_fc_internal_min: residual,

            Planned_Ship_Timestamp: ts(plannedShip),
            Actual_Ship_Timestamp: ts(fcExitTS),
            On_Time_Dispatch_Flag: (fcExitTS<=plannedShip?1:0),

            __net_Route_Type: routeType,
            __net_Sortation_Hub_Name: sortHub,
            __net_FC_Exit_TS: ts(fcExitTS),
            __net_Hub_In_TS: hubInTS? ts(hubInTS): null,
            __net_Hub_Out_TS: hubOutTS? ts(hubOutTS): null,
            __net_Camp_In_TS: ts(campInTS),
            __net_Loadout_Start_TS: ts(loadS),
            __net_Loadout_End_TS: ts(loadE),
            __net_OFD_TS: ts(ofdTS),
            __net_FC_Dwell_Min: fcTotalMin,
            __net_Hub_Dwell_Min: (hubInTS && hubOutTS)? Math.round((hubOutTS-hubInTS)/60000): null,
            __net_Camp_Dwell_Min: Math.round((ofdTS-campInTS)/60000)
          };

          // 반품 파생
          if (row.Return_Flag===1){
            row.Return_Reason = pick(['단순변심','상품하자','배송지연','오배송']);
            row.Return_Cost = Math.round(Math.max(1000, nrand(3500,900)));
            row.Is_Resellable = (row.Return_Reason==='단순변심' ? 1 : (R()<0.35?1:0));
            row.Resellability_Reason = row.Is_Resellable? '패키지 양호':'훼손/신선상품';
          }

          row.Total_Process_Time = (row.Picking_Time_Seconds + row.Packing_Time_Seconds);

          if (++emitted % CHUNK === 0){
            postMessage({type:'rows', rows:[row]});
            postMessage({type:'progress', processed: emitted, total: totalRows});
            // NOTE: 행 단위로 보내 UI 반응성 ↑ (큰 청크 묶음이 문제였던 포인트 FIX)
          } else {
            postMessage({type:'rows', rows:[row]});
          }

          if (emitted % Math.max(1000, Math.floor(CHUNK/2)) === 0){
            await new Promise(r=> setTimeout(r, 0));
          }
        }

        postMessage({type:'progress', processed: emitted, total: totalRows});
        postMessage({type:'done'});
      }
    `;
    const blob = new Blob([code], { type: 'application/javascript' });
    return new Worker(URL.createObjectURL(blob));
  }

  // ==========================
  // 11) UI 이벤트 & 초기화
  // ==========================
  function clearTable() {
    DATA.length = 0; TABLE_KEYS = null;
    const thead = qs('tbl').querySelector('thead'); const tbody = qs('tbl').querySelector('tbody');
    thead.innerHTML = ''; tbody.innerHTML = '';
  }

  function startGeneration() {
    if (PROCESSING_STATE.isRunning) return;
    clearTable();
    Object.assign(AGG, resetAgg());

    const startYear = Number(qs('startYear').value);
    const endYear = Number(qs('endYear').value);
    const userCount = Math.max(100, Number(qs('userCount').value));
    const totalRows = Math.max(500, Number(qs('orderCount').value));
    const chunkSize = Math.max(500, Number(qs('chunkSize').value));
    const rocketRate = Number(qs('rocketRate').value);
    const wowRate = Number(qs('wowRate').value);
    FAST_MODE = !!qs('fastMode').checked;

    const CAL = {
      lossLo: parseFloat(qs('dial_loss_lo').value),
      lossHi: parseFloat(qs('dial_loss_hi').value),
      tempLo: parseFloat(qs('dial_temp_lo').value),
      tempHi: parseFloat(qs('dial_temp_hi').value),
      jejuLo: parseFloat(qs('dial_jeju_lo').value),
      jejuHi: parseFloat(qs('dial_jeju_hi').value),
      overLo: parseFloat(qs('dial_over_lo').value),
      overHi: parseFloat(qs('dial_over_hi').value),
      expLo: parseFloat(qs('dial_exp_lo').value),
      expHi: parseFloat(qs('dial_exp_hi').value),
    };

    PROCESSING_STATE = { isRunning: true, shouldStop:false, startTime: Date.now(), processedRows:0, totalRows };
    showProgress(true); setStatus('RUNNING', 'running');
    setDisabled('btnStart', true); setDisabled('btnStop', false); setDisabled('btnCsv', true); setDisabled('btnCsvTurbo', true);

    WORKER = createWorker();
    WORKER.onmessage = (e) => {
      const m = e.data || {};
      if (m.type === 'rows') {
        ingestRows(m.rows || []);
      } else if (m.type === 'progress') {
        PROCESSING_STATE.processedRows = m.processed || PROCESSING_STATE.processedRows;
        PROCESSING_STATE.totalRows = m.total || PROCESSING_STATE.totalRows;
        updateProgressFromState('Generating');
      } else if (m.type === 'done') {
        PROCESSING_STATE.isRunning = false;
        setStatus('READY', 'ok');
        setDisabled('btnStop', true);
        setDisabled('btnStart', false);
        setDisabled('btnCsv', DATA.length>0 ? false:true);
        setDisabled('btnCsvTurbo', DATA.length>0 ? false:true);
        showProgress(false);
        try { WORKER.terminate(); } catch(_) {}
        WORKER = null;
      } else if (m.type === 'stopped') {
        PROCESSING_STATE.isRunning = false;
        setStatus('STOPPED', 'ng');
        setDisabled('btnStop', true);
        setDisabled('btnStart', false);
        showProgress(false);
        try { WORKER.terminate(); } catch(_) {}
        WORKER = null;
      }
    };

    const seed = (Math.random()*0xFFFFFFFF)>>>0;
    WORKER.postMessage({
      cmd:'start',
      cfg:{
        seed, startYear, endYear, userCount, totalRows, chunkSize,
        rocketRate, wowRate, CAL, FAST_MODE
      }
    });
  }

  function stopGeneration() {
    if (WORKER) {
      PROCESSING_STATE.shouldStop = true;
      try { WORKER.postMessage({cmd:'stop'}); } catch(_) {}
    }
  }

  function initYears(){
    const now = new Date();
    const thisY = now.getFullYear();
    const years = [];
    for (let y = thisY - 3; y <= thisY; y++) years.push(y);
    const startSel = qs('startYear'); const endSel = qs('endYear');
    startSel.innerHTML = ''; endSel.innerHTML = '';
    years.forEach(y=> {
      const o1=document.createElement('option'); o1.value=String(y); o1.textContent=String(y); startSel.appendChild(o1);
      const o2=document.createElement('option'); o2.value=String(y); o2.textContent=String(y); endSel.appendChild(o2);
    });
    startSel.value = String(thisY - 1);
    endSel.value = String(thisY);
  }

  function hookEvents(){
    qs('btnStart').addEventListener('click', startGeneration);
    qs('btnStop').addEventListener('click', stopGeneration);
    qs('btnCsv').addEventListener('click', downloadCSV);
    qs('btnCsvTurbo').addEventListener('click', downloadCSVGzip);
    qs('btnTune').addEventListener('click', ()=> {
      const p = qs('tunePanel');
      p.style.display = (p.style.display==='none'?'block':'none');
    });
    qs('btnApplyDials').addEventListener('click', ()=> {
      qs('tuneStatus').textContent = 'DIALS APPLIED';
      qs('tuneStatus').className = 'pill ok';
    });
    qs('btnResetDials').addEventListener('click', ()=> {
      const setv=(id,v)=> qs(id).value = String(v);
      setv('dial_loss_lo', 0.07); setv('dial_loss_hi', 0.12);
      setv('dial_temp_lo', 0.01); setv('dial_temp_hi', 0.02);
      setv('dial_jeju_lo', 0.10); setv('dial_jeju_hi', 0.15);
      setv('dial_over_lo', 0.15); setv('dial_over_hi', 0.25);
      setv('dial_exp_lo', 0.005); setv('dial_exp_hi', 0.01);
      qs('tuneStatus').textContent = 'DIALS RESET';
      qs('tuneStatus').className = 'pill running';
    });
  }

  // 초기화
  (function bootstrap(){
    initYears(); hookEvents();
    setStatus('READY', 'ok');
  })();
</script>
</body>
</html>
