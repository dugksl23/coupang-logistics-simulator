<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ - í†µí•© ì•ˆì •íŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg:#f7fafc; --card:#fff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --pri:#2563eb;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --vio:#8b5cf6; --cyan:#06b6d4; --rocket:#ff6b35; --wow:#9333ea; --fresh:#059669
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1800px;margin:0 auto;padding:20px}
    .header{background:linear-gradient(135deg,#ff6b35 0%,#f7931e 50%,#9333ea 100%);color:#fff;border-radius:16px;padding:28px 32px;margin-bottom:20px;box-shadow:0 12px 32px rgba(255,107,53,.25);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,255,255,.05) 10px,rgba(255,255,255,.05) 20px);animation:slide 20s linear infinite}
    @keyframes slide{0%{transform:translateX(-50px)}100%{transform:translateX(50px)}}
    .header h1{margin:0 0 8px 0;font-size:24px;position:relative;z-index:1}
    .header .sub{opacity:.9;font-size:14px;position:relative;z-index:1}
    .header .reality-badge{position:absolute;top:20px;right:30px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-radius:12px;padding:8px 16px;font-size:12px;font-weight:700;border:1px solid rgba(255,255,255,.3)}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 6px 20px rgba(2,6,23,.08)}
    .controls{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
    .ctrl{display:flex;flex-direction:column;gap:6px}
    .ctrl label{font-size:12px;color:var(--muted);font-weight:600}
    .ctrl input,.ctrl select{padding:8px 12px;border:1px solid var(--line);border-radius:10px;min-width:130px}
    .btn{background:var(--pri);color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;transition:all .3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(37,99,235,.3)}
    .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none}
    .btn.secondary{background:#374151}.btn.danger{background:var(--bad)}.btn.rocket{background:var(--rocket)}.btn.wow{background:var(--wow)}
    .progress-container{margin:12px 0;display:none}
    .progress-bar{width:100%;height:10px;background:var(--line);border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(45deg,var(--rocket),var(--wow));width:0%;transition:width .2s ease}
    .progress-text{font-size:13px;color:var(--muted);margin-top:6px;text-align:center;font-weight:600}
    .progress-stats{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:6px}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;position:relative;transition:transform .3s}
    .kpi:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(2,6,23,.12)}
    .kpi h4{margin:0 0 10px 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;display:flex;align-items:center;gap:6px}
    .kpi .v{font-size:28px;font-weight:800;margin-bottom:4px}.kpi .meta{font-size:11px;color:var(--muted)}
    .kpi.primary{border-top:4px solid var(--pri)}.kpi.good{border-top:4px solid var(--good)}.kpi.warn{border-top:4px solid var(--warn)}.kpi.bad{border-top:4px solid var(--bad)}
    .kpi.rocket{border-top:4px solid var(--rocket)}.kpi.wow{border-top:4px solid var(--wow)}.kpi.fresh{border-top:4px solid var(--fresh)}.kpi.cyan{border-top:4px solid var(--cyan)}
    .pill{display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600}
    .pill.ok{background:#dcfce7;color:#065f46}.pill.ng{background:#fee2e2;color:#991b1b}.pill.running{background:#dbeafe;color:#1e40af}
    .sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:18px;margin-top:12px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    .section h3{margin:0 0 12px 0;font-size:17px;display:flex;align-items:center;gap:8px}
    .alerts{display:flex;flex-direction:column;gap:10px;max-height:280px;overflow:auto}
    .alert{padding:12px 15px;border-radius:12px;font-size:13px;border:1px solid;transition:all .3s}.alert:hover{transform:translateX(4px)}
    .alert.good{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}.alert.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}.alert.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:0;margin-top:18px;overflow:hidden}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{position:sticky;top:0;background:#f9fafb;border-bottom:2px solid var(--line)}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:center;white-space:nowrap}
    th{font-weight:700;color:var(--ink)}
    .delivery-mode.rocket{color:var(--rocket);font-weight:600}
    .delivery-mode.dawn{color:var(--wow);font-weight:600}
    .delivery-mode.fresh{color:var(--fresh);font-weight:600}
    @media (max-width:768px){
      .controls{flex-direction:column;align-items:flex-start}
      .ctrl input,.ctrl select{min-width:280px}
      .sections{grid-template-columns:1fr}
      .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    }
    /* FAST MODE í† ê¸€ */
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e1;border-radius:999px;transition:.2s}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
    .switch input:checked + .slider{background:#22c55e}
    .switch input:checked + .slider:before{transform:translateX(20px)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="reality-badge">í˜„ì‹¤ì„± 95%</div>
    <h1>ğŸš€ ì¿ íŒ¡ ë¬¼ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œìŠ¤í…œ (Coupang Logistics Reality Simulator)</h1>
    <div class="sub">ğŸ¯ ë¡œì¼“ë°°ì†¡Â·ì‹ ì„ ì‹í’ˆÂ·WOWÂ·AIìë™í™” | FCÂ·í—ˆë¸Œ ë¶„ë¦¬ | ì…ê³ /ì ì¹˜/ìœ í†µê¸°í•œ/ë¡œì¼€ì´ì…˜ í¬í•¨</div>
  </div>

  <div class="panel">
    <div class="controls">
      <div class="ctrl"><label>ì‹œì‘ë…„ë„ / Start Year</label><select id="startYear"></select></div>
      <div class="ctrl"><label>ì¢…ë£Œë…„ë„ / End Year</label><select id="endYear"></select></div>
      <div class="ctrl"><label>ê³ ê° ìˆ˜ / #Users</label><input id="userCount" type="number" min="100" max="200000" value="300"></div>
      <div class="ctrl"><label>ì£¼ë¬¸ ìˆ˜ / #Orders</label><input id="orderCount" type="number" min="500" max="10000000" step="1000" value="10000"></div>
      <div class="ctrl"><label>ì²­í¬ í¬ê¸° / Chunk Size</label><input id="chunkSize" type="number" min="500" max="15000" step="500" value="3000"></div>
      <div class="ctrl"><label>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘ / Rocket Rate (%)</label><input id="rocketRate" type="number" min="35" max="90" value="55"></div>
      <div class="ctrl"><label>WOW ê°€ì…ë¥  / WOW Rate (%)</label><input id="wowRate" type="number" min="60" max="100" value="80"></div>
      <div class="ctrl"><label>ëª©í‘œ ìˆœì´ìµë¥ (%)</label><input id="targetNetMargin" type="number" step="0.1" value="3.2" min="-20" max="30"></div>
      <div class="ctrl">
        <label>FAST MODE</label>
        <label class="switch"><input type="checkbox" id="fastMode"><span class="slider"></span></label>
      </div>
      <button class="btn rocket" id="btnStart">â–¶ï¸ ë°ì´í„° ìƒì„± / Generate</button>
      <button class="btn secondary" id="btnTune">âš™ï¸ DIALS</button>
      <button class="btn danger" id="btnStop" disabled>â¹ï¸ ì¤‘ë‹¨ / Stop</button>
      <button class="btn wow" id="btnCsv" disabled>ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ / Download CSV</button>
      <button class="btn wow" id="btnCsvTurbo" disabled>âš¡ï¸ ì´ˆê³ ì† CSV (GZIP)</button>
      <div id="status" class="pill ok" style="margin-left:auto">READY</div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘... / Processing...</div>
      <div class="progress-stats"><span id="progressStats">-</span><span id="progressETA">ì˜ˆìƒ ì™„ë£Œ: - / ETA: -</span></div>
    </div>
  </div>

  <!-- DIALS -->
  <div class="panel" id="tunePanel" style="display:block">
    <div class="controls" style="align-items:flex-start">
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœì†Œ</label><input id="dial_loss_lo" type="number" step="0.001" min="0" max="1" value="0.07"></div>
      <div class="ctrl"><label>ì ìì£¼ë¬¸ìœ¨ ìµœëŒ€</label><input id="dial_loss_hi" type="number" step="0.001" min="0" max="1" value="0.12"></div>
      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœì†Œ</label><input id="dial_temp_lo" type="number" step="0.001" min="0" max="1" value="0.01"></div>
      <div class="ctrl"><label>ì˜¨ë„ìœ„ë°˜ìœ¨ ìµœëŒ€</label><input id="dial_temp_hi" type="number" step="0.001" min="0" max="1" value="0.02"></div>
      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœì†Œ</label><input id="dial_jeju_lo" type="number" step="0.001" min="0" max="1" value="0.10"></div>
      <div class="ctrl"><label>ì œì£¼ ì•…ì²œí›„ ìµœëŒ€</label><input id="dial_jeju_hi" type="number" step="0.001" min="0" max="1" value="0.15"></div>
      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœì†Œ</label><input id="dial_over_lo" type="number" step="0.001" min="0" max="1" value="0.15"></div>
      <div class="ctrl"><label>ê³¼ì¬ê³  ìµœëŒ€</label><input id="dial_over_hi" type="number" step="0.001" min="0" max="1" value="0.25"></div>
      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœì†Œ</label><input id="dial_exp_lo" type="number" step="0.001" min="0" max="1" value="0.005"></div>
      <div class="ctrl"><label>ìœ í†µê¸°í•œ ì„ë°• ìµœëŒ€</label><input id="dial_exp_hi" type="number" step="0.001" min="0" max="1" value="0.01"></div>
    </div>
    <div class="controls">
      <button class="btn wow" id="btnApplyDials">ì ìš©</button>
      <button class="btn secondary" id="btnResetDials">ì´ˆê¸°í™”</button>
      <div id="tuneStatus" class="pill ok">DIALS READY</div>
    </div>
  </div>

  <!-- KPI ì„¹ì…˜ë“¤ (ë™ì¼) -->
  <div class="sections">
    <div class="section"><h3>ğŸš€ ë¡œì¼“ë°°ì†¡ ì„±ê³¼</h3>
      <div class="kpi-grid">
        <div class="kpi rocket"><h4>ë¡œì¼“ë°°ì†¡ ë¹„ì¤‘</h4><div class="v" id="k_rocketShare">-</div><div class="meta">% of orders</div></div>
        <div class="kpi rocket"><h4>ë¡œì¼“ë‹¹ì¼ ì„±ê³µë¥ </h4><div class="v" id="k_rocketSameDayRate">-</div><div class="meta">%</div></div>
        <div class="kpi rocket"><h4>ë¡œì¼“ìƒˆë²½ ì •ì‹œìœ¨</h4><div class="v" id="k_rocketDawnRate">-</div><div class="meta">%</div></div>
        <div class="kpi rocket"><h4>30ë¶„ë‚´ ì¶œê³ ìœ¨</h4><div class="v" id="k_fastShipRate">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ“¦ ì¶œê³ Â·í’€í•„ë¨¼íŠ¸</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì •ì‹œ ì¶œê³ ìœ¨</h4><div class="v" id="k_fcOnTimeShip">-</div><div class="meta">ëª©í‘œ â‰¥ 96%</div></div>
        <div class="kpi"><h4>í‰ê·  ì¶œê³  ì‹œê°„</h4><div class="v" id="k_fcAvgShipHour">-</div><div class="meta">ì‹œê°„</div></div>
        <div class="kpi"><h4>í”¼í‚¹ ì†ë„</h4><div class="v" id="k_fcPickSecPerItem">-</div><div class="meta">ì´ˆ/ê°œ</div></div>
        <div class="kpi"><h4>íŒ¨í‚¹ ì†ë„</h4><div class="v" id="k_fcPackSecPerItem">-</div><div class="meta">ì´ˆ/ê°œ</div></div>
        <div class="kpi good"><h4>í’€í•„ë¨¼íŠ¸ íš¨ìœ¨</h4><div class="v" id="k_fcEfficiency">-</div><div class="meta">%</div></div>
        <div class="kpi wow"><h4>60ë¶„ë‚´ ì¶œê³ ìœ¨</h4><div class="v" id="k_fcShipUnder60">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸŒŸ WOW ë©¤ë²„ì‹­ & í”„ë¦¬ë¯¸ì—„</h3>
      <div class="kpi-grid">
        <div class="kpi wow"><h4>WOW ê°€ì…ë¥ </h4><div class="v" id="k_wowShare">-</div><div class="meta">%</div></div>
        <div class="kpi wow"><h4>WOW Plus ë¹„ì¤‘</h4><div class="v" id="k_wowPlusShare">0</div><div class="meta">%</div></div>
        <div class="kpi wow"><h4>WOW vs ë¹„íšŒì› AOV ì°¨ì´</h4><div class="v" id="k_wowAovGap">-</div><div class="meta">â‚©</div></div>
        <div class="kpi warn"><h4>WOW ì´íƒˆ ìœ„í—˜ ê³ ê°</h4><div class="v" id="k_wowChurnRisk">-</div><div class="meta">ëª…</div></div>
      </div>
    </div>
    <div class="section"><h3>â„ï¸ ì‹ ì„ ì‹í’ˆ & ì½œë“œì²´ì¸</h3>
      <div class="kpi-grid">
        <div class="kpi fresh"><h4>ì‹ ì„ ì‹í’ˆ ë¹„ì¤‘</h4><div class="v" id="k_freshShare">-</div><div class="meta">%</div></div>
        <div class="kpi fresh"><h4>ì½œë“œì²´ì¸ ì¤€ìˆ˜ìœ¨</h4><div class="v" id="k_coldChainRate">-</div><div class="meta">%</div></div>
        <div class="kpi warn"><h4>ì˜¨ë„ ìœ„ë°˜ìœ¨</h4><div class="v" id="k_tempViolation">-</div><div class="meta">%</div></div>
        <div class="kpi fresh"><h4>ëƒ‰ë™ì‹í’ˆ í’ˆì§ˆ ì ìˆ˜</h4><div class="v" id="k_frozenQuality">-</div><div class="meta">/100</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ­ í—ˆë¸Œ&ìŠ¤í¬í¬ ë¬¼ë¥˜ë§</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ë©”ê°€í—ˆë¸Œ ì²˜ë¦¬ ë¹„ì¤‘</h4><div class="v" id="k_megaHubShare">-</div><div class="meta">%</div></div>
        <div class="kpi primary"><h4>ìˆ˜ë„ê¶Œ ì»¤ë²„ë¦¬ì§€</h4><div class="v" id="k_seoulCoverage">-</div><div class="meta">%</div></div>
        <div class="kpi good"><h4>í‰ê·  ë°°ì†¡ ê±°ë¦¬</h4><div class="v" id="k_avgDistance">-</div><div class="meta">km</div></div>
        <div class="kpi primary"><h4>ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±</h4><div class="v" id="k_networkEff">-</div><div class="meta">ì </div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ¤– AI & ìë™í™” ìˆ˜ì¤€</h3>
      <div class="kpi-grid">
        <div class="kpi cyan"><h4>AI ìµœì í™” ë¹„ìœ¨</h4><div class="v" id="k_aiOptimized">-</div><div class="meta">%</div></div>
        <div class="kpi cyan"><h4>ìë™ í”¼í‚¹ìœ¨</h4><div class="v" id="k_autoPickRate">-</div><div class="meta">%</div></div>
        <div class="kpi good"><h4>í‰ê·  í”¼í‚¹ ì‹œê°„</h4><div class="v" id="k_avgPickTime">-</div><div class="meta">ì´ˆ</div></div>
        <div class="kpi cyan"><h4>WMS ê³ ë„í™” ì ìˆ˜</h4><div class="v" id="k_wmsAdvanced">-</div><div class="meta">/100</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ’° ë§¤ì¶œÂ·ìˆ˜ìµ</h3>
      <div class="kpi-grid">
        <div class="kpi primary"><h4>ì´ ë§¤ì¶œ</h4><div class="v" id="k_totalSales">-</div><div class="meta">â‚©</div></div>
        <div class="kpi good"><h4>ìˆœì´ìµë¥ </h4><div class="v" id="k_netMargin">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>í‰ê· ì£¼ë¬¸ê¸ˆì•¡</h4><div class="v" id="k_aov">-</div><div class="meta">â‚©</div></div>
        <div class="kpi"><h4>ARPPU</h4><div class="v" id="k_arppu">-</div><div class="meta">â‚©</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ‘¥ ê³ ê°</h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>LTV:CAC</h4><div class="v" id="k_ltvCac">-</div></div>
        <div class="kpi"><h4>ìœ ì§€ìœ¨</h4><div class="v" id="k_retention">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì´íƒˆë¥ </h4><div class="v" id="k_churn">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>AI ì´íƒˆ ì˜ˆì¸¡ ì •í™•ë„</h4><div class="v" id="k_ai">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸšš ë°°ì†¡Â·ë¬¼ë¥˜</h3>
      <div class="kpi-grid">
        <div class="kpi good"><h4>ì •ì‹œìœ¨</h4><div class="v" id="k_onTime">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>SLA ìœ„ë°˜ìœ¨</h4><div class="v" id="k_sla">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì ì¬ìœ¨</h4><div class="v" id="k_load">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì—°ë¹„</h4><div class="v" id="k_fuel">-</div><div class="meta">km/â„“ Â· km/kWh</div></div>
        <div class="kpi"><h4>ë¼ìš°íŒ… ì ìˆ˜</h4><div class="v" id="k_route">-</div><div class="meta">/100</div></div>
        <div class="kpi warn"><h4>ë°°ì†¡ ì˜ˆì™¸ìœ¨</h4><div class="v" id="k_exception">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ“¦ ë°˜í’ˆ</h3>
      <div class="kpi-grid">
        <div class="kpi warn"><h4>ë°˜í’ˆë¥ </h4><div class="v" id="k_returnRate">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ë°˜í’ˆ ì†ì‹¤ë¥ </h4><div class="v" id="k_returnCost">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì¬íŒë§¤ ê°€ëŠ¥ë¥ </h4><div class="v" id="k_resell">-</div><div class="meta">%</div></div>
      </div>
    </div>
    <div class="section"><h3>ğŸ­ WMSÂ·ì¬ê³ </h3>
      <div class="kpi-grid">
        <div class="kpi"><h4>ì¬ê³  íšŒì „ìœ¨</h4><div class="v" id="k_invTurn">-</div><div class="meta">íšŒ</div></div>
        <div class="kpi"><h4>í’ˆì ˆë¥ </h4><div class="v" id="k_stockout">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ê³¼ì¬ê³  ë¹„ìœ¨</h4><div class="v" id="k_overstock">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì¬ê³  ì •í™•ë„</h4><div class="v" id="k_invAcc">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>ì¬ê³  ì†ì‹¤ë¥ </h4><div class="v" id="k_shrink">-</div><div class="meta">%</div></div>
        <div class="kpi"><h4>WMS í™œìš©ë¥ </h4><div class="v" id="k_wms">-</div><div class="meta">%</div></div>
      </div>
    </div>
  </div>

  <div class="sections">
    <div class="section"><h3>âœ… ì¿ íŒ¡ íŠ¹í™” ì •í•©ì„± ê²€ì‚¬</h3>
      <div id="validateSummary" class="pill ok">-</div>
      <div class="alerts" id="validateList"></div>
    </div>
    <div class="section"><h3>âš ï¸ ì¿ íŒ¡ ë³µí•© ìœ„í—˜ ìš”ì†Œ</h3>
      <div class="alerts" id="riskList"></div>
    </div>
    <div class="section"><h3>ğŸ“Š ì²˜ë¦¬ ì„±ëŠ¥ & í˜„ì‹¤ì„± ì§€í‘œ</h3>
      <div class="alerts" id="perfList"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* ==========================
     0) ë„¤íŠ¸ì›Œí¬ íƒ€ì„ë¼ì¸ í‚¤ (ë©”ì¸/ì›Œì»¤ ê³µí†µ í‚¤ê°’)
  ========================== */
  const NET_PREFIX='__net_';
  const N=s=>NET_PREFIX+s;
  const NET=Object.freeze({
    ROUTE_TYPE:N('Route_Type'),
    SORT_HUB_NAME:N('Sortation_Hub_Name'),
    FC_EXIT:N('FC_Exit_TS'),
    HUB_IN:N('Hub_In_TS'),
    HUB_OUT:N('Hub_Out_TS'),
    CAMP_IN:N('Camp_In_TS'),
    LOAD_START:N('Loadout_Start_TS'),
    LOAD_END:N('Loadout_End_TS'),
    OFD:N('OFD_TS'),
    FC_DWELL:N('FC_Dwell_Min'),
    HUB_DWELL:N('Hub_Dwell_Min'),
    CAMP_DWELL:N('Camp_Dwell_Min'),
  });

  /* ==========================
     1) CSV ë¼ë²¨/ìœ í‹¸ (ê·¸ëŒ€ë¡œ ìœ ì§€)
  ========================== */
  const CSV_SPECIAL_LABELS={
    Order_ID:'Order ID',Order_Date:'Order Date',Order_Timestamp:'Order Timestamp',Order_Hour:'Order Hour',
    Delivery_Mode:'Delivery Mode',Planned_Delivery_Date:'Planned Delivery Date',Actual_Delivery_Date:'Actual Delivery Date',
    Delivery_Timestamp:'Delivery Timestamp',Is_Delayed:'Is Delayed',Delay_Hours:'Delay Hours',SLA_Breach:'SLA Breach',Delivery_Status:'Delivery Status',
    Fast_Ship_30min:'Fast Ship 30min',Order_To_Ship_Minutes:'Order To Ship Minutes',
    Region:'Region',City:'City',District:'District',Address:'Address',Fulfillment_Center:'Fulfillment Center',Delivery_Center:'Delivery Center',Is_Mega_Hub:'Is Mega Hub',Distance_km:'Distance km',
    Customer_ID:'Customer ID',Is_WOW_Member:'Is WOW Member',WOW_Tier:'WOW Tier',WOW_Join_Date:'WOW Join Date',WOW_Tenure_Days:'WOW Tenure Days',Customer_Segment:'Customer Segment',
    Product_Category:'Product Category',SKU:'SKU',ABC_Category:'ABC Category',Unit_Price:'Unit Price',Quantity:'Quantity',Order_Amount:'Order Amount',
    Is_Fresh_Food:'Is Fresh Food',Is_Cold_Chain_Required:'Is Cold Chain Required',Target_Temperature:'Target Temperature',Actual_Temperature:'Actual Temperature',
    Temperature_Violation:'Temperature Violation',Cold_Chain_Quality_Score:'Cold Chain Quality Score',
    Vehicle_ID:'Vehicle ID',Vehicle_Type:'Vehicle Type',Vehicle_Capacity:'Vehicle Capacity',Driver_ID:'Driver ID',Driver_Grade:'Driver Grade',
    Load_Factor:'Load Factor',Fuel_Efficiency:'Fuel Efficiency',Routing_Score:'Routing Score',GPS_Tracking:'GPS Tracking',
    Actual_Logistics_Cost:'Actual Logistics Cost',Customer_Delivery_Charge:'Customer Delivery Charge',Gross_Profit:'Gross Profit',Net_Profit:'Net Profit',
    CAC:'CAC',Customer_LTV:'Customer LTV',LTV_to_CAC:'LTV to CAC',
    Return_Flag:'Is Returned',Return_Reason:'Return Reason',Return_Cost:'Return Cost',Is_Resellable:'Is Resellable',Resellability_Reason:'Resellability Reason',
    Current_Stock:'Current Stock',Reorder_Point:'Reorder Point',Stockout_Flag:'Stockout Flag',Overstock_Flag:'Overstock Flag',Inventory_Turnover:'Inventory Turnover',Inventory_Accuracy:'Inventory Accuracy',
    Automation_Level:'Automation Level',Picking_Time_Seconds:'Picking Time Seconds',Packing_Time_Seconds:'Packing Time Seconds',Total_Process_Time:'Total Process Time',
    WMS_Usage:'WMS Usage',OMS_Usage:'OMS Usage',WMS_Advanced_Score:'WMS Advanced Score',Service_Quality_Score:'Service Quality Score',Customer_NPS:'Customer NPS',Processing_Error_Rate:'Processing Error Rate',
    Weather_Condition:'Weather Condition',Weather_Severity_Score:'Weather Severity Score',Churn_Flag:'Churn Flag',Predicted_Churn_Score:'Predicted Churn Score',
    Is_Rocket_Delivery:'Is Rocket Delivery',Is_Same_Day_Delivery:'Is Same Day Delivery',Is_Dawn_Delivery:'Is Dawn Delivery',Is_Fresh_Delivery:'Is Fresh Delivery',
    Is_Premium_Order:'Is Premium Order',Is_Bulk_Order:'Is Bulk Order',Is_Weekend_Order:'Is Weekend Order',Is_Peak_Hour_Order:'Is Peak Hour Order',Is_Free_Shipping:'Is Free Shipping',
    Is_Weather_Risk:'Is Weather Risk',Is_Long_Distance:'Is Long Distance',Is_High_LTV:'Is High LTV',Is_Churn_Risk:'Is Churn Risk',Is_VIP_Customer:'Is VIP Customer',
    Is_Loss_Order:'Is Loss Order',Is_AI_Optimized:'Is AI Optimized',
    Receiving_Date:'Receiving Date',Putaway_Date:'Putaway Date',Lot_ID:'Lot ID',Expiry_Date:'Expiry Date',Bin:'Bin',Slot:'Slot',Unit_Cost:'Unit Cost',
    Daily_OnHand_Snapshot:'Daily OnHand Snapshot',Safety_Stock:'Safety Stock',Forecast_Demand:'Forecast Demand',ASN_ID:'Asn Id',PO_ID:'Po Id',Replenishment_Type:'Replenishment Type',
    Picking_Start_TS:'Picking Start TS',Picking_End_TS:'Picking End TS',Packing_Start_TS:'Packing Start TS',Packing_End_TS:'Packing End TS',
    Planned_Ship_Timestamp:'Planned Ship Timestamp',
    Actual_Ship_Timestamp:'Actual Ship Timestamp',On_Time_Dispatch_Flag:'On-time Dispatch Flag',
    Is_Quality_Issue:'Is Quality Issue',Mis_Ship_Flag:'Mis ship Flag',
    Damage_Rate:'Damage Rate',Damage_Flag:'Damage Flag',
    Distance_Bucket:'Distance Bucket',Distance_Band_Label:'Distance Band Label',
    [NET.ROUTE_TYPE]:'Route Type',[NET.SORT_HUB_NAME]:'Sortation Hub Name',[NET.FC_EXIT]:'FC Exit TS',[NET.HUB_IN]:'Hub In TS',[NET.HUB_OUT]:'Hub Out TS',
    [NET.CAMP_IN]:'Camp In TS',[NET.LOAD_START]:'Loadout Start TS',[NET.LOAD_END]:'Loadout End TS',[NET.OFD]:'OFD TS',
    [NET.FC_DWELL]:'FC Dwell Min',[NET.HUB_DWELL]:'Hub Dwell Min',[NET.CAMP_DWELL]:'Camp Dwell Min'
  };
  function prettyHeader(key){if(CSV_SPECIAL_LABELS[key])return CSV_SPECIAL_LABELS[key];return key.replace(/^_+/,'').replace(/__/g,'_').replace(/[_]/g,' ').replace(/([a-z0-9])([A-Z])/g,'$1 $2').replace(/\s+/g,' ').trim().replace(/\b\w/g,m=>m.toUpperCase())}

  /* ==========================
     2) ì „ì—­ ìƒíƒœ / ìœ í‹¸ (ë©”ì¸ ìŠ¤ë ˆë“œ)
  ========================== */
  let DATA=[]; // ì „ì²´ ë°ì´í„°(ë©”ëª¨ë¦¬ ë³´ê´€) â€” ìŠ¤í‚¤ë§ˆ ë™ì¼
  let TABLE_KEYS=null;
  let WORKER=null; // WORKER: ìƒì„±ìš© ì›¹ì›Œì»¤ í•¸ë“¤
  let FAST_MODE=false;

  const CHUNK_CONFIG={defaultSize:3000,maxMemoryRows:150000,batchUpdateInterval:3,gcInterval:8};
  const RENDER_MAX_ROWS=2000; // PERF: í…Œì´ë¸” ê°€ìƒí™” ìƒí•œ

  let PROCESSING_STATE={isRunning:false,shouldStop:false,startTime:null,processedRows:0,totalRows:0};

  // PERF: ìŠ¤ë¡œí‹€/ì• ë‹ˆë©”ì´ì…˜ìš©
  let _throttleTS=0;
  const _THROTTLE_MS=100; // ìµœëŒ€ 10Hz
  const raf=(fn)=>window.requestAnimationFrame?requestAnimationFrame(fn):setTimeout(fn,16);
  const qs=id=>document.getElementById(id);
  const setText=(id,txt)=>{const el=qs(id);if(el)el.textContent=txt};
  const setDisabled=(id,flag)=>{const el=qs(id);if(el)el.disabled=!!flag};
  const setDisplay=(id,show)=>{const el=qs(id);if(el)el.style.display=show?'':'none'};
  const pad=(n,l=2)=>String(n).padStart(l,'0');
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  function formatCurrencyKRW(n){if(!isFinite(n))return '-';return 'â‚©'+Math.round(n).toLocaleString('ko-KR')}

  // ì§„í–‰ ë°”
  function setStatus(text,cls='ok'){const st=qs('status');st.textContent=text;st.className='pill '+cls;}
  function showProgress(show){setDisplay('progressContainer',show)}
  function _updateProgressUI(label, processed, total){
    const pctNum=Math.min(100,Math.round(processed/Math.max(1,total)*100));
    qs('progressFill').style.width=pctNum+'%';
    qs('progressText').textContent=`${label}... ${processed.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pctNum}%)`;
    const elapsed=(Date.now()-PROCESSING_STATE.startTime)/1000;
    const rps=processed/Math.max(0.1,elapsed);
    qs('progressStats').textContent=`ì†ë„ ${rps.toFixed(1)} r/s`;
    const remain=(total-processed)/Math.max(0.1,rps);
    qs('progressETA').textContent=`ì˜ˆìƒ ì™„ë£Œ: ${remain.toFixed(0)}s`;
  }
  function updateProgressFromState(label='Generating'){
    const now=Date.now();
    if(now-_throttleTS<_THROTTLE_MS) return;
    _throttleTS=now;
    raf(()=>_updateProgressUI(label, PROCESSING_STATE.processedRows, PROCESSING_STATE.totalRows));
  }
  function updateExportProgress(done,total){
    const pctNum=Math.min(100,Math.round(done/Math.max(1,total)*100));
    qs('progressFill').style.width=pctNum+'%';
    qs('progressText').textContent=`Exporting CSV... ${done.toLocaleString('ko-KR')} / ${total.toLocaleString('ko-KR')} (${pctNum}%)`;
    qs('progressStats').textContent=`ì²­í¬ ì§„í–‰`;
    qs('progressETA').textContent='';
  }

  /* ==========================
     3) KPI/ê²€ì¦ ìŠ¤íŠ¸ë¦¬ë° ì§‘ê³„ (O(1) ì—…ë°ì´íŠ¸)
  ========================== */
  const AGG=resetAgg();
  function resetAgg(){
    return {
      total:0,

      // ë°°ì†¡ ëª¨ë“œ ê´€ë ¨
      rocket:0,
      sameDayTotal:0, sameDayOnTime:0,
      dawnTotal:0, dawnOnTime:0,
      fastShip30:0,
      shipUnder60:0,
      fcSlaBreach:0,

      // ì‹œê°„/íš¨ìœ¨
      shipMinutesSum:0,
      pickPerItemSum:0, packPerItemSum:0,
      procErrRateSum:0,

      // WOW
      wowCount:0, wowSales:0, nonWowSales:0, wowOrders:0, nonWowOrders:0, wowChurnRisk:0,

      // ì¹´í…Œê³ ë¦¬/ì½œë“œì²´ì¸
      freshCount:0, coldReq:0, tempViol:0,
      frozenQualitySum:0, frozenCnt:0,

      // ë„¤íŠ¸ì›Œí¬/ê±°ë¦¬
      megaHub:0, metro:0, distanceSum:0, routingSum:0,

      // ìë™í™”
      aiOpt:0, autoPickScoreSum:0, pickTimeSum:0, wmsAdvSum:0,

      // ì¬ë¬´
      salesSum:0, netProfitSum:0,

      // ê³ ê°
      ltvSum:0, cacSum:0,
      uniqueCustomers:new Set(),
      churnRisk:0,
      aiAccEqual:0, // (Is_Churn_Risk === Churn_Flag)

      // ë°°ì†¡ ì§€í‘œ
      onTime:0, delay:0,
      loadSum:0, fuelSum:0, routeSum:0, exception:0,

      // ë°˜í’ˆ
      returnCnt:0, returnCostSum:0, resellCnt:0,

      // ì¬ê³ /WMS
      invTurnSum:0, stockoutCnt:0, overstockCnt:0, invAccSum:0, wmsActiveCnt:0,

      // ìœ„í—˜/ì •í•©ì„±ìš©
      lossOrderCnt:0,
      jejuWeatherRiskCnt:0, jejuTotal:0,
      expiryImminentCnt:0
    };
  }

  function ingestRows(rows){
    if(!rows||!rows.length) return;

    // í—¤ë” ê²°ì • (ìµœì´ˆ 1íšŒ)
    if(!TABLE_KEYS){
      TABLE_KEYS=Object.keys(rows[0]);
      buildTableHeader(TABLE_KEYS);
    }

    // ë©”ëª¨ë¦¬ ì ì¬
    for(const r of rows){ DATA.push(r); }
    // ë©”ëª¨ë¦¬ ë³´í˜¸ (ì›ë³¸ ì •ì±… ìœ ì§€)
    if(DATA.length>CHUNK_CONFIG.maxMemoryRows){
      DATA.splice(0, DATA.length-CHUNK_CONFIG.maxMemoryRows);
    }

    // ìŠ¤íŠ¸ë¦¬ë° ì§‘ê³„
    for(const r of rows){
      AGG.total++;

      // ë°°ì†¡ ëª¨ë“œ ì§‘ê³„
      if(r.Is_Rocket_Delivery===1) AGG.rocket++;
      if(r.Delivery_Mode==='ë¡œì¼“ë‹¹ì¼'){ AGG.sameDayTotal++; if(r.Is_Delayed===0) AGG.sameDayOnTime++; }
      if(r.Delivery_Mode==='ë¡œì¼“ìƒˆë²½'){ AGG.dawnTotal++; if(r.Is_Delayed===0) AGG.dawnOnTime++; }
      if(r.Fast_Ship_30min===1) AGG.fastShip30++;
      if(r.Order_To_Ship_Minutes<=60) AGG.shipUnder60++;
      if(r.FC_SLA_Breach===1) AGG.fcSlaBreach++;
      AGG.shipMinutesSum += (r.Order_To_Ship_Minutes||0);
      AGG.pickPerItemSum += (r.Picking_Time_Seconds/Math.max(1,r.Quantity));
      AGG.packPerItemSum += (r.Packing_Time_Seconds/Math.max(1,r.Quantity));
      AGG.procErrRateSum += (r.Processing_Error_Rate||0);

      // WOW
      if(r.Is_WOW_Member===1){ AGG.wowCount++; AGG.wowSales+=r.Order_Amount; AGG.wowOrders++; if(r.Is_Churn_Risk===1) AGG.wowChurnRisk++; }
      else { AGG.nonWowSales+=r.Order_Amount; AGG.nonWowOrders++; }

      // ì½œë“œì²´ì¸/ì¹´í…Œê³ ë¦¬
      if(r.Is_Fresh_Food===1) AGG.freshCount++;
      if(r.Is_Cold_Chain_Required===1){ AGG.coldReq++; if(r.Temperature_Violation===1) AGG.tempViol++; }
      if(r.Product_Category==='ëƒ‰ë™ì‹í’ˆ' && isFinite(r.Cold_Chain_Quality_Score)){ AGG.frozenQualitySum+=r.Cold_Chain_Quality_Score; AGG.frozenCnt++; }

      // ë„¤íŠ¸ì›Œí¬/ê±°ë¦¬
      if(r.Is_Mega_Hub===1) AGG.megaHub++;
      if(['ì„œìš¸íŠ¹ë³„ì‹œ','ê²½ê¸°ë„','ì¸ì²œê´‘ì—­ì‹œ'].includes(r.Region)) AGG.metro++;
      AGG.distanceSum += (r.Distance_km||0);
      AGG.routingSum += (r.Routing_Score||0);

      // ìë™í™”
      if(r.Automation_Level==='AI_OPTIMIZED') AGG.aiOpt++;
      AGG.autoPickScoreSum += (r.Automation_Level==='AI_OPTIMIZED'?90: r.Automation_Level==='AUTO'?70: r.Automation_Level==='SEMI_AUTO'?40:10);
      AGG.pickTimeSum += (r.Picking_Time_Seconds||0);
      AGG.wmsAdvSum += (r.WMS_Advanced_Score||0);

      // ì¬ë¬´
      AGG.salesSum += (r.Order_Amount||0);
      AGG.netProfitSum += (r.Net_Profit||0);

      // ê³ ê°
      AGG.ltvSum += (r.Customer_LTV||0);
      AGG.cacSum += (r.CAC||0);
      AGG.uniqueCustomers.add(r.Customer_ID);
      if(r.Is_Churn_Risk===1) AGG.churnRisk++;
      if((r.Is_Churn_Risk===1)===(r.Churn_Flag===1)) AGG.aiAccEqual++;

      // ë°°ì†¡
      if(r.Is_Delayed===0) AGG.onTime++; else AGG.delay++;
      AGG.loadSum += (r.Load_Factor||0);
      AGG.fuelSum += (r.Fuel_Efficiency||0);
      AGG.routeSum += (r.Routing_Score||0);
      if(r.Temperature_Violation===1 || r.FC_SLA_Breach===1 || r.Return_Flag===1) AGG.exception++;

      // ë°˜í’ˆ
      if(r.Return_Flag===1){ AGG.returnCnt++; AGG.returnCostSum+=(r.Return_Cost||0); if(r.Is_Resellable===1) AGG.resellCnt++; }

      // ì¬ê³ /WMS
      AGG.invTurnSum += (r.Inventory_Turnover||0);
      if(r.Stockout_Flag===1) AGG.stockoutCnt++;
      if(r.Overstock_Flag===1) AGG.overstockCnt++;
      AGG.invAccSum += (r.Inventory_Accuracy||0);
      if(r.WMS_Usage==='Active') AGG.wmsActiveCnt++;

      // ìœ„í—˜/ì •í•©ì„±
      if(r.Is_Loss_Order===1) AGG.lossOrderCnt++;
      if(r.Region==='ì œì£¼íŠ¹ë³„ìì¹˜ë„'){ AGG.jejuTotal++; if(r.Is_Weather_Risk===1) AGG.jejuWeatherRiskCnt++; }
      if(r.Expiry_Date){
        const d = (new Date(r.Expiry_Date)) - (new Date(r.Order_Date));
        if(d<=86400000 && d>=-31536000000) AGG.expiryImminentCnt++; // ì•ˆì „ê°€ë“œ
      }
    }

    // í…Œì´ë¸” ê°€ìƒí™” ë Œë”
    renderTableRowsVirtual(rows, TABLE_KEYS);

    // KPI/ê²€ì¦ ì—…ë°ì´íŠ¸
    updateKPIsFromAgg();
    updateValidationAndRiskFromAgg();

    // ì§„í–‰ë¥  ìƒíƒœ ê°±ì‹ 
    PROCESSING_STATE.processedRows += rows.length;
    updateProgressFromState('Generating');
  }

  function updateKPIsFromAgg(){
    const total=Math.max(1,AGG.total);
    const fmtPct=v=>(isFinite(v)?(Number(v).toFixed(1)+'%'):'-');

    const rocketShare=(AGG.rocket/total*100);
    const sameDaySuccess=(AGG.sameDayTotal?AGG.sameDayOnTime/AGG.sameDayTotal*100:0);
    const dawnOnTime=(AGG.dawnTotal?AGG.dawnOnTime/AGG.dawnTotal*100:0);
    const fastShip=(AGG.fastShip30/total*100);

    const fcOnTime=100-(AGG.fcSlaBreach/total*100);
    const avgShipHr=(AGG.shipMinutesSum/total)/60;
    const pickSecPerItem=(AGG.pickPerItemSum/total);
    const packSecPerItem=(AGG.packPerItemSum/total);
    const effFulfill=clamp(100-((AGG.procErrRateSum/total)*100*2),0,100);
    const shipUnder60=(AGG.shipUnder60/total*100);

    const wowShare=(AGG.wowCount/total*100);
    const wowAov = (AGG.wowOrders?AGG.wowSales/AGG.wowOrders:0);
    const nonWowAov = (AGG.nonWowOrders?AGG.nonWowSales/AGG.nonWowOrders:0);
    const wowAovGap = (wowAov - nonWowAov);
    const wowChurnRisk = AGG.wowChurnRisk;

    const freshShare=(AGG.freshCount/total*100);
    const coldChainRate=(AGG.coldReq? (1-AGG.tempViol/AGG.coldReq)*100 : 100);
    const tempViolRate=(AGG.coldReq? (AGG.tempViol/AGG.coldReq*100) : 0);
    const frozenQuality=(AGG.frozenCnt? AGG.frozenQualitySum/AGG.frozenCnt : 0);

    const megaHubShare=(AGG.megaHub/total*100);
    const metroCoverage=(AGG.metro/total*100);
    const avgDist=(AGG.distanceSum/total);
    const networkEff=(AGG.routingSum/total);

    const aiOptimized=(AGG.aiOpt/total*100);
    const autoPickRate=(AGG.autoPickScoreSum/total);
    const avgPickTime=(AGG.pickTimeSum/total);
    const wmsAdvanced=(AGG.wmsAdvSum/total);

    const totalSales=AGG.salesSum;
    const netMargin=(AGG.salesSum?AGG.netProfitSum/AGG.salesSum*100:0);
    const aov=(AGG.salesSum/total);
    const uniqueCust=Math.max(1,AGG.uniqueCustomers.size);
    const arppu=(AGG.salesSum/uniqueCust);

    const ltvAvg=(AGG.ltvSum/total);
    const cacAvg=(AGG.cacSum/total);
    const ltvCac=(cacAvg? (ltvAvg/cacAvg).toFixed(2):'0.00');

    const churnRate=(AGG.churnRisk/total*100);
    const aiAcc=(AGG.aiAccEqual/total*100);

    const onTime=(AGG.onTime/total*100);
    const sla=(AGG.fcSlaBreach/total*100);
    const load=(AGG.loadSum/total);
    const fuel=(AGG.fuelSum/total);
    const route=(AGG.routeSum/total);
    const exception=(AGG.exception/total*100);

    const retRate=(AGG.returnCnt/total*100);
    const retCostRate=(AGG.salesSum?AGG.returnCostSum/AGG.salesSum*100:0);
    const resell=(AGG.returnCnt?AGG.resellCnt/AGG.returnCnt*100:0);

    const invTurn=(AGG.invTurnSum/total);
    const stockout=(AGG.stockoutCnt/total*100);
    const overstock=(AGG.overstockCnt/total*100);
    const invAcc=(AGG.invAccSum/total);
    const shrink=(100 - invAcc);
    const wmsUse=(AGG.wmsActiveCnt/total*100);

    setText('k_rocketShare',fmtPct(rocketShare));
    setText('k_rocketSameDayRate',fmtPct(sameDaySuccess));
    setText('k_rocketDawnRate',fmtPct(dawnOnTime));
    setText('k_fastShipRate',fmtPct(fastShip));

    setText('k_fcOnTimeShip',fmtPct(fcOnTime));
    setText('k_fcAvgShipHour',(avgShipHr||0).toFixed(2));
    setText('k_fcPickSecPerItem',(pickSecPerItem||0).toFixed(1));
    setText('k_fcPackSecPerItem',(packSecPerItem||0).toFixed(1));
    setText('k_fcEfficiency',(effFulfill||0).toFixed(1));
    setText('k_fcShipUnder60',fmtPct(shipUnder60));

    setText('k_wowShare',fmtPct(wowShare));
    setText('k_wowPlusShare','0');
    setText('k_wowAovGap',formatCurrencyKRW(wowAovGap));
    setText('k_wowChurnRisk',wowChurnRisk.toLocaleString('ko-KR'));

    setText('k_freshShare',fmtPct(freshShare));
    setText('k_coldChainRate',fmtPct(coldChainRate));
    setText('k_tempViolation',fmtPct(tempViolRate));
    setText('k_frozenQuality',(frozenQuality||0).toFixed(0));

    setText('k_megaHubShare',fmtPct(megaHubShare));
    setText('k_seoulCoverage',fmtPct(metroCoverage));
    setText('k_avgDistance',(avgDist||0).toFixed(1));
    setText('k_networkEff',(networkEff||0).toFixed(0));

    setText('k_aiOptimized',fmtPct(aiOptimized));
    setText('k_autoPickRate',(autoPickRate||0).toFixed(1));
    setText('k_avgPickTime',(avgPickTime||0).toFixed(1));
    setText('k_wmsAdvanced',(wmsAdvanced||0).toFixed(0));

    setText('k_totalSales',formatCurrencyKRW(totalSales));
    setText('k_netMargin',(netMargin||0).toFixed(2));
    setText('k_aov',formatCurrencyKRW(aov));
    setText('k_arppu',formatCurrencyKRW(arppu));

    setText('k_ltvCac',ltvCac);
    setText('k_retention',(100-churnRate).toFixed(1));
    setText('k_churn',churnRate.toFixed(1));
    setText('k_ai',aiAcc.toFixed(1));

    setText('k_onTime',fmtPct(onTime));
    setText('k_sla',fmtPct(sla));
    setText('k_load',(load||0).toFixed(1));
    setText('k_fuel',(fuel||0).toFixed(2));
    setText('k_route',(route||0).toFixed(0));
    setText('k_exception',fmtPct(exception));

    setText('k_returnRate',fmtPct(retRate));
    setText('k_returnCost',(retCostRate||0).toFixed(2));
    setText('k_resell',fmtPct(resell));

    setText('k_invTurn',(invTurn||0).toFixed(1));
    setText('k_stockout',fmtPct(stockout));
    setText('k_overstock',fmtPct(overstock));
    setText('k_invAcc',(invAcc||0).toFixed(1));
    setText('k_shrink',(shrink||0).toFixed(1));
    setText('k_wms',fmtPct(wmsUse));
  }

  function updateValidationAndRiskFromAgg(){
    const list=qs('validateList');list.innerHTML='';
    const risk=qs('riskList');risk.innerHTML='';
    const perf=qs('perfList');perf.innerHTML='';
    if(AGG.total===0){qs('validateSummary').textContent='-';return;}

    const total=AGG.total;
    const tempViolRate=(AGG.coldReq?AGG.tempViol/AGG.coldReq:0);
    const lossRate=(AGG.lossOrderCnt/total);
    const jejuRate=(AGG.jejuTotal?AGG.jejuWeatherRiskCnt/AGG.jejuTotal:0);
    const overStockRate=(AGG.overstockCnt/total);
    const expirySoonRate=(AGG.expiryImminentCnt/total);

    function pill(text,type){const d=document.createElement('div');d.className='alert '+type;d.textContent=text;return d}
    const okText=`ì½œë“œì²´ì¸ ìœ„ë°˜ìœ¨ ${(tempViolRate*100).toFixed(2)}% / ì†ì‹¤ì£¼ë¬¸ìœ¨ ${(lossRate*100).toFixed(2)}%`;
    qs('validateSummary').textContent=okText;

    // DIALS í•œê³„ì¹˜ (í˜„ì¬ ì…ë ¥ê°’ì—ì„œ ì½ìŒ)
    const DIALS_CUR={
      tempHi: parseFloat(qs('dial_temp_hi').value),
      lossHi: parseFloat(qs('dial_loss_hi').value),
      jejuHi: parseFloat(qs('dial_jeju_hi').value),
      overHi: parseFloat(qs('dial_over_hi').value),
      expHi: parseFloat(qs('dial_exp_hi').value),
    };

    if(tempViolRate > DIALS_CUR.tempHi) risk.appendChild(pill(`ì½œë“œì²´ì¸ ìœ„ë°˜ìœ¨ ìƒí•œ ì´ˆê³¼ (${(tempViolRate*100).toFixed(2)}% > ${(DIALS_CUR.tempHi*100).toFixed(1)}%)`,'bad'));
    if(lossRate > DIALS_CUR.lossHi) risk.appendChild(pill(`ì ìì£¼ë¬¸ìœ¨ ìƒí•œ ì´ˆê³¼ (${(lossRate*100).toFixed(2)}%)`,'bad'));
    if(jejuRate > DIALS_CUR.jejuHi) risk.appendChild(pill(`ì œì£¼ ì•…ì²œí›„ ë…¸ì¶œ ê³¼ë‹¤ (${(jejuRate*100).toFixed(1)}%)`,'warn'));
    if(overStockRate > DIALS_CUR.overHi) risk.appendChild(pill(`ê³¼ì¬ê³  ë¹„ìœ¨ ê³¼ë‹¤ (${(overStockRate*100).toFixed(1)}%)`,'warn'));
    if(expirySoonRate > DIALS_CUR.expHi) risk.appendChild(pill(`ìœ í†µê¸°í•œ ì„ë°• ê³¼ë‹¤ (${(expirySoonRate*100).toFixed(2)}%)`,'warn'));

    const rps=PROCESSING_STATE.processedRows/Math.max(1,((Date.now()-PROCESSING_STATE.startTime)/1000));
    perf.appendChild(pill(`ìƒì„± ì²˜ë¦¬ì†ë„: ${rps.toFixed(1)} rows/sec`,'good'));
    perf.appendChild(pill(`ë©”ëª¨ë¦¬ ë³´í˜¸: ìµœëŒ€ ${CHUNK_CONFIG.maxMemoryRows.toLocaleString('ko-KR')} rows ìœ ì§€`,'good'));
  }

  /* ==========================
     4) í…Œì´ë¸” ë Œë” â€” ê°€ìƒí™”
  ========================== */
  function buildTableHeader(keys){
    const thead=qs('tbl').querySelector('thead');thead.innerHTML='';
    const tr=document.createElement('tr');
    keys.forEach(k=>{const th=document.createElement('th');th.textContent=prettyHeader(k);tr.appendChild(th)});
    thead.appendChild(tr);
  }

  // PERF: ìµœê·¼ Ní–‰ë§Œ DOM ìœ ì§€(ê°€ìƒí™”). ì „ì²´ ë°ì´í„°ëŠ” DATAì— ë³´ê´€.
  function renderTableRowsVirtual(rows, keys){
    const tbody=qs('tbl').querySelector('tbody');
    const frag=document.createDocumentFragment();
    for(const r of rows){
      const tr=document.createElement('tr');
      for(const k of keys){
        const td=document.createElement('td');
        const v=r[k];
        td.textContent=(v===null||v===undefined)?'':v;
        if(k==='Delivery_Mode'){
          td.className='delivery-mode '+(v==='ë¡œì¼“ìƒˆë²½'?'dawn':(v==='ë¡œì¼“í”„ë ˆì‹œ'?'fresh':(String(v).includes('ë¡œì¼“')?'rocket':'')));
        }
        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);

    // ìƒí•œ ì´ˆê³¼ ì‹œ ìƒë‹¨ì—ì„œ ì œê±°
    const excess = tbody.children.length - RENDER_MAX_ROWS;
    if(excess>0){
      for(let i=0;i<excess;i++){ tbody.removeChild(tbody.firstChild); }
    }
  }

  /* ==========================
     5) DIALS <-> CAL ë§¤í•‘ (ê·¸ëŒ€ë¡œ)
  ========================== */
  let DIALS={
    lossOrderTarget:[0.07,0.12],
    tempViolationTarget:[0.01,0.02],
    jejuWeatherExposureTarget:[0.10,0.15],
    overstockTarget:[0.15,0.25],
    expiryImminentTarget:[0.005,0.01]
  };
  let CAL={
    costBias:1.0,
    tempViolationBase:0.015,
    jejuWeatherScale:1.0,
    overstockProb:0.22,
    expiryImminentRate:0.008
  };
  function applyDialsToCal(targetNetMargin){
    const lossLo = parseFloat(qs('dial_loss_lo').value);
    const lossHi = parseFloat(qs('dial_loss_hi').value);
    const tempLo = parseFloat(qs('dial_temp_lo').value);
    const tempHi = parseFloat(qs('dial_temp_hi').value);
    const jejuLo = parseFloat(qs('dial_jeju_lo').value);
    const jejuHi = parseFloat(qs('dial_jeju_hi').value);
    const overLo = parseFloat(qs('dial_over_lo').value);
    const overHi = parseFloat(qs('dial_over_hi').value);
    const expLo = parseFloat(qs('dial_exp_lo').value);
    const expHi = parseFloat(qs('dial_exp_hi').value);

    DIALS.lossOrderTarget=[lossLo,lossHi];
    DIALS.tempViolationTarget=[tempLo,tempHi];
    DIALS.jejuWeatherExposureTarget=[jejuLo,jejuHi];
    DIALS.overstockTarget=[overLo,overHi];
    DIALS.expiryImminentTarget=[expLo,expHi];

    CAL.tempViolationBase = clamp((tempLo + tempHi) / 2, 0.001, 0.20);
    const jejuAvg = (jejuLo + jejuHi) / 2;
    CAL.jejuWeatherScale = clamp(jejuAvg / 0.12, 0.6, 1.6);
    CAL.overstockProb = clamp((overLo + overHi) / 2, 0, 0.60);
    CAL.expiryImminentRate = clamp((expLo + expHi) / 2, 0, 0.20);

    if (Number.isFinite(targetNetMargin)) {
      const delta = clamp((3 - targetNetMargin) / 30, -0.1, 0.1);
      CAL.costBias = clamp(1 + delta, 0.85, 1.15);
    } else {
      CAL.costBias = 1.0;
    }
    qs('tuneStatus').textContent='DIALS APPLIED';
    qs('tuneStatus').className='pill ok';
  }

  /* ==========================
     6) Web Worker ì½”ë“œ ìƒì„± (Blob URL) â€” í–‰ ìƒì„± ì „ë‹´
     (ì›ë³¸ ë¡œì§/ìŠ¤í‚¤ë§ˆ ê·¸ëŒ€ë¡œ ì´ë™)
  ========================== */
  function createGeneratorWorker(){
    // WORKER: ë³¸ë¬¸ ë¬¸ìì—´(ì›ë³¸ ë¡œì§ì„ ê·¸ëŒ€ë¡œ í¬í•¨)
    const workerCode = `
      // ===== Worker Scope Begin =====
      let SHOULD_STOP=false;

      // ê³µìœ  í‚¤
      const NET_PREFIX='${NET_PREFIX}';
      const N=s=>NET_PREFIX+s;
      const NET=Object.freeze({
        ROUTE_TYPE:N('Route_Type'),
        SORT_HUB_NAME:N('Sortation_Hub_Name'),
        FC_EXIT:N('FC_Exit_TS'),
        HUB_IN:N('Hub_In_TS'),
        HUB_OUT:N('Hub_Out_TS'),
        CAMP_IN:N('Camp_In_TS'),
        LOAD_START:N('Loadout_Start_TS'),
        LOAD_END:N('Loadout_End_TS'),
        OFD:N('OFD_TS'),
        FC_DWELL:N('FC_Dwell_Min'),
        HUB_DWELL:N('Hub_Dwell_Min'),
        CAMP_DWELL:N('Camp_Dwell_Min'),
      });

      // ì›ë³¸ ìƒìˆ˜/ë§µ/ë„ìš°ë¯¸ â€” (ë„ë©”ì¸ ë¡œì§ ë™ì¼)
      const SHIP_SLA_MIN={'ë¡œì¼“ë‹¹ì¼':60,'ë¡œì¼“ìƒˆë²½':90,'ë¡œì¼“ìµì¼':90,'ë¡œì¼“í”„ë ˆì‹œ':60,'ì¼ë°˜íƒë°°':120,DEFAULT:90};
      const DELIVERY_MODES={
        'ë¡œì¼“ë‹¹ì¼':{delayRate:0.005,baseDays:0,cutoffHour:20,regions:['ìˆ˜ë„ê¶Œ'],wowOnly:false,cost:1.2},
        'ë¡œì¼“ìƒˆë²½':{delayRate:0.008,baseDays:1,regions:['ìˆ˜ë„ê¶Œ','ì˜ë‚¨','ì¶©ì²­'],wowOnly:false,cost:1.1},
        'ë¡œì¼“ìµì¼':{delayRate:0.012,baseDays:1,regions:['ì „êµ­'],wowOnly:false,cost:1.0},
        'ë¡œì¼“í”„ë ˆì‹œ':{delayRate:0.015,baseDays:0,cutoffHour:18,regions:['ìˆ˜ë„ê¶Œ'],wowOnly:false,cost:1.3,coldChain:true},
        'ì¼ë°˜íƒë°°':{delayRate:0.035,baseDays:2,regions:['ì „êµ­'],wowOnly:false,cost:0.8}
      };
      const REGIONS=['ì„œìš¸íŠ¹ë³„ì‹œ','ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ì¸ì²œê´‘ì—­ì‹œ','ê´‘ì£¼ê´‘ì—­ì‹œ','ëŒ€ì „ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ','ê²½ê¸°ë„','ê°•ì›íŠ¹ë³„ìì¹˜ë„','ì¶©ì²­ë¶ë„','ì¶©ì²­ë‚¨ë„','ì „ë¶íŠ¹ë³„ìì¹˜ë„','ì „ë¼ë‚¨ë„','ê²½ìƒë¶ë„','ê²½ìƒë‚¨ë„','ì œì£¼íŠ¹ë³„ìì¹˜ë„'];
      const CITIES_BY_REGION={ 'ì„œìš¸íŠ¹ë³„ì‹œ':['ì„œìš¸ì‹œ'],'ë¶€ì‚°ê´‘ì—­ì‹œ':['ë¶€ì‚°ì‹œ'],'ëŒ€êµ¬ê´‘ì—­ì‹œ':['ëŒ€êµ¬ì‹œ'],'ì¸ì²œê´‘ì—­ì‹œ':['ì¸ì²œì‹œ'],'ê´‘ì£¼ê´‘ì—­ì‹œ':['ê´‘ì£¼ì‹œ'],'ëŒ€ì „ê´‘ì—­ì‹œ':['ëŒ€ì „ì‹œ'],'ìš¸ì‚°ê´‘ì—­ì‹œ':['ìš¸ì‚°ì‹œ'],'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':['ì„¸ì¢…ì‹œ'],
        'ê²½ê¸°ë„':['ì„±ë‚¨ì‹œ','ìš©ì¸ì‹œ','ìˆ˜ì›ì‹œ','ê³ ì–‘ì‹œ','ë‚¨ì–‘ì£¼ì‹œ'],'ê°•ì›íŠ¹ë³„ìì¹˜ë„':['ì¶˜ì²œì‹œ','ì›ì£¼ì‹œ','ê°•ë¦‰ì‹œ'],'ì¶©ì²­ë¶ë„':['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ'],'ì¶©ì²­ë‚¨ë„':['ì²œì•ˆì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ'],
        'ì „ë¶íŠ¹ë³„ìì¹˜ë„':['ì „ì£¼ì‹œ','ìµì‚°ì‹œ','êµ°ì‚°ì‹œ'],'ì „ë¼ë‚¨ë„':['ìˆœì²œì‹œ','ì—¬ìˆ˜ì‹œ','ëª©í¬ì‹œ'],'ê²½ìƒë¶ë„':['í¬í•­ì‹œ','êµ¬ë¯¸ì‹œ','ê²½ì‚°ì‹œ'],'ê²½ìƒë‚¨ë„':['ì°½ì›ì‹œ','ê¹€í•´ì‹œ','ì§„ì£¼ì‹œ'],'ì œì£¼íŠ¹ë³„ìì¹˜ë„':['ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ'] };
      const DISTRICTS_BY_CITY={'ì„œìš¸ì‹œ':['ê°•ë‚¨êµ¬','ì„œì´ˆêµ¬','ì†¡íŒŒêµ¬','ë§ˆí¬êµ¬','ì„±ë™êµ¬','ê°•ì„œêµ¬'],'ë¶€ì‚°ì‹œ':['í•´ìš´ëŒ€êµ¬','ìˆ˜ì˜êµ¬','ë‚¨êµ¬','ë¶€ì‚°ì§„êµ¬'],'ëŒ€êµ¬ì‹œ':['ìˆ˜ì„±êµ¬','ë‹¬ì„œêµ¬','ì¤‘êµ¬','ë™êµ¬'],'ì¸ì²œì‹œ':['ë‚¨ë™êµ¬','ì—°ìˆ˜êµ¬','ë¶€í‰êµ¬','ë¯¸ì¶”í™€êµ¬'],
        'ê´‘ì£¼ì‹œ':['ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ê´‘ì‚°êµ¬'],'ëŒ€ì „ì‹œ':['ì„œêµ¬','ìœ ì„±êµ¬','ëŒ€ë•êµ¬','ë™êµ¬'],'ìš¸ì‚°ì‹œ':['ë‚¨êµ¬','ì¤‘êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°'],'ì„¸ì¢…ì‹œ':['ì„¸ì¢…ë™','ìƒˆë¡¬ë™','ë³´ëŒë™'],
        'ì„±ë‚¨ì‹œ':['ë¶„ë‹¹êµ¬','ìˆ˜ì •êµ¬','ì¤‘ì›êµ¬'],'ìš©ì¸ì‹œ':['ìˆ˜ì§€êµ¬','ê¸°í¥êµ¬','ì²˜ì¸êµ¬'],'ìˆ˜ì›ì‹œ':['ì˜í†µêµ¬','ê¶Œì„ êµ¬','íŒ”ë‹¬êµ¬','ì¥ì•ˆêµ¬'],'ê³ ì–‘ì‹œ':['ì¼ì‚°ì„œêµ¬','ì¼ì‚°ë™êµ¬','ë•ì–‘êµ¬'],
        'ë‚¨ì–‘ì£¼ì‹œ':['í™”ë„ì','ì§„ì ‘ì','ë³„ë‚´ë™'],'ì¶˜ì²œì‹œ':['í‡´ê³„ë™','ì„ì‚¬ë™','í›„í‰ë™'],'ì›ì£¼ì‹œ':['ë¬´ì‹¤ë™','ë‹¨êµ¬ë™','íƒœì¥ë™'],'ê°•ë¦‰ì‹œ':['êµë™','í¬ë‚¨ë™','ì…ì•”ë™'],
        'ì²­ì£¼ì‹œ':['í¥ë•êµ¬','ì„œì›êµ¬','ì²­ì›êµ¬'],'ì¶©ì£¼ì‹œ':['ì—°ìˆ˜ë™','êµí˜„ë™','í˜¸ì•”ë™'],'ì œì²œì‹œ':['ì‹ ë°±ë™','ì²­ì „ë™'],'ì²œì•ˆì‹œ':['ì„œë¶êµ¬','ë™ë‚¨êµ¬'],'ì•„ì‚°ì‹œ':['ë°°ë°©ì','íƒ•ì •ë©´','ì˜¨ì–‘ë™'],'ì„œì‚°ì‹œ':['ë™ë¬¸ë™','ì„ë‚¨ë™'],
        'ì „ì£¼ì‹œ':['ì™„ì‚°êµ¬','ë•ì§„êµ¬'],'ìµì‚°ì‹œ':['ì˜ë“±ë™','ë¶€ì†¡ë™'],'êµ°ì‚°ì‹œ':['ë‚˜ìš´ë™','ìˆ˜ì†¡ë™'],'ìˆœì²œì‹œ':['ì—°í–¥ë™','ì¡°ë¡€ë™'],'ì—¬ìˆ˜ì‹œ':['ì›…ì²œë™','ë¬¸ìˆ˜ë™'],'ëª©í¬ì‹œ':['í•˜ë‹¹ë™','ì‹ í¥ë™'],
        'í¬í•­ì‹œ':['ë¶êµ¬','ë‚¨êµ¬'],'êµ¬ë¯¸ì‹œ':['ì›í‰ë™','í˜•ê³¡ë™'],'ê²½ì‚°ì‹œ':['ì¤‘ë°©ë™','ì„œìƒë™'],'ì°½ì›ì‹œ':['ì„±ì‚°êµ¬','ì˜ì°½êµ¬','ë§ˆì‚°í•©í¬êµ¬'],'ê¹€í•´ì‹œ':['ì‚¼ê³„ë™','êµ¬ì‚°ë™','ì¥ìœ ë™'],'ì§„ì£¼ì‹œ':['ìƒëŒ€ë™','í‰ê±°ë™'],
        'ì œì£¼ì‹œ':['ë…¸í˜•ë™','ì—°ë™','ì•„ë¼ë™'],'ì„œê·€í¬ì‹œ':['ì„œê·€ë™','ëŒ€ì •ì','í‘œì„ ë©´'] };
      const MEGA_HUBS=['ê¹€í¬ë©”ê°€í—ˆë¸Œ','ê³¤ì§€ì•”ë©”ê°€í—ˆë¸Œ','ë•í‰í—ˆë¸Œ','í‰íƒí—ˆë¸Œ'];
      const FC_SITES={'ì„œìš¸íŠ¹ë³„ì‹œ':'ì„œìš¸ë™ë¶€FC','ì¸ì²œê´‘ì—­ì‹œ':'ì¸ì²œFC','ê²½ê¸°ë„':'ê²½ê¸°ë‚¨ë¶€FC','ë¶€ì‚°ê´‘ì—­ì‹œ':'ë¶€ì‚°FC','ëŒ€êµ¬ê´‘ì—­ì‹œ':'ëŒ€êµ¬FC','ê´‘ì£¼ê´‘ì—­ì‹œ':'ê´‘ì£¼FC','ëŒ€ì „ê´‘ì—­ì‹œ':'ëŒ€ì „FC','ìš¸ì‚°ê´‘ì—­ì‹œ':'ìš¸ì‚°FC','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':'ì„¸ì¢…FC','ê°•ì›íŠ¹ë³„ìì¹˜ë„':'ê°•ì›FC','ì¶©ì²­ë¶ë„':'ì¶©ë¶FC','ì¶©ì²­ë‚¨ë„':'ì¶©ë‚¨FC','ì „ë¶íŠ¹ë³„ìì¹˜ë„':'ì „ë¶FC','ì „ë¼ë‚¨ë„':'ì „ë‚¨FC','ê²½ìƒë¶ë„':'ê²½ë¶FC','ê²½ìƒë‚¨ë„':'ê²½ë‚¨FC','ì œì£¼íŠ¹ë³„ìì¹˜ë„':'ì œì£¼FC'};
      const REGION_LOGISTICS={'ì„œìš¸íŠ¹ë³„ì‹œ':{baseCost:2800,perKmCost:90,avgDistance:16,populationWeight:0.18},'ë¶€ì‚°ê´‘ì—­ì‹œ':{baseCost:3200,perKmCost:95,avgDistance:22,populationWeight:0.06},'ëŒ€êµ¬ê´‘ì—­ì‹œ':{baseCost:3100,perKmCost:95,avgDistance:20,populationWeight:0.05},'ì¸ì²œê´‘ì—­ì‹œ':{baseCost:2900,perKmCost:90,avgDistance:18,populationWeight:0.06},'ê´‘ì£¼ê´‘ì—­ì‹œ':{baseCost:3100,perKmCost:100,avgDistance:24,populationWeight:0.03},'ëŒ€ì „ê´‘ì—­ì‹œ':{baseCost:3000,perKmCost:95,avgDistance:21,populationWeight:0.03},'ìš¸ì‚°ê´‘ì—­ì‹œ':{baseCost:3200,perKmCost:100,avgDistance:23,populationWeight:0.02},'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':{baseCost:3000,perKmCost:95,avgDistance:20,populationWeight:0.01},'ê²½ê¸°ë„':{baseCost:3000,perKmCost:95,avgDistance:26,populationWeight:0.24},'ê°•ì›íŠ¹ë³„ìì¹˜ë„':{baseCost:3400,perKmCost:110,avgDistance:40,populationWeight:0.04},'ì¶©ì²­ë¶ë„':{baseCost:3100,perKmCost:100,avgDistance:28,populationWeight:0.04},'ì¶©ì²­ë‚¨ë„':{baseCost:3100,perKmCost:100,avgDistance:27,populationWeight:0.05},'ì „ë¶íŠ¹ë³„ìì¹˜ë„':{baseCost:3200,perKmCost:105,avgDistance:29,populationWeight:0.04},'ì „ë¼ë‚¨ë„':{baseCost:3300,perKmCost:110,avgDistance:36,populationWeight:0.04},'ê²½ìƒë¶ë„':{baseCost:3300,perKmCost:108,avgDistance:34,populationWeight:0.06},'ê²½ìƒë‚¨ë„':{baseCost:3250,perKmCost:105,avgDistance:31,populationWeight:0.06},'ì œì£¼íŠ¹ë³„ìì¹˜ë„':{baseCost:4200,perKmCost:130,avgDistance:38,populationWeight:0.02}};
      const WEATHER_CONDITIONS=['ë§‘ìŒ','íë¦¼','ë¹„','ëˆˆ','ì•ˆê°œ','ê°•í’'];
      function weatherSeverity(c){const m={'ë§‘ìŒ':0.02,'íë¦¼':0.15,'ë¹„':0.45,'ëˆˆ':0.75,'ì•ˆê°œ':0.35,'ê°•í’':0.55};return m[c]||0.2}
      const COUPANG_CATEGORIES={
        'ì‹ ì„ ì‹í’ˆ':{margin:0.18,price:[2000,18000],coldChain:true,freshFood:true,tempRange:[0,4],returnRate:0.035,skus:['FRESH-APPLE-1KG','FRESH-PEAR-1KG','FRESH-LETTUCE','FRESH-MEAT-500G','FRESH-EGG-30','FRESH-MILK-1L']},
        'ëƒ‰ë™ì‹í’ˆ':{margin:0.22,price:[3000,22000],coldChain:true,freshFood:false,tempRange:[-18,-12],returnRate:0.028,skus:['FROZ-DUMPLING-1KG','FROZ-PIZZA','FROZ-ICECREAM','FROZ-SHRIMP-500G','FROZ-CHICKEN-1KG']},
        'ê°€ì „ì „ì':{margin:0.14,price:[15000,700000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.022,skus:['ELEC-MOUSE','ELEC-KEYBOARD','ELEC-HEADSET','ELEC-MONITOR-27','ELEC-ROBOTVAC','ELEC-AIRFRYER']},
        'íŒ¨ì…˜ì˜ë¥˜':{margin:0.38,price:[9000,180000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.11,skus:['FASH-TSHIRT','FASH-JEANS','FASH-JACKET','FASH-DRESS','FASH-SNEAKERS','FASH-HAT']},
        'ìƒí™œìš©í’ˆ':{margin:0.28,price:[2000,55000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.03,skus:['LIFE-TISSUE','LIFE-TOILETPAPER','LIFE-DETERGENT','LIFE-FABRICSOFT','LIFE-SHOWERGEL','LIFE-DISHSOAP']},
        'ì£¼ë°©ìš©í’ˆ':{margin:0.30,price:[4000,120000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.025,skus:['KITCHEN-PAN28','KITCHEN-POT20','KITCHEN-KNIFE','KITCHEN-CUPSET','KITCHEN-FOODBOX']},
        'ë·°í‹°':{margin:0.35,price:[3000,250000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.06,skus:['BEAUTY-TONER','BEAUTY-LOTION','BEAUTY-SERUM','BEAUTY-SUNSCREEN','BEAUTY-LIP','BEAUTY-MASKPACK']},
        'ìœ ì•„ë™':{margin:0.26,price:[4000,350000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.05,skus:['KIDS-DIAPER','KIDS-WIPES','KIDS-TOYBLOCK','KIDS-STROLLER','KIDS-BOTTLE']},
        'ë°˜ë ¤ë™ë¬¼':{margin:0.25,price:[3000,220000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.04,skus:['PET-DRYFOOD','PET-WETFOOD','PET-LITTER','PET-LEASH','PET-SHAMPOO']},
        'ìŠ¤í¬ì¸ Â·ë ˆì €':{margin:0.24,price:[5000,400000],coldChain:false,freshFood:false,tempRange:null,returnRate:0.035,skus:['SPRT-YOGA-MAT','SPRT-DUMBBELL','SPRT-BICYCLE','SPRT-TENT','SPRT-COOLER','SPRT-BALL']}
      };
      const ABC_DISTRIBUTION={A:0.15,B:0.35,C:0.5};
      const VEHICLES=[{type:'ì˜¤í† ë°”ì´',capacity:15,fuelEff:[28,45],regions:['ë„ì‹¬']},{type:'ì†Œí˜•ë°´',capacity:50,fuelEff:[11,16],regions:['ì „ì²´']},{type:'ì¤‘í˜•íŠ¸ëŸ­',capacity:200,fuelEff:[7,11],regions:['ì „ì²´']},{type:'ëŒ€í˜•íŠ¸ëŸ­',capacity:500,fuelEff:[5,8],regions:['ê°„ì„ ']},{type:'ì „ê¸°ì°¨',capacity:40,fuelEff:[4.5,6.8],regions:['ë„ì‹¬']}];
      const DRIVER_GRADES=['ì‹ ì…','ì¼ë°˜','ìˆ™ë ¨','ë² í…Œë‘','MVP'];
      const RETURN_REASONS=['ë‹¨ìˆœë³€ì‹¬','ìƒí’ˆë¶ˆëŸ‰','ë°°ì†¡ì§€ì—°','ì˜¤ë°°ì†¡','íŒŒì†','ì„¤ëª…ë¶ˆì¼ì¹˜','ì‚¬ì´ì¦ˆë¶ˆì¼ì¹˜','ê¸°íƒ€'];
      const WOW_TIERS={'WOW_BASIC':{freeShippingThreshold:0,deliveryDiscount:0.0,ltvMultiplier:2.0,priorityShipping:true,returnBenefit:1.2}};
      const AUTOMATION_LEVELS={
        'MANUAL':{pickingTime:45,packingTime:25,errorRate:0.008,regions:['ì œì£¼íŠ¹ë³„ìì¹˜ë„','ê°•ì›íŠ¹ë³„ìì¹˜ë„']},
        'SEMI_AUTO':{pickingTime:28,packingTime:18,errorRate:0.005,regions:['ì „ë¼ë‚¨ë„','ê²½ìƒë¶ë„','ì¶©ì²­ë¶ë„']},
        'AUTO':{pickingTime:15,packingTime:12,errorRate:0.003,regions:['ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ê´‘ì£¼ê´‘ì—­ì‹œ']},
        'AI_OPTIMIZED':{pickingTime:8,packingTime:6,errorRate:0.001,regions:['ì„œìš¸íŠ¹ë³„ì‹œ','ê²½ê¸°ë„','ì¸ì²œê´‘ì—­ì‹œ']}
      };
      const HOURLY_ORDER_PATTERN={0:.008,1:.005,2:.003,3:.002,4:.002,5:.003,6:.008,7:.015,8:.025,9:.035,10:.045,11:.052,12:.058,13:.048,14:.042,15:.055,16:.065,17:.075,18:.085,19:.125,20:.135,21:.095,22:.068,23:.035};
      function getOrderHour(){const e=Object.entries(HOURLY_ORDER_PATTERN).map(([h,p])=>[parseInt(h),p]);const total=e.reduce((s,[,p])=>s+p,0);const r=Math.random();let cum=0;for(const [h,p] of e){cum+=p/total;if(r<=cum)return h}return 23}
      const rnd=(a,b)=>Math.random()*(b-a)+a;
      const irnd=(a,b)=>Math.floor(rnd(a,b+1));
      const pick=arr=>arr[irnd(0,arr.length-1)];
      const weightedPick=w=>{const t=Object.values(w).reduce((s,x)=>s+x,0);let r=Math.random()*t,c=0;for(const [k,v] of Object.entries(w)){c+=v;if(r<=c)return k}return Object.keys(w)[0]};
      const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
      const pad=(n,l=2)=>String(n).padStart(l,'0');

      function macroRegionBySiDo(region){if(['ì„œìš¸íŠ¹ë³„ì‹œ','ê²½ê¸°ë„','ì¸ì²œê´‘ì—­ì‹œ'].includes(region))return'ìˆ˜ë„ê¶Œ';if(['ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ','ê²½ìƒë¶ë„','ê²½ìƒë‚¨ë„'].includes(region))return'ì˜ë‚¨';if(['ëŒ€ì „ê´‘ì—­ì‹œ','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ','ì¶©ì²­ë¶ë„','ì¶©ì²­ë‚¨ë„'].includes(region))return'ì¶©ì²­';if(['ê´‘ì£¼ê´‘ì—­ì‹œ','ì „ë¶íŠ¹ë³„ìì¹˜ë„','ì „ë¼ë‚¨ë„'].includes(region))return'í˜¸ë‚¨';if(['ê°•ì›íŠ¹ë³„ìì¹˜ë„'].includes(region))return'ê°•ì›';if(['ì œì£¼íŠ¹ë³„ìì¹˜ë„'].includes(region))return'ì œì£¼';return'ê¸°íƒ€'}
      function pickWeather(region,month,CAL){let w={'ë§‘ìŒ':0.40,'íë¦¼':0.22,'ë¹„':0.18,'ëˆˆ':0.06,'ì•ˆê°œ':0.06,'ê°•í’':0.08};if([6,7,8].includes(month)){w['ë¹„']+=0.10;w['ê°•í’']+=0.03;w['ë§‘ìŒ']-=0.08}if([12,1,2].includes(month)){w['ëˆˆ']+=0.07;w['ë§‘ìŒ']-=0.04}if(region==='ì œì£¼íŠ¹ë³„ìì¹˜ë„'){w['ê°•í’']=Math.max(0.01,(w['ê°•í’']+0.02)*(CAL.jejuWeatherScale||1.0));w['ëˆˆ']=Math.max(0,w['ëˆˆ']-0.05)}const macro=macroRegionBySiDo(region);if(['ì˜ë‚¨','í˜¸ë‚¨'].includes(macro))w['ê°•í’']+=0.02;const s=Object.values(w).reduce((a,b)=>a+b,0);let r=Math.random()*s,acc=0;for(const k of Object.keys(w)){acc+=w[k];if(r<=acc)return k}return'ë§‘ìŒ'}
      function selectFulfillmentCenter(region){return FC_SITES[region]||'ì§€ì—­FC'}
      function genBinSlot(){const a=pad(irnd(1,40)),b=pad(irnd(1,30)),l=pad(irnd(1,5)),s=pad(irnd(1,20));return{Bin:\`A\${a}-B\${b}-L\${l}\`,Slot:\`S\${s}\`}}
      function genLotAndExpiry(category,orderDate,receivingDate,CAL){const cold=COUPANG_CATEGORIES[category]?.coldChain;if(!cold)return{Lot_ID:null,Expiry_Date:null};const lot=\`LOT\${irnd(100000,999999)}\`;let daysAhead=90;if(category==='ì‹ ì„ ì‹í’ˆ')daysAhead=irnd(3,10);else if(category==='ëƒ‰ë™ì‹í’ˆ')daysAhead=irnd(180,365);let expiry=new Date(receivingDate.getTime()+daysAhead*86400000);if(expiry<=orderDate){expiry=new Date(orderDate.getTime()+irnd(2,5)*86400000)}if(Math.random()<(CAL.expiryImminentRate??0.008)){expiry=new Date(orderDate.getTime()+irnd(0,1)*86400000)}return{Lot_ID:lot,Expiry_Date:expiry.toISOString().split('T')[0]}}
      function estimateUnitCost(category,unitPrice){const m=COUPANG_CATEGORIES[category]?.margin||0.3;return Math.round(unitPrice*(1-m)*rnd(0.97,1.03))}
      function forecastByABC(abc){if(abc==='A')return irnd(20,60);if(abc==='B')return irnd(8,25);return irnd(2,8)}
      function safetyStockCalc(forecastPerDay,leadDays){const z=1.28;const sigma=forecastPerDay*0.3;return Math.max(0,Math.round(z*sigma*Math.sqrt(Math.max(1,leadDays))))}
      function selectRegionWeighted(){const w={};Object.entries(REGION_LOGISTICS).forEach(([r,d])=>w[r]=d.populationWeight);return weightedPick(w)}
      function getAutomationLevel(region){for(const [level,cfg] of Object.entries(AUTOMATION_LEVELS)){if(cfg.regions.includes(region))return level}if(region.includes('ì„œìš¸')||region.includes('ê²½ê¸°')||region.includes('ì¸ì²œ'))return Math.random()<0.6?'AI_OPTIMIZED':'AUTO';return 'SEMI_AUTO'}
      function calculateDistance(region,city){const base=REGION_LOGISTICS[region]?.avgDistance||25;const v=rnd(-0.3,0.3);return Math.max(3,Math.round(base*(1+v)))}
      function generateAddress(region,city,district){const roads=['ë¬¼ë¥˜ë¡œ','ë°°ì†¡ëŒ€ë¡œ','ì¿ íŒ¡ê¸¸','ë¡œì¼“ë¡œ','í—ˆë¸ŒëŒ€ë¡œ','ì„¼í„°ë¡œ'];const no=irnd(1,999),b=irnd(1,150);return \`\${city} \${district} \${pick(roads)} \${no}-\${b}\`}

      function buildRocketPlan(total,ratePct){const k=Math.round(total*(ratePct/100));const arr=Array(total).fill(false).map((_,i)=>i<k);for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
      function preAssignCustomerProfiles(uniqueCustomers,wowRate){const profiles={};const wowPlan=buildRocketPlan(uniqueCustomers,wowRate);for(let i=0;i<uniqueCustomers;i++){const custId=\`CUST\${String(100000+i).padStart(7,'0')}\`;const isWow=wowPlan[i]?1:0;profiles[custId]={isWow,wowTier:isWow?'WOW_BASIC':null,churnFlag:Math.random()<0.08?1:0,joinDate:isWow?new Date(Date.now()-irnd(30,1095)*86400000):null,preferredRegion:selectRegionWeighted()};}return profiles}

      function generateCoupangRealisticRow(index,totalUsers,yearStart,yearEnd,customerProfiles,forceRocket,CAL){
        const custIndex=index%totalUsers;
        const custId=\`CUST\${String(100000+custIndex).padStart(7,'0')}\`;
        const customerProfile=customerProfiles[custId];
        const region=Math.random()<0.7?customerProfile.preferredRegion:selectRegionWeighted();
        const city=pick(CITIES_BY_REGION[region]||['ê¸°íƒ€ì‹œ']);
        const district=pick(DISTRICTS_BY_CITY[city]||['ê¸°íƒ€êµ¬']);
        const address=generateAddress(region,city,district);
        const distanceKm=calculateDistance(region,city);
        const categoryKeys=Object.keys(COUPANG_CATEGORIES);
        const month=irnd(1,12);
        let categoryWeights={};categoryKeys.forEach(cat=>{let w=1;if(cat==='ì‹ ì„ ì‹í’ˆ'&&[6,7,8].includes(month))w=1.8;if(cat==='ëƒ‰ë™ì‹í’ˆ'&&[12,1,2].includes(month))w=1.5;if(cat==='íŒ¨ì…˜ì˜ë¥˜'&&[3,4,9,10].includes(month))w=1.4;categoryWeights[cat]=w;});
        const selectedCategory=weightedPick(categoryWeights);
        const categoryData=COUPANG_CATEGORIES[selectedCategory]||COUPANG_CATEGORIES['ìƒí™œìš©í’ˆ'];
        const skuList=(Array.isArray(categoryData.skus)&&categoryData.skus.length)?categoryData.skus:['GEN-ITEM-001','GEN-ITEM-002'];
        const sku=pick(skuList);
        const unitPrice=irnd(categoryData.price[0],categoryData.price[1]);
        const quantity=Math.random()<0.7?1:irnd(2,5);
        const orderAmount=unitPrice*quantity;
        const abcRand=Math.random();
        const abcGrade=abcRand<ABC_DISTRIBUTION.A?'A':(abcRand<ABC_DISTRIBUTION.A+ABC_DISTRIBUTION.B?'B':'C');
        const year=irnd(yearStart,yearEnd);
        const orderHour=getOrderHour();
        const orderDate=new Date(year,month-1,irnd(1,28),orderHour,irnd(0,59),irnd(0,59));

        let availableModes;const mReg=(region==='ì„œìš¸íŠ¹ë³„ì‹œ'||region==='ê²½ê¸°ë„'||region==='ì¸ì²œê´‘ì—­ì‹œ')?'ìˆ˜ë„ê¶Œ':(region==='ì œì£¼íŠ¹ë³„ìì¹˜ë„'?'ì œì£¼':(region.includes('ì¶©ì²­')?'ì¶©ì²­':(region.includes('ê²½ìƒ')||['ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ'].includes(region))?'ì˜ë‚¨':(region.includes('ì „ë¼')||region==='ê´‘ì£¼ê´‘ì—­ì‹œ')?'í˜¸ë‚¨':'ê¸°íƒ€'));
        if(forceRocket){
          availableModes=['ë¡œì¼“ë‹¹ì¼','ë¡œì¼“ìƒˆë²½','ë¡œì¼“ìµì¼','ë¡œì¼“í”„ë ˆì‹œ'].filter(mode=>{const cfg=DELIVERY_MODES[mode];return cfg.regions.includes('ì „êµ­')||cfg.regions.includes(region)||cfg.regions.includes(mReg)});
          if(mReg!=='ìˆ˜ë„ê¶Œ')availableModes=availableModes.filter(m=>m!=='ë¡œì¼“ë‹¹ì¼');
          if(categoryData.freshFood&&availableModes.includes('ë¡œì¼“í”„ë ˆì‹œ')&&Math.random()<0.6)availableModes=['ë¡œì¼“í”„ë ˆì‹œ'];
          if(!availableModes.length)availableModes=['ë¡œì¼“ìµì¼'];
        }else{availableModes=['ì¼ë°˜íƒë°°']}
        const deliveryMode=pick(availableModes);
        const modeConfig=DELIVERY_MODES[deliveryMode];

        const plannedDelivery=new Date(orderDate);
        if(deliveryMode==='ë¡œì¼“ë‹¹ì¼'){
          const cutoffHour=modeConfig.cutoffHour;
          if(orderDate.getHours()>=cutoffHour){plannedDelivery.setDate(plannedDelivery.getDate()+1);plannedDelivery.setHours(6+irnd(0,3),irnd(0,59),0,0)}
          else{const h=Math.max(3,cutoffHour-orderDate.getHours()+irnd(-1,2));plannedDelivery.setHours(orderDate.getHours()+h,irnd(0,59),0,0)}
        }else if(deliveryMode==='ë¡œì¼“ìƒˆë²½'){
          plannedDelivery.setDate(plannedDelivery.getDate()+modeConfig.baseDays);plannedDelivery.setHours(6,irnd(0,30),0,0)
        }else{
          plannedDelivery.setDate(plannedDelivery.getDate()+modeConfig.baseDays);plannedDelivery.setHours(irnd(9,18),irnd(0,59),0,0)
        }

        const weather=pickWeather(region,month,CAL);
        const weatherSev=weatherSeverity(weather);
        const isPeakTime=orderDate.getHours()>=19&&orderDate.getHours()<=21;
        const isWeekend=[0,6].includes(orderDate.getDay());
        let actualDelayRate=modeConfig.delayRate;
        if(weatherSev>0.4)actualDelayRate*=1.8; if(isPeakTime)actualDelayRate*=1.3; if(isWeekend)actualDelayRate*=0.8; if(region==='ì œì£¼íŠ¹ë³„ìì¹˜ë„')actualDelayRate*=2.2;
        const isDelayed=Math.random()<actualDelayRate;
        let actualDelivery=new Date(plannedDelivery);
        if(isDelayed){const baseDelay=deliveryMode.includes('ë¡œì¼“')?irnd(4,24):irnd(12,48);const delayHours=baseDelay+(weatherSev>0.6?irnd(0,24):0);actualDelivery.setHours(actualDelivery.getHours()+delayHours)}
        else{const early=deliveryMode.includes('ë¡œì¼“')?rnd(0,4):rnd(0,2);actualDelivery.setTime(actualDelivery.getTime()-early*3600000)}

        const suitableVehicles=VEHICLES.filter(v=>v.regions.includes('ì „ì²´')||(v.regions.includes('ë„ì‹¬')&&['ì„œìš¸íŠ¹ë³„ì‹œ','ë¶€ì‚°ê´‘ì—­ì‹œ','ì¸ì²œê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ'].includes(region))||(v.regions.includes('ê°„ì„ ')&&mReg!=='ìˆ˜ë„ê¶Œ'));
        const vehicle=pick(suitableVehicles);const vehicleId=\`V\${irnd(10000,99999)}\`;const driverId=\`D\${irnd(1000,9999)}\`;const driverGrade=pick(DRIVER_GRADES);
        const baseLoadFactor=Math.random()<0.3?rnd(40,70):rnd(70,95);const loadFactor=Math.round(clamp(baseLoadFactor,20,100));const fuelEfficiency=Math.round(rnd(vehicle.fuelEff[0],vehicle.fuelEff[1])*10)/10;
        const automationLevel=getAutomationLevel(region);
        const baseRouting=automationLevel==='AI_OPTIMIZED'?rnd(88,98):automationLevel==='AUTO'?rnd(78,92):automationLevel==='SEMI_AUTO'?rnd(65,85):rnd(50,75);
        const routingScore=Math.round(baseRouting);

        const regLog=REGION_LOGISTICS[region];
        const baseCost=regLog.baseCost;const distanceCost=distanceKm*regLog.perKmCost;const modeCostMultiplier=modeConfig.cost;
        const weatherMultiplier=weatherSev>0.6?1.25:(weatherSev>0.3?1.1:1.0);const peakMultiplier=isPeakTime?1.15:1.0;const handlingBase=500;
        const islandMultiplier=region==='ì œì£¼íŠ¹ë³„ìì¹˜ë„'?(weatherSev>0.6?1.8:1.5):1.0;
        const estCost=Math.round((baseCost+distanceCost+handlingBase)*modeCostMultiplier*weatherMultiplier*peakMultiplier*islandMultiplier);
        const driverFactor=1+rnd(-0.05,0.05);const vehicleFactor=(vehicle.type==='ëŒ€í˜•íŠ¸ëŸ­'?1.08:(vehicle.type==='ì˜¤í† ë°”ì´'?0.92:1.0));
        const hubFactor=(Math.random()<0.5&&(Math.random()<0.65))?1+rnd(0.02,0.08):1.0;const congestion=isPeakTime?irnd(0,400):0;const weatherSurcharge=(weather==='ê°•í’'||weather==='ëˆˆ')?irnd(200,700):0;const jitter=irnd(-150,150);
        const actualLogisticsCost=Math.max(0,Math.round((estCost*driverFactor*vehicleFactor*hubFactor+congestion+weatherSurcharge+jitter)*(CAL.costBias||1.0)));

        let customerDeliveryCharge=0;if(customerProfile.isWow===0&&orderAmount<50000){customerDeliveryCharge=deliveryMode.includes('ë¡œì¼“')?3500:3000}
        customerDeliveryCharge=Math.round(customerDeliveryCharge);

        // ì½œë“œì²´ì¸
        function generateTemperatureData(category,coldChain,CAL){if(!coldChain)return{temp:null,violation:false,quality:null};const cfg=COUPANG_CATEGORIES[category];const target=cfg.tempRange;const targetTemp=rnd(target[0],target[1]);let actualTemp=targetTemp+rnd(-2,2);let violation=Math.random()< (CAL.tempViolationBase??0.015); if(violation){if(Math.random()<0.5)actualTemp=target[1]+rnd(4,8);else actualTemp=target[0]-rnd(4,8)}const quality=violation?rnd(60,85):rnd(85,98);return{targetTemp:Math.round(targetTemp*10)/10,actualTemp:Math.round(actualTemp*10)/10,violation,quality:Math.round(quality)}}
        const tempData=generateTemperatureData(selectedCategory,!!categoryData.coldChain,CAL);

        let returnRate=categoryData.returnRate;if(tempData.violation)returnRate*=2.5;if(isDelayed&&deliveryMode.includes('ë¡œì¼“'))returnRate*=1.8;
        const returnFlag=Math.random()<returnRate?1:0;const returnReason=returnFlag?pick(RETURN_REASONS):null;const returnCost=returnFlag?Math.round(orderAmount*rnd(0.1,0.25)):0;
        let resellable=null,resellReason=null;if(returnFlag){if(tempData.violation){resellable=0;resellReason='ì˜¨ë„ê´€ë¦¬ì‹¤íŒ¨'}else if(['ë‹¨ìˆœë³€ì‹¬','ê¸°íƒ€'].includes(returnReason)){resellable=Math.random()<0.92?1:0;resellReason=resellable?'ì •ìƒìƒí’ˆ':'í¬ì¥ì†ìƒ'}else{resellable=Math.random()<0.45?1:0;resellReason=resellable?'ë¶€ë¶„ìˆ˜ë¦¬ê°€ëŠ¥':'ìƒí’ˆì†ìƒ'}}

        const currentStock=abcGrade==='A'?irnd(200,800):(abcGrade==='B'?irnd(50,300):irnd(10,100));
        const reorderPoint=Math.round(currentStock*(abcGrade==='A'?0.4:abcGrade==='B'?0.3:0.2));
        const stockTurnover=abcGrade==='A'?rnd(12,20):(abcGrade==='B'?rnd(6,12):rnd(2,8));
        const stockoutFlag=Math.random()<(abcGrade==='A'?0.015:abcGrade==='B'?0.04:0.08)?1:0;
        const overstockFlag=Math.random()< ( (typeof CAL.overstockProb==='number'?CAL.overstockProb:0.22) ) ?1:0;

        const automationConfig=AUTOMATION_LEVELS[automationLevel];
        const pickingTime=automationConfig.pickingTime+rnd(-3,5);
        const packingTime=automationConfig.packingTime+rnd(-2,3);
        const totalProcessTime=Math.round((pickingTime+packingTime)*10)/10;

        const SLA=SHIP_SLA_MIN[deliveryMode]??SHIP_SLA_MIN.DEFAULT;
        let orderToShipMinutes;if(Math.random()<0.90)orderToShipMinutes=irnd(10,Math.floor(SLA*0.8));else orderToShipMinutes=irnd(Math.floor(SLA*0.8)+1,Math.floor(SLA*1.2));
        const autoBoost=automationLevel==='AI_OPTIMIZED'?0.85:automationLevel==='AUTO'?0.93:automationLevel==='SEMI_AUTO'?1.00:1.05;
        const peakPenalty=(orderHour>=19&&orderHour<=21)?1.06:1.0;
        orderToShipMinutes=Math.round(orderToShipMinutes*autoBoost*peakPenalty);
        const pickStart=new Date(orderDate.getTime()+irnd(5,15)*60000);
        const pickEnd=new Date(pickStart.getTime()+Math.max(5,pickingTime)*1000);
        const packStart=new Date(pickEnd.getTime()+irnd(2,12)*60000);
        const packEnd=new Date(packStart.getTime()+Math.max(4,packingTime)*1000);
        const shipSlaDue=new Date(orderDate.getTime()+SLA*60000);
        let fcExit=new Date(orderDate.getTime()+Math.max(orderToShipMinutes,5)*60000);
        const minBufferMin=irnd(3,10);if(fcExit<new Date(packEnd.getTime()+minBufferMin*60000)){fcExit=new Date(packEnd.getTime()+minBufferMin*60000)}
        orderToShipMinutes=Math.round((fcExit-orderDate)/60000);
        const fastShipFlag=orderToShipMinutes<=30?1:0;
        const fcSlaBreach=fcExit>shipSlaDue?1:0;

        const baseCac=customerProfile.isWow?irnd(3500,7000):irnd(1200,2800);
        const wowTierConfig=customerProfile.wowTier?WOW_TIERS[customerProfile.wowTier]:{ltvMultiplier:1.5};
        const customerLTV=Math.round(orderAmount*wowTierConfig.ltvMultiplier*rnd(2.8,4.2));
        const grossProfit=Math.round(orderAmount*categoryData.margin);
        const inventoryCarryingCost=Math.round(currentStock*unitPrice*0.002/12);
        const stockoutCost=stockoutFlag?Math.round(orderAmount*0.08):0;
        const qualityCost=tempData.violation?Math.round(orderAmount*0.05):0;
        const netProfit=grossProfit-actualLogisticsCost-returnCost-inventoryCarryingCost-stockoutCost-qualityCost;

        let churnScore=customerProfile.churnFlag?rnd(0.65,0.95):rnd(0.05,0.55);
        if(isDelayed&&deliveryMode.includes('ë¡œì¼“'))churnScore+=0.15;
        if(returnFlag&&!resellable)churnScore+=0.1;
        churnScore=Math.min(0.98,Math.round(churnScore*1000)/1000);

        const serviceQualityScore=Math.round((100-(isDelayed?15:0)-(returnFlag?10:0)-(tempData.violation?20:0))*(automationLevel==='AI_OPTIMIZED'?1.05:1.0));
        const wmsUsage=automationLevel==='MANUAL'?'Legacy':'Active';
        const omsUsage=Math.random()<0.95?'Active':'Manual';
        const wmsAdvancedScore=automationLevel==='AI_OPTIMIZED'?rnd(88,96):automationLevel==='AUTO'?rnd(75,87):automationLevel==='SEMI_AUTO'?rnd(55,74):rnd(30,54);
        const isRocketDelivery=deliveryMode.includes('ë¡œì¼“')?1:0;
        const isSameDayDelivery=deliveryMode==='ë¡œì¼“ë‹¹ì¼'?1:0;
        const isDawnDelivery=deliveryMode==='ë¡œì¼“ìƒˆë²½'?1:0;
        const isFreshDelivery=deliveryMode==='ë¡œì¼“í”„ë ˆì‹œ'?1:0;

        const routeIsMetro=(['ì„œìš¸íŠ¹ë³„ì‹œ','ê²½ê¸°ë„','ì¸ì²œê´‘ì—­ì‹œ'].includes(region));
        const routeType=routeIsMetro?'FCâ†’CAMPâ†’OFD':'FCâ†’HUBâ†’CAMPâ†’OFD';
        const sortHub=routeIsMetro?null:(pick(MEGA_HUBS));
        const isMegaHub=sortHub?1:0;
        const fcDwellMin=irnd(5,20);
        const hubDwellMin=sortHub?irnd(20,90):null;
        const campDwellMin=irnd(8,25);
        const fcExitTS=new Date(fcExit);
        let hubInTS=null,hubOutTS=null;
        if(sortHub){hubInTS=new Date(fcExitTS.getTime()+irnd(40,120)*60000);hubOutTS=new Date(hubInTS.getTime()+(hubDwellMin??30)*60000)}
        const campInBase=sortHub?hubOutTS:fcExitTS;
        const campInTS=new Date(campInBase.getTime()+irnd(25,80)*60000);
        const loadStartTS=new Date(campInTS.getTime()+campDwellMin*60000);
        const loadEndTS=new Date(loadStartTS.getTime()+irnd(5,20)*60000);
        const ofdTS=new Date(loadEndTS.getTime()+irnd(15,90)*60000);

        const plannedDeliveryDate=plannedDelivery.toISOString().split('T')[0];
        const actualDeliveryDate=actualDelivery.toISOString().split('T')[0];
        const delayHrs=Math.max(0,Math.round((actualDelivery-plannedDelivery)/3600000));
        const deliveryStatus=isDelayed?'Delayed Delivered':'Delivered';
        const slaBreach=isDelayed?1:0;

        let distanceBucket,distanceBandLabel;
        if(distanceKm<=10){distanceBucket=1;distanceBandLabel='â‰¤10km'}
        else if(distanceKm<=20){distanceBucket=2;distanceBandLabel='11â€“20km'}
        else if(distanceKm<=30){distanceBucket=3;distanceBandLabel='21â€“30km'}
        else if(distanceKm<=40){distanceBucket=4;distanceBandLabel='31â€“40km'}
        else{distanceBucket=5;distanceBandLabel='>40km'}

        const receivingDate=new Date(orderDate.getTime()-irnd(1,5)*86400000);
        const putawayDate=new Date(receivingDate.getTime()+irnd(0,2)*86400000);
        const {Bin,Slot}=genBinSlot();
        const {Lot_ID,Expiry_Date}=genLotAndExpiry(selectedCategory,orderDate,receivingDate,CAL);
        const unitCost=estimateUnitCost(selectedCategory,unitPrice);
        const forecast=forecastByABC(abcGrade);
        const safetyStock=safetyStockCalc(forecast,irnd(1,7));
        const dailyOnHandSnapshot=irnd(Math.max(0,currentStock-50),currentStock+50);

        const clvQuartile=(customerLTV>=600000)?1:(customerLTV>=300000)?2:(customerLTV>=150000)?3:4;

        const asnId='ASN'+irnd(1000000,9999999);
        const poId='PO'+irnd(1000000,9999999);
        const replType=pick(['Regular','Safety Refill','Promotion','Seasonal']);

        const processingErrorRate=AUTOMATION_LEVELS[automationLevel].errorRate;
        const misShipFlag=Math.random()<processingErrorRate*1.2?1:0;
        const isQualityIssue=(tempData.violation || ['ìƒí’ˆë¶ˆëŸ‰','íŒŒì†'].includes(returnReason)) ? 1 : (Math.random()<0.01?1:0);
        let baseDamage = 0.004;
        if(categoryData.freshFood) baseDamage += 0.010;
        if(selectedCategory==='ê°€ì „ì „ì') baseDamage += 0.002;
        const damageRateRaw = baseDamage
          + (tempData.violation?0.06:0)
          + (distanceKm>35?0.008:0)
          + (weatherSev>0.5?0.010:0)
          + (isQualityIssue?0.020:0)
          + (misShipFlag?0.006:0);
        const Damage_Rate = Math.min(0.35, Math.max(0, +(damageRateRaw).toFixed(3)));
        const Damage_Flag = (['íŒŒì†','ìƒí’ˆë¶ˆëŸ‰'].includes(returnReason)) ? 1 : (Math.random() < Damage_Rate ? 1 : 0);

        const customerNPS=Math.round(clamp(70+(isDelayed?-10:5)+(returnFlag?-12:0)+(tempData.violation?-15:0)+(automationLevel==='AI_OPTIMIZED'?5:0),0,100));
        const wmsAdvanced=Math.round(wmsAdvancedScore);

        return {
          Order_ID:\`ORD\${String(1000000+index).padStart(7,'0')}\`,
          Order_Date:orderDate.toISOString().split('T')[0],
          Order_Timestamp:orderDate.toISOString(),
          Order_Hour:orderHour,

          Delivery_Mode:deliveryMode,
          Planned_Delivery_Date:plannedDeliveryDate,
          Actual_Delivery_Date:actualDeliveryDate,
          Delivery_Timestamp:actualDelivery.toISOString(),
          Is_Delayed:isDelayed?1:0,
          Delay_Hours:delayHrs,
          SLA_Breach:slaBreach,
          Delivery_Status:deliveryStatus,

          Fast_Ship_30min:fastShipFlag,
          Order_To_Ship_Minutes:orderToShipMinutes,

          Region:region,City:city,District:district,Address:address,
          Fulfillment_Center:selectFulfillmentCenter(region),
          Delivery_Center:\`\${city} ë°°ì†¡ìº í”„\`,
          Is_Mega_Hub:isMegaHub,
          Distance_km:distanceKm,

          Customer_ID:custId,
          Is_WOW_Member:customerProfile.isWow,
          WOW_Tier:customerProfile.wowTier,
          WOW_Join_Date:customerProfile.joinDate?customerProfile.joinDate.toISOString().split('T')[0]:null,
          WOW_Tenure_Days:customerProfile.joinDate?Math.round((orderDate-customerProfile.joinDate)/86400000):0,
          Customer_Segment:pick(['ì¼ë°˜','í™œì„±','í•µì‹¬','íœ´ë©´ì¤€ë¹„']),

          Product_Category:selectedCategory,SKU:sku,ABC_Category:abcGrade,Unit_Price:unitPrice,Quantity:quantity,Order_Amount:orderAmount,

          Is_Fresh_Food:categoryData.freshFood?1:0,
          Is_Cold_Chain_Required:categoryData.coldChain?1:0,
          Target_Temperature:tempData.targetTemp??null,
          Actual_Temperature:tempData.actualTemp??null,
          Temperature_Violation:tempData.violation?1:0,
          Cold_Chain_Quality_Score:tempData.quality??null,

          Vehicle_ID:vehicleId,Vehicle_Type:vehicle.type,Vehicle_Capacity:vehicle.capacity,Driver_ID:driverId
          ,Driver_Grade:driverGrade,

          Load_Factor:loadFactor,
          Fuel_Efficiency:fuelEfficiency,
          Routing_Score:routingScore,
          GPS_Tracking:(Math.random()<0.97?1:0),

          Actual_Logistics_Cost:actualLogisticsCost,
          Customer_Delivery_Charge:customerDeliveryCharge,
          Gross_Profit:grossProfit,
          Net_Profit:netProfit,

          CAC:baseCac,
          Customer_LTV:customerLTV,
          LTV_to_CAC:+(customerLTV/Math.max(1,baseCac)).toFixed(2),

          Return_Flag:returnFlag,
          Return_Reason:returnReason,
          Return_Cost:returnCost,
          Is_Resellable:resellable,
          Resellability_Reason:resellReason,

          Current_Stock:currentStock,
          Reorder_Point:reorderPoint,
          Stockout_Flag:stockoutFlag,
          Overstock_Flag:overstockFlag,
          Inventory_Turnover:+stockTurnover.toFixed(1),
          Inventory_Accuracy:+(100 - (Damage_Rate*100)).toFixed(1),

          Automation_Level:automationLevel,
          Picking_Time_Seconds:Math.round(pickingTime),
          Packing_Time_Seconds:Math.round(packingTime),
          Total_Process_Time:totalProcessTime,

          WMS_Usage:wmsUsage,
          OMS_Usage:omsUsage,
          WMS_Advanced_Score:wmsAdvanced,
          Service_Quality_Score:serviceQualityScore,
          Customer_NPS:customerNPS,
          Processing_Error_Rate:processingErrorRate,

          Weather_Condition:weather,
          Weather_Severity_Score:+weatherSev.toFixed(2),

          Churn_Flag:customerProfile.churnFlag?1:0,
          Predicted_Churn_Score:+churnScore.toFixed(3),

          Is_Rocket_Delivery:isRocketDelivery,
          Is_Same_Day_Delivery:isSameDayDelivery,
          Is_Dawn_Delivery:isDawnDelivery,
          Is_Fresh_Delivery:isFreshDelivery,

          Is_Premium_Order:(orderAmount>=200000)?1:0,
          Is_Bulk_Order:(quantity>=3)?1:0,
          Is_Weekend_Order:isWeekend?1:0,
          Is_Peak_Hour_Order:isPeakTime?1:0,
          Is_Free_Shipping:(customerDeliveryCharge===0)?1:0,

          Is_Weather_Risk:(weatherSev>0.5)?1:0,
          Is_Long_Distance:(distanceKm>30)?1:0,
          Is_High_LTV:(clvQuartile===1)?1:0,
          Is_Churn_Risk:(churnScore>=0.6)?1:0,
          Is_VIP_Customer:(customerProfile.isWow===1 && clvQuartile===1)?1:0,

          Is_Loss_Order:(netProfit<0)?1:0,
          Is_AI_Optimized:(automationLevel==='AI_OPTIMIZED')?1:0,

          Receiving_Date:receivingDate.toISOString().split('T')[0],
          Putaway_Date:putawayDate.toISOString().split('T')[0],
          Lot_ID:Lot_ID,
          Expiry_Date:Expiry_Date,
          Bin:Bin,
          Slot:Slot,
          Unit_Cost:unitCost,

          Daily_OnHand_Snapshot:dailyOnHandSnapshot,
          Safety_Stock:safetyStock,
          Forecast_Demand:forecast,

          ASN_ID:asnId,
          PO_ID:poId,
          Replenishment_Type:replType,

          Picking_Start_TS:pickStart.toISOString(),
          Picking_End_TS:pickEnd.toISOString(),
          Packing_Start_TS:packStart.toISOString(),
          Packing_End_TS:packEnd.toISOString(),

          Planned_Ship_Timestamp:shipSlaDue.toISOString(),
          Actual_Ship_Timestamp:fcExitTS.toISOString(),
          On_Time_Dispatch_Flag:fcSlaBreach?0:1,

          Is_Quality_Issue:isQualityIssue,
          Mis_Ship_Flag:misShipFlag,
          Damage_Rate:Damage_Rate,
          Damage_Flag:Damage_Flag,

          Distance_Bucket:distanceBucket,
          Distance_Band_Label:distanceBandLabel,

          [NET.ROUTE_TYPE]:routeType,
          [NET.SORT_HUB_NAME]:sortHub,
          [NET.FC_EXIT]:fcExitTS.toISOString(),
          [NET.HUB_IN]:hubInTS?hubInTS.toISOString():null,
          [NET.HUB_OUT]:hubOutTS?hubOutTS.toISOString():null,
          [NET.CAMP_IN]:campInTS.toISOString(),
          [NET.LOAD_START]:loadStartTS.toISOString(),
          [NET.LOAD_END]:loadEndTS.toISOString(),
          [NET.OFD]:ofdTS.toISOString(),
          [NET.FC_DWELL]:fcDwellMin,
          [NET.HUB_DWELL]:hubDwellMin,
          [NET.CAMP_DWELL]:campDwellMin
        };
      }

      // WORKER: ë©”ì‹œì§€ ì²˜ë¦¬ â€” ë°°ì¹˜ ìŠ¤íŠ¸ë¦¬ë°
      self.onmessage = async (e)=>{
        const msg=e.data||{};
        if(msg.type==='stop'){ SHOULD_STOP=true; return; }
        if(msg.type!=='start') return;

        try{
          SHOULD_STOP=false;
          const {
            totalRows, userCount, startYear, endYear,
            chunkSize, rocketRate, wowRate, CAL
          } = msg;

          const profiles = preAssignCustomerProfiles(userCount, wowRate);
          const rocketPlan = buildRocketPlan(totalRows, rocketRate);

          let processed=0;
          let batch=[];
          const effChunk = Math.max(100, chunkSize|0);

          while(processed < totalRows && !SHOULD_STOP){
            const idx=processed;
            const row = generateCoupangRealisticRow(
              idx, userCount, startYear, endYear, profiles, !!rocketPlan[idx], CAL
            );
            batch.push(row);
            processed++;

            if(batch.length>=effChunk || processed===totalRows){
              // WORKER -> MAIN: rows
              postMessage({type:'rows', rows:batch, processed, total:totalRows});
              batch=[];
              // ì§„ë™ ì™„í™”
              await new Promise(r=>setTimeout(r,0));
            }

            if(processed % (effChunk*2)===0){
              postMessage({type:'progress', processed, total:totalRows});
            }
          }

          postMessage({type:'done'});
        }catch(err){
          postMessage({type:'error', message:String(err&&err.message||err)});
        }
      };
      // ===== Worker Scope End =====
    `;
    // WORKER: Blob URLë¡œ ë™ì  ìƒì„±
    const blob = new Blob([workerCode], {type:'text/javascript'});
    return new Worker(URL.createObjectURL(blob));
  }

  /* ==========================
     7) CSV ë‚´ë³´ë‚´ê¸° (ìŠ¤íŠ¸ë¦¬ë°/ë°°ì¹˜)
  ========================== */
  function buildCSVHeader(keys){
    return keys.map(k=>CSV_SPECIAL_LABELS[k]||prettyHeader(k)).join(',')+'\n';
  }
  function escapeCsvCell(v){
    if(v===null||v===undefined) return '';
    const s=String(v);
    return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
  }
  async function downloadCSVFast(){
    if(!TABLE_KEYS || DATA.length===0) return;

    setStatus('EXPORTING','running');
    showProgress(true);
    let processed=0;
    const total=DATA.length;

    const parts=[];
    parts.push(buildCSVHeader(TABLE_KEYS));

    const BATCH=5000; // PERF: ë°°ì¹˜ í¬ê¸°
    for(let i=0;i<DATA.length;i+=BATCH){
      const slice=DATA.slice(i,i+BATCH);
      const lines = slice.map(row=>TABLE_KEYS.map(k=>escapeCsvCell(row[k])).join(',')).join('\n')+'\n';
      parts.push(lines);
      processed += slice.length;
      updateExportProgress(processed,total);
      await new Promise(r=>setTimeout(r,0)); // PERF: ë©”ì¸ìŠ¤ë ˆë“œ ì–‘ë³´
    }

    const blob=new Blob(parts,{type:'text/csv;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`coupang-logistics-${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();

    URL.revokeObjectURL(url);
    setStatus('READY','ok');
    showProgress(false);
  }

  async function downloadCSVTurbo(){
    if(!TABLE_KEYS || DATA.length===0) return;

    setStatus('EXPORTING','running');
    showProgress(true);

    const header = buildCSVHeader(TABLE_KEYS);

    // WORKER/STREAM: TextEncoderStream + CompressionStream(gzip)
    const supportsGzip = typeof CompressionStream!=='undefined';
    const encoder = new TextEncoder();

    const readable = new ReadableStream({
      pull(controller){
        // ì´ˆê¸° í—¤ë”
        controller.enqueue(encoder.encode(header));
        // ì´í›„ ë³¸ë¬¸ì€ pushChunksì—ì„œ ì²˜ë¦¬
        controller.close();
      }
    });

    // ë³¸ë¬¸ ìŠ¤íŠ¸ë¦¼ ìƒì„± (ëŒ€ìš©ëŸ‰ì—ì„œë„ ë¶€í•˜ ë¶„ì‚°)
    const bodyStream = new ReadableStream({
      start(controller){
        (async()=>{
          const BATCH=8000;
          let processed=0;
          for(let i=0;i<DATA.length;i+=BATCH){
            const slice=DATA.slice(i,i+BATCH);
            const text = slice.map(row=>TABLE_KEYS.map(k=>escapeCsvCell(row[k])).join(',')).join('\n')+'\n';
            controller.enqueue(encoder.encode(text));
            processed+=slice.length;
            updateExportProgress(processed,DATA.length);
            await new Promise(r=>setTimeout(r,0)); // PERF: ì–‘ë³´
          }
          controller.close();
        })().catch(err=>controller.error(err));
      }
    });

    // í—¤ë” + ë°”ë””ë¥¼ í•©ì¹˜ëŠ” ê°„ë‹¨í•œ concatenate
    const combined = new ReadableStream({
      async start(controller){
        const r1=readable.getReader(); const r2=bodyStream.getReader();
        for await (const r of [r1,r2]){
          while(true){
            const {done,value}=await r.read();
            if(done) break;
            controller.enqueue(value);
          }
        }
        controller.close();
      }
    });

    let finalStream = combined;
    let fileName = `coupang-logistics-${Date.now()}.csv`;

    if(supportsGzip){
      // PERF: gzip ì••ì¶•
      finalStream = combined.pipeThrough(new CompressionStream('gzip'));
      fileName += '.gz';
    }

    // Responseë¡œ ë°›ì•„ Blob ìƒì„±
    const blob = await new Response(finalStream).blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fileName;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

    setStatus('READY','ok');
    showProgress(false);
  }

  /* ==========================
     8) ì‹œì‘/ì¤‘ë‹¨ ë° UI ë°”ì¸ë”©
  ========================== */
  function resetUIForRun(total){
    // ì´ˆê¸°í™”
    DATA.length=0;
    TABLE_KEYS=null;
    const tbody=qs('tbl').querySelector('tbody'); tbody.innerHTML='';
    Object.assign(AGG, resetAgg());

    PROCESSING_STATE={isRunning:true,shouldStop:false,startTime:Date.now(),processedRows:0,totalRows:total};

    setDisabled('btnStart',true);
    setDisabled('btnStop',false);
    setDisabled('btnCsv',true);
    setDisabled('btnCsvTurbo',true);
    setStatus('RUNNING','running');
    showProgress(true);
    updateProgressFromState('Generating');
  }

  function finishRun(label='READY'){           // â† ê¸°ë³¸ê°’ì€ ê¸°ì¡´ì²˜ëŸ¼ READY
    PROCESSING_STATE.isRunning=false;
    setDisabled('btnStart',false);
    setDisabled('btnStop',true);
    setDisabled('btnCsv',DATA.length===0);
    setDisabled('btnCsvTurbo',DATA.length===0);
    setStatus(label,'ok');                    // â† ì—¬ê¸°ì„œ READY ëŒ€ì‹  label ì‚¬ìš©
    showProgress(false);
  }



  function startGeneration(){
    // ì…ë ¥ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
    const yearStart=parseInt(qs('startYear').value,10);
    const yearEnd=parseInt(qs('endYear').value,10);
    const userCount=parseInt(qs('userCount').value,10);
    const orderCount=parseInt(qs('orderCount').value,10);
    const chunkSize=parseInt(qs('chunkSize').value,10);
    const rocketRate=parseFloat(qs('rocketRate').value);
    const wowRate=parseFloat(qs('wowRate').value);
    const targetNetMargin=parseFloat(qs('targetNetMargin').value);
    FAST_MODE=!!qs('fastMode').checked;

    applyDialsToCal(targetNetMargin); // PERF: íŠœë‹ ë°˜ì˜

    const effectiveChunk = Math.max(500, Math.round(chunkSize * (FAST_MODE? 1.6:1)));

    resetUIForRun(orderCount);

    if(typeof Worker==='undefined'){
      // Fallback í†µì§€ (ê°„ë‹¨ ê²½ê³ )
      setStatus('NO WORKER: Degraded','warn');
    }

    // WORKER: ìƒì„± ë° ì‹¤í–‰
    WORKER = createGeneratorWorker();
    WORKER.onmessage = (e)=>{
      const {data}=e;
      if(!data) return;
      if(data.type==='rows'){
        ingestRows(data.rows);
      }else if(data.type==='progress'){
        PROCESSING_STATE.processedRows = data.processed;
        PROCESSING_STATE.totalRows = data.total;
        updateProgressFromState('Generating');
      }else if(data.type==='done'){
        finishRun();
        // ì™„ë£Œ í›„ CSV ë²„íŠ¼ í™œì„±í™”
        setDisabled('btnCsv',false);
        setDisabled('btnCsvTurbo',false);
      }else if(data.type==='error'){
        console.error('Worker Error:', data.message);
        setStatus('ERROR','ng');
        finishRun();
      }
    };

    WORKER.postMessage({
      type:'start',
      totalRows:orderCount,
      userCount,
      startYear:yearStart,
      endYear:yearEnd,
      chunkSize:effectiveChunk,
      rocketRate,
      wowRate,
      FAST_MODE:FAST_MODE,
      CAL
    });

    WORKER = createGeneratorWorker();
    WORKER.onmessage = (e)=>{
      const {data}=e;
      if(!data) return;
      if(data.type==='rows'){
        ingestRows(data.rows);
      }else if(data.type==='progress'){
        PROCESSING_STATE.processedRows = data.processed;
        PROCESSING_STATE.totalRows = data.total;
        updateProgressFromState('Generating');
      }else if(data.type==='done'){     // â† ì—¬ê¸° ë¸”ë¡ì„ êµì²´
        finishRun();
        setDisabled('btnCsv',false);
        setDisabled('btnCsvTurbo',false);
      }else if(data.type==='error'){
        console.error('Worker Error:', data.message);
        setStatus('ERROR','ng');
        finishRun();
      }
    };

  }

  function stopGeneration(){
    if(WORKER){
      PROCESSING_STATE.shouldStop=true;
      try{ WORKER.postMessage({type:'stop'}); }catch(e){}
      try{ WORKER.terminate(); }catch(e){}
      WORKER=null;
    }
    finishRun();
  }

  // DIALS ë²„íŠ¼ë“¤
  function onApplyDials(){
    const targetNetMargin=parseFloat(qs('targetNetMargin').value);
    applyDialsToCal(targetNetMargin);
  }
  function onResetDials(){
    // ê¸°ë³¸ê°’ ë³µì›
    const def={loss:[0.07,0.12],temp:[0.01,0.02],jeju:[0.10,0.15],over:[0.15,0.25],exp:[0.005,0.01]};
    qs('dial_loss_lo').value=def.loss[0]; qs('dial_loss_hi').value=def.loss[1];
    qs('dial_temp_lo').value=def.temp[0]; qs('dial_temp_hi').value=def.temp[1];
    qs('dial_jeju_lo').value=def.jeju[0]; qs('dial_jeju_hi').value=def.jeju[1];
    qs('dial_over_lo').value=def.over[0]; qs('dial_over_hi').value=def.over[1];
    qs('dial_exp_lo').value=def.exp[0]; qs('dial_exp_hi').value=def.exp[1];
    onApplyDials();
    qs('tuneStatus').textContent='DIALS RESET';
    qs('tuneStatus').className='pill ok';
  }

  /* ==========================
     9) ì´ˆê¸°í™”
  ========================== */
  function initYears(){
    const s=qs('startYear'), e=qs('endYear');
    const nowY=(new Date()).getFullYear();
    for(let y=nowY-6;y<=nowY;y++){
      const o1=document.createElement('option'); o1.value=y; o1.textContent=y;
      const o2=document.createElement('option'); o2.value=y; o2.textContent=y;
      s.appendChild(o1); e.appendChild(o2);
    }
    s.value=nowY-1; e.value=nowY;
  }

  function bindUI(){
    qs('btnStart').addEventListener('click', startGeneration);
    qs('btnStop').addEventListener('click', stopGeneration);
    qs('btnCsv').addEventListener('click', downloadCSVFast);
    qs('btnCsvTurbo').addEventListener('click', downloadCSVTurbo);
    qs('btnApplyDials').addEventListener('click', onApplyDials);
    qs('btnResetDials').addEventListener('click', onResetDials);
    qs('btnTune').addEventListener('click', ()=>{
      const p=qs('tunePanel');
      p.style.display = (p.style.display==='none'?'block':'none');
    });
  }

  // DOM ì¤€ë¹„
  document.addEventListener('DOMContentLoaded', ()=>{
    initYears();
    bindUI();
    setStatus('READY','ok');
  });
</script>
</body>
</html>
